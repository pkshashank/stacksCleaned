\begin{lemma} \label{lemma-dominate-factorizations} Let $A \to B$ be a quasi-finite ring map. Given two factorizations $A \to B' \to B$ and $A \to B'' \to B$ with $A \to B'$ and $A \to B''$ finite and $\Spec(B) \to \Spec(B')$ and $\Spec(B) \to \Spec(B'')$ open immersions, there exists an $A$-subalgebra $B''' \subset B$ finite over $A$ such that $\Spec(B) \to \Spec(B''')$ an open immersion and $B' \to B$ and $B'' \to B$ factor through $B'''$. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-well-defined} The module (\ref{equation-dualizing}) is well defined, i.e., independent of the choice of the factorization. \end{lemma} 
\begin{lemma} \label{lemma-localize-dualizing} Let $A \to B$ be a quasi-finite map of Noetherian rings. \begin{enumerate} \item If $A \to B$ factors as $A \to A_f \to B$ for some $f \in A$, then $\omega_{B/A} = \omega_{B/A_f}$. \item If $g \in B$, then $(\omega_{B/A})_g = \omega_{B_g/A}$. \item If $f \in A$, then $\omega_{B_f/A_f} = (\omega_{B/A})_f$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-bc-map-dualizing} The base change map (\ref{equation-bc-dualizing}) is independent of the choice of the factorization $A \to B' \to B$. Given ring maps $A \to A_1 \to A_2$ the composition of the base change maps for $A \to A_1$ and $A_1 \to A_2$ is the base change map for $A \to A_2$. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-flat-base-change} If $A \to A_1$ is flat, then the base change map (\ref{equation-bc-dualizing}) induces an isomorphism $\omega_{B/A} \otimes_B B_1 \to \omega_{B_1/A_1}$. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-composition} Let $A \to B \to C$ be quasi-finite homomorphisms of Noetherian rings. There is a canonical map $\omega_{B/A} \otimes_B \omega_{C/B} \to \omega_{C/A}$. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-product} Let $A \to B$ and $A \to C$ be quasi-finite maps of Noetherian rings. Then $\omega_{B \times C/A} = \omega_{B/A} \times \omega_{C/A}$ as modules over $B \times C$. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-associated-primes} Let $A \to B$ be a quasi-finite homomorphism of Noetherian rings. Then $\text{Ass}_B(\omega_{B/A})$ is the set of primes of $B$ lying over associated primes of $A$. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-base-flat-flat} Let $A \to B$ be a flat quasi-finite homomorphism of Noetherian rings. Then $\omega_{B/A}$ is a flat $A$-module. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-base-change-of-flat} If $A \to B$ is flat, then the base change map (\ref{equation-bc-dualizing}) induces an isomorphism $\omega_{B/A} \otimes_B B_1 \to \omega_{B_1/A_1}$. \end{lemma} 
\begin{lemma} \label{lemma-compare-dualizing-algebraic} Let $A \to B$ be a quasi-finite homomorphism of Noetherian rings. Let $\omega_{B/A}^\bullet \in D(B)$ be the algebraic relative dualizing complex discussed in Dualizing Complexes, Section \ref{dualizing-section-relative-dualizing-complexes-Noetherian}. Then there is a (nonunique) isomorphism $\omega_{B/A} = H^0(\omega_{B/A}^\bullet)$. \end{lemma} 
\begin{lemma} \label{lemma-discriminant} Let $\pi : X \to Y$ be a morphism of schemes which is finite locally free. Then $\pi$ is \'etale if and only if its discriminant is empty. \end{lemma} 
\begin{definition} \label{definition-trace-element} Let $A \to B$ be a flat quasi-finite map of Noetherian rings. The {\it trace element} is the unique\footnote{Uniqueness and existence will be justified in Lemmas \ref{lemma-trace-unique} and \ref{lemma-dualizing-tau}.} element $\tau_{B/A} \in \omega_{B/A}$ with the following property: for any Noetherian $A$-algebra $A_1$ such that $B_1 = B \otimes_A A_1$ comes with a product decomposition $B_1 = C \times D$ with $A_1 \to C$ finite the image of $\tau_{B/A}$ in $\omega_{C/A_1}$ is $\text{Trace}_{C/A_1}$. Here we use the base change map (\ref{equation-bc-dualizing}) and Lemma \ref{lemma-dualizing-product} to get $\omega_{B/A} \to \omega_{B_1/A_1} \to \omega_{C/A_1}$. \end{definition} 
\begin{lemma} \label{lemma-trace-unique} Let $A \to B$ be a flat quasi-finite map of Noetherian rings. Then there is at most one trace element in $\omega_{B/A}$. \end{lemma} 
\begin{lemma} \label{lemma-finite-flat-trace} Let $A \to B$ be a finite flat map of Noetherian rings. Then $\text{Trace}_{B/A} \in \omega_{B/A}$ is the trace element. \end{lemma} 
\begin{lemma} \label{lemma-trace-base-change} Let $A \to B$ be a flat quasi-finite map of Noetherian rings. Let $\tau \in \omega_{B/A}$ be a trace element. \begin{enumerate} \item If $A \to A_1$ is a map with $A_1$ Noetherian, then with $B_1 = A_1 \otimes_A B$ the image of $\tau$ in $\omega_{B_1/A_1}$ is a trace element. \item If $A = R_f$, then $\tau$ is a trace element in $\omega_{B/R}$. \item If $g \in B$, then the image of $\tau$ in $\omega_{B_g/A}$ is a trace element. \item If $B = B_1 \times B_2$, then $\tau$ maps to a trace element in both $\omega_{B_1/A}$ and $\omega_{B_2/A}$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-glue-trace} Let $A \to B$ be a flat quasi-finite map of Noetherian rings. Let $g_1, \ldots, g_m \in B$ be elements generating the unit ideal. Let $\tau \in \omega_{B/A}$ be an element whose image in $\omega_{B_{g_i}/A}$ is a trace element for $A \to B_{g_i}$. Then $\tau$ is a trace element. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-tau} Let $A \to B$ be a flat quasi-finite map of Noetherian rings. There exists a trace element $\tau \in \omega_{B/A}$. \end{lemma} 
\begin{lemma} \label{lemma-tau-nonzero} Let $k$ be a field and let $A$ be a finite $k$-algebra. Assume $A$ is local with residue field $k'$. The following are equivalent \begin{enumerate} \item $\text{Trace}_{A/k}$ is nonzero, \item $\tau_{A/k} \in \omega_{A/k}$ is nonzero, and \item $k'/k$ is separable and $\text{length}_A(A)$ is prime to the characteristic of $k$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-noether-different-product} Let $A \to B_i$, $i = 1, 2$ be ring maps. Set $B = B_1 \times B_2$. \begin{enumerate} \item The annihilator $J$ of $\Ker(B \otimes_A B \to B)$ is $J_1 \times J_2$ where $J_i$ is the annihilator of $\Ker(B_i \otimes_A B_i \to B_i)$. \item The Noether different $\mathfrak{D}$ of $B$ over $A$ is $\mathfrak{D}_1 \times \mathfrak{D}_2$, where $\mathfrak{D}_i$ is the Noether different of $B_i$ over $A$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-noether-different-base-change} Let $A \to B$ be a finite type ring map. Let $A \to A'$ be a flat ring map. Set $B' = B \otimes_A A'$. \begin{enumerate} \item The annihilator $J'$ of $\Ker(B' \otimes_{A'} B' \to B')$ is $J \otimes_A A'$ where $J$ is the annihilator of $\Ker(B \otimes_A B \to B)$. \item The Noether different $\mathfrak{D}'$ of $B'$ over $A'$ is $\mathfrak{D}B'$, where $\mathfrak{D}$ is the Noether different of $B$ over $A$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-noether-different-localization} Let $A \to B' \to B$ be ring maps with $A \to B'$ of finite type and $B' \to B$ inducing an open immersion of spectra. \begin{enumerate} \item The annihilator $J$ of $\Ker(B \otimes_A B \to B)$ is $J' \otimes_{B'} B$ where $J'$ is the annihilator of $\Ker(B' \otimes_A B' \to B')$. \item The Noether different $\mathfrak{D}$ of $B$ over $A$ is $\mathfrak{D}'B$, where $\mathfrak{D}'$ is the Noether different of $B'$ over $A$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-noether-pairing-compatibilities} Let $A \to B$ be a quasi-finite homomorphism of Noetherian rings. \begin{enumerate} \item If $A \to A'$ is a flat map of Noetherian rings, then $$ \xymatrix{ \omega_{B/A} \times J \ar[r] \ar[d] & B \ar[d]  \\ \omega_{B'/A'} \times J' \ar[r] & B' } $$ is commutative where notation as in Lemma \ref{lemma-noether-different-base-change} and horizontal arrows are given by (\ref{equation-pairing-noether}). \item If $B = B_1 \times B_2$, then $$ \xymatrix{ \omega_{B/A} \times J \ar[r] \ar[d] & B \ar[d]  \\ \omega_{B_i/A} \times J_i \ar[r] & B_i } $$ is commutative for $i = 1, 2$ where notation as in Lemma \ref{lemma-noether-different-product} and horizontal arrows are given by (\ref{equation-pairing-noether}). \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-noether-pairing-flat-quasi-finite} Let $A \to B$ be a flat quasi-finite homomorphism of Noetherian rings. The pairing of Remark \ref{remark-construction-pairing} induces an isomorphism $J \to \Hom_B(\omega_{B/A}, B)$. \end{lemma} 
\begin{lemma} \label{lemma-noether-different-flat-quasi-finite} Let $A \to B$ be a flat quasi-finite homomorphism of Noetherian rings. The diagram $$ \xymatrix{ J \ar[rr] \ar[rd]_\mu & & \Hom_B(\omega_{B/A}, B) \ar[ld]^{\varphi \mapsto \varphi(\tau_{B/A})} \\ & B } $$ commutes where the horizontal arrow is the isomorphism of Lemma \ref{lemma-noether-pairing-flat-quasi-finite}. Hence the Noether different of $B$ over $A$ is the image of the map $\Hom_B(\omega_{B/A}, B) \to B$. \end{lemma} 
\begin{lemma} \label{lemma-noether-different} Let $A \to B$ be a finite type ring map. Let $\mathfrak{D} \subset B$ be the Noether different. Then $V(\mathfrak{D})$ is the set of primes $\mathfrak q \subset B$ such that $A \to B$ is not unramified at $\mathfrak q$. \end{lemma} 
\begin{definition} \label{definition-kahler-different} Let $f : Y \to X$ be a morphism of schemes which is locally of finite type. The {\it K\"ahler different} is the $0$th fitting ideal of $\Omega_{Y/X}$. \end{definition} 
\begin{lemma} \label{lemma-base-change-kahler-different} Consider a cartesian diagram of schemes $$ \xymatrix{ Y' \ar[d]_{f'} \ar[r] & Y \ar[d]^f \\ X' \ar[r]^g & X } $$ with $f$ locally of finite type. Let $R \subset Y$, resp.\ $R' \subset Y'$ be the closed subscheme cut out by the K\"ahler different of $f$, resp.\ $f'$. Then $Y' \to Y$ induces an isomorphism $R' \to R \times_Y Y'$. \end{lemma} 
\begin{lemma} \label{lemma-kahler-different} Let $f : Y \to X$ be a morphism of schemes which is locally of finite type. Let $R \subset Y$ be the closed subscheme defined by the K\"ahler different. Then $R \subset Y$ is exactly the set of points where $f$ is not unramified. \end{lemma} 
\begin{lemma} \label{lemma-kahler-different-complete-intersection} Let $A$ be a ring. Let $n \geq 1$ and $f_1, \ldots, f_n \in A[x_1, \ldots, x_n]$. Set $B = A[x_1, \ldots, x_n]/(f_1, \ldots, f_n)$. The K\"ahler different of $B$ over $A$ is the ideal of $B$ generated by $\det(\partial f_i/\partial x_j)$. \end{lemma} 
\begin{lemma} \label{lemma-dedekind-different-ideal} Assume the Dedekind different of $A \to B$ is defined. Consider the statements \begin{enumerate} \item $A \to B$ is flat, \item $A$ is a normal ring, \item $\text{Trace}_{L/K}(B) \subset A$, \item $1 \in \mathcal{L}_{B/A}$, and \item the Dedekind different $\mathfrak{D}_{B/A}$ is an ideal of $B$. \end{enumerate} Then we have (1) $\Rightarrow$ (3), (2) $\Rightarrow$ (3), (3) $\Leftrightarrow$ (4), and (4) $\Rightarrow$ (5). \end{lemma} 
\begin{lemma} \label{lemma-dedekind-complementary-module} If the Dedekind different of $A \to B$ is defined, then there is a canonical isomorphism $\mathcal{L}_{B/A} \to \omega_{B/A}$. \end{lemma} 
\begin{lemma} \label{lemma-flat-dedekind-complementary-module-trace} If the Dedekind different of $A \to B$ is defined and $A \to B$ is flat, then \begin{enumerate} \item the canonical isomorphism $\mathcal{L}_{B/A} \to \omega_{B/A}$ sends $1 \in \mathcal{L}_{B/A}$ to the trace element $\tau_{B/A} \in \omega_{B/A}$, and \item the Dedekind different is $\mathfrak{D}_{B/A} = \{b \in B \mid b\omega_{B/A} \subset B\tau_{B/A}\}$. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-different} Let $f : Y \to X$ be a flat locally quasi-finite morphism of locally Noetherian schemes. Let $\omega_{Y/X}$ be the relative dualizing module and let $\tau_{Y/X} \in \Gamma(Y, \omega_{Y/X})$ be the trace element (Remarks \ref{remark-relative-dualizing-for-quasi-finite} and \ref{remark-relative-dualizing-for-flat-quasi-finite}). The annihilator of $$ \Coker(\mathcal{O}_Y \xrightarrow{\tau_{Y/X}} \omega_{Y/X}) $$ is the {\it different} of $Y/X$. It is a coherent ideal $\mathfrak{D}_f \subset \mathcal{O}_Y$. \end{definition} 
\begin{lemma} \label{lemma-flat-agree-dedekind} Let $f : Y \to X$ be a flat quasi-finite morphism of Noetherian schemes. Let $V = \Spec(B) \subset Y$, $U = \Spec(A) \subset X$ be affine open subschemes with $f(V) \subset U$. If the Dedekind different of $A \to B$ is defined, then $$ \mathfrak{D}_f|_V = \widetilde{\mathfrak{D}_{B/A}} $$ as coherent ideal sheaves on $V$. \end{lemma} 
\begin{lemma} \label{lemma-flat-gorenstein-agree-noether} Let $f : Y \to X$ be a flat quasi-finite morphism of Noetherian schemes. Let $V = \Spec(B) \subset Y$, $U = \Spec(A) \subset X$ be affine open subschemes with $f(V) \subset U$. If $\omega_{Y/X}|_V$ is invertible, i.e., if $\omega_{B/A}$ is an invertible $B$-module, then $$ \mathfrak{D}_f|_V = \widetilde{\mathfrak{D}} $$ as coherent ideal sheaves on $V$ where $\mathfrak{D} \subset B$ is the Noether different of $B$ over $A$. \end{lemma} 
\begin{lemma} \label{lemma-base-change-different} Consider a cartesian diagram of Noetherian schemes $$ \xymatrix{ Y' \ar[d]_{f'} \ar[r] & Y \ar[d]^f \\ X' \ar[r]^g & X } $$ with $f$ flat and quasi-finite. Let $R \subset Y$, resp.\ $R' \subset Y'$ be the closed subscheme cut out by the different $\mathfrak{D}_f$, resp.\ $\mathfrak{D}_{f'}$. Then $Y' \to Y$ induces a bijective closed immersion $R' \to R \times_Y Y'$. If $g$ is flat or if $\omega_{Y/X}$ is invertible, then $R' = R \times_Y Y'$. \end{lemma} 
\begin{lemma} \label{lemma-norm-different-in-discriminant} Let $f : Y \to X$ be a finite flat morphism of Noetherian schemes. Then $\text{Norm}_f : f_*\mathcal{O}_Y \to \mathcal{O}_X$ maps $f_*\mathfrak{D}_f$ into the ideal sheaf of the discriminant $D_f$. \end{lemma} 
\begin{lemma} \label{lemma-different-ramification} Let $f : Y \to X$ be a flat quasi-finite morphism of Noetherian schemes. The closed subscheme $R \subset Y$ defined by the different $\mathfrak{D}_f$ is exactly the set of points where $f$ is not \'etale (equivalently not unramified). \end{lemma} 
\begin{lemma} \label{lemma-norm-different-is-discriminant} Let $f : Y \to X$ be a flat quasi-finite morphism of Noetherian schemes. Let $R \subset Y$ be the closed subscheme defined by $\mathfrak{D}_f$. \begin{enumerate} \item If $\omega_{Y/X}$ is invertible, then $R$ is a locally principal closed subscheme of $Y$. \item If $\omega_{Y/X}$ is invertible and $f$ is finite, then the norm of $R$ is the discriminant $D_f$ of $f$. \item If $\omega_{Y/X}$ is invertible and $f$ is \'etale at the associated points of $Y$, then $R$ is an effective Cartier divisor and there is an isomorphism $\mathcal{O}_Y(R) = \omega_{Y/X}$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-syntomic-quasi-finite} Let $f : Y \to X$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item $f$ is locally quasi-finite and syntomic, \item $f$ is locally quasi-finite, flat, and a local complete intersection morphism, \item $f$ is locally quasi-finite, flat, locally of finite presentation, and the fibres of $f$ are local complete intersections, \item $f$ is locally quasi-finite and for every $y \in Y$ there are affine opens $y \in V = \Spec(B) \subset Y$, $U = \Spec(A) \subset X$ with $f(V) \subset U$ an integer $n$ and $h, f_1, \ldots, f_n \in A[x_1, \ldots, x_n]$ such that $B = A[x_1, \ldots, x_n, 1/h]/(f_1, \ldots, f_n)$, \item for every $y \in Y$ there are affine opens $y \in V = \Spec(B) \subset Y$, $U = \Spec(A) \subset X$ with $f(V) \subset U$ such that $A \to B$ is a relative global complete intersection of the form $B = A[x_1, \ldots, x_n]/(f_1, \ldots, f_n)$, \item $f$ is locally quasi-finite, flat, locally of finite presentation, and $\NL_{X/Y}$ has tor-amplitude in $[-1, 0]$, and \item $f$ is flat, locally of finite presentation, $\NL_{X/Y}$ is perfect of rank $0$ with tor-amplitude in $[-1, 0]$, \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-characterize-invertible} Invertibility of the relative dualizing module. \begin{enumerate} \item If $A \to B$ is a quasi-finite flat homomorphism of Noetherian rings, then $\omega_{B/A}$ is an invertible $B$-module if and only if $\omega_{B \otimes_A \kappa(\mathfrak p)/\kappa(\mathfrak p)}$ is an invertible $B \otimes_A \kappa(\mathfrak p)$-module for all primes $\mathfrak p \subset A$. \item If $Y \to X$ is a quasi-finite flat morphism of Noetherian schemes, then $\omega_{Y/X}$ is invertible if and only if $\omega_{Y_x/x}$ is invertible for all $x \in X$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-dim-zero-global-complete-intersection-over-field} Let $k$ be a field. Let $B = k[x_1, \ldots, x_n]/(f_1, \ldots, f_n)$ be a global complete intersection over $k$ of dimension $0$. Then $\omega_{B/k}$ is invertible. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-syntomic-quasi-finite} Let $f : Y \to X$ be a morphism of locally Noetherian schemes. If $f$ satisfies the equivalent conditions of Lemma \ref{lemma-syntomic-quasi-finite} then $\omega_{Y/X}$ is an invertible $\mathcal{O}_Y$-module. \end{lemma} 
\begin{lemma} \label{lemma-universal-quasi-finite-syntomic-etale} With notation as in Example \ref{example-universal-quasi-finite-syntomic} the schemes $X_{n, d}$ and $Y_{n, d}$ are regular and irreducible, the morphism $Y_{n, d} \to X_{n, d}$ is locally quasi-finite and syntomic, and there is a dense open subscheme $V \subset Y_{n, d}$ such that $Y_{n, d} \to X_{n, d}$ restricts to an \'etale morphism $V \to X_{n, d}$. \end{lemma} 
\begin{lemma} \label{lemma-locally-comes-from-universal} Let $f : Y \to X$ be a morphism of schemes. If $f$ satisfies the equivalent conditions of Lemma \ref{lemma-syntomic-quasi-finite} then for every $y \in Y$ there exist $n, d$ and a commutative diagram $$ \xymatrix{ Y \ar[d] & V \ar[d] \ar[l] \ar[r] & Y_{n, d} \ar[d] \\ X & U \ar[l] \ar[r] & X_{n, d} } $$ where $U \subset X$ and $V \subset Y$ are open, where $Y_{n, d} \to X_{n, d}$ is as in Example \ref{example-universal-quasi-finite-syntomic}, and where the square on the right hand side is cartesian. \end{lemma} 
\begin{lemma} \label{lemma-syntomic-finite} Let $f : Y \to X$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item $f$ is finite and syntomic, \item $f$ is finite, flat, and a local complete intersection morphism, \item $f$ is finite, flat, locally of finite presentation, and the fibres of $f$ are local complete intersections, \item $f$ is finite and for every $x \in X$ there is an affine open $x \in U = \Spec(A) \subset X$ an integer $n$ and $f_1, \ldots, f_n \in A[x_1, \ldots, x_n]$ such that $f^{-1}(U)$ is isomorphic to the spectrum of $A[x_1, \ldots, x_n]/(f_1, \ldots, f_n)$, \item $f$ is finite, flat, locally of finite presentation, and $\NL_{X/Y}$ has tor-amplitude in $[-1, 0]$, and \item $f$ is finite, flat, locally of finite presentation, and $\NL_{X/Y}$ is perfect of rank $0$ with tor-amplitude in $[-1, 0]$, \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-universal-finite-syntomic} With notation as in Example \ref{example-universal-finite-syntomic} there is an open subscheme $U_d \subset X_d$ with the following property: a morphism of schemes $X \to X_d$ factors through $U_d$ if and only if $Y_d \times_{X_d} X \to X$ is syntomic. \end{lemma} 
\begin{lemma} \label{lemma-universal-finite-syntomic-smooth} With notation as in Example \ref{example-universal-finite-syntomic} and $U_d$ as in Lemma \ref{lemma-universal-finite-syntomic} then $U_d$ is smooth over $\Spec(\mathbf{Z})$. \end{lemma} 
\begin{lemma} \label{lemma-universal-finite-syntomic-etale} With notation as in Example \ref{example-universal-finite-syntomic} consider the open subscheme $U'_d \subset X_d$ over which $\pi_d$ is \'etale. Then $U'_d$ is a dense subset of the open $U_d$ of Lemma \ref{lemma-universal-finite-syntomic}. \end{lemma} 
\begin{lemma} \label{lemma-locally-comes-from-universal-finite} Let $f : Y \to X$ be a morphism of schemes. If $f$ satisfies the equivalent conditions of Lemma \ref{lemma-syntomic-finite} then for every $x \in X$ there exist a $d$ and a commutative diagram $$ \xymatrix{ Y \ar[d] & V \ar[d] \ar[l] \ar[r] & V_d \ar[d] \ar[r] & Y_d \ar[d]^{\pi_d}\\ X & U \ar[l] \ar[r] & U_d \ar[r] & X_d } $$ with the following properties \begin{enumerate} \item $U \subset X$ is open, $x \in U$, and $V = f^{-1}(U)$, \item $\pi_d : Y_d \to X_d$ is as in Example \ref{example-universal-finite-syntomic}, \item $U_d \subset X_d$ is as in Lemma \ref{lemma-universal-finite-syntomic} and $V_d = \pi_d^{-1}(U_d) \subset Y_d$, \item where the middle square is cartesian. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-tate} \begin{reference} \cite[Appendix]{Mazur-Roberts} \end{reference} Let $A \to P$ be a ring map. Let $f_1, \ldots, f_n \in P$ be a Koszul regular sequence. Assume $B = P/(f_1, \ldots, f_n)$ is flat over $A$. Let $g_1, \ldots, g_n \in P \otimes_A B$ be a Koszul regular sequence generating the kernel of the multiplication map $P \otimes_A B \to B$. Write $f_i \otimes 1 = \sum g_{ij} g_j$. Then the annihilator of $\Ker(B \otimes_A B \to B)$ is a principal ideal generated by the image of $\det(g_{ij})$. \end{lemma} 
\begin{lemma} \label{lemma-quasi-finite-complete-intersection} Let $A$ be a ring. Let $n \geq 1$ and $h, f_1, \ldots, f_n \in A[x_1, \ldots, x_n]$. Set $B = A[x_1, \ldots, x_n, 1/h]/(f_1, \ldots, f_n)$. Assume that $B$ is quasi-finite over $A$. Then \begin{enumerate} \item $B$ is flat over $A$ and $A \to B$ is a relative local complete intersection, \item the annihilator $J$ of $I = \Ker(B \otimes_A B \to B)$ is free of rank $1$ over $B$, \item the Noether different of $B$ over $A$ is generated by $\det(\partial f_i/\partial x_j)$ in $B$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-different-syntomic-quasi-finite} Let $f : Y \to X$ be a morphism of Noetherian schemes. If $f$ satisfies the equivalent conditions of Lemma \ref{lemma-syntomic-quasi-finite} then the different $\mathfrak{D}_f$ of $f$ is the K\"ahler different of $f$. \end{lemma} 
\begin{lemma} \label{lemma-different-quasi-finite-complete-intersection} Let $A$ be a ring. Let $n \geq 1$ and $h, f_1, \ldots, f_n \in A[x_1, \ldots, x_n]$. Set $B = A[x_1, \ldots, x_n, 1/h]/(f_1, \ldots, f_n)$. Assume that $B$ is quasi-finite over $A$. Then there is an isomorphism $B \to \omega_{B/A}$ mapping $\det(\partial f_i/\partial x_j)$ to $\tau_{B/A}$. \end{lemma} 
\begin{lemma} \label{lemma-discriminant-quasi-finite-morphism-smooth} Let $S$ be a Noetherian scheme. Let $X$, $Y$ be smooth schemes of relative dimension $n$ over $S$. Let $f : Y \to X$ be a locally quasi-finite morphism over $S$. Then $f$ is flat and the closed subscheme $R \subset Y$ cut out by the different of $f$ is the locally principal closed subscheme cut out by $$ \wedge^n(\text{d}f) \in \Gamma(Y, (f^*\Omega^n_{X/S})^{\otimes -1} \otimes_{\mathcal{O}_Y} \Omega^n_{Y/S}) $$ If $f$ is \'etale at the associated points of $Y$, then $R$ is an effective Cartier divisor and $$ f^*\Omega^n_{X/S} \otimes_{\mathcal{O}_Y} \mathcal{O}(R) = \Omega^n_{Y/S} $$ as invertible sheaves on $Y$. \end{lemma} 
\begin{proposition} \label{proposition-tate-map} There exists a unique rule that to every locally quasi-finite syntomic morphism of locally Noetherian schemes $Y \to X$ assigns an isomorphism $$ c_{Y/X} : \det(\NL_{Y/X}) \longrightarrow \omega_{Y/X} $$ satisfying the following two properties \begin{enumerate} \item the section $\delta(\NL_{Y/X})$ is mapped to $\tau_{Y/X}$, and \item the rule is compatible with restriction to opens and with base change. \end{enumerate} \end{proposition} 
\begin{lemma} \label{lemma-explain-condition} Let $A \to B$ be a map of Noetherian rings. Consider the conditions \begin{enumerate} \item nonzerodivisors of $A$ map to nonzerodivisors of $B$, \item (1) holds and $Q(A) \to Q(A) \otimes_A B$ is flat, \item $A \to B_\mathfrak q$ is flat for every $\mathfrak q \in \text{Ass}(B)$, \item (3) holds and $A \to B_\mathfrak q$ is flat for every $\mathfrak q$ lying over an element in $\text{Ass}(A)$. \end{enumerate} Then we have the following implications $$ \xymatrix{ (1) & (2) \ar@{=>}[l] \ar@{=>}[d] \\ (3) \ar@{=>}[u] & (4) \ar@{=>}[l] } $$ If going up holds for $A \to B$ then (2) and (4) are equivalent. \end{lemma} 
\begin{lemma} \label{lemma-agree-dedekind} Assume the Dedekind different is defined for $A \to B$. Set $X = \Spec(A)$ and $Y = \Spec(B)$. The generalization of Remark \ref{remark-different-generalization} applies to the morphism $f : Y \to X$ if and only if $1 \in \mathcal{L}_{B/A}$ (e.g., if $A$ is normal, see Lemma \ref{lemma-dedekind-different-ideal}). In this case $\mathfrak{D}_{B/A}$ is an ideal of $B$ and we have $$ \mathfrak{D}_f = \widetilde{\mathfrak{D}_{B/A}} $$ as coherent ideal sheaves on $Y$. \end{lemma} 
\begin{lemma} \label{lemma-compare-dualizing} Let $f : Y \to X$ be a quasi-finite separated morphism of Noetherian schemes. For every pair of affine opens $\Spec(B) = V \subset Y$, $\Spec(A) = U \subset X$ with $f(V) \subset U$ there is an isomorphism $$ H^0(V, f^!\mathcal{O}_X) = \omega_{B/A} $$ where $f^!$ is as in Duality for Schemes, Section \ref{duality-section-upper-shriek}. These isomorphisms are compatible with restriction maps and define a canonical isomorphism $H^0(f^!\mathcal{O}_X) = \omega_{Y/X}$ with $\omega_{Y/X}$ as in Remark \ref{remark-relative-dualizing-for-quasi-finite}. Similarly, if $f : Y \to X$ is a quasi-finite morphism of schemes of finite type over a Noetherian base $S$ endowed with a dualizing complex $\omega_S^\bullet$, then $H^0(f_{new}^!\mathcal{O}_X) = \omega_{Y/X}$. \end{lemma} 
\begin{lemma} \label{lemma-compare-trace} Let $f : Y \to X$ be a finite flat morphism of Noetherian schemes. The map $$ \text{Trace}_f : f_*\mathcal{O}_Y \longrightarrow \mathcal{O}_X $$ of Section \ref{section-discriminant} corresponds to a map $\mathcal{O}_Y \to f^!\mathcal{O}_X$ (see proof). Denote $\tau_{Y/X} \in H^0(Y, f^!\mathcal{O}_X)$ the image of $1$. Via the isomorphism $H^0(f^!\mathcal{O}_X) = \omega_{X/Y}$ of Lemma \ref{lemma-compare-dualizing} this agrees with the construction in Remark \ref{remark-relative-dualizing-for-flat-quasi-finite}. \end{lemma} 
\begin{lemma} \label{lemma-gorenstein-quasi-finite} Let $f : Y \to X$ be a quasi-finite morphism of Noetherian schemes. The following are equivalent \begin{enumerate} \item $f$ is Gorenstein, \item $f$ is flat and the fibres of $f$ are Gorenstein, \item $f$ is flat and $\omega_{Y/X}$ is invertible (Remark \ref{remark-relative-dualizing-for-quasi-finite}), \item for every $y \in Y$ there are affine opens $y \in V = \Spec(B) \subset Y$, $U = \Spec(A) \subset X$ with $f(V) \subset U$ such that $A \to B$ is flat and $\omega_{B/A}$ is an invertible $B$-module. \end{enumerate} \end{lemma} 
