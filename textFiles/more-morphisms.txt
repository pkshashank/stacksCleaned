\begin{definition} \label{definition-thickening} Thickenings. \begin{enumerate} \item We say a scheme $X'$ is a {\it thickening} of a scheme $X$ if $X$ is a closed subscheme of $X'$ and the underlying topological spaces are equal. \item We say a scheme $X'$ is a {\it first order thickening} of a scheme $X$ if $X$ is a closed subscheme of $X'$ and the quasi-coherent sheaf of ideals $\mathcal{I} \subset \mathcal{O}_{X'}$ defining $X$ has square zero. \item Given two thickenings $X \subset X'$ and $Y \subset Y'$ a {\it morphism of thickenings} is a morphism $f' : X' \to Y'$ such that $f'(X) \subset Y$, i.e., such that $f'|_X$ factors through the closed subscheme $Y$. In this situation we set $f = f'|_X : X \to Y$ and we say that $(f, f') : (X \subset X') \to (Y \subset Y')$ is a morphism of thickenings. \item Let $S$ be a scheme. We similarly define {\it thickenings over $S$}, and {\it morphisms of thickenings over $S$}. This means that the schemes $X, X', Y, Y'$ above are schemes over $S$, and that the morphisms $X \to X'$, $Y \to Y'$ and $f' : X' \to Y'$ are morphisms over $S$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-first-order-thickening} Let $X$ be a scheme over a base $S$. Consider a short exact sequence $$ 0 \to \mathcal{I} \to \mathcal{A} \to \mathcal{O}_X \to 0 $$ of sheaves on $X$ where $\mathcal{A}$ is a sheaf of $f^{-1}\mathcal{O}_S$-algebras, $\mathcal{A} \to \mathcal{O}_X$ is a surjection of sheaves of $f^{-1}\mathcal{O}_S$-algebras, and $\mathcal{I}$ is its kernel. If \begin{enumerate} \item $\mathcal{I}$ is an ideal of square zero in $\mathcal{A}$, and \item $\mathcal{I}$ is quasi-coherent as an $\mathcal{O}_X$-module \end{enumerate} then $X' = (X, \mathcal{A})$ is a scheme and $X \to X'$ is a first order thickening over $S$. Moreover, any first order thickening over $S$ is of this form. \end{lemma} 
\begin{lemma} \label{lemma-thickening-affine-scheme} \begin{slogan} Affineness is insensitive to thickenings \end{slogan} \begin{reference} The case of a finite order thickening is \cite[Proposition 5.1.9]{EGA1}. \end{reference} Any thickening of an affine scheme is affine. \end{lemma} 
\begin{lemma} \label{lemma-base-change-thickening} Let $S \subset S'$ be a thickening of schemes. Let $X' \to S'$ be a morphism and set $X = S \times_{S'} X'$. Then $(X \subset X') \to (S \subset S')$ is a morphism of thickenings. If $S \subset S'$ is a first (resp.\ finite order) thickening, then $X \subset X'$ is a first (resp.\ finite order) thickening. \end{lemma} 
\begin{lemma} \label{lemma-composition-thickening} \begin{slogan} Compositions of thickenings are thickenings \end{slogan} If $S \subset S'$ and $S' \subset S''$ are thickenings, then so is $S \subset S''$. \end{lemma} 
\begin{lemma} \label{lemma-descending-property-thickening} The property of being a thickening is fpqc local. Similarly for first order thickenings. \end{lemma} 
\begin{lemma} \label{lemma-thicken-property-morphisms} Let $(f, f') : (X \subset X') \to (S \subset S')$ be a morphism of thickenings. Then \begin{enumerate} \item $f$ is an affine morphism if and only if $f'$ is an affine morphism, \item $f$ is a surjective morphism if and only if $f'$ is a surjective morphism, \item $f$ is quasi-compact if and only if $f'$ quasi-compact, \item $f$ is universally closed if and only if $f'$ is universally closed, \item $f$ is integral if and only if $f'$ is integral, \item $f$ is (quasi-)separated if and only if $f'$ is (quasi-)separated, \item $f$ is universally injective if and only if $f'$ is universally injective, \item $f$ is universally open if and only if $f'$ is universally open, \item $f$ is quasi-affine if and only if $f'$ is quasi-affine, and \item add more here. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-thicken-property-relatively-ample} Let $(f, f') : (X \subset X') \to (S \subset S')$ be a morphism of thickenings. Let $\mathcal{L}'$ be an invertible sheaf on $X'$ and denote $\mathcal{L}$ the restriction to $X$. Then $\mathcal{L}'$ is $f'$-ample if and only if $\mathcal{L}$ is $f$-ample. \end{lemma} 
\begin{lemma} \label{lemma-thicken-property-morphisms-cartesian} Let $(f, f') : (X \subset X') \to (S \subset S')$ be a morphism of thickenings such that $X = S \times_{S'} X'$. If $S \subset S'$ is a finite order thickening, then \begin{enumerate} \item $f$ is a closed immersion if and only if $f'$ is a closed immersion, \item $f$ is locally of finite type if and only if $f'$ is locally of finite type, \item $f$ is locally quasi-finite if and only if $f'$ is locally quasi-finite, \item $f$ is locally of finite type of relative dimension $d$ if and only if $f'$ is locally of finite type of relative dimension $d$, \item $\Omega_{X/S} = 0$ if and only if $\Omega_{X'/S'} = 0$, \item $f$ is unramified if and only if $f'$ is unramified, \item $f$ is proper if and only if $f'$ is proper, \item $f$ is finite if and only if $f'$ is finite, \item $f$ is a monomorphism if and only if $f'$ is a monomorphism, \item $f$ is an immersion if and only if $f'$ is an immersion, and \item add more here. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-properties-that-extend-over-thickenings} Let $(f, f') : (X \subset X') \to (Y \to Y')$ be a morphism of thickenings. Assume $f$ and $f'$ are locally of finite type and $X = Y \times_{Y'} X'$. Then \begin{enumerate} \item $f$ is locally quasi-finite if and only if $f'$ is locally quasi-finite, \item $f$ is finite if and only if $f'$ is finite, \item $f$ is a closed immersion if and only if $f'$ is a closed immersion, \item $\Omega_{X/Y} = 0$ if and only if $\Omega_{X'/Y'} = 0$, \item $f$ is unramified if and only if $f'$ is unramified, \item $f$ is a monomorphism if and only if $f'$ is a monomorphism, \item $f$ is an immersion if and only if $f'$ is an immersion, \item $f$ is proper if and only if $f'$ is proper, and \item add more here. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-picard-group-first-order-thickening} Let $X \subset X'$ be a first order thickening with ideal sheaf $\mathcal{I}$. Then there is a canonical exact sequence $$ \xymatrix{ 0 \ar[r] & H^0(X, \mathcal{I}) \ar[r] & H^0(X', \mathcal{O}_{X'}^*) \ar[r] & H^0(X, \mathcal{O}^*_X) \ar `r[d] `d[l] `l[llld] `d[dll] [dll] \\ & H^1(X, \mathcal{I}) \ar[r] & \Pic(X') \ar[r] & \Pic(X) \ar `r[d] `d[l] `l[llld] `d[dll] [dll] \\ & H^2(X, \mathcal{I}) \ar[r] & \ldots \ar[r] & \ldots } $$ of abelian groups. \end{lemma} 
\begin{lemma} \label{lemma-torsion-pic-thickening} Let $X \subset X'$ be a thickening. Let $n$ be an integer invertible in $\mathcal{O}_X$. Then the map $\Pic(X')[n] \to \Pic(X)[n]$ is bijective. \end{lemma} 
\begin{definition} \label{definition-first-order-infinitesimal-neighbourhood} Let $i : Z \to X$ be an immersion of schemes. The {\it first order infinitesimal neighbourhood} of $Z$ in $X$ is the first order thickening $Z \subset Z'$ over $X$ described above. \end{definition} 
\begin{lemma} \label{lemma-first-order-infinitesimal-neighbourhood} Let $i : Z \to X$ be an immersion of schemes. The first order infinitesimal neighbourhood $Z'$ of $Z$ in $X$ has the following universal property: Given any commutative diagram $$ \xymatrix{ Z \ar[d]_i & T \ar[l]^a \ar[d] \\ X & T' \ar[l]_b } $$ where $T \subset T'$ is a first order thickening over $X$, there exists a unique morphism $(a', a) : (T \subset T') \to (Z \subset Z')$ of thickenings over $X$. \end{lemma} 
\begin{lemma} \label{lemma-infinitesimal-neighbourhood-conormal} Let $i : Z \to X$ be an immersion of schemes. Let $Z \subset Z'$ be the first order infinitesimal neighbourhood of $Z$ in $X$. Then the diagram $$ \xymatrix{ Z \ar[r] \ar[d] & Z' \ar[d] \\ Z \ar[r] & X } $$ induces a map of conormal sheaves $\mathcal{C}_{Z/X} \to \mathcal{C}_{Z/Z'}$ by Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial}. This map is an isomorphism. \end{lemma} 
\begin{definition} \label{definition-formally-unramified} Let $f : X \to S$ be a morphism of schemes. We say $f$ is {\it formally unramified} if given any solid commutative diagram $$ \xymatrix{ X \ar[d]_f & T \ar[d]^i \ar[l] \\ S & T' \ar[l] \ar@{-->}[lu] } $$ where $T \subset T'$ is a first order thickening of affine schemes over $S$ there exists at most one dotted arrow making the diagram commute. \end{definition} 
\begin{lemma} \label{lemma-formally-unramified-not-affine} If $f : X \to S$ is a formally unramified morphism, then given any solid commutative diagram $$ \xymatrix{ X \ar[d]_f & T \ar[d]^i \ar[l] \\ S & T' \ar[l] \ar@{-->}[lu] } $$ where $T \subset T'$ is a first order thickening of schemes over $S$ there exists at most one dotted arrow making the diagram commute. In other words, in Definition \ref{definition-formally-unramified} the condition that $T$ be affine may be dropped. \end{lemma} 
\begin{lemma} \label{lemma-composition-formally-unramified} A composition of formally unramified morphisms is formally unramified. \end{lemma} 
\begin{lemma} \label{lemma-base-change-formally-unramified} A base change of a formally unramified morphism is formally unramified. \end{lemma} 
\begin{lemma} \label{lemma-formally-unramified-on-opens} Let $f : X \to S$ be a morphism of schemes. Let $U \subset X$ and $V \subset S$ be open such that $f(U) \subset V$. If $f$ is formally unramified, so is $f|_U : U \to V$. \end{lemma} 
\begin{lemma} \label{lemma-affine-formally-unramified} Let $f : X \to S$ be a morphism of schemes. Assume $X$ and $S$ are affine. Then $f$ is formally unramified if and only if $\mathcal{O}_S(S) \to \mathcal{O}_X(X)$ is a formally unramified ring map. \end{lemma} 
\begin{lemma} \label{lemma-formally-unramified-differentials} Let $f : X \to S$ be a morphism of schemes. Then $f$ is formally unramified if and only if $\Omega_{X/S} = 0$. \end{lemma} 
\begin{lemma} \label{lemma-unramified-formally-unramified} \begin{slogan} Unramified morphisms are the same as formally unramified morphism that are locally of finite type. \end{slogan} Let $f : X \to S$ be a morphism of schemes. The following are equivalent: \begin{enumerate} \item The morphism $f$ is unramified (resp.\ G-unramified), and \item the morphism $f$ is locally of finite type (resp.\ locally of finite presentation) and formally unramified. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-universal-thickening} Let $h : Z \to X$ be a formally unramified morphism of schemes. There exists a universal first order thickening $Z \subset Z'$ of $Z$ over $X$. \end{lemma} 
\begin{definition} \label{definition-universal-thickening} Let $h : Z \to X$ be a formally unramified morphism of schemes. \begin{enumerate} \item The {\it universal first order thickening} of $Z$ over $X$ is the thickening $Z \subset Z'$ constructed in Lemma \ref{lemma-universal-thickening}. \item The {\it conormal sheaf of $Z$ over $X$} is the conormal sheaf of $Z$ in its universal first order thickening $Z'$ over $X$. \end{enumerate} We often denote the conormal sheaf $\mathcal{C}_{Z/X}$ in this situation. \end{definition} 
\begin{lemma} \label{lemma-immersion-universal-thickening} Let $i : Z \to X$ be an immersion of schemes. Then \begin{enumerate} \item $i$ is formally unramified, \item the universal first order thickening of $Z$ over $X$ is the first order infinitesimal neighbourhood of $Z$ in $X$ of Definition \ref{definition-first-order-infinitesimal-neighbourhood}, and \item the conormal sheaf of $i$ in the sense of Morphisms, Definition \ref{morphisms-definition-conormal-sheaf} agrees with the conormal sheaf of $i$ in the sense of Definition \ref{definition-universal-thickening}. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-universal-thickening-unramified} Let $Z \to X$ be a formally unramified morphism of schemes. Then the universal first order thickening $Z'$ is formally unramified over $X$. \end{lemma} 
\begin{lemma} \label{lemma-universal-thickening-functorial} Consider a commutative diagram of schemes $$ \xymatrix{ Z \ar[r]_h \ar[d]_f & X \ar[d]^g \\ W \ar[r]^{h'} & Y } $$ with $h$ and $h'$ formally unramified. Let $Z \subset Z'$ be the universal first order thickening of $Z$ over $X$. Let $W \subset W'$ be the universal first order thickening of $W$ over $Y$. There exists a canonical morphism $(f, f') : (Z, Z') \to (W, W')$ of thickenings over $Y$ which fits into the following commutative diagram $$ \xymatrix{ & & & Z' \ar[ld] \ar[d]^{f'} \\ Z \ar[rr] \ar[d]_f \ar[rrru] & & X \ar[d] & W' \ar[ld] \\ W \ar[rrru]|!{[rr];[rruu]}\hole \ar[rr] & & Y } $$ In particular the morphism $(f, f')$ of thickenings induces a morphism of conormal sheaves $f^*\mathcal{C}_{W/Y} \to \mathcal{C}_{Z/X}$. \end{lemma} 
\begin{lemma} \label{lemma-universal-thickening-fibre-product} Let $$ \xymatrix{ Z \ar[r]_h \ar[d]_f & X \ar[d]^g \\ W \ar[r]^{h'} & Y } $$ be a fibre product diagram in the category of schemes with $h'$ formally unramified. Then $h$ is formally unramified and if $W \subset W'$ is the universal first order thickening of $W$ over $Y$, then $Z = X \times_Y W \subset X \times_Y W'$ is the universal first order thickening of $Z$ over $X$. In particular the canonical map $f^*\mathcal{C}_{W/Y} \to \mathcal{C}_{Z/X}$ of Lemma \ref{lemma-universal-thickening-functorial} is surjective. \end{lemma} 
\begin{lemma} \label{lemma-universal-thickening-fibre-product-flat} Let $$ \xymatrix{ Z \ar[r]_h \ar[d]_f & X \ar[d]^g \\ W \ar[r]^{h'} & Y } $$ be a fibre product diagram in the category of schemes with $h'$ formally unramified and $g$ flat. In this case the corresponding map $Z' \to W'$ of universal first order thickenings is flat, and $f^*\mathcal{C}_{W/Y} \to \mathcal{C}_{Z/X}$ is an isomorphism. \end{lemma} 
\begin{lemma} \label{lemma-universal-thickening-localize} Taking the universal first order thickenings commutes with taking opens. More precisely, let $h : Z \to X$ be a formally unramified morphism of schemes. Let $V \subset Z$, $U \subset X$ be opens such that $h(V) \subset U$. Let $Z'$ be the universal first order thickening of $Z$ over $X$. Then $h|_V : V \to U$ is formally unramified and the universal first order thickening of $V$ over $U$ is the open subscheme $V' \subset Z'$ such that $V = Z \cap V'$. In particular, $\mathcal{C}_{Z/X}|_V = \mathcal{C}_{V/U}$. \end{lemma} 
\begin{lemma} \label{lemma-differentials-universally-unramified} Let $h : Z \to X$ be a formally unramified morphism of schemes over $S$. Let $Z \subset Z'$ be the universal first order thickening of $Z$ over $X$ with structure morphism $h' : Z' \to X$. The canonical map $$ c_{h'} : (h')^*\Omega_{X/S} \longrightarrow \Omega_{Z'/S} $$ induces an isomorphism $h^*\Omega_{X/S} \to \Omega_{Z'/S} \otimes \mathcal{O}_Z$. \end{lemma} 
\begin{lemma} \label{lemma-universally-unramified-differentials-sequence} Let $h : Z \to X$ be a formally unramified morphism of schemes over $S$. There is a canonical exact sequence $$ \mathcal{C}_{Z/X} \to h^*\Omega_{X/S} \to \Omega_{Z/S} \to 0. $$ The first arrow is induced by $\text{d}_{Z'/S}$ where $Z'$ is the universal first order neighbourhood of $Z$ over $X$. \end{lemma} 
\begin{lemma} \label{lemma-two-unramified-morphisms} Let $$ \xymatrix{ Z \ar[r]_i \ar[rd]_j & X \ar[d] \\ & Y } $$ be a commutative diagram of schemes where $i$ and $j$ are formally unramified. Then there is a canonical exact sequence $$ \mathcal{C}_{Z/Y} \to \mathcal{C}_{Z/X} \to i^*\Omega_{X/Y} \to 0 $$ where the first arrow comes from Lemma \ref{lemma-universal-thickening-functorial} and the second from Lemma \ref{lemma-universally-unramified-differentials-sequence}. \end{lemma} 
\begin{lemma} \label{lemma-transitivity-conormal} Let $Z \to Y \to X$ be formally unramified morphisms of schemes. \begin{enumerate} \item If $Z \subset Z'$ is the universal first order thickening of $Z$ over $X$ and $Y \subset Y'$ is the universal first order thickening of $Y$ over $X$, then there is a morphism $Z' \to Y'$ and $Y \times_{Y'} Z'$ is the universal first order thickening of $Z$ over $Y$. \item There is a canonical exact sequence $$ i^*\mathcal{C}_{Y/X} \to \mathcal{C}_{Z/X} \to \mathcal{C}_{Z/Y} \to 0 $$ where the maps come from Lemma \ref{lemma-universal-thickening-functorial} and $i : Z \to Y$ is the first morphism. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-formally-etale} Let $f : X \to S$ be a morphism of schemes. We say $f$ is {\it formally \'etale} if given any solid commutative diagram $$ \xymatrix{ X \ar[d]_f & T \ar[d]^i \ar[l] \\ S & T' \ar[l] \ar@{-->}[lu] } $$ where $T \subset T'$ is a first order thickening of affine schemes over $S$ there exists exactly one dotted arrow making the diagram commute. \end{definition} 
\begin{lemma} \label{lemma-formally-etale-not-affine} If $f : X \to S$ is a formally \'etale morphism, then given any solid commutative diagram $$ \xymatrix{ X \ar[d]_f & T \ar[d]^i \ar[l] \\ S & T' \ar[l] \ar@{-->}[lu] } $$ where $T \subset T'$ is a first order thickening of schemes over $S$ there exists exactly one dotted arrow making the diagram commute. In other words, in Definition \ref{definition-formally-etale} the condition that $T$ be affine may be dropped. \end{lemma} 
\begin{lemma} \label{lemma-composition-formally-etale} A composition of formally \'etale morphisms is formally \'etale. \end{lemma} 
\begin{lemma} \label{lemma-base-change-formally-etale} A base change of a formally \'etale morphism is formally \'etale. \end{lemma} 
\begin{lemma} \label{lemma-formally-etale-on-opens} Let $f : X \to S$ be a morphism of schemes. Let $U \subset X$ and $V \subset S$ be open subschemes such that $f(U) \subset V$. If $f$ is formally \'etale, so is $f|_U : U \to V$. \end{lemma} 
\begin{lemma} \label{lemma-characterize-formally-etale} Let $f : X \to S$ be a morphism of schemes. The following are equivalent: \begin{enumerate} \item $f$ is formally \'etale, \item $f$ is formally unramified and the universal first order thickening of $X$ over $S$ is equal to $X$, \item $f$ is formally unramified and $\mathcal{C}_{X/S} = 0$, and \item $\Omega_{X/S} = 0$ and $\mathcal{C}_{X/S} = 0$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-unramified-flat-formally-etale} An unramified flat morphism is formally \'etale. \end{lemma} 
\begin{lemma} \label{lemma-affine-formally-etale} Let $f : X \to S$ be a morphism of schemes. Assume $X$ and $S$ are affine. Then $f$ is formally \'etale if and only if $\mathcal{O}_S(S) \to \mathcal{O}_X(X)$ is a formally \'etale ring map. \end{lemma} 
\begin{lemma} \label{lemma-etale-formally-etale} Let $f : X \to S$ be a morphism of schemes. The following are equivalent: \begin{enumerate} \item The morphism $f$ is \'etale, and \item the morphism $f$ is locally of finite presentation and formally \'etale. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-difference-derivation} Let $S$ be a scheme. Let $X \subset X'$ and $Y \subset Y'$ be two first order thickenings over $S$. Let $(a, a'), (b, b') : (X \subset X') \to (Y \subset Y')$ be two morphisms of thickenings over $S$. Assume that \begin{enumerate} \item $a = b$, and \item the two maps $a^*\mathcal{C}_{Y/Y'} \to \mathcal{C}_{X/X'}$ (Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial}) are equal. \end{enumerate} Then the map $(a')^\sharp - (b')^\sharp$ factors as $$ \mathcal{O}_{Y'} \to \mathcal{O}_Y \xrightarrow{D} a_*\mathcal{C}_{X/X'} \to a_*\mathcal{O}_{X'} $$ where $D$ is an $\mathcal{O}_S$-derivation. \end{lemma} 
\begin{lemma} \label{lemma-action-by-derivations} Let $S$ be a scheme. Let $(a, a') : (X \subset X') \to (Y \subset Y')$ be a morphism of first order thickenings over $S$. Let $$ \theta : a^*\Omega_{Y/S} \to \mathcal{C}_{X/X'} $$ be an $\mathcal{O}_X$-linear map. Then there exists a unique morphism of pairs $(b, b') : (X \subset X') \to (Y \subset Y')$ such that (1) and (2) of Lemma \ref{lemma-difference-derivation} hold and the derivation $D$ and $\theta$ are related by Equation (\ref{equation-D}). \end{lemma} 
\begin{lemma} \label{lemma-sheaf} Let $S$ be a scheme. Let $X \subset X'$ and $Y \subset Y'$ be first order thickenings over $S$. Assume given a morphism $a : X \to Y$ and a map $A : a^*\mathcal{C}_{Y/Y'} \to \mathcal{C}_{X/X'}$ of $\mathcal{O}_X$-modules. For an open subscheme $U' \subset X'$ consider morphisms $a' : U' \to Y'$ such that \begin{enumerate} \item $a'$ is a morphism over $S$, \item $a'|_U = a|_U$, and \item the induced map $a^*\mathcal{C}_{Y/Y'}|_U \to \mathcal{C}_{X/X'}|_U$ is the restriction of $A$ to $U$. \end{enumerate} Here $U = X \cap U'$. Then the rule \begin{equation} \label{equation-sheaf} U' \mapsto \{a' : U' \to Y'\text{ such that (1), (2), (3) hold.}\} \end{equation} defines a sheaf of sets on $X'$. \end{lemma} 
\begin{lemma} \label{lemma-action-sheaf} Same notation and assumptions as in Lemma \ref{lemma-sheaf}. There is an action of the sheaf $$ \SheafHom_{\mathcal{O}_X}(a^*\Omega_{Y/S}, \mathcal{C}_{X/X'}) $$ on the sheaf (\ref{equation-sheaf}). Moreover, the action is simply transitive for any open $U' \subset X'$ over which the sheaf (\ref{equation-sheaf}) has a section. \end{lemma} 
\begin{lemma} \label{lemma-omega-deformation} Let $S$ be a scheme. Let $X \subset X'$ be a first order thickening over $S$. Let $Y$ be a scheme over $S$. Let $a', b' : X' \to Y$ be two morphisms over $S$ with $a = a'|_X = b'|_X$. This gives rise to a commutative diagram $$ \xymatrix{ X \ar[r] \ar[d]_a & X' \ar[d]^{(b', a')} \\ Y \ar[r]^-{\Delta_{Y/S}} & Y \times_S Y } $$ Since the horizontal arrows are immersions with conormal sheaves $\mathcal{C}_{X/X'}$ and $\Omega_{Y/S}$, by Morphisms, Lemma \ref{morphisms-lemma-conormal-functorial}, we obtain a map $\theta : a^*\Omega_{Y/S} \to \mathcal{C}_{X/X'}$. Then this $\theta$ and the derivation $D$ of Lemma \ref{lemma-difference-derivation} are related by Equation (\ref{equation-D}). \end{lemma} 
\begin{lemma} \label{lemma-sheaf-differentials-etale-localization} Let $$ \xymatrix{ X_1 \ar[d] & X_2 \ar[l]^f \ar[d] \\ S_1 & S_2 \ar[l] } $$ be a commutative diagram of schemes with $X_2 \to X_1$ and $S_2 \to S_1$ \'etale. Then the map $c_f : f^*\Omega_{X_1/S_1} \to \Omega_{X_2/S_2}$ of Morphisms, Lemma \ref{morphisms-lemma-functoriality-differentials} is an isomorphism. \end{lemma} 
\begin{lemma} \label{lemma-action-by-derivations-etale-localization} Consider a commutative diagram of first order thickenings $$ \vcenter{ \xymatrix{ (T_2 \subset T_2') \ar[d]_{(h, h')} \ar[rr]_{(a_2, a_2')} & & (X_2 \subset X_2') \ar[d]^{(f, f')} \\ (T_1 \subset T_1') \ar[rr]^{(a_1, a_1')} & & (X_1 \subset X_1') } } \quad \begin{matrix} \text{and a commutative} \\ \text{diagram of schemes} \end{matrix} \quad \vcenter{ \xymatrix{ X_2' \ar[r] \ar[d] & S_2 \ar[d] \\ X_1' \ar[r] & S_1 } } $$ with $X_2 \to X_1$ and $S_2 \to S_1$ \'etale. For any $\mathcal{O}_{T_1}$-linear map $\theta_1 : a_1^*\Omega_{X_1/S_1} \to \mathcal{C}_{T_1/T'_1}$ let $\theta_2$ be the composition $$ \xymatrix{ a_2^*\Omega_{X_2/S_2} \ar@{=}[r] & h^*a_1^*\Omega_{X_1/S_1} \ar[r]^-{h^*\theta_1} & h^*\mathcal{C}_{T_1/T'_1} \ar[r] & \mathcal{C}_{T_2/T'_2} } $$ (equality sign is explained in the proof). Then the diagram $$ \xymatrix{ T_2' \ar[rr]_{\theta_2 \cdot a_2'} \ar[d] & & X'_2 \ar[d] \\ T_1' \ar[rr]^{\theta_1 \cdot a_1'} & & X'_1 } $$ commutes where the actions $\theta_2 \cdot a_2'$ and $\theta_1 \cdot a_1'$ are as in Remark \ref{remark-action-by-derivations}. \end{lemma} 
\begin{lemma} \label{lemma-deform} Let $(f, f') : (X \subset X') \to (S \subset S')$ be a morphism of first order thickenings. Assume that $f$ is flat. Then the following are equivalent \begin{enumerate} \item $f'$ is flat and $X = S \times_{S'} X'$, and \item the canonical map $f^*\mathcal{C}_{S/S'} \to \mathcal{C}_{X/X'}$ is an isomorphism. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-flatness-morphism-thickenings} Consider a commutative diagram $$ \xymatrix{ (X \subset X') \ar[rr]_{(f, f')} \ar[rd] & & (Y \subset Y') \ar[ld] \\ & (S \subset S') } $$ of thickenings. Assume \begin{enumerate} \item $X'$ is flat over $S'$, \item $f$ is flat, \item $S \subset S'$ is a finite order thickening, and \item $X = S \times_{S'} X'$ and $Y = S \times_{S'} Y'$. \end{enumerate} Then $f'$ is flat and $Y'$ is flat over $S'$ at all points in the image of $f'$. \end{lemma} 
\begin{lemma} \label{lemma-deform-property} Consider a commutative diagram $$ \xymatrix{ (X \subset X') \ar[rr]_{(f, f')} \ar[rd] & & (Y \subset Y') \ar[ld] \\ & (S \subset S') } $$ of thickenings. Assume $S \subset S'$ is a finite order thickening, $X'$ flat over $S'$, $X = S \times_{S'} X'$, and $Y = S \times_{S'} Y'$. Then \begin{enumerate} \item $f$ is flat if and only if $f'$ is flat, \label{item-flat} \item $f$ is an isomorphism if and only if $f'$ is an isomorphism, \label{item-isomorphism} \item $f$ is an open immersion if and only if $f'$ is an open immersion, \label{item-open-immersion} \item $f$ is quasi-compact if and only if $f'$ is quasi-compact, \label{item-quasi-compact} \item $f$ is universally closed if and only if $f'$ is universally closed, \label{item-universally-closed} \item $f$ is (quasi-)separated if and only if $f'$ is (quasi-)separated, \label{item-separated} \item $f$ is a monomorphism if and only if $f'$ is a monomorphism, \label{item-monomorphism} \item $f$ is surjective if and only if $f'$ is surjective, \label{item-surjective} \item $f$ is universally injective if and only if $f'$ is universally injective, \label{item-universally-injective} \item $f$ is affine if and only if $f'$ is affine, \label{item-affine} \item \label{item-finite-type} $f$ is locally of finite type if and only if $f'$ is locally of finite type, \item $f$ is locally quasi-finite if and only if $f'$ is locally quasi-finite, \label{item-quasi-finite} \item \label{item-finite-presentation} $f$ is locally of finite presentation if and only if $f'$ is locally of finite presentation, \item \label{item-relative-dimension-d} $f$ is locally of finite type of relative dimension $d$ if and only if $f'$ is locally of finite type of relative dimension $d$, \item $f$ is universally open if and only if $f'$ is universally open, \label{item-universally-open} \item $f$ is syntomic if and only if $f'$ is syntomic, \label{item-syntomic} \item $f$ is smooth if and only if $f'$ is smooth, \label{item-smooth} \item $f$ is unramified if and only if $f'$ is unramified, \label{item-unramified} \item $f$ is \'etale if and only if $f'$ is \'etale, \label{item-etale} \item $f$ is proper if and only if $f'$ is proper, \label{item-proper} \item $f$ is integral if and only if $f'$ is integral, \label{item-integral} \item $f$ is finite if and only if $f'$ is finite, \label{item-finite} \item \label{item-finite-locally-free} $f$ is finite locally free (of rank $d$) if and only if $f'$ is finite locally free (of rank $d$), and \item add more here. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-flatness-morphism-thickenings-fp-over-ft} Consider a commutative diagram $$ \xymatrix{ (X \subset X') \ar[rr]_{(f, f')} \ar[rd] & & (Y \subset Y') \ar[ld] \\ & (S \subset S') } $$ of thickenings. Assume \begin{enumerate} \item $Y' \to S'$ is locally of finite type, \item $X' \to S'$ is flat and locally of finite presentation, \item $f$ is flat, and \item $X = S \times_{S'} X'$ and $Y = S \times_{S'} Y'$. \end{enumerate} Then $f'$ is flat and for all $y' \in Y'$ in the image of $f'$ the local ring $\mathcal{O}_{Y', y'}$ is flat and essentially of finite presentation over $\mathcal{O}_{S', s'}$. \end{lemma} 
\begin{lemma} \label{lemma-deform-property-fp-over-ft} Consider a commutative diagram $$ \xymatrix{ (X \subset X') \ar[rr]_{(f, f')} \ar[rd] & & (Y \subset Y') \ar[ld] \\ & (S \subset S') } $$ of thickenings. Assume $Y' \to S'$ locally of finite type, $X' \to S'$ flat and locally of finite presentation, $X = S \times_{S'} X'$, and $Y = S \times_{S'} Y'$. Then \begin{enumerate} \item $f$ is flat if and only if $f'$ is flat, \label{item-flat-fp-over-ft} \item $f$ is an isomorphism if and only if $f'$ is an isomorphism, \label{item-isomorphism-fp-over-ft} \item $f$ is an open immersion if and only if $f'$ is an open immersion, \label{item-open-immersion-fp-over-ft} \item $f$ is quasi-compact if and only if $f'$ is quasi-compact, \label{item-quasi-compact-fp-over-ft} \item $f$ is universally closed if and only if $f'$ is universally closed, \label{item-universally-closed-fp-over-ft} \item $f$ is (quasi-)separated if and only if $f'$ is (quasi-)separated, \label{item-separated-fp-over-ft} \item $f$ is a monomorphism if and only if $f'$ is a monomorphism, \label{item-monomorphism-fp-over-ft} \item $f$ is surjective if and only if $f'$ is surjective, \label{item-surjective-fp-over-ft} \item $f$ is universally injective if and only if $f'$ is universally injective, \label{item-universally-injective-fp-over-ft} \item $f$ is affine if and only if $f'$ is affine, \label{item-affine-fp-over-ft} \item $f$ is locally quasi-finite if and only if $f'$ is locally quasi-finite, \label{item-quasi-finite-fp-over-ft} \item \label{item-relative-dimension-d-fp-over-ft} $f$ is locally of finite type of relative dimension $d$ if and only if $f'$ is locally of finite type of relative dimension $d$, \item $f$ is universally open if and only if $f'$ is universally open, \label{item-universally-open-fp-over-ft} \item $f$ is syntomic if and only if $f'$ is syntomic, \label{item-syntomic-fp-over-ft} \item $f$ is smooth if and only if $f'$ is smooth, \label{item-smooth-fp-over-ft} \item $f$ is unramified if and only if $f'$ is unramified, \label{item-unramified-fp-over-ft} \item $f$ is \'etale if and only if $f'$ is \'etale, \label{item-etale-fp-over-ft} \item $f$ is proper if and only if $f'$ is proper, \label{item-proper-fp-over-ft} \item $f$ is finite if and only if $f'$ is finite, \label{item-finite-fp-over-ft} \item \label{item-finite-locally-free-fp-over-ft} $f$ is finite locally free (of rank $d$) if and only if $f'$ is finite locally free (of rank $d$), and \item add more here. \end{enumerate} \end{lemma} 
\begin{lemma}[Deformations of projective schemes] \label{lemma-deform-projective} Let $f : X \to S$ be a morphism of schemes which is proper, flat, and of finite presentation. Let $\mathcal{L}$ be $f$-ample. Assume $S$ is quasi-compact. There exists a $d_0 \geq 0$ such that for every cartesian diagram $$ \vcenter{ \xymatrix{ X \ar[r]_{i'} \ar[d]_f & X' \ar[d]^{f'} \\ S \ar[r]^i & S' } } \quad\text{and}\quad \begin{matrix} \text{invertible }\mathcal{O}_{X'}\text{-module}\\ \mathcal{L}'\text{ with }\mathcal{L} \cong (i')^*\mathcal{L}' \end{matrix} $$ where $S \subset S'$ is a thickening and $f'$ is proper, flat, of finite presentation we have \begin{enumerate} \item $R^p(f')_*(\mathcal{L}')^{\otimes d} = 0$ for all $p > 0$ and $d \geq d_0$, \item $\mathcal{A}'_d = (f')_*(\mathcal{L}')^{\otimes d}$ is finite locally free for $d \geq d_0$, \item $\mathcal{A}' = \mathcal{O}_{S'} \oplus \bigoplus_{d \geq d_0} \mathcal{A}'_d$ is a quasi-coherent $\mathcal{O}_{S'}$-algebra of finite presentation, \item there is a canonical isomorphism $r' : X' \to \underline{\text{Proj}}_{S'}(\mathcal{A}')$, and \item there is a canonical isomorphism $\theta' : (r')^*\mathcal{O}_{\underline{\text{Proj}}_{S'}(\mathcal{A}')}(1) \to \mathcal{L}'$. \end{enumerate} The construction of $\mathcal{A}'$, $r'$, $\theta'$ is functorial in the data $(X', S', i, i', f', \mathcal{L}')$. \end{lemma} 
\begin{definition} \label{definition-formally-smooth} Let $f : X \to S$ be a morphism of schemes. We say $f$ is {\it formally smooth} if given any solid commutative diagram $$ \xymatrix{ X \ar[d]_f & T \ar[d]^i \ar[l] \\ S & T' \ar[l] \ar@{-->}[lu] } $$ where $T \subset T'$ is a first order thickening of affine schemes over $S$ there exists a dotted arrow making the diagram commute. \end{definition} 
\begin{lemma} \label{lemma-composition-formally-smooth} A composition of formally smooth morphisms is formally smooth. \end{lemma} 
\begin{lemma} \label{lemma-base-change-formally-smooth} A base change of a formally smooth morphism is formally smooth. \end{lemma} 
\begin{lemma} \label{lemma-formally-etale-unramified-smooth} Let $f : X \to S$ be a morphism of schemes. Then $f$ is formally \'etale if and only if $f$ is formally smooth and formally unramified. \end{lemma} 
\begin{lemma} \label{lemma-formally-smooth-on-opens} Let $f : X \to S$ be a morphism of schemes. Let $U \subset X$ and $V \subset S$ be open subschemes such that $f(U) \subset V$. If $f$ is formally smooth, so is $f|_U : U \to V$. \end{lemma} 
\begin{lemma} \label{lemma-affine-formally-smooth} Let $f : X \to S$ be a morphism of schemes. Assume $X$ and $S$ are affine. Then $f$ is formally smooth if and only if $\mathcal{O}_S(S) \to \mathcal{O}_X(X)$ is a formally smooth ring map. \end{lemma} 
\begin{lemma}[Infinitesimal lifting criterion] \label{lemma-smooth-formally-smooth} Let $f : X \to S$ be a morphism of schemes. The following are equivalent: \begin{enumerate} \item The morphism $f$ is smooth, and \item the morphism $f$ is locally of finite presentation and formally smooth. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-formally-smooth-sheaf-differentials} Let $f : X \to Y$ be a formally smooth morphism of schemes. Then $\Omega_{X/Y}$ is locally projective on $X$. \end{lemma} 
\begin{lemma} \label{lemma-h1-is-zero} Let $T$ be an affine scheme. Let $\mathcal{F}$, $\mathcal{G}$ be quasi-coherent $\mathcal{O}_T$-modules. Consider $\mathcal{H} = \SheafHom_{\mathcal{O}_T}(\mathcal{F}, \mathcal{G})$. If $\mathcal{F}$ is locally projective, then $H^1(T, \mathcal{H}) = 0$. \end{lemma} 
\begin{lemma} \label{lemma-formally-smooth} Let $f : X \to Y$ be a morphism of schemes. The following are equivalent: \begin{enumerate} \item $f$ is formally smooth, \item for every $x \in X$ there exist opens $x \in U \subset X$ and $f(x) \in V \subset Y$ with $f(U) \subset V$ such that $f|_U : U \to V$ is formally smooth, \item for every pair of affine opens $U \subset X$ and $V \subset Y$ with $f(U) \subset V$ the ring map $\mathcal{O}_Y(V) \to \mathcal{O}_X(U)$ is formally smooth, and \item there exists an affine open covering $Y = \bigcup V_j$ and for each $j$ an affine open covering $f^{-1}(V_j) = \bigcup U_{ji}$ such that $\mathcal{O}_Y(V) \to \mathcal{O}_X(U)$ is a formally smooth ring map for all $j$ and $i$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-triangle-differentials-formally-smooth} Let $f : X \to Y$, $g : Y \to S$ be morphisms of schemes. Assume $f$ is formally smooth. Then $$ 0 \to f^*\Omega_{Y/S} \to \Omega_{X/S} \to \Omega_{X/Y} \to 0 $$ (see Morphisms, Lemma \ref{morphisms-lemma-triangle-differentials}) is short exact. \end{lemma} 
\begin{lemma} \label{lemma-differentials-formally-unramified-formally-smooth} Let $h : Z \to X$ be a formally unramified morphism of schemes over $S$. Assume that $Z$ is formally smooth over $S$. Then the canonical exact sequence $$ 0 \to \mathcal{C}_{Z/X} \to h^*\Omega_{X/S} \to \Omega_{Z/S} \to 0 $$ of Lemma \ref{lemma-universally-unramified-differentials-sequence} is short exact. \end{lemma} 
\begin{lemma} \label{lemma-two-unramified-morphisms-formally-smooth} Let $$ \xymatrix{ Z \ar[r]_i \ar[rd]_j & X \ar[d]^f \\ & Y } $$ be a commutative diagram of schemes where $i$ and $j$ are formally unramified and $f$ is formally smooth. Then the canonical exact sequence $$ 0 \to \mathcal{C}_{Z/Y} \to \mathcal{C}_{Z/X} \to i^*\Omega_{X/Y} \to 0 $$ of Lemma \ref{lemma-two-unramified-morphisms} is exact and locally split. \end{lemma} 
\begin{lemma} \label{lemma-lifting-along-artinian-at-point} Let $f : X \to S$ be a morphism of schemes. Let $x \in X$. Assume that $S$ is locally Noetherian and $f$ locally of finite type. The following are equivalent: \begin{enumerate} \item $f$ is smooth at $x$, \item for every solid commutative diagram $$ \xymatrix{ X \ar[d]_f & \Spec(B) \ar[d]^i \ar[l]^-\alpha \\ S & \Spec(B') \ar[l]_-{\beta} \ar@{-->}[lu] } $$ where $B' \to B$ is a surjection of local rings with $\Ker(B' \to B)$ of square zero, and $\alpha$ mapping the closed point of $\Spec(B)$ to $x$ there exists a dotted arrow making the diagram commute, \item same as in (2) but with $B' \to B$ ranging over small extensions (see Algebra, Definition \ref{algebra-definition-small-extension}), and \item same as in (2) but with $B' \to B$ ranging over small extensions such that $\alpha$ induces an isomorphism $\kappa(x) \to \kappa(\mathfrak m)$ where $\mathfrak m \subset B$ is the maximal ideal. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-lifting-along-artinian} Let $f : X \to S$ be a morphism of schemes. Assume that $S$ is locally Noetherian and $f$ locally of finite type. The following are equivalent: \begin{enumerate} \item $f$ is smooth, \item for every solid commutative diagram $$ \xymatrix{ X \ar[d]_f & \Spec(B) \ar[d]^i \ar[l]^-\alpha \\ S & \Spec(B') \ar[l]_-{\beta} \ar@{-->}[lu] } $$ where $B' \to B$ is a small extension of Artinian local rings and $\beta$ of finite type (!) there exists a dotted arrow making the diagram commute. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-check-smoothness-on-infinitesimal-nbhds} Let $f : X \to S$ be a finite type morphism of locally Noetherian schemes. Let $Z \subset S$ be a closed subscheme with $n$th infinitesimal neighbourhood $Z_n \subset S$. Set $X_n = Z_n \times_S X$. \begin{enumerate} \item If $X_n \to Z_n$ is smooth for all $n$, then $f$ is smooth at every point of $f^{-1}(Z)$. \item If $X_n \to Z_n$ is \'etale for all $n$, then $f$ is \'etale at every point of $f^{-1}(Z)$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-check-flatness-on-infinitesimal-nbhds} Let $f : X \to S$ be a morphism of locally Noetherian schemes. Let $Z \subset S$ be a closed subscheme with $n$th infinitesimal neighbourhood $Z_n \subset S$. Set $X_n = Z_n \times_S X$. If $X_n \to Z_n$ is flat for all $n$, then $f$ is flat at every point of $f^{-1}(Z)$. \end{lemma} 
\begin{definition} \label{definition-netherlander} Let $f : X \to Y$ be a morphism of schemes. The {\it naive cotangent complex of $f$} is the complex defined in Modules, Definition \ref{modules-definition-cotangent-complex-morphism-ringed-topoi}. Notation: $\NL_f$ or $\NL_{X/Y}$. \end{definition} 
\begin{lemma} \label{lemma-NL-affine} Let $f : X \to Y$ be a morphism of schemes. Let $\Spec(A) = U \subset X$ and $\Spec(R) = V \subset S$ be affine opens with $f(U) \subset V$. There is a canonical map $$ \widetilde{\NL_{A/R}} \longrightarrow \NL_{X/Y}|_U $$ of complexes which is an isomorphism in $D(\mathcal{O}_U)$. \end{lemma} 
\begin{lemma} \label{lemma-netherlander-quasi-coherent} Let $f : X \to Y$ be a morphism of schemes. The cohomology sheaves of the complex $\NL_{X/Y}$ are quasi-coherent, zero outside degrees $-1$, $0$ and equal to $\Omega_{X/Y}$ in degree $0$. \end{lemma} 
\begin{lemma} \label{lemma-netherlander-fp} Let $f : X \to Y$ be a morphism of schemes. If $f$ is locally of finite presentation, then $\NL_{X/Y}$ is locally on $X$ quasi-isomorphic to a complex $$ \ldots \to 0 \to \mathcal{F}^{-1} \to \mathcal{F}^0 \to 0 \to \ldots $$ of quasi-coherent $\mathcal{O}_X$-modules with $\mathcal{F}^0$ of finite presentation and $\mathcal{F}^{-1}$ of finite type. \end{lemma} 
\begin{lemma} \label{lemma-NL-formally-smooth} Let $f : X \to Y$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item $f$ is formally smooth, \item $H^{-1}(\NL_{X/Y}) = 0$ and $H^0(\NL_{X/Y}) = \Omega_{X/Y}$ is locally projective. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-NL-formally-etale} Let $f : X \to Y$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item $f$ is formally \'etale, \item $H^{-1}(\NL_{X/Y}) = H^0(\NL_{X/Y}) = 0$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-NL-smooth} Let $f : X \to Y$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item $f$ is smooth, and \item $f$ is locally of finite presentation, $H^{-1}(\NL_{X/Y}) = 0$, and $H^0(\NL_{X/Y}) = \Omega_{X/Y}$ is finite locally free. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-NL-etale} Let $f : X \to Y$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item $f$ is \'etale, and \item $f$ is locally of finite presentation and $H^{-1}(\NL_{X/Y}) = H^0(\NL_{X/Y}) = 0$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-NL-immersion} Let $i : Z \to X$ be an immersion of schemes. Then $\NL_{Z/X}$ is isomorphic to $\mathcal{C}_{Z/X}[1]$ in $D(\mathcal{O}_Z)$ where $\mathcal{C}_{Z/X}$ is the conormal sheaf of $Z$ in $X$. \end{lemma} 
\begin{lemma} \label{lemma-exact-sequence-NL} Let $f : X \to Y$ and $g : Y \to Z$ be morphisms of schemes. There is a canonical six term exact sequence $$ H^{-1}(f^*\NL_{Y/Z}) \to H^{-1}(\NL_{X/Z}) \to H^{-1}(\NL_{X/Y}) \to f^*\Omega_{Y/Z} \to \Omega_{X/Z} \to \Omega_{X/Y} \to 0 $$ of cohomology sheaves. \end{lemma} 
\begin{lemma} \label{lemma-get-triangle-NL} Let $f : X \to Y$ and $Y \to Z$ be morphisms of schemes. Assume $X \to Y$ is a complete intersection morphism. Then there is a canonical distinguished triangle $$ f^*\NL_{Y/Z} \to \NL_{X/Z} \to \NL_{X/Y} \to f^*\NL_{Y/Z}[1] $$ in $D(\mathcal{O}_X)$ which recovers the $6$-term exact sequence of Lemma \ref{lemma-exact-sequence-NL}. \end{lemma} 
\begin{lemma} \label{lemma-smooth-etale-permanence} Let $X \to Y \to Z$ be morphisms of schemes. Assume $X \to Z$ smooth and $Y \to Z$ \'etale. Then $X \to Y$ is smooth. \end{lemma} 
\begin{lemma} \label{lemma-get-NL} Let $f : X \to Y$ be a morphism of schemes which factors as $f = g \circ i$ with $i$ an immersion and $g : P \to Y$ formally smooth (for example smooth). Then there is a canonical isomorphism $$ \NL_{X/Y} \cong \left(\mathcal{C}_{X/P} \to i^*\Omega_{P/Y}\right) $$ in $D(\mathcal{O}_X)$ where the conormal sheaf $\mathcal{C}_{X/P}$ is placed in degree $-1$. \end{lemma} 
\begin{lemma} \label{lemma-base-change-NL} Consider a cartesian diagram of schemes $$ \xymatrix{ X' \ar[r]_{g'} \ar[d] & X \ar[d] \\ Y' \ar[r] & Y } $$ The canonical map $(g')^*\NL_{X/Y} \to \NL_{X'/Y'}$ induces an isomorphism on $H^0$ and a surjection on $H^{-1}$. \end{lemma} 
\begin{lemma} \label{lemma-flat-base-change-NL} Consider a cartesian diagram of schemes $$ \xymatrix{ X' \ar[d] \ar[r]_{g'} & X \ar[d] \\ Y' \ar[r] & Y } $$ If $Y' \to Y$ is flat, then the canonical map $(g')^*\NL_{X/Y} \to \NL_{X'/Y'}$ is a quasi-isomorphism. \end{lemma} 
\begin{lemma} \label{lemma-base-change-NL-flat} Consider a cartesian diagram of schemes $$ \xymatrix{ X' \ar[r]_{g'} \ar[d] & X \ar[d] \\ Y' \ar[r] & Y } $$ If $X \to Y$ is flat, then the canonical map $(g')^*\NL_{X/Y} \to \NL_{X'/Y'}$ is a quasi-isomorphism. If in addition $\NL_{X/Y}$ has tor-amplitude in $[-1, 0]$ then $L(g')^*\NL_{X/Y} \to \NL_{X'/Y'}$ is a quasi-isomorphism too. \end{lemma} 
\begin{lemma} \label{lemma-basic-example-pushout} Let $A' \to A$ be a surjection of rings and let $B \to A$ be a ring map. Let $B' = B \times_A A'$ be the fibre product of rings. Set $S = \Spec(A)$, $S' = \Spec(A')$, $T = \Spec(B)$, and $T' = \Spec(B')$. Then $$ \vcenter{ \xymatrix{ S \ar[r]_i \ar[d]_f & S' \ar[d]^{f'} \\ T \ar[r]^{i'} & T' } } \quad\text{corresponding to}\quad \vcenter{ \xymatrix{ A & A' \ar[l] \\ B \ar[u] & B' \ar[l] \ar[u] } } $$ is a pushout of schemes. \end{lemma} 
\begin{lemma} \label{lemma-pushout-fpqc-local} Let $\mathcal{I} \to (\Sch/S)_{fppf}$, $i \mapsto X_i$ be a diagram of schemes. Let $(W, X_i \to W)$ be a cocone for the diagram in the category of schemes (Categories, Remark \ref{categories-remark-cones-and-cocones}). If there exists a fpqc covering $\{W_a \to W\}_{a \in A}$ of schemes such that \begin{enumerate} \item for all $a \in A$ we have $W_a = \colim X_i \times_W W_a$ in the category of schemes, and \item for all $a, b \in A$ we have $W_a \times_W W_b = \colim X_i \times_W W_a \times_W W_b$ in the category of schemes, \end{enumerate} then $W = \colim X_i$ in the category of schemes. \end{lemma} 
\begin{lemma} \label{lemma-pushout-along-thickening} Let $X \to X'$ be a thickening of schemes and let $X \to Y$ be an affine morphism of schemes. Then there exists a pushout $$ \xymatrix{ X \ar[r] \ar[d]_f & X' \ar[d]^{f'} \\ Y \ar[r] & Y' } $$ in the category of schemes. Moreover, $Y \subset Y'$ is a thickening, $X = Y \times_{Y'} X'$, and $$ \mathcal{O}_{Y'} = \mathcal{O}_Y \times_{f_*\mathcal{O}_X} f'_*\mathcal{O}_{X'} $$ as sheaves on $|Y| = |Y'|$. \end{lemma} 
\begin{lemma} \label{lemma-equivalence-categories-schemes-over-pushout} Let $X \to X'$ be a thickening of schemes and let $X \to Y$ be an affine morphism of schemes. Let $Y' = Y \amalg_X X'$ be the pushout (see Lemma \ref{lemma-pushout-along-thickening}). Base change gives a functor $$ F : (\Sch/Y') \longrightarrow (\Sch/Y) \times_{(\Sch/Y')} (\Sch/X') $$ given by $V' \longmapsto (V' \times_{Y'} Y, V' \times_{Y'} X', 1)$ which has a left adjoint $$ G : (\Sch/Y) \times_{(\Sch/Y')} (\Sch/X') \longrightarrow (\Sch/Y') $$ which sends the triple $(V, U', \varphi)$ to the pushout $V \amalg_{(V \times_Y X)} U'$. Finally, $F \circ G$ is isomorphic to the identity functor. \end{lemma} 
\begin{lemma} \label{lemma-scheme-over-pushout-flat-modules} Let $X \to X'$ be a thickening of schemes and let $X \to Y$ be an affine morphism of schemes. Let $Y' = Y \amalg_X X'$ be the pushout (see Lemma \ref{lemma-pushout-along-thickening}). Let $V' \to Y'$ be a morphism of schemes. Set $V = Y \times_{Y'} V'$, $U' = X' \times_{Y'} V'$, and $U = X \times_{Y'} V'$. There is an equivalence of categories between \begin{enumerate} \item quasi-coherent $\mathcal{O}_{V'}$-modules flat over $Y'$, and \item the category of triples $(\mathcal{G}, \mathcal{F}', \varphi)$ where \begin{enumerate} \item $\mathcal{G}$ is a quasi-coherent $\mathcal{O}_V$-module flat over $Y$, \item $\mathcal{F}'$ is a quasi-coherent $\mathcal{O}_{U'}$-module flat over $X'$, and \item $\varphi : (U \to V)^*\mathcal{G} \to (U \to U')^*\mathcal{F}'$ is an isomorphism of $\mathcal{O}_U$-modules. \end{enumerate} \end{enumerate} The equivalence maps $\mathcal{G}'$ to $((V \to V')^*\mathcal{G}', (U' \to V')^*\mathcal{G}', can)$. Suppose $\mathcal{G}'$ corresponds to the triple $(\mathcal{G}, \mathcal{F}', \varphi)$. Then \begin{enumerate} \item[(a)] $\mathcal{G}'$ is a finite type $\mathcal{O}_{V'}$-module if and only if $\mathcal{G}$ and $\mathcal{F}'$ are finite type $\mathcal{O}_Y$ and $\mathcal{O}_{U'}$-modules. \item[(b)] if $V' \to Y'$ is locally of finite presentation, then $\mathcal{G}'$ is an $\mathcal{O}_{V'}$-module of finite presentation if and only if $\mathcal{G}$ and $\mathcal{F}'$ are $\mathcal{O}_Y$ and $\mathcal{O}_{U'}$-modules of finite presentation. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-equivalence-categories-schemes-over-pushout-flat} In the situation of Lemma \ref{lemma-equivalence-categories-schemes-over-pushout}. If $V' = G(V, U', \varphi)$ for some triple $(V, U', \varphi)$, then \begin{enumerate} \item $V' \to Y'$ is locally of finite type if and only if $V \to Y$ and $U' \to X'$ are locally of finite type, \item $V' \to Y'$ is flat if and only if $V \to Y$ and $U' \to X'$ are flat, \item $V' \to Y'$ is flat and locally of finite presentation if and only if $V \to Y$ and $U' \to X'$ are flat and locally of finite presentation, \item $V' \to Y'$ is smooth if and only if $V \to Y$ and $U' \to X'$ are smooth, \item $V' \to Y'$ is \'etale if and only if $V \to Y$ and $U' \to X'$ are \'etale, and \item add more here as needed. \end{enumerate} If $W'$ is flat over $Y'$, then the adjunction mapping $G(F(W')) \to W'$ is an isomorphism. Hence $F$ and $G$ define mutually quasi-inverse functors between the category of schemes flat over $Y'$ and the category of triples $(V, U', \varphi)$ with $V \to Y$ and $U' \to X'$ flat. \end{lemma} 
\begin{theorem} \label{theorem-openness-flatness} \begin{reference} \cite[IV Theorem 11.3.1]{EGA} \end{reference} Let $S$ be a scheme. Let $f : X \to S$ be a morphism which is locally of finite presentation. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module which is locally of finite presentation. Then $$ U = \{x \in X \mid \mathcal{F}\text{ is flat over }S\text{ at }x\} $$ is open in $X$. \end{theorem} 
\begin{lemma} \label{lemma-flat-locus-base-change} Let $S$ be a scheme. Let $$ \xymatrix{ X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\ S' \ar[r]^g & S } $$ be a cartesian diagram of schemes. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Let $x' \in X'$ with images $x = g'(x')$ and $s' = f'(x')$. \begin{enumerate} \item If $\mathcal{F}$ is flat over $S$ at $x$, then $(g')^*\mathcal{F}$ is flat over $S'$ at $x'$. \item If $g$ is flat at $s'$ and $(g')^*\mathcal{F}$ is flat over $S'$ at $x'$, then $\mathcal{F}$ is flat over $S$ at $x$. \end{enumerate} In particular, if $g$ is flat, $f$ is locally of finite presentation, and $\mathcal{F}$ is locally of finite presentation, then formation of the open subset of Theorem \ref{theorem-openness-flatness} commutes with base change. \end{lemma} 
\begin{theorem} \label{theorem-criterion-flatness-fibre-Noetherian} Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of schemes over $S$. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Let $x \in X$. Set $y = f(x)$ and $s \in S$ the image of $x$ in $S$. Assume $S$, $X$, $Y$ locally Noetherian, $\mathcal{F}$ coherent, and $\mathcal{F}_x \not = 0$. Then the following are equivalent: \begin{enumerate} \item $\mathcal{F}$ is flat over $S$ at $x$, and $\mathcal{F}_s$ is flat over $Y_s$ at $x$, and \item $Y$ is flat over $S$ at $y$ and $\mathcal{F}$ is flat over $Y$ at $x$. \end{enumerate} \end{theorem} 
\begin{theorem} \label{theorem-criterion-flatness-fibre} Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of schemes over $S$. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Assume \begin{enumerate} \item $X$ is locally of finite presentation over $S$, \item $\mathcal{F}$ an $\mathcal{O}_X$-module of finite presentation, and \item $Y$ is locally of finite type over $S$. \end{enumerate} Let $x \in X$. Set $y = f(x)$ and let $s \in S$ be the image of $x$ in $S$. If $\mathcal{F}_x \not = 0$, then the following are equivalent: \begin{enumerate} \item $\mathcal{F}$ is flat over $S$ at $x$, and $\mathcal{F}_s$ is flat over $Y_s$ at $x$, and \item $Y$ is flat over $S$ at $y$ and $\mathcal{F}$ is flat over $Y$ at $x$. \end{enumerate} Moreover, the set of points $x$ where (1) and (2) hold is open in $\text{Supp}(\mathcal{F})$. \end{theorem} 
\begin{lemma} \label{lemma-morphism-between-flat-Noetherian} Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of schemes over $S$. Assume \begin{enumerate} \item $S$, $X$, $Y$ are locally Noetherian, \item $X$ is flat over $S$, \item for every $s \in S$ the morphism $f_s : X_s \to Y_s$ is flat. \end{enumerate} Then $f$ is flat. If $f$ is also surjective, then $Y$ is flat over $S$. \end{lemma} 
\begin{lemma} \label{lemma-morphism-between-flat} Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of schemes over $S$. Assume \begin{enumerate} \item $X$ is locally of finite presentation over $S$, \item $X$ is flat over $S$, \item for every $s \in S$ the morphism $f_s : X_s \to Y_s$ is flat, and \item $Y$ is locally of finite type over $S$. \end{enumerate} Then $f$ is flat. If $f$ is also surjective, then $Y$ is flat over $S$. \end{lemma} 
\begin{lemma} \label{lemma-base-change-criterion-flatness-fibre} Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of schemes over $S$. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Assume \begin{enumerate} \item $X$ is locally of finite presentation over $S$, \item $\mathcal{F}$ an $\mathcal{O}_X$-module of finite presentation, \item $\mathcal{F}$ is flat over $S$, and \item $Y$ is locally of finite type over $S$. \end{enumerate} Then the set $$ U = \{x \in X \mid \mathcal{F} \text{ flat at }x \text{ over }Y\}. $$ is open in $X$ and its formation commutes with arbitrary base change: If $S' \to S$ is a morphism of schemes, and $U'$ is the set of points of $X' = X \times_S S'$ where $\mathcal{F}' = \mathcal{F} \times_S S'$ is flat over $Y' = Y \times_S S'$, then $U' = U \times_S S'$. \end{lemma} 
\begin{lemma} \label{lemma-base-change-flatness-fibres} Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of schemes over $S$. Assume \begin{enumerate} \item $X$ is locally of finite presentation over $S$, \item $X$ is flat over $S$, and \item $Y$ is locally of finite type over $S$. \end{enumerate} Then the set $$ U = \{x \in X \mid X\text{ flat at }x \text{ over }Y\}. $$ is open in $X$ and its formation commutes with arbitrary base change. \end{lemma} 
\begin{lemma} \label{lemma-flat-and-free-at-point-fibre} Let $f : X \to S$ be a morphism of schemes of finite presentation. Let $\mathcal{F}$ be a finitely presented $\mathcal{O}_X$-module. Let $x \in X$ with image $s \in S$. If $\mathcal{F}$ is flat at $x$ over $S$ and $(\mathcal{F}_s)_x$ is a flat $\mathcal{O}_{X_s, x}$-module, then $\mathcal{F}$ is finite free in a neighbourhood of $x$. \end{lemma} 
\begin{lemma} \label{lemma-finite-free-open} Let $f : X \to S$ be a morphism of schemes which is locally of finite presentation. Let $\mathcal{F}$ be a finitely presented $\mathcal{O}_X$-module flat over $S$. Then the set $$ \{x \in X : \mathcal{F}\text{ free in a neighbourhood of }x\} $$ is open in $X$ and its formation commutes with arbitrary base change $S' \to S$. \end{lemma} 
\begin{lemma} \label{lemma-etale-local-structure} Let $S$ be a scheme. Let $Y \to X$ be a closed immersion of schemes smooth over $S$. For every $y \in Y$ there exist integers $0 \leq m, n$ and a commutative diagram $$ \xymatrix{ Y \ar[d] & V \ar[l] \ar[d] \ar[r] & \mathbf{A}^m_S \ar[d]^{(a_1, \ldots, a_m) \mapsto (a_1, \ldots, a_m, 0 \ldots, 0)} \\ X & U \ar[l] \ar[r]^-\pi & \mathbf{A}^{m + n}_S } $$ where $U \subset X$ is open, $V = Y \cap U$, $\pi$ is \'etale, $V = \pi^{-1}(\mathbf{A}^m_S)$, and $y \in V$. \end{lemma} 
\begin{lemma} \label{lemma-blowup} Let $S$ be a scheme. Let $Z \to X$ be a closed immersion of schemes smooth over $S$. Let $b : X' \to X$ be the blowing up of $Z$ with exceptional divisor $E \subset X'$. Then $X'$ and $E$ are smooth over $S$. The morphism $p : E \to Z$ is canonically isomorphic to the projective space bundle $$ \mathbf{P}(\mathcal{I}/\mathcal{I}^2) \longrightarrow Z $$ where $\mathcal{I} \subset \mathcal{O}_X$ is the ideal sheaf of $Z$. The relative $\mathcal{O}_E(1)$ coming from the projective space bundle structure is isomorphic to the restriction of $\mathcal{O}_{X'}(-E)$ to $E$. \end{lemma} 
\begin{lemma} \label{lemma-mod-injective-valuation-ring} Let $A$ be a valuation ring. Let $A \to B$ is a local homomorphism of local rings which is essentially of finite type. Let $u : N \to M$ be a map of finite $B$-modules. Assume $M$ is flat over $A$ and $\overline{u} : N/\mathfrak m_A N \to M/\mathfrak m_A M$ is injective. Then $u$ is injective and $M/u(N)$ is flat over $A$. \end{lemma} 
\begin{lemma} \label{lemma-make-base-change} \begin{reference} This can be found in the proof of \cite[IV Proposition 12.1.1.5]{EGA} \end{reference} Let $f : X \to S$ be a morphism of schemes. Let $y \in X$ be a point with image $t \in S$. Denote $Y \subset X$ the closure of $\{y\}$ viewed as an integral closed subscheme of $X$. Let $s \in S$ and let $x \in Y_s$ be a generic point of an irreducible component of $Y_s$. There exists a cartesian diagram $$ \xymatrix{ X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\ S' \ar[r]^g & S } $$ with the following properties: \begin{enumerate} \item $S'$ is the spectrum of a valuation ring with generic point $t'$ and closed point $s'$, \item $g(t') = t$ and $g(s') = s$, \item there exists a point $y' \in X'_{t'}$ which is a generic point of an irreducible component of $(S' \times_S Y)_{t'} = Y_t \times_t t'$ and satisfies $g'(y') = y$, \item denoting $Y' \subset X'$ the closure of $\{y'\}$ viewed as an integral closed subscheme of $X'$ there exists a point $x' \in Y'_{s'}$ which is a generic point of an irreducible component of $Y'_{s'}$ with $g'(x') = x$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-associated-point-specializes} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. Let $\mathcal{F}$ be a quasi-coherent finite type $\mathcal{O}_X$-module. Let $y \in \text{Ass}_{X/S}(\mathcal{F})$ with image $t \in S$. Denote $Y \subset X$ the closure of $\{y\}$ in $X$ viewed as an integral closed subscheme. Let $s \in S$ and let $x \in Y_s$ be a generic point of an irreducible component of $Y_s$. If $\mathcal{F}$ is flat over $S$ at $x$, then $x \in \text{Ass}_{X/S}(\mathcal{F})$ and $\dim_x(Y_s) = \dim(Y_t)$. \end{lemma} 
\begin{lemma} \label{lemma-relative-dimension-support-flat} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. Let $\mathcal{F}$ be a finite type, quasi-coherent $\mathcal{O}_X$-module flat over $S$. Assume $S$ is irreducible with generic point $\eta$. If $\dim(\text{Supp}(\mathcal{F}_\eta)) \leq r$ then for all $s \in S$ we have $\dim(\text{Supp}(\mathcal{F}_s)) \leq r$. \end{lemma} 
\begin{lemma} \label{lemma-flat-associated-equidimensional} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type. Let $y \in \text{Ass}_{X/S}(\mathcal{F})$. Denote $Y \subset X$ the closure of $\{y\}$ in $X$ viewed as an integral closed subscheme. Denote $T \subset S$ the closure of $\{f(y)\}$ viewed as an integral closed subscheme. We obtain a commutative diagram $$ \xymatrix{ Y \ar[r] \ar[d] & X \ar[d] \\ T \ar[r] & S } $$ where $Y \to T$ is dominant. Assume $\mathcal{F}$ is flat over $S$ at all generic points of irreducible components of fibres of $Y \to T$ (for example if $\mathcal{F}$ is flat over $S$). Then \begin{enumerate} \item if $s \in S$ and $x \in Y_s$ is the generic point of an irreducible component of $Y_s$, then $x \in \text{Ass}_{X/S}(\mathcal{F})$, and \item there is an integer $d \geq 0$ such that $Y \to T$ is of relative dimension $d$, see Morphisms, Definition \ref{morphisms-definition-relative-dimension-d}. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-integral-closure-smooth-pullback} Let $f : Y \to X$ be a smooth morphism of schemes. Let $\mathcal{A}$ be a quasi-coherent sheaf of $\mathcal{O}_X$-algebras. The integral closure of $\mathcal{O}_Y$ in $f^*\mathcal{A}$ is equal to $f^*\mathcal{A}'$ where $\mathcal{A}' \subset \mathcal{A}$ is the integral closure of $\mathcal{O}_X$ in $\mathcal{A}$. \end{lemma} 
\begin{lemma}[Normalization commutes with smooth base change] \label{lemma-normalization-smooth-localization} Let $$ \xymatrix{ Y_2 \ar[r] \ar[d]_{f_2} & Y_1 \ar[d]^{f_1} \\ X_2 \ar[r]^\varphi & X_1 } $$ be a fibre square in the category of schemes. Assume $f_1$ is quasi-compact and quasi-separated, and $\varphi$ is smooth. Let $Y_i \to X_i' \to X_i$ be the normalization of $X_i$ in $Y_i$. Then $X_2' \cong X_2 \times_{X_1} X_1'$. \end{lemma} 
\begin{lemma}[Normalization and smooth morphisms] \label{lemma-normalization-and-smooth} Let $X \to Y$ be a smooth morphism of schemes. Assume every quasi-compact open of $Y$ has finitely many irreducible components. Then the same is true for $X$ and there is a unique isomorphism $X^\nu = X \times_Y Y^\nu$ over $X$ where $X^\nu$, $Y^\nu$ are the normalizations of $X$, $Y$. \end{lemma} 
\begin{lemma}[Normalization and henselization] \label{lemma-normalization-and-henselization} Let $X$ be a locally Noetherian scheme. Let $\nu : X^\nu \to X$ be the normalization morphism. Then for any point $x \in X$ the base change $$ X^\nu \times_X \Spec(\mathcal{O}_{X, x}^h) \to \Spec(\mathcal{O}_{X, x}^h), \quad\text{resp.}\quad X^\nu \times_X \Spec(\mathcal{O}_{X, x}^{sh}) \to \Spec(\mathcal{O}_{X, x}^{sh}) $$ is the normalization of $\Spec(\mathcal{O}_{X, x}^h)$, resp.\ $\Spec(\mathcal{O}_{X, x}^{sh})$. \end{lemma} 
\begin{definition} \label{definition-normal} Let $f : X \to Y$ be a morphism of schemes. Assume that all the fibres $X_y$ are locally Noetherian schemes. \begin{enumerate} \item Let $x \in X$, and $y = f(x)$. We say that $f$ is {\it normal at $x$} if $f$ is flat at $x$, and the scheme $X_y$ is geometrically normal at $x$ over $\kappa(y)$ (see Varieties, Definition \ref{varieties-definition-geometrically-normal}). \item We say $f$ is a {\it normal morphism} if $f$ is normal at every point of $X$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-normal} Let $f : X \to Y$ be a morphism of schemes. Assume all fibres of $f$ are locally Noetherian. The following are equivalent \begin{enumerate} \item $f$ is normal, and \item $f$ is flat and its fibres are geometrically normal schemes. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-smooth-normal} A smooth morphism is normal. \end{lemma} 
\begin{lemma} \label{lemma-locally-Noetherian-fibres-fppf-local-source-and-target} The property $\mathcal{P}(f)=$``the fibres of $f$ are locally Noetherian'' is local in the fppf topology on the source and the target. \end{lemma} 
\begin{lemma} \label{lemma-normal-fppf-local-source-and-target} The property $\mathcal{P}(f)=$``the fibres of $f$ are locally Noetherian and $f$ is normal'' is local in the fppf topology on the target and local in the smooth topology on the source. \end{lemma} 
\begin{definition} \label{definition-regular} Let $f : X \to Y$ be a morphism of schemes. Assume that all the fibres $X_y$ are locally Noetherian schemes. \begin{enumerate} \item Let $x \in X$, and $y = f(x)$. We say that $f$ is {\it regular at $x$} if $f$ is flat at $x$, and the scheme $X_y$ is geometrically regular at $x$ over $\kappa(y)$ (see Varieties, Definition \ref{varieties-definition-geometrically-regular}). \item We say $f$ is a {\it regular morphism} if $f$ is regular at every point of $X$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-regular} Let $f : X \to Y$ be a morphism of schemes. Assume all fibres of $f$ are locally Noetherian. The following are equivalent \begin{enumerate} \item $f$ is regular, \item $f$ is flat and its fibres are geometrically regular schemes, \item for every pair of affine opens $U \subset X$, $V \subset Y$ with $f(U) \subset V$ the ring map $\mathcal{O}_Y(V) \to \mathcal{O}_X(U)$ is regular, \item there exists an open covering $Y = \bigcup_{j \in J} V_j$ and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such that each of the morphisms $U_i \to V_j$ is regular, and \item there exists an affine open covering $Y = \bigcup_{j \in J} V_j$ and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such that the ring maps $\mathcal{O}_Y(V_j) \to \mathcal{O}_X(U_i)$ are regular. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-smooth-regular} A smooth morphism is regular. \end{lemma} 
\begin{lemma} \label{lemma-regular-fppf-local-source-and-target} The property $\mathcal{P}(f)=$``the fibres of $f$ are locally Noetherian and $f$ is regular'' is local in the fppf topology on the target and local in the smooth topology on the source. \end{lemma} 
\begin{definition} \label{definition-CM} Let $f : X \to Y$ be a morphism of schemes. Assume that all the fibres $X_y$ are locally Noetherian schemes. \begin{enumerate} \item Let $x \in X$, and $y = f(x)$. We say that $f$ is {\it Cohen-Macaulay at $x$} if $f$ is flat at $x$, and the local ring of the scheme $X_y$ at $x$ is Cohen-Macaulay. \item We say $f$ is a {\it Cohen-Macaulay morphism} if $f$ is Cohen-Macaulay at every point of $X$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-CM} Let $f : X \to Y$ be a morphism of schemes. Assume all fibres of $f$ are locally Noetherian. The following are equivalent \begin{enumerate} \item $f$ is Cohen-Macaulay, and \item $f$ is flat and its fibres are Cohen-Macaulay schemes. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-CM-dimension} Let $f : X \to Y$ be a morphism of locally Noetherian schemes which is locally of finite type and Cohen-Macaulay. For every point $x$ in $X$ with image $y$ in $Y$, $$ \dim_x(X) = \dim_y(Y) + \dim_x(X_y), $$ where $X_y$ denotes the fiber over $y$. \end{lemma} 
\begin{lemma} \label{lemma-composition-CM} Let $f : X \to Y$ and $g : Y \to Z$ be morphisms of schemes. Assume that the fibres of $f$, $g$, and $g \circ f$ are locally Noetherian. Let $x \in X$ with images $y \in Y$ and $z \in Z$. \begin{enumerate} \item If $f$ is Cohen-Macaulay at $x$ and $g$ is Cohen-Macaulay at $f(x)$, then $g \circ f$ is Cohen-Macaulay at $x$. \item If $f$ and $g$ are Cohen-Macaulay, then $g \circ f$ is Cohen-Macaulay. \item If $g \circ f$ is Cohen-Macaulay at $x$ and $f$ is flat at $x$, then $f$ is Cohen-Macaulay at $x$ and $g$ is Cohen-Macaulay at $f(x)$. \item If $g \circ f$ is Cohen-Macaulay and $f$ is flat, then $f$ is Cohen-Macaulay and $g$ is Cohen-Macaulay at every point in the image of $f$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-flat-morphism-from-CM-scheme} Let $f : X \to Y$ be a flat morphism of locally Noetherian schemes. If $X$ is Cohen-Macaulay, then $f$ is Cohen-Macaulay and $\mathcal{O}_{Y, f(x)}$ is Cohen-Macaulay for all $x \in X$. \end{lemma} 
\begin{lemma} \label{lemma-base-change-CM} Let $f : X \to Y$ be a morphism of schemes. Assume that all the fibres $X_y$ are locally Noetherian schemes. Let $Y' \to Y$ be locally of finite type. Let $f' : X' \to Y'$ be the base change of $f$. Let $x' \in X'$ be a point with image $x \in X$. \begin{enumerate} \item If $f$ is Cohen-Macaulay at $x$, then $f' : X' \to Y'$ is Cohen-Macaulay at $x'$. \item If $f$ is flat at $x$ and $f'$ is Cohen-Macaulay at $x'$, then $f$ is Cohen-Macaulay at $x$. \item If $Y' \to Y$ is flat at $f'(x')$ and $f'$ is Cohen-Macaulay at $x'$, then $f$ is Cohen-Macaulay at $x$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-flat-finite-presentation-CM-open} \begin{reference} \cite[IV Corollary 12.1.7(iii)]{EGA} \end{reference} Let $f : X \to S$ be a morphism of schemes which is flat and locally of finite presentation. Let $$ W = \{x \in X \mid f\text{ is Cohen-Macaulay at }x\} $$ Then \begin{enumerate} \item $W = \{x \in X \mid \mathcal{O}_{X_{f(x)}, x}\text{ is Cohen-Macaulay}\}$, \item $W$ is open in $X$, \item $W$ is dense in every fibre of $X \to S$, \item the formation of $W$ commutes with arbitrary base change of $f$: For any morphism $g : S' \to S$, consider the base change $f' : X' \to S'$ of $f$ and the projection $g' : X' \to X$. Then the corresponding set $W'$ for the morphism $f'$ is equal to $W' = (g')^{-1}(W)$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-flat-finite-presentation-characterize-CM} Let $f : X \to S$ be a morphism of schemes which is flat and locally of finite presentation. Let $x \in X$ with image $s \in S$. Set $d = \dim_x(X_s)$. The following are equivalent \begin{enumerate} \item $f$ is Cohen-Macaulay at $x$, \item there exists an open neighbourhood $U \subset X$ of $x$ and a locally quasi-finite morphism $U \to \mathbf{A}^d_S$ over $S$ which is flat at $x$, \item there exists an open neighbourhood $U \subset X$ of $x$ and a locally quasi-finite flat morphism $U \to \mathbf{A}^d_S$ over $S$, \item for any $S$-morphism $g : U \to \mathbf{A}^d_S$ of an open neighbourhood $U \subset X$ of $x$ we have: $g$ is quasi-finite at $x$ $\Rightarrow$ $g$ is flat at $x$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-flat-finite-presentation-CM-pieces} Let $f : X \to S$ be a morphism of schemes which is flat and locally of finite presentation. For $d \geq 0$ there exist opens $U_d \subset X$ with the following properties \begin{enumerate} \item $W = \bigcup_{d \geq 0} U_d$ is dense in every fibre of $f$, and \item $U_d \to S$ is of relative dimension $d$ (see Morphisms, Definition \ref{morphisms-definition-relative-dimension-d}). \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-flat-finite-presentation-specialization-dimension} Let $f : X \to S$ be a morphism of schemes which is flat and locally of finite presentation. Suppose $x' \leadsto x$ is a specialization of points of $X$ with image $s' \leadsto s$ in $S$. If $x$ is a generic point of an irreducible component of $X_s$ then $\dim_{x'}(X_{s'}) = \dim_x(X_s)$. \end{lemma} 
\begin{lemma} \label{lemma-CM-local-source-and-target} The property $\mathcal{P}(f)=$``the fibres of $f$ are locally Noetherian and $f$ is Cohen-Macaulay'' is local in the fppf topology on the target and local in the syntomic topology on the source. \end{lemma} 
\begin{lemma} \label{lemma-slice-given-element} Let $f : X \to S$ be a morphism of schemes. Let $x \in X$ be a point with image $s \in S$. Let $h \in \mathfrak m_x \subset \mathcal{O}_{X, x}$. Assume \begin{enumerate} \item $f$ is locally of finite presentation, \item $f$ is flat at $x$, and \item the image $\overline{h}$ of $h$ in $\mathcal{O}_{X_s, x} = \mathcal{O}_{X, x}/\mathfrak m_s\mathcal{O}_{X, x}$ is a nonzerodivisor. \end{enumerate} Then there exists an affine open neighbourhood $U \subset X$ of $x$ such that $h$ comes from $h \in \Gamma(U, \mathcal{O}_U)$ and such that $D = V(h)$ is an effective Cartier divisor in $U$ with $x \in D$ and $D \to S$ flat and locally of finite presentation. \end{lemma} 
\begin{lemma} \label{lemma-slice-given-elements} Let $f : X \to S$ be a morphism of schemes. Let $x \in X$ be a point with image $s \in S$. Let $h_1, \ldots, h_r \in \mathcal{O}_{X, x}$. Assume \begin{enumerate} \item $f$ is locally of finite presentation, \item $f$ is flat at $x$, and \item the images of $h_1, \ldots, h_r$ in $\mathcal{O}_{X_s, x} = \mathcal{O}_{X, x}/\mathfrak m_s\mathcal{O}_{X, x}$ form a regular sequence. \end{enumerate} Then there exists an affine open neighbourhood $U \subset X$ of $x$ such that $h_1, \ldots, h_r$ come from $h_1, \ldots, h_r \in \Gamma(U, \mathcal{O}_U)$ and such that $Z = V(h_1, \ldots, h_r) \to U$ is a regular immersion with $x \in Z$ and $Z \to S$ flat and locally of finite presentation. Moreover, the base change $Z_{S'} \to U_{S'}$ is a regular immersion for any scheme $S'$ over $S$. \end{lemma} 
\begin{lemma} \label{lemma-slice-once} Let $f : X \to S$ be a morphism of schemes. Let $x \in X$ be a point with image $s \in S$. Assume \begin{enumerate} \item $f$ is locally of finite presentation, \item $f$ is flat at $x$, and \item $\mathcal{O}_{X_s, x}$ has $\text{depth} \geq 1$. \end{enumerate} Then there exists an affine open neighbourhood $U \subset X$ of $x$ and an effective Cartier divisor $D \subset U$ containing $x$ such that $D \to S$ is flat and of finite presentation. \end{lemma} 
\begin{lemma} \label{lemma-slice-CM} \begin{reference} \cite[IV Proposition 17.16.1]{EGA} \end{reference} Let $f : X \to S$ be a morphism of schemes. Let $x \in X$ be a point with image $s \in S$. Assume \begin{enumerate} \item $f$ is locally of finite presentation, \item $f$ is Cohen-Macaulay at $x$, and \item $x$ is a closed point of $X_s$. \end{enumerate} Then there exists a regular immersion $Z \to X$ containing $x$ such that \begin{enumerate} \item[(a)] $Z \to S$ is flat and locally of finite presentation, \item[(b)] $Z \to S$ is locally quasi-finite, and \item[(c)] $Z_s = \{x\}$ set theoretically. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-qf-fp-flat-neighbourhood-dominates-fppf} Let $f : X \to S$ be a flat morphism of schemes which is locally of finite presentation. Let $s \in S$ be a point in the image of $f$. Then there exists a commutative diagram $$ \xymatrix{ S' \ar[rr] \ar[rd]_g & & X \ar[ld]^f \\ & S } $$ where $g : S' \to S$ is flat, locally of finite presentation, locally quasi-finite, and $s \in g(S')$. \end{lemma} 
\begin{lemma} \label{lemma-qf-fp-flat-dominates-fppf} Let $S$ be a scheme. Let $\mathcal{U} = \{S_i \to S\}_{i \in I}$ be an fppf covering of $S$, see Topologies, Definition \ref{topologies-definition-fppf-covering}. Then there exists an fppf covering $\mathcal{V} = \{T_j \to S\}_{j \in J}$ which refines (see Sites, Definition \ref{sites-definition-morphism-coverings}) $\mathcal{U}$ such that each $T_j \to S$ is locally quasi-finite. \end{lemma} 
\begin{lemma} \label{lemma-empty-generic-fibre} Let $f : X \to Y$ be a finite type morphism of schemes. Assume $Y$ irreducible with generic point $\eta$. If $X_\eta = \emptyset$ then there exists a nonempty open $V \subset Y$ such that $X_V = V \times_Y X = \emptyset$. \end{lemma} 
\begin{lemma} \label{lemma-nonempty-generic-fibre} Let $f : X \to Y$ be a finite type morphism of schemes. Assume $Y$ irreducible with generic point $\eta$. If $X_\eta \not = \emptyset$ then there exists a nonempty open $V \subset Y$ such that $X_V = V \times_Y X \to V$ is surjective. \end{lemma} 
\begin{lemma} \label{lemma-nowhere-dense-generic-fibre} Let $f : X \to Y$ be a finite type morphism of schemes. Assume $Y$ irreducible with generic point $\eta$. If $Z \subset X$ is a closed subset with $Z_\eta$ nowhere dense in $X_\eta$, then there exists a nonempty open $V \subset Y$ such that $Z_y$ is nowhere dense in $X_y$ for all $y \in V$. \end{lemma} 
\begin{lemma} \label{lemma-scheme-theoretically-dense-generic-fibre} Let $f : X \to Y$ be a finite type morphism of schemes. Assume $Y$ irreducible with generic point $\eta$. Let $U \subset X$ be an open subscheme such that $U_\eta$ is scheme theoretically dense in $X_\eta$. Then there exists a nonempty open $V \subset Y$ such that $U_y$ is scheme theoretically dense in $X_y$ for all $y \in V$. \end{lemma} 
\begin{lemma} \label{lemma-cover-generic-fibre-neighbourhood} Let $f : X \to Y$ be a finite type morphism of schemes. Assume $Y$ irreducible with generic point $\eta$. Let $X_\eta = Z_{1, \eta} \cup \ldots \cup Z_{n, \eta}$ be a covering of the generic fibre by closed subsets of $X_\eta$. Let $Z_i$ be the closure of $Z_{i, \eta}$ in $X$ (see discussion above). Then there exists a nonempty open $V \subset Y$ such that $X_y = Z_{1, y} \cup \ldots \cup Z_{n, y}$ for all $y \in V$. \end{lemma} 
\begin{lemma} \label{lemma-reduction-generic-fibre} Let $f : X \to Y$ be a morphism of schemes. Let $\eta \in Y$ be a generic point of an irreducible component of $Y$. Then $(X_\eta)_{red} = (X_{red})_\eta$. \end{lemma} 
\begin{lemma} \label{lemma-make-generic-fibre-geometrically-reduced} Let $f : X \to Y$ be a morphism of schemes. Assume that $Y$ is irreducible and $f$ is of finite type. There exists a diagram $$ \xymatrix{ X' \ar[d]_{f'} \ar[r]_{g'} & X_V \ar[r] \ar[d] & X \ar[d]^f \\ Y' \ar[r]^g & V \ar[r] & Y } $$ where \begin{enumerate} \item $V$ is a nonempty open of $Y$, \item $X_V = V \times_Y X$, \item $g : Y' \to V$ is a finite universal homeomorphism, \item $X' = (Y' \times_Y X)_{red} = (Y' \times_V X_V)_{red}$, \item $g'$ is a finite universal homeomorphism, \item $Y'$ is an integral affine scheme, \item $f'$ is flat and of finite presentation, and \item the generic fibre of $f'$ is geometrically reduced. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-make-components-generic-fibre-geometrically-irreducible} Let $f : X \to Y$ be a morphism of schemes. Assume that $Y$ is irreducible and $f$ is of finite type. There exists a diagram $$ \xymatrix{ X' \ar[d]_{f'} \ar[r]_{g'} & X_V \ar[r] \ar[d] & X \ar[d]^f \\ Y' \ar[r]^g & V \ar[r] & Y } $$ where \begin{enumerate} \item $V$ is a nonempty open of $Y$, \item $X_V = V \times_Y X$, \item $g : Y' \to V$ is surjective finite \'etale, \item $X' = Y' \times_Y X = Y' \times_V X_V$, \item $g'$ is surjective finite \'etale, \item $Y'$ is an irreducible affine scheme, and \item all irreducible components of the generic fibre of $f'$ are geometrically irreducible. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-relative-assassin-in-neighbourhood} Let $f : X \to S$ be a morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Let $\xi \in \text{Ass}_{X/S}(\mathcal{F})$ and set $Z = \overline{\{\xi\}} \subset X$. If $f$ is locally of finite type and $\mathcal{F}$ is a finite type $\mathcal{O}_X$-module, then there exists a nonempty open $V \subset Z$ such that for every $s \in f(V)$ the generic points of $V_s$ are elements of $\text{Ass}_{X/S}(\mathcal{F})$. \end{lemma} 
\begin{lemma} \label{lemma-bad-case} Let $f : X \to Y$ be a morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Let $U \subset X$ be an open subscheme. Assume \begin{enumerate} \item $f$ is of finite type, \item $\mathcal{F}$ is of finite type, \item $Y$ is irreducible with generic point $\eta$, and \item $\text{Ass}_{X_\eta}(\mathcal{F}_\eta)$ is not contained in $U_\eta$. \end{enumerate} Then there exists a nonempty open subscheme $V \subset Y$ such that for all $y \in V$ the set $\text{Ass}_{X_y}(\mathcal{F}_y)$ is not contained in $U_y$. \end{lemma} 
\begin{lemma} \label{lemma-good-case} Let $f : X \to Y$ be a morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Let $U \subset X$ be an open subscheme. Assume \begin{enumerate} \item $f$ is of finite type, \item $\mathcal{F}$ is of finite type, \item $Y$ is irreducible with generic point $\eta$, and \item $\text{Ass}_{X_\eta}(\mathcal{F}_\eta) \subset U_\eta$. \end{enumerate} Then there exists a nonempty open subscheme $V \subset Y$ such that for all $y \in V$ we have $\text{Ass}_{X_y}(\mathcal{F}_y) \subset U_y$. \end{lemma} 
\begin{lemma} \label{lemma-base-change-assassin-in-U} Let $f : X \to S$ be a morphism which is locally of finite type. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite type. Let $U \subset X$ be an open subscheme. Let $g : S' \to S$ be a morphism of schemes, let $f' : X' = X_{S'} \to S'$ be the base change of $f$, let $g' : X' \to X$ be the projection, set $\mathcal{F}' = (g')^*\mathcal{F}$, and set $U' = (g')^{-1}(U)$. Finally, let $s' \in S'$ with image $s = g(s')$. In this case $$ \text{Ass}_{X_s}(\mathcal{F}_s) \subset U_s \Leftrightarrow \text{Ass}_{X'_{s'}}(\mathcal{F}'_{s'}) \subset U'_{s'}. $$ \end{lemma} 
\begin{lemma} \label{lemma-relative-assassin-constructible} Let $f : X \to Y$ be a morphism of finite presentation. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite presentation. Let $U \subset X$ be an open subscheme such that $U \to Y$ is quasi-compact. Then the set $$ E = \{y \in Y \mid \text{Ass}_{X_y}(\mathcal{F}_y) \subset U_y\} $$ is locally constructible in $Y$. \end{lemma} 
\begin{lemma} \label{lemma-nonreduced-in-neighbourhood} Let $f : X \to Y$ be a morphism of schemes. Assume $Y$ irreducible with generic point $\eta$ and $f$ of finite type. If $X_\eta$ is nonreduced, then there exists a nonempty open $V \subset Y$ such that for all $y \in V$ the fibre $X_y$ is nonreduced. \end{lemma} 
\begin{lemma} \label{lemma-base-change-fibres-geometrically-reduced} Let $f : X \to Y$ be a morphism of schemes. Let $g : Y' \to Y$ be any morphism, and denote $f' : X' \to Y'$ the base change of $f$. Then \begin{align*} \{y' \in Y' \mid X'_{y'}\text{ is geometrically reduced}\} \\ = g^{-1}(\{y \in Y \mid X_y\text{ is geometrically reduced}\}). \end{align*} \end{lemma} 
\begin{lemma} \label{lemma-not-geometrically-reduced-in-neighbourhood} Let $f : X \to Y$ be a morphism of schemes. Assume $Y$ irreducible with generic point $\eta$ and $f$ of finite type. If $X_\eta$ is not geometrically reduced, then there exists a nonempty open $V \subset Y$ such that for all $y \in V$ the fibre $X_y$ is not geometrically reduced. \end{lemma} 
\begin{lemma} \label{lemma-geometrically-reduced-generic-fibre} Let $f : X \to Y$ be a morphism of schemes. Assume \begin{enumerate} \item $Y$ is irreducible with generic point $\eta$, \item $X_\eta$ is geometrically reduced, and \item $f$ is of finite type. \end{enumerate} Then there exists a nonempty open subscheme $V \subset Y$ such that $X_V \to V$ has geometrically reduced fibres. \end{lemma} 
\begin{lemma} \label{lemma-geometrically-reduced-constructible} Let $f : X \to Y$ be a morphism which is quasi-compact and locally of finite presentation. Then the set $$ E = \{y \in Y \mid X_y\text{ is geometrically reduced}\} $$ is locally constructible in $Y$. \end{lemma} 
\begin{lemma} \label{lemma-proper-flat-over-dvr-reduced-fibre} Let $X \to \Spec(R)$ be a proper flat morphism where $R$ is a discrete valuation ring. If the special fibre is reduced, then both $X$ and the generic fibre $X_\eta$ are reduced. \end{lemma} 
\begin{lemma} \label{lemma-geometrically-reduced-open} Let $f : X \to Y$ be a flat proper morphism of finite presentation. Then the set $\{y \in Y \mid X_y\text{ is geometrically reduced}\}$ is open in $Y$. \end{lemma} 
\begin{lemma} \label{lemma-irreducible-components-in-neighbourhood} Let $f : X \to Y$ be a morphism of schemes. Assume $Y$ irreducible with generic point $\eta$ and $f$ of finite type. If $X_\eta$ has $n$ irreducible components, then there exists a nonempty open $V \subset Y$ such that for all $y \in V$ the fibre $X_y$ has at least $n$ irreducible components. \end{lemma} 
\begin{lemma} \label{lemma-base-change-fibres-geometrically-irreducible} Let $f : X \to Y$ be a morphism of schemes. Let $g : Y' \to Y$ be any morphism, and denote $f' : X' \to Y'$ the base change of $f$. Then \begin{align*} \{y' \in Y' \mid X'_{y'}\text{ is geometrically irreducible}\} \\ = g^{-1}(\{y \in Y \mid X_y\text{ is geometrically irreducible}\}). \end{align*} \end{lemma} 
\begin{lemma} \label{lemma-base-change-fibres-nr-geometrically-irreducible-components} Let $f : X \to Y$ be a morphism of schemes. Let $$ n_{X/Y} : Y \to \{0, 1, 2, 3, \ldots, \infty\} $$ be the function which associates to $y \in Y$ the number of irreducible components of $(X_y)_K$ where $K$ is a separably closed extension of $\kappa(y)$. This is well defined and if $g : Y' \to Y$ is a morphism then $$ n_{X'/Y'} = n_{X/Y} \circ g $$ where $X' \to Y'$ is the base change of $f$. \end{lemma} 
\begin{lemma} \label{lemma-irreducible-polynomial-over-domain} Let $A$ be a domain with fraction field $K$. Let $P \in A[x_1, \ldots, x_n]$. Denote $\overline{K}$ the algebraic closure of $K$. Assume $P$ is irreducible in $\overline{K}[x_1, \ldots, x_n]$. Then there exists a $f \in A$ such that $P^\varphi \in \kappa[x_1, \ldots, x_n]$ is irreducible for all homomorphisms $\varphi : A_f \to \kappa$ into fields. \end{lemma} 
\begin{lemma} \label{lemma-geom-irreducible-generic-fibre} Let $f : X \to Y$ be a morphism of schemes. Assume \begin{enumerate} \item $Y$ is irreducible with generic point $\eta$, \item $X_\eta$ is geometrically irreducible, and \item $f$ is of finite type. \end{enumerate} Then there exists a nonempty open subscheme $V \subset Y$ such that $X_V \to V$ has geometrically irreducible fibres. \end{lemma} 
\begin{lemma} \label{lemma-nr-geom-irreducible-components-good} Let $f : X \to Y$ be a morphism of schemes. Let $n_{X/Y}$ be the function on $Y$ counting the numbers of geometrically irreducible components of fibres of $f$ introduced in Lemma \ref{lemma-base-change-fibres-nr-geometrically-irreducible-components}. Assume $f$ of finite type. Let $y \in Y$ be a point. Then there exists a nonempty open $V \subset \overline{\{y\}}$ such that $n_{X/Y}|_V$ is constant. \end{lemma} 
\begin{lemma} \label{lemma-nr-geom-irreducible-components-constructible} Let $f : X \to Y$ be a morphism of schemes. Let $n_{X/Y}$ be the function on $Y$ counting the numbers of geometrically irreducible components of fibres of $f$ introduced in Lemma \ref{lemma-base-change-fibres-nr-geometrically-irreducible-components}. Assume $f$ of finite presentation. Then the level sets $$ E_n = \{y \in Y \mid n_{X/Y}(y) = n\} $$ of $n_{X/Y}$ are locally constructible in $Y$. \end{lemma} 
\begin{lemma} \label{lemma-connected-components-in-neighbourhood} Let $f : X \to Y$ be a morphism of schemes. Assume $Y$ irreducible with generic point $\eta$ and $f$ of finite type. If $X_\eta$ has $n$ connected components, then there exists a nonempty open $V \subset Y$ such that for all $y \in V$ the fibre $X_y$ has at least $n$ connected components. \end{lemma} 
\begin{lemma} \label{lemma-base-change-fibres-geometrically-connected} Let $f : X \to Y$ be a morphism of schemes. Let $g : Y' \to Y$ be any morphism, and denote $f' : X' \to Y'$ the base change of $f$. Then \begin{align*} \{y' \in Y' \mid X'_{y'}\text{ is geometrically connected}\} \\ = g^{-1}(\{y \in Y \mid X_y\text{ is geometrically connected}\}). \end{align*} \end{lemma} 
\begin{lemma} \label{lemma-base-change-fibres-nr-geometrically-connected-components} Let $f : X \to Y$ be a morphism of schemes. Let $$ n_{X/Y} : Y \to \{0, 1, 2, 3, \ldots, \infty\} $$ be the function which associates to $y \in Y$ the number of connected components of $(X_y)_K$ where $K$ is a separably closed extension of $\kappa(y)$. This is well defined and if $g : Y' \to Y$ is a morphism then $$ n_{X'/Y'} = n_{X/Y} \circ g $$ where $X' \to Y'$ is the base change of $f$. \end{lemma} 
\begin{lemma} \label{lemma-geometrically-connected-generic-fibre} Let $f : X \to Y$ be a morphism of schemes. Assume \begin{enumerate} \item $Y$ is irreducible with generic point $\eta$, \item $X_\eta$ is geometrically connected, and \item $f$ is of finite type. \end{enumerate} Then there exists a nonempty open subscheme $V \subset Y$ such that $X_V \to V$ has geometrically connected fibres. \end{lemma} 
\begin{lemma} \label{lemma-nr-geom-connected-components-good} Let $f : X \to Y$ be a morphism of schemes. Let $n_{X/Y}$ be the function on $Y$ counting the numbers of geometrically connected components of fibres of $f$ introduced in Lemma \ref{lemma-base-change-fibres-nr-geometrically-connected-components}. Assume $f$ of finite type. Let $y \in Y$ be a point. Then there exists a nonempty open $V \subset \overline{\{y\}}$ such that $n_{X/Y}|_V$ is constant. \end{lemma} 
\begin{lemma} \label{lemma-nr-geom-connected-components-constructible} Let $f : X \to Y$ be a morphism of schemes. Let $n_{X/Y}$ be the function on $Y$ counting the numbers of geometric connected components of fibres of $f$ introduced in Lemma \ref{lemma-base-change-fibres-nr-geometrically-connected-components}. Assume $f$ of finite presentation. Then the level sets $$ E_n = \{y \in Y \mid n_{X/Y}(y) = n\} $$ of $n_{X/Y}$ are locally constructible in $Y$. \end{lemma} 
\begin{lemma} \label{lemma-connected-flat-over-dvr} \begin{slogan} A flat degeneration of a disconnected scheme is either disconnected or nonreduced. \end{slogan} Let $f : X \to S$ be a morphism of schemes. Assume that \begin{enumerate} \item $S$ is the spectrum of a discrete valuation ring, \item $f$ is flat, \item $X$ is connected, \item the closed fibre $X_s$ is reduced. \end{enumerate} Then the generic fibre $X_\eta$ is connected. \end{lemma} 
\begin{lemma} \label{lemma-base-change-connected-along-section} Let $f : X \to Y$, $s : Y \to X$ be as in Situation \ref{situation-connected-along-section}. If $g : Y' \to Y$ is any morphism, consider the base change diagram $$ \xymatrix{ X' \ar[r]_{g'} \ar[d]^{f'} & X \ar[d]_f \\ Y' \ar@/^1pc/[u]^{s'} \ar[r]^g & Y \ar@/_1pc/[u]_s } $$ so that we obtain $(X')^0 \subset X'$. Then $(X')^0 = (g')^{-1}(X^0)$. \end{lemma} 
\begin{lemma} \label{lemma-connected-along-section-good} Let $f : X \to Y$, $s : Y \to X$ be as in Situation \ref{situation-connected-along-section}. Assume $f$ of finite type. Let $y \in Y$ be a point. Then there exists a nonempty open $V \subset \overline{\{y\}}$ such that the inverse image of $X^0$ in the base change $X_V$ is open and closed in $X_V$. \end{lemma} 
\begin{lemma} \label{lemma-connected-along-section-locally-constructible} Let $f : X \to Y$, $s : Y \to X$ be as in Situation \ref{situation-connected-along-section}. If $f$ is of finite presentation then $X^0$ is locally constructible in $X$. \end{lemma} 
\begin{lemma} \label{lemma-connected-along-section-open-neighbourhood} Let $f : X \to Y$, $s : Y \to X$ be as in Situation \ref{situation-connected-along-section}. Let $y \in Y$ be a point. Assume \begin{enumerate} \item $f$ is of finite presentation and flat, and \item the fibre $X_y$ is geometrically reduced. \end{enumerate} Then $X^0$ is a neighbourhood of $X^0_y$ in $X$. \end{lemma} 
\begin{lemma} \label{lemma-connected-along-section-open} Let $f : X \to Y$, $s : Y \to X$ be as in Situation \ref{situation-connected-along-section}. Assume \begin{enumerate} \item $f$ is of finite presentation and flat, and \item all fibres of $f$ are geometrically reduced. \end{enumerate} Then $X^0$ is open in $X$. \end{lemma} 
\begin{lemma} \label{lemma-dimension-in-neighbourhood} Let $f : X \to Y$ be a morphism of schemes. Assume $Y$ irreducible with generic point $\eta$ and $f$ of finite type. If $X_\eta$ has dimension $n$, then there exists a nonempty open $V \subset Y$ such that for all $y \in V$ the fibre $X_y$ has dimension $n$. \end{lemma} 
\begin{lemma} \label{lemma-base-change-dimension-fibres} Let $f : X \to Y$ be a morphism of finite type. Let $$ n_{X/Y} : Y \to \{0, 1, 2, 3, \ldots, \infty\} $$ be the function which associates to $y \in Y$ the dimension of $X_y$. If $g : Y' \to Y$ is a morphism then $$ n_{X'/Y'} = n_{X/Y} \circ g $$ where $X' \to Y'$ is the base change of $f$. \end{lemma} 
\begin{lemma} \label{lemma-dimension-fibres-constructible} Let $f : X \to Y$ be a morphism of schemes. Let $n_{X/Y}$ be the function on $Y$ giving the dimension of fibres of $f$ introduced in Lemma \ref{lemma-base-change-dimension-fibres}. Assume $f$ of finite presentation. Then the level sets $$ E_n = \{y \in Y \mid n_{X/Y}(y) = n\} $$ of $n_{X/Y}$ are locally constructible in $Y$. \end{lemma} 
\begin{lemma} \label{lemma-dimension-fibres-flat} Let $f : X \to Y$ be a flat morphism of schemes of finite presentation. Let $n_{X/Y}$ be the function on $Y$ giving the dimension of fibres of $f$ introduced in Lemma \ref{lemma-base-change-dimension-fibres}. Then $n_{X/Y}$ is lower semi-continuous. \end{lemma} 
\begin{lemma} \label{lemma-dimension-fibres-proper} Let $f : X \to Y$ be a proper morphism of schemes. Let $n_{X/Y}$ be the function on $Y$ giving the dimension of fibres of $f$ introduced in Lemma \ref{lemma-base-change-dimension-fibres}. Then $n_{X/Y}$ is upper semi-continuous. \end{lemma} 
\begin{lemma} \label{lemma-dimension-fibres-proper-flat} Let $f : X \to Y$ be a proper, flat morphism of schemes of finite presentation. Let $n_{X/Y}$ be the function on $Y$ giving the dimension of fibres of $f$ introduced in Lemma \ref{lemma-base-change-dimension-fibres}. Then $n_{X/Y}$ is locally constant. \end{lemma} 
\begin{lemma} \label{lemma-silly} Let $R$ be a ring. Let $\mathfrak p_1, \ldots, \mathfrak p_r$ be prime ideals of $R$ with $\mathfrak p_i \not \subset \mathfrak p_j$ if $i \not = j$. Let $k_i \subset \kappa(\mathfrak p_i)$ be subfields such that the extensions $\kappa(\mathfrak p_i)/k_i$ are not algebraic. Let $J \subset R$ be an ideal not contained in any of the $\mathfrak p_i$. Then there exists an element $x \in J$ such that the image of $x$ in $\kappa(\mathfrak p_i)$ is transcendental over $k_i$ for $i = 1, \ldots, r$. \end{lemma} 
\begin{lemma} \label{lemma-sum-is-ok} Let $R \to S$ be a finite type ring map. Let $d \geq 0$. Let $a, b \in S$. Assume that the fibres of $$ f_a : \Spec(S) \longrightarrow \mathbf{A}^1_R $$ given by the $R$-algebra map $R[x] \to S$ sending $x$ to $a$ have dimension $\leq d$. Then there exists an $n_0$ such that for $n \geq n_0$ the fibres of $$ f_{a^n + b} : \Spec(S) \longrightarrow \mathbf{A}^1_R $$ given by the $R$-algebra map $R[x] \to S$ sending $x$ to $a^n + b$ have dimension $\leq d$. \end{lemma} 
\begin{lemma} \label{lemma-weak-relative-noether-normalization} Let $R \to S$ be a finite type ring map. Let $d$ be the maximum of the dimensions of fibres of $\Spec(S) \to \Spec(R)$. Then there exists a quasi-finite ring map $R[t_1, \ldots, t_d] \to S$. \end{lemma} 
\begin{lemma} \label{lemma-amazing-bertini-lemma} \begin{reference} See pages 71 and 72 of \cite{Jou} \end{reference} Let $K/k$ be a geometrically irreducible and finitely generated field extension. Let $n \geq 1$. Let $g_1, \ldots, g_n \in K$ be elements such that there exist $c_1, \ldots, c_n \in k$ such that the elements $$ x_1, \ldots, x_n, \sum g_ix_i, \sum c_ig_i \in K(x_1, \ldots, x_n) $$ are algebraically independent over $k$. Then $K(x_1, \ldots, x_n)$ is geometrically irreducible over $k(x_1, \ldots, x_n, \sum g_ix_i)$. \end{lemma} 
\begin{lemma} \label{lemma-algebraically-independent} Let $A$ be a domain of finite type over a field $k$. Let $n \geq 2$. Let $g_1, \ldots, g_n \in A$ be elements such that $V(g_1, g_2)$ has an irreducible component of dimension $\dim(A) - 2$. Then there exist $c_1, \ldots, c_n \in k$ such that the elements $$ x_1, \ldots, x_n, \sum g_ix_i, \sum c_ig_i \in \text{Frac}(A)(x_1, \ldots, x_n) $$ are algebraically independent over $k$. \end{lemma} 
\begin{lemma} \label{lemma-bertini-irreducible} \begin{reference} \cite[Theorem 6.3 part 4)]{Jou} \end{reference} In Varieties, Situation \ref{varieties-situation-family-divisors} assume \begin{enumerate} \item $X$ is of finite type over $k$, \item $X$ is geometrically irreducible over $k$, \item there exist $v_1, v_2, v_3 \in V$ and an irreducible component $Z$ of $H_{v_2} \cap H_{v_3}$ such that $Z \not \subset H_{v_1}$ and $\text{codim}(Z, X) = 2$, and \item every irreducible component $Y$ of $\bigcap_{v \in V} H_v$ has $\text{codim}(Y, X) \geq 2$. \end{enumerate} Then for general $v \in V \otimes_k k'$ the scheme $H_v$ is geometrically irreducible over $k'$. \end{lemma} 
\begin{lemma} \label{lemma-diagonal-picard-flat-proper} Let $f : X \to S$ be a flat, proper morphism of finite presentation. Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module. For a morphism $g : T \to S$ consider the base change diagram $$ \xymatrix{ X_T \ar[d]_p \ar[r]_q & X \ar[d]^f \\ T \ar[r]^g & S } $$ Assume $\mathcal{O}_T \to p_*\mathcal{O}_{X_T}$ is an isomorphism for all $g : T \to S$. Then there exists an immersion $j : Z \to S$ of finite presentation such that a morphism $g : T \to S$ factors through $Z$ if and only if there exists a finite locally free $\mathcal{O}_T$-module $\mathcal{N}$ with $p^*\mathcal{N} \cong q^*\mathcal{E}$. \end{lemma} 
\begin{lemma} \label{lemma-trivial-on-fibres} Let $f : X \to S$ be a flat, proper morphism of finite presentation such that $f_*\mathcal{O}_X = \mathcal{O}_S$ and this remains true after arbitrary base change. Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module. Assume \begin{enumerate} \item $\mathcal{E}|_{X_s}$ is isomorphic to $\mathcal{O}_{X_s}^{\oplus r_s}$ for all $s \in S$, and \item $S$ is reduced. \end{enumerate} Then $\mathcal{E} = f^*\mathcal{N}$ for some finite locally free $\mathcal{O}_S$-module $\mathcal{N}$. \end{lemma} 
\begin{lemma} \label{lemma-triviality-generic-fibre-valuation-ring} Let $f : X \to S$ be a proper flat morphism of finite presentation. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Assume \begin{enumerate} \item $S$ is the spectrum of a valuation ring, \item $\mathcal{L}$ is trivial on the generic fibre $X_\eta$ of $f$, \item the closed fibre $X_0$ of $f$ is integral, \item $H^0(X_\eta, \mathcal{O}_{X_\eta})$ is equal to the function field of $S$. \end{enumerate} Then $\mathcal{L}$ is trivial. \end{lemma} 
\begin{lemma} \label{lemma-get-a-closed} Let $f : X \to S$ and $\mathcal{E}$ be as in Lemma \ref{lemma-diagonal-picard-flat-proper} and in addition assume $\mathcal{E}$ is an invertible $\mathcal{O}_X$-module. If moreover the geometric fibres of $f$ are integral, then $Z$ is closed in $S$. \end{lemma} 
\begin{lemma} \label{lemma-H1-O-picard-flat-proper} Consider a commutative diagram of schemes $$ \xymatrix{ X' \ar[rr] \ar[dr]_{f'} & & X \ar[dl]^f \\ & S } $$ with $f' : X' \to S$ and $f : X \to S$ satisfying the hypotheses of Lemma \ref{lemma-diagonal-picard-flat-proper}. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module and let $\mathcal{L}'$ be the pullback to $X'$. Let $Z \subset S$, resp.\ $Z' \subset S$ be the locally closed subscheme constructed in Lemma \ref{lemma-diagonal-picard-flat-proper} for $(f, \mathcal{L})$, resp.\ $(f', \mathcal{L}')$ so that $Z \subset Z'$. If $s \in Z$ and $$ H^1(X_s, \mathcal{O}) \longrightarrow H^1(X'_s, \mathcal{O}) $$ is injective, then $Z \cap U = Z' \cap U$ for some open neighbourhood $U$ of $s$. \end{lemma} 
\begin{lemma} \label{lemma-H1-O-multiple-picard-flat-proper} Consider $n$ commutative diagrams of schemes $$ \xymatrix{ X_i \ar[rr] \ar[dr]_{f_i} & & X \ar[dl]^f \\ & S } $$ with $f_i : X_i \to S$ and $f : X \to S$ satisfying the hypotheses of Lemma \ref{lemma-diagonal-picard-flat-proper}. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module and let $\mathcal{L}_i$ be the pullback to $X_i$. Let $Z \subset S$, resp.\ $Z_i \subset S$ be the locally closed subscheme constructed in Lemma \ref{lemma-diagonal-picard-flat-proper} for $(f, \mathcal{L})$, resp.\ $(f_i, \mathcal{L}_i)$ so that $Z \subset \bigcap_{i = 1, \ldots, n} Z_i$. If $s \in Z$ and $$ H^1(X_s, \mathcal{O}) \longrightarrow \bigoplus\nolimits_{i = 1, \ldots, n} H^1(X_{i, s}, \mathcal{O}) $$ is injective, then $Z \cap U = (\bigcap_{i = 1, \ldots, n} Z_i) \cap U$ (scheme theoretic intersection) for some open neighbourhood $U$ of $s$. \end{lemma} 
\begin{lemma} \label{lemma-pic-of-product} Let $f : X \to S$ and $g : Y \to S$ be morphisms of schemes satisfying the hypotheses of Lemma \ref{lemma-diagonal-picard-flat-proper}. Let $\sigma : S \to X$ and $\tau : S \to Y$ be sections of $f$ and $g$. Let $s \in S$. Let $\mathcal{L}$ be an invertible sheaf on $X \times_S Y$. If $(1 \times \tau)^*\mathcal{L}$ on $X$, $(\sigma \times 1)^*\mathcal{L}$ on $Y$, and $\mathcal{L}|_{(X \times_S Y)_s}$ are trivial, then there is an open neighbourhood $U$ of $s$ such that $\mathcal{L}$ is trivial over $(X \times_S Y)_U$. \end{lemma} 
\begin{theorem}[Theorem of the cube] \label{theorem-of-the-cube} Let $S$ be a scheme. Let $X$, $Y$, and $Z$ be schemes over $S$. Let $x : S \to X$ and $y : S \to Y$ be sections of the structure morphisms. Let $\mathcal{L}$ be an invertible module on $X \times_S Y \times_S Z$. If \begin{enumerate} \item $X \to S$ and $Y \to S$ are flat, proper morphisms of finite presentation with geometrically integral fibres, \item the pullbacks of $\mathcal{L}$ by $x \times \text{id}_Y \times \text{id}_Z$ and $\text{id}_X \times y \times \text{id}_Z$ are trivial over $Y \times_S Z$ and $X \times_S Z$, \item there is a point $z \in Z$ such that $\mathcal{L}$ restricted to $X \times_S Y \times_S z$ is trivial, and \item $Z$ is connected, \end{enumerate} then $\mathcal{L}$ is trivial. \end{theorem} 
\begin{lemma} \label{lemma-Noetherian-approximation} Let $f : X \to S$ be a morphism of affine schemes, which is of finite presentation. Then there exists a cartesian diagram $$ \xymatrix{ X_0 \ar[d]_{f_0} & X \ar[l]^g \ar[d]^f \\ S_0 & S \ar[l] } $$ such that \begin{enumerate} \item $X_0$, $S_0$ are affine schemes, \item $S_0$ of finite type over $\mathbf{Z}$, \item $f_0$ is of finite type. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-Noetherian-approximation-module} Let $f : X \to S$ be a morphism of affine schemes, which is of finite presentation. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite presentation. Then there exists a diagram as in Lemma \ref{lemma-Noetherian-approximation} such that there exists a coherent $\mathcal{O}_{X_0}$-module $\mathcal{F}_0$ with $g^*\mathcal{F}_0 = \mathcal{F}$. \end{lemma} 
\begin{lemma} \label{lemma-Noetherian-approximation-flat-module} Let $f : X \to S$ be a morphism of affine schemes, which is of finite presentation. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module of finite presentation and flat over $S$. Then we may choose a diagram as in Lemma \ref{lemma-Noetherian-approximation-module} and sheaf $\mathcal{F}_0$ such that in addition $\mathcal{F}_0$ is flat over $S_0$. \end{lemma} 
\begin{lemma} \label{lemma-Noetherian-approximation-flat} Let $f : X \to S$ be a morphism of affine schemes, which is of finite presentation and flat. Then there exists a diagram as in Lemma \ref{lemma-Noetherian-approximation} such that in addition $f_0$ is flat. \end{lemma} 
\begin{lemma} \label{lemma-Noetherian-approximation-smooth} Let $f : X \to S$ be a morphism of affine schemes, which is smooth. Then there exists a diagram as in Lemma \ref{lemma-Noetherian-approximation} such that in addition $f_0$ is smooth. \end{lemma} 
\begin{lemma} \label{lemma-Noetherian-approximation-geometrically-reduced} Let $f : X \to S$ be a morphism of affine schemes, which is of finite presentation with geometrically reduced fibres. Then there exists a diagram as in Lemma \ref{lemma-Noetherian-approximation} such that in addition $f_0$ has geometrically reduced fibres. \end{lemma} 
\begin{lemma} \label{lemma-Noetherian-approximation-geometrically-irreducible} Let $f : X \to S$ be a morphism of affine schemes, which is of finite presentation with geometrically irreducible fibres. Then there exists a diagram as in Lemma \ref{lemma-Noetherian-approximation} such that in addition $f_0$ has geometrically irreducible fibres. \end{lemma} 
\begin{lemma} \label{lemma-Noetherian-approximation-geometrically-connected} Let $f : X \to S$ be a morphism of affine schemes, which is of finite presentation with geometrically connected fibres. Then there exists a diagram as in Lemma \ref{lemma-Noetherian-approximation} such that in addition $f_0$ has geometrically connected fibres. \end{lemma} 
\begin{lemma} \label{lemma-Noetherian-approximation-dimension-d} Let $d \geq 0$ be an integer. Let $f : X \to S$ be a morphism of affine schemes, which is of finite presentation all of whose fibres have dimension $d$. Then there exists a diagram as in Lemma \ref{lemma-Noetherian-approximation} such that in addition all fibres of $f_0$ have dimension $d$. \end{lemma} 
\begin{lemma} \label{lemma-Noetherian-approximation-standard-syntomic} Let $f : X \to S$ be a morphism of affine schemes, which is standard syntomic (see Morphisms, Definition \ref{morphisms-definition-syntomic}). Then there exists a diagram as in Lemma \ref{lemma-Noetherian-approximation} such that in addition $f_0$ is standard syntomic. \end{lemma} 
\begin{lemma} \label{lemma-Noetherian-approximation-combine} (Noetherian approximation and combining properties.) Let $P$, $Q$ be properties of morphisms of schemes which are stable under base change. Let $f : X \to S$ be a morphism of finite presentation of affine schemes. Assume we can find cartesian diagrams $$ \vcenter{ \xymatrix{ X_1 \ar[d]_{f_1} & X \ar[l] \ar[d]^f \\ S_1 & S \ar[l] } } \quad\text{and}\quad \vcenter{ \xymatrix{ X_2 \ar[d]_{f_2} & X \ar[l] \ar[d]^f \\ S_2 & S \ar[l] } } $$ of affine schemes, with $S_1$, $S_2$ of finite type over $\mathbf{Z}$ and $f_1$, $f_2$ of finite type such that $f_1$ has property $P$ and $f_2$ has property $Q$. Then we can find a cartesian diagram $$ \xymatrix{ X_0 \ar[d]_{f_0} & X \ar[l] \ar[d]^f \\ S_0 & S \ar[l] } $$ of affine schemes with $S_0$ of finite type over $\mathbf{Z}$ and $f_0$ of finite type such that $f_0$ has both property $P$ and property $Q$. \end{lemma} 
\begin{definition} \label{definition-etale-neighbourhood} Let $S$ be a scheme. Let $s \in S$ be a point. \begin{enumerate} \item An {\it \'etale neighbourhood of $(S, s)$} is a pair $(U, u)$ together with an \'etale morphism of schemes $\varphi : U \to S$ such that $\varphi(u) = s$. \item A {\it morphism of \'etale neighbourhoods} $f : (V, v) \to (U, u)$ of $(S, s)$ is simply a morphism of $S$-schemes $f : V \to U$ such that $f(v) = u$. \item An {\it elementary \'etale neighbourhood} is an \'etale neighbourhood $\varphi : (U, u) \to (S, s)$ such that $\kappa(s) = \kappa(u)$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-realize-prescribed-residue-field-extension-etale} Let $S$ be a scheme. Let $s \in S$. Let $k/\kappa(s)$ be a finite separable field extension. Then there exists an \'etale neighbourhood $(U, u) \to (S, s)$ such that the field extension $\kappa(u)/\kappa(s)$ is isomorphic to $k/\kappa(s)$. \end{lemma} 
\begin{lemma} \label{lemma-etale-neighbourhoods-not-quite-filtered} Let $S$ be a scheme, and let $s$ be a point of $S$. The category of \'etale neighborhoods has the following properties: \begin{enumerate} \item Let $(U_i, u_i)_{i=1, 2}$ be two \'etale neighborhoods of $s$ in $S$. Then there exists a third \'etale neighborhood $(U, u)$ and morphisms $(U, u) \to (U_i, u_i)$, $i = 1, 2$. \item Let $h_1, h_2: (U, u) \to (U', u')$ be two morphisms between \'etale neighborhoods of $s$. Assume $h_1$, $h_2$ induce the same map $\kappa(u') \to \kappa(u)$ of residue fields. Then there exist an \'etale neighborhood $(U'', u'')$ and a morphism $h : (U'', u'') \to (U, u)$ which equalizes $h_1$ and $h_2$, i.e., such that $h_1 \circ h = h_2 \circ h$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-elementary-etale-neighbourhoods} Let $S$ be a scheme, and let $s$ be a point of $S$. The category of elementary \'etale neighborhoods of $(S, s)$ is cofiltered (see Categories, Definition \ref{categories-definition-codirected}). \end{lemma} 
\begin{lemma} \label{lemma-describe-henselization} Let $S$ be a scheme. Let $s \in S$. Then we have $$ \mathcal{O}_{S, s}^h = \colim_{(U, u)} \mathcal{O}(U) $$ where the colimit is over the filtered category which is opposite to the category of elementary \'etale neighbourhoods $(U, u)$ of $(S, s)$. \end{lemma} 
\begin{lemma} \label{lemma-lift-etale-neighbourhood-fibre} \begin{slogan} Lift \'etale neighbourhood of point on fibre to total space. \end{slogan} Let $X \to S$ be a morphism of schemes. Let $x \in X$ with image $s \in S$. Let $(V, v) \to (X_s, x)$ be an \'etale neighbourhood. Then there exists an \'etale neighbourhood $(U, u) \to (X, x)$ such that there exists a morphism $(U_s, u) \to (V, v)$ of \'etale neighbourhoods of $(X_s, x)$ which is an open immersion. \end{lemma} 
\begin{lemma} \label{lemma-nr-minimal-primes} Let $R = \colim R_i$ be colimit of a directed system of rings whose transition maps are faithfully flat. Then the number of minimal primes of $R$ taken as an element of $\{0, 1, 2, \ldots, \infty\}$ is the supremum of the numbers of minimal primes of the $R_i$. \end{lemma} 
\begin{lemma} \label{lemma-nr-branches} Let $X$ be a scheme and $x \in X$ a point. Then \begin{enumerate} \item the number of branches of $X$ at $x$ is equal to the supremum of the number of irreducible components of $U$ passing through $u$ taken over elementary \'etale neighbourhoods $(U, u) \to (X, x)$, \item the number of geometric branches of $X$ at $x$ is equal to the supremum of the number of irreducible components of $U$ passing through $u$ taken over \'etale neighbourhoods $(U, u) \to (X, x)$, \item $X$ is unibranch at $x$ if and only if for every elementary \'etale neighbourhood $(U, u) \to (X, x)$ there is exactly one irreducible component of $U$ passing through $u$, and \item $X$ is geometrically unibranch at $x$ if and only if for every \'etale neighbourhood $(U, u) \to (X, x)$ there is exactly one irreducible component of $U$ passing through $u$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-nr-branches-fibre} Let $X \to S$ be a morphism of schemes and $x \in X$ a point with image $s$. Then \begin{enumerate} \item the number of branches of the fibre $X_s$ at $x$ is equal to the supremum of the number of irreducible components of the fibre $U_s$ passing through $u$ taken over elementary \'etale neighbourhoods $(U, u) \to (X, x)$, \item the number of geometric branches of the fibre $X_s$ at $x$ is equal to the supremum of the number of irreducible components of the fibre $U_s$ passing through $u$ taken over \'etale neighbourhoods $(U, u) \to (X, x)$, \item the fibre $X_s$ is unibranch at $x$ if and only if for every elementary \'etale neighbourhood $(U, u) \to (X, x)$ there is exactly one irreducible component of the fibre $U_s$ passing through $u$, and \item $X$ is geometrically unibranch at $x$ if and only if for every \'etale neighbourhood $(U, u) \to (X, x)$ there is exactly one irreducible component of $U_s$ passing through $u$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-number-of-branches-and-smooth} Let $X \to S$ be a smooth morphism of schemes. Let $x \in X$ with image $s \in S$. Then \begin{enumerate} \item The number of geometric branches of $X$ at $x$ is equal to the number of geometric branches of $S$ at $s$. \item If $\kappa(x)/\kappa(s)$ is a purely inseparable\footnote{In fact, it would suffice if $\kappa(x)$ is geometrically irreducible over $\kappa(s)$. If we ever need this we will add a detailed proof.} extension of fields, then number of branches of $X$ at $x$ is equal to the number of branches of $S$ at $s$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-unramified-dominant-unibranch-is-etale} Let $f : X \to Y$ be a morphism of schemes. Let $x \in X$ with image $y \in Y$. Assume \begin{enumerate} \item $Y$ is integral and geometrically unibranch at $y$, \item $f$ is locally of finite type, \item there is a specialization $x' \leadsto x$ such that $f(x')$ is the generic point of $Y$, \item $f$ is unramified at $x$. \end{enumerate} Then $f$ is \'etale at $x$. \end{lemma} 
\begin{lemma} \label{lemma-global-unramified-dominant-unibranch-is-etale} \begin{reference} \cite[Expose I, Corollary 9.11]{SGA1} \end{reference} Let $f : X \to Y$ be a morphism of schemes. Assume \begin{enumerate} \item $Y$ is integral and geometrically unibranch, \item at least one irreducible component of $X$ dominates $Y$, \item $f$ is unramified, and \item $X$ is connected. \end{enumerate} Then $f$ is \'etale and $X$ is irreducible. \end{lemma} 
\begin{lemma} \label{lemma-weird-permanence-etale} Let $f : X \to Y$ and $g : Y \to Z$ be morphisms of schemes. Let $x \in X$ with image $y \in Y$. Assume \begin{enumerate} \item $Y$ is integral and geometrically unibranch at $y$, \item $g \circ f$ is \'etale at $x$, \item there is a specialization $x' \leadsto x$ such that $f(x')$ is the generic point of $Y$. \end{enumerate} Then $f$ is \'etale at $x$ and $g$ is \'etale at $y$. \end{lemma} 
\begin{lemma} \label{lemma-global-weird-permanence-etale} Let $f : X \to Y$ and $g : Y \to Z$ be morphisms of schemes. Assume \begin{enumerate} \item $Y$ is integral and geometrically unibranch, \item $g \circ f$ is \'etale, \item every irreducible component of $X$ dominates $Y$. \end{enumerate} Then $f$ is \'etale and $g$ is \'etale at every point in the image of $f$. \end{lemma} 
\begin{lemma} \label{lemma-slice-smooth-given-element} Let $f : X \to S$ be a morphism of schemes. Let $x \in X$ be a point with image $s \in S$. Let $h \in \mathfrak m_x \subset \mathcal{O}_{X, x}$. Assume \begin{enumerate} \item $f$ is smooth at $x$, and \item the image $\text{d}\overline{h}$ of $\text{d}h$ in $$ \Omega_{X_s/s, x} \otimes_{\mathcal{O}_{X_s, x}} \kappa(x) = \Omega_{X/S, x} \otimes_{\mathcal{O}_{X, x}} \kappa(x) $$ is nonzero. \end{enumerate} Then there exists an affine open neighbourhood $U \subset X$ of $x$ such that $h$ comes from $h \in \Gamma(U, \mathcal{O}_U)$ and such that $D = V(h)$ is an effective Cartier divisor in $U$ with $x \in D$ and $D \to S$ smooth. \end{lemma} 
\begin{lemma} \label{lemma-slice-smooth-once} Let $f : X \to S$ be a morphism of schemes. Let $x \in X$ be a point with image $s \in S$. Assume \begin{enumerate} \item $f$ is smooth at $x$, and \item the map $$ \Omega_{X_s/s, x} \otimes_{\mathcal{O}_{X_s, x}} \kappa(x) \longrightarrow \Omega_{\kappa(x)/\kappa(s)} $$ has a nonzero kernel. \end{enumerate} Then there exists an affine open neighbourhood $U \subset X$ of $x$ and an effective Cartier divisor $D \subset U$ containing $x$ such that $D \to S$ is smooth. \end{lemma} 
\begin{lemma} \label{lemma-slice-smooth-once-separable-residue-field-extension} Let $f : X \to S$ be a morphism of schemes. Let $x \in X$ be a point with image $s \in S$. Assume \begin{enumerate} \item $f$ is smooth at $x$, \item the residue field extension $\kappa(x)/\kappa(s)$ is separable, and \item $x$ is not a generic point of $X_s$. \end{enumerate} Then there exists an affine open neighbourhood $U \subset X$ of $x$ and an effective Cartier divisor $D \subset U$ containing $x$ such that $D \to S$ is smooth. \end{lemma} 
\begin{lemma} \label{lemma-slice-smooth} Let $f : X \to S$ be a morphism of schemes. Let $x \in X$ be a point with image $s \in S$. Assume \begin{enumerate} \item $f$ is smooth at $x$, and \item $x$ is a closed point of $X_s$ and $\kappa(s) \subset \kappa(x)$ is separable. \end{enumerate} Then there exists an immersion $Z \to X$ containing $x$ such that \begin{enumerate} \item $Z \to S$ is \'etale, and \item $Z_s = \{x\}$ set theoretically. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-etale-nbhd-dominates-smooth} Let $f : X \to S$ be a smooth morphism of schemes. Let $s \in S$ be a point in the image of $f$. Then there exists an \'etale neighbourhood $(S', s') \to (S, s)$ and a $S$-morphism $S' \to X$. \end{lemma} 
\begin{lemma} \label{lemma-etale-dominates-smooth} Let $S$ be a scheme. Let $\mathcal{U} = \{S_i \to S\}_{i \in I}$ be a smooth covering of $S$, see Topologies, Definition \ref{topologies-definition-smooth-covering}. Then there exists an \'etale covering $\mathcal{V} = \{T_j \to S\}_{j \in J}$ (see Topologies, Definition \ref{topologies-definition-etale-covering}) which refines (see Sites, Definition \ref{sites-definition-morphism-coverings}) $\mathcal{U}$. \end{lemma} 
\begin{lemma} \label{lemma-cover-smooth-by-special} Let $f : X \to S$ be a smooth morphism of schemes. Then there exists an \'etale covering $\{U_i \to X\}_{i \in I}$ such that $U_i \to S$ factors as $U_i \to V_i \to S$ where $V_i \to S$ is \'etale and $U_i \to V_i$ is a smooth morphism of affine schemes, which has a section, and has geometrically connected fibres. \end{lemma} 
\begin{lemma} \label{lemma-map-approximation} Let $S$ be a locally Noetherian scheme. Let $X$, $Y$ be schemes locally of finite type over $S$. Let $x \in X$ and $y \in Y$ be points lying over the same point $s \in S$. Assume $\mathcal{O}_{S, s}$ is a G-ring. Assume further we are given a local $\mathcal{O}_{S, s}$-algebra map $$ \varphi : \mathcal{O}_{Y, y} \longrightarrow \mathcal{O}_{X, x}^\wedge $$ For every $N \geq 1$ there exists an elementary \'etale neighbourhood $(U, u) \to (X, x)$ and an $S$-morphism $f : U \to Y$ mapping $u$ to $y$ such that the diagram $$ \xymatrix{ \mathcal{O}_{X, x}^\wedge \ar[r] & \mathcal{O}_{U, u}^\wedge \\ \mathcal{O}_{Y, y} \ar[r]^{f^\sharp_u} \ar[u]^\varphi & \mathcal{O}_{U, u} \ar[u] } $$ commutes modulo $\mathfrak m_u^N$. \end{lemma} 
\begin{lemma} \label{lemma-isomorphism-approximation} Let $S$ be a locally Noetherian scheme. Let $X$, $Y$ be schemes locally of finite type over $S$. Let $x \in X$ and $y \in Y$ be points lying over the same point $s \in S$. Assume $\mathcal{O}_{S, s}$ is a G-ring. Assume we have an $\mathcal{O}_{S, s}$-algebra isomorphism $$ \varphi : \mathcal{O}_{Y, y}^\wedge \longrightarrow \mathcal{O}_{X, x}^\wedge $$ between the complete local rings. Then for every $N \geq 1$ there exists morphisms $$ (X, x) \leftarrow (U, u) \rightarrow (Y, y) $$ of pointed schemes over $S$ such that both arrows define elementary \'etale neighbourhoods and such that the diagram $$ \xymatrix{ & \mathcal{O}_{U, u}^\wedge \\ \mathcal{O}_{Y, y}^\wedge \ar[rr]^\varphi \ar[ru] & & \mathcal{O}_{X, x}^\wedge \ar[lu] } $$ commutes modulo $\mathfrak m_u^N$. \end{lemma} 
\begin{lemma} \label{lemma-relative-map-approximation-pre} Let $X \to S$, $Y \to T$, $x$, $s$, $y$, $t$, $\sigma$, $y_\sigma$, and $\varphi$ be given as follows: we have morphisms of schemes $$ \vcenter{ \xymatrix{ X \ar[d] & Y \ar[d] \\ S & T } } \quad\text{with points}\quad \vcenter{ \xymatrix{ x \ar[d] & y \ar[d] \\ s & t } } $$ Here $S$ is locally Noetherian and $T$ is of finite type over $\mathbf{Z}$. The morphisms $X \to S$ and $Y \to T$ are locally of finite type. The local ring $\mathcal{O}_{S, s}$ is a G-ring. The map $$ \sigma : \mathcal{O}_{T, t} \longrightarrow \mathcal{O}_{S, s}^\wedge $$ is a local homomorphism. Set $Y_\sigma = Y \times_{T, \sigma} \Spec(\mathcal{O}_{S, s}^\wedge)$. Next, $y_\sigma$ is a point of $Y_\sigma$ mapping to $y$ and the closed point of $\Spec(\mathcal{O}_{S, s}^\wedge)$. Finally $$ \varphi : \mathcal{O}_{X, x}^\wedge \longrightarrow \mathcal{O}_{Y_\sigma, y_\sigma}^\wedge $$ is an isomorphism of $\mathcal{O}_{S, s}^\wedge$-algebras. In this situation there exists a commutative diagram $$ \xymatrix{ X \ar[d] & W \ar[l] \ar[rd] \ar[rr] & & Y \times_{T, \tau} V \ar[r] \ar[ld] & Y \ar[d] \\ S & & V \ar[ll] \ar[rr]^\tau & & T } $$ of schemes and points $w \in W$, $v \in V$ such that \begin{enumerate} \item $(V, v) \to (S, s)$ is an elementary \'etale neighbourhood, \item $(W, w) \to (X, x)$ is an elementary \'etale neighbourhood, and \item $\tau(v) = t$. \end{enumerate} Let $y_\tau \in Y \times_T V$ correspond to $y_\sigma$ via the identification $(Y_\sigma)_s = (Y \times_T V)_v$. Then \begin{enumerate} \item[(4)] $(W, w) \to (Y \times_{T, \tau} V, y_\tau)$ is an elementary \'etale neighbourhood. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-relative-map-approximation} Consider a diagram $$ \vcenter{ \xymatrix{ X \ar[d] & Y \ar[d] \\ S & T \ar[l] } } \quad\text{with points}\quad \vcenter{ \xymatrix{ x \ar[d] & y \ar[d] \\ s & t \ar[l] } } $$ where $S$ be a locally Noetherian scheme and the morphisms are locally of finite type. Assume $\mathcal{O}_{S, s}$ is a G-ring. Assume further we are given a local $\mathcal{O}_{S, s}$-algebra map $$ \sigma : \mathcal{O}_{T, t} \longrightarrow \mathcal{O}_{S, s}^\wedge $$ and a local $\mathcal{O}_{S, s}$-algebra map $$ \varphi : \mathcal{O}_{X, x} \longrightarrow \mathcal{O}_{Y_\sigma, y_\sigma}^\wedge $$ where $Y_\sigma = Y \times_{T, \sigma} \Spec(\mathcal{O}_{S, s}^\wedge)$ and $y_\sigma$ is the unique point of $Y_\sigma$ lying over $y$. For every $N \geq 1$ there exists a commutative diagram $$ \xymatrix{ X \ar[d] & X \times_S V \ar[l] \ar[rd] & W \ar[l]^-f \ar[r] \ar[d] & Y \times_{T, \tau} V \ar[r] \ar[ld] & Y \ar[d] \\ S & & V \ar[ll] \ar[rr]^\tau & & T } $$ of schemes over $S$ and points $w \in W$, $v \in V$ such that \begin{enumerate} \item $v \mapsto s$, $\tau(v) = t$, $f(w) = (x, v)$, and $w \mapsto (y, v)$, \item $(V, v) \to (S, s)$ is an elementary \'etale neighbourhood, \item the diagram $$ \xymatrix{ \mathcal{O}_{S, s}^\wedge \ar[r] & \mathcal{O}_{V, v}^\wedge \\ \mathcal{O}_{T, t} \ar[r]^{\tau^\sharp_v} \ar[u]_\sigma & \mathcal{O}_{V, v} \ar[u] } $$ commutes module $\mathfrak m_v^N$, \item $(W, w) \to (Y \times_{T, \tau} V, (y, v))$ is an elementary \'etale neighbourhood, \item the diagram $$ \xymatrix{ \mathcal{O}_{X, x} \ar[r]_\varphi & \mathcal{O}_{Y_\sigma, y_\sigma}^\wedge \ar[r] & \mathcal{O}_{Y_\sigma, y_\sigma}/\mathfrak m_{y_\sigma}^N \ar@{=}[r] & \mathcal{O}_{Y \times_{T, \tau} V, (y, v)}/\mathfrak m_{(y, v)}^N \ar[d]_{\cong} \\ \mathcal{O}_{X, x} \ar[r] \ar@{=}[u] & \mathcal{O}_{X \times_S V, (x, v)} \ar[r]^{f^\sharp_w} & \mathcal{O}_{W, w} \ar[r] & \mathcal{O}_{W, w}/\mathfrak m_w^N } $$ commutes. The equality comes from the fact that $Y_\sigma$ and $Y \times_{T, \tau} V$ are canonically isomorphic over $\mathcal{O}_{V, v}/\mathfrak m_v^N = \mathcal{O}_{S, s}/\mathfrak m_s^N$ by parts (2) and (3). \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-control-agreement} Let $T \to S$ be finite type morphisms of Noetherian schemes. Let $t \in T$ map to $s \in S$ and let $\sigma : \mathcal{O}_{T, t} \to \mathcal{O}_{S, s}^\wedge$ be a local $\mathcal{O}_{S, s}$-algebra map. For every $N \geq 1$ there exists a finite type morphism $(T', t') \to (T, t)$ such that $\sigma$ factors through $\mathcal{O}_{T, t} \to \mathcal{O}_{T', t'}$ and such that for every local $\mathcal{O}_{S, s}$-algebra map $\sigma' : \mathcal{O}_{T, t} \to \mathcal{O}_{S, s}^\wedge$ which factors through $\mathcal{O}_{T, t} \to \mathcal{O}_{T', t'}$ the maps $\sigma$ and $\sigma'$ agree modulo $\mathfrak m_s^N$. \end{lemma} 
\begin{lemma} \label{lemma-control-graded} Let $Y \to T \to S$ be finite type morphisms of Noetherian schemes. Let $t \in T$ map to $s \in S$ and let $\sigma : \mathcal{O}_{T, t} \to \mathcal{O}_{S, s}^\wedge$ be a local $\mathcal{O}_{S, s}$-algebra map. There exists a finite type morphism $(T', t') \to (T, t)$ such that $\sigma$ factors through $\mathcal{O}_{T, t} \to \mathcal{O}_{T', t'}$ and such that for every local $\mathcal{O}_{S, s}$-algebra map $\sigma' : \mathcal{O}_{T, t} \to \mathcal{O}_{S, s}^\wedge$ which factors through $\mathcal{O}_{T, t} \to \mathcal{O}_{T', t'}$ the closed immersions $$ Y \times_{T, \sigma} \Spec(\mathcal{O}_{S, s}^\wedge) = Y_\sigma \longleftarrow Y_t \longrightarrow Y_{\sigma'} = Y \times_{T, \sigma'} \Spec(\mathcal{O}_{S, s}^\wedge) $$ have isomorphic conormal algebras. \end{lemma} 
\begin{lemma} \label{lemma-relative-isomorphism-approximation} With notation an assumptions as in Lemma \ref{lemma-relative-map-approximation} assume that $\varphi$ induces an isomorphism on completions. Then we can choose our diagram such that $f$ is \'etale. \end{lemma} 
\begin{lemma} \label{lemma-dominate-etale-neighbourhood-finite-flat} Let $S$ be a scheme. Let $s \in S$. Let $f : (U, u) \to (S, s)$ be an \'etale neighbourhood. There exists an affine open neighbourhood $s \in V \subset S$ and a surjective, finite locally free morphism $\pi : T \to V$ such that for every $t \in \pi^{-1}(s)$ there exists an open neighbourhood $t \in W_t \subset T$ and a commutative diagram $$ \xymatrix{ T \ar[d]^\pi & W_t \ar[l] \ar[rr]_{h_t} \ar[rd] & & U \ar[dl] \\ V \ar[rr] & & S } $$ with $h_t(t) = u$. \end{lemma} 
\begin{lemma} \label{lemma-dominate-etale-affine-finite-flat} Let $f : U \to S$ be a surjective \'etale morphism of affine schemes. There exists a surjective, finite locally free morphism $\pi : T \to S$ and a finite open covering $T = T_1 \cup \ldots \cup T_n$ such that each $T_i \to S$ factors through $U \to S$. Diagram: $$ \xymatrix{ & \coprod T_i  \ar[rd] \ar[ld] & \\ T \ar[rd]^\pi & & U \ar[ld]_f \\ & S & } $$ where the south-west arrow is a Zariski-covering. \end{lemma} 
\begin{lemma} \label{lemma-etale-makes-quasi-finite-finite-at-point} Let $f : X \to S$ be a morphism of schemes. Let $x \in X$. Set $s = f(x)$. Assume that \begin{enumerate} \item $f$ is locally of finite type, and \item $x \in X_s$ is isolated\footnote{In the presence of (1) this means that $f$ is quasi-finite at $x$, see Morphisms, Lemma \ref{morphisms-lemma-quasi-finite-at-point-characterize}.}. \end{enumerate} Then there exist \begin{enumerate} \item[(a)] an elementary \'etale neighbourhood $(U, u) \to (S, s)$, \item[(b)] an open subscheme $V \subset X_U$ (see \ref{equation-basic-diagram}) \end{enumerate} such that \begin{enumerate} \item[(\romannumeral1)] $V \to U$ is a finite morphism, \item[(\romannumeral2)] there is a unique point $v$ of $V$ mapping to $u$ in $U$, and \item[(\romannumeral3)] the point $v$ maps to $x$ under the morphism $X_U \to X$, inducing $\kappa(x) = \kappa(v)$. \end{enumerate} Moreover, for any elementary \'etale neighbourhood $(U', u') \to (U, u)$ setting $V' = U' \times_U V \subset X_{U'}$ the triple $(U', u', V')$ satisfies the properties (\romannumeral1), (\romannumeral2), and (\romannumeral3) as well. \end{lemma} 
\begin{lemma} \label{lemma-etale-makes-quasi-finite-finite-multiple-points} Let $f : X \to S$ be a morphism of schemes. Let $x_1, \ldots, x_n \in X$ be points having the same image $s$ in $S$. Assume that \begin{enumerate} \item $f$ is locally of finite type, and \item $x_i \in X_s$ is isolated for $i = 1, \ldots, n$. \end{enumerate} Then there exist \begin{enumerate} \item[(a)] an elementary \'etale neighbourhood $(U, u) \to (S, s)$, \item[(b)] for each $i$ an open subscheme $V_i \subset X_U$, \end{enumerate} such that for each $i$ we have \begin{enumerate} \item[(\romannumeral1)] $V_i \to U$ is a finite morphism, \item[(\romannumeral2)] there is a unique point $v_i$ of $V_i$ mapping to $u$ in $U$, and \item[(\romannumeral3)] the point $v_i$ maps to $x_i$ in $X$ and $\kappa(x_i) = \kappa(v_i)$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-etale-makes-quasi-finite-finite-multiple-points-var} Let $f : X \to S$ be a morphism of schemes. Let $x_1, \ldots, x_n \in X$ be points having the same image $s$ in $S$. Assume that \begin{enumerate} \item $f$ is locally of finite type, and \item $x_i \in X_s$ is isolated for $i = 1, \ldots, n$. \end{enumerate} Then there exist \begin{enumerate} \item[(a)] an \'etale neighbourhood $(U, u) \to (S, s)$, \item[(b)] for each $i$ an integer $m_i$ and open subschemes $V_{i, j} \subset X_U$, $j = 1, \ldots, m_i$ \end{enumerate} such that we have \begin{enumerate} \item[(\romannumeral1)] each $V_{i, j} \to U$ is a finite morphism, \item[(\romannumeral2)] there is a unique point $v_{i, j}$ of $V_{i, j}$ mapping to $u$ in $U$ with $\kappa(u) \subset \kappa(v_{i, j})$ finite purely inseparable, \item[(\romannumeral4)] if $v_{i, j} = v_{i', j'}$, then $i = i'$ and $j = j'$, and \item[(\romannumeral3)] the points $v_{i, j}$ map to $x_i$ in $X$ and no other points of $(X_U)_u$ map to $x_i$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-etale-splits-off-quasi-finite-part-technical} Let $f : X \to S$ be a morphism of schemes. Let $s \in S$. Let $x_1, \ldots, x_n \in X_s$. Assume that \begin{enumerate} \item $f$ is locally of finite type, \item $f$ is separated, and \item $x_1, \ldots, x_n$ are pairwise distinct isolated points of $X_s$. \end{enumerate} Then there exists an elementary \'etale neighbourhood $(U, u) \to (S, s)$ and a decomposition $$ U \times_S X = W \amalg V_1 \amalg \ldots \amalg V_n $$ into open and closed subschemes such that the morphisms $V_i \to U$ are finite, the fibres of $V_i \to U$ over $u$ are singletons $\{v_i\}$, each $v_i$ maps to $x_i$ with $\kappa(x_i) = \kappa(v_i)$, and the fibre of $W \to U$ over $u$ contains no points mapping to any of the $x_i$. \end{lemma} 
\begin{lemma} \label{lemma-etale-splits-off-quasi-finite-part-technical-variant} Let $f : X \to S$ be a morphism of schemes. Let $s \in S$. Let $x_1, \ldots, x_n \in X_s$. Assume that \begin{enumerate} \item $f$ is locally of finite type, \item $f$ is separated, and \item $x_1, \ldots, x_n$ are pairwise distinct isolated points of $X_s$. \end{enumerate} Then there exists an \'etale neighbourhood $(U, u) \to (S, s)$ and a decomposition $$ U \times_S X = W \amalg \ \coprod\nolimits_{i = 1, \ldots, n} \ \coprod\nolimits_{j = 1, \ldots, m_i} V_{i, j} $$ into open and closed subschemes such that the morphisms $V_{i, j} \to U$ are finite, the fibres of $V_{i, j} \to U$ over $u$ are singletons $\{v_{i, j}\}$, each $v_{i, j}$ maps to $x_i$, $\kappa(u) \subset \kappa(v_{i, j})$ is purely inseparable, and the fibre of $W \to U$ over $u$ contains no points mapping to any of the $x_i$. \end{lemma} 
\begin{lemma} \label{lemma-etale-splits-off-quasi-finite-part} Let $f : X \to S$ be a morphism of schemes. Let $s \in S$. Assume that \begin{enumerate} \item $f$ is locally of finite type, \item $f$ is separated, and \item $X_s$ has at most finitely many isolated points. \end{enumerate} Then there exists an elementary \'etale neighbourhood $(U, u) \to (S, s)$ and a decomposition $$ U \times_S X = W \amalg V $$ into open and closed subschemes such that the morphism $V \to U$ is finite, and the fibre $W_u$ of the morphism $W \to U$ contains no isolated points. In particular, if $f^{-1}(s)$ is a finite set, then $W_u = \emptyset$. \end{lemma} 
\begin{lemma} \label{lemma-etale-makes-integral-split} Let $R \to S$ be an integral ring map. Let $\mathfrak p \subset R$ be a prime ideal. Assume \begin{enumerate} \item there are finitely many primes $\mathfrak q_1, \ldots, \mathfrak q_n$ lying over $\mathfrak p$, and \item for each $i$ the maximal separable subextension $\kappa(\mathfrak q)/\kappa(\mathfrak q_i)_{sep}/\kappa(\mathfrak p)$ (Fields, Lemma \ref{fields-lemma-separable-first}) is finite over $\kappa(\mathfrak p)$. \end{enumerate} Then there exists an \'etale ring map $R \to R'$ and a prime $\mathfrak p'$ lying over $\mathfrak p$ such that $$ S \otimes_R R' = A_1 \times \ldots \times A_m $$ with $R' \to A_j$ integral having a unique prime $\mathfrak r_j$ over $\mathfrak p'$ such that $\kappa(\mathfrak r_j)/\kappa(\mathfrak p')$ is purely inseparable. \end{lemma} 
\begin{lemma} \label{lemma-finite-type-separated} Let $f : X \to S$ be a morphism of schemes. Assume $f$ is of finite type and separated. Let $S'$ be the normalization of $S$ in $X$, see Morphisms, Definition \ref{morphisms-definition-normalization-X-in-Y}. Picture: $$ \xymatrix{ X \ar[rd]_f \ar[rr]_{f'} & & S' \ar[ld]^\nu \\ & S & } $$ Then there exists an open subscheme $U' \subset S'$ such that \begin{enumerate} \item $(f')^{-1}(U') \to U'$ is an isomorphism, and \item $(f')^{-1}(U') \subset X$ is the set of points at which $f$ is quasi-finite. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-quasi-finite-separated-quasi-affine} \begin{slogan} Quasi-finite, separated morphisms are quasi-affine \end{slogan} Let $f : X \to S$ be a morphism of schemes. Assume $f$ is quasi-finite and separated. Let $S'$ be the normalization of $S$ in $X$, see Morphisms, Definition \ref{morphisms-definition-normalization-X-in-Y}. Picture: $$ \xymatrix{ X \ar[rd]_f \ar[rr]_{f'} & & S' \ar[ld]^\nu \\ & S & } $$ Then $f'$ is a quasi-compact open immersion and $\nu$ is integral. In particular $f$ is quasi-affine. \end{lemma} 
\begin{lemma}[Zariski's Main Theorem] \label{lemma-quasi-finite-separated-pass-through-finite} \begin{reference} \cite[IV Corollary 18.12.13]{EGA} \end{reference} Let $f : X \to S$ be a morphism of schemes. Assume $f$ is quasi-finite and separated and assume that $S$ is quasi-compact and quasi-separated. Then there exists a factorization $$ \xymatrix{ X \ar[rd]_f \ar[rr]_j & & T \ar[ld]^\pi \\ & S & } $$ where $j$ is a quasi-compact open immersion and $\pi$ is finite. \end{lemma} 
\begin{lemma} \label{lemma-quasi-finite-separated-pass-through-finite-addendum} With notation and hypotheses as in Lemma \ref{lemma-quasi-finite-separated-pass-through-finite}. Assume moreover that $f$ is locally of finite presentation. Then we can choose the factorization such that $T$ is finite and of finite presentation over $S$. \end{lemma} 
\begin{lemma} \label{lemma-characterize-finite} Let $f : X \to S$ be a morphism of schemes. The following are equivalent: \begin{enumerate} \item $f$ is finite, \item $f$ is proper with finite fibres, \item $f$ is proper and locally quasi-finite, \item $f$ is universally closed, separated, locally of finite type and has finite fibres. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-proper-finite-fibre-finite-in-neighbourhood} Let $f : X \to S$ be a morphism of schemes. Let $s \in S$. Assume that $f$ is proper and $f^{-1}(\{s\})$ is a finite set. Then there exists an open neighbourhood $V \subset S$ of $s$ such that $f|_{f^{-1}(V)} : f^{-1}(V) \to V$ is finite. \end{lemma} 
\begin{lemma} \label{lemma-flat-proper-family-cannot-collapse-fibre} Consider a commutative diagram of schemes $$ \xymatrix{ X \ar[rr]_h \ar[rd]_f & & Y \ar[ld]^g \\ & S } $$ Let $s \in S$. Assume \begin{enumerate} \item $X \to S$ is a proper morphism, \item $Y \to S$ is separated and locally of finite type, and \item the image of $X_s \to Y_s$ is finite. \end{enumerate} Then there is an open subspace $U \subset S$ containing $s$ such that $X_U \to Y_U$ factors through a closed subscheme $Z \subset Y_U$ finite over $U$. \end{lemma} 
\begin{lemma} \label{lemma-separated-locally-quasi-finite-over-affine} Let $f : X \to Y$ be a separated, locally quasi-finite morphism with $Y$ affine. Then every finite set of points of $X$ is contained in an open affine of $X$. \end{lemma} 
\begin{lemma} \label{lemma-quasi-finite-finite-over-dense-open} Let $f : Y \to X$ be a quasi-finite morphism. There exists a dense open $U \subset X$ such that $f|_{f^{-1}(U)} : f^{-1}(U) \to U$ is finite. \end{lemma} 
\begin{lemma} \label{lemma-stratify-flat-fp-lqf-universally-bounded} Let $f : X \to S$ be flat, locally of finite presentation, separated, locally quasi-finite with universally bounded fibres. Then there exist closed subsets $$ \emptyset = Z_{-1} \subset Z_0 \subset Z_1 \subset Z_2 \subset \ldots \subset Z_n = S $$ such that with $S_r = Z_r \setminus Z_{r - 1}$ the stratification $S = \coprod_{r = 0, \ldots, n} S_r$ is characterized by the following universal property: Given $g : T \to S$ the projection $X \times_S T \to T$ is finite locally free of degree $r$ if and only if $g(T) \subset S_r$ (set theoretically). \end{lemma} 
\begin{lemma} \label{lemma-stratify-flat-fp-qf} Let $f : X \to S$ be a morphism of schemes which is flat, locally of finite presentation, separated, and quasi-finite. Then there exist closed subsets $$ \emptyset = Z_{-1} \subset Z_0 \subset Z_1 \subset Z_2 \subset \ldots \subset S $$ such that with $S_r = Z_r \setminus Z_{r - 1}$ the stratification $S = \coprod S_r$ is characterized by the following universal property: Given a morphism $g : T \to S$ the projection $X \times_S T \to T$ is finite locally free of degree $r$ if and only if $g(T) \subset S_r$ (set theoretically). Moreover, the inclusion maps $S_r \to S$ are quasi-compact. \end{lemma} 
\begin{lemma} \label{lemma-stratify-flat-fp-lqf} Let $f : X \to S$ be a flat, locally of finite presentation, separated, and locally quasi-finite morphism of schemes. Then there exist open subschemes $$ S = U_0 \supset U_1 \supset U_2 \supset \ldots $$ such that a morphism $\Spec(k) \to S$ where $k$ is a field factors through $U_d$ if and only if $X \times_S \Spec(k)$ has degree $\geq d$ over $k$. \end{lemma} 
\begin{lemma} \label{lemma-go-down-with-annihilators} Let $f : X \to S$ be a morphism of schemes which is flat, locally of finite presentation, and locally quasi-finite. Let $g \in \Gamma(X, \mathcal{O}_X)$ nonzero. Then there exist an open $V \subset X$ such that $g|_V \not = 0$, an open $U \subset S$ fitting into a commutative diagram $$ \xymatrix{ V \ar[r] \ar[d]_\pi & X \ar[d]^f \\ U \ar[r] & S, } $$ a quasi-coherent subsheaf $\mathcal{F} \subset \mathcal{O}_U$, an integer $r > 0$, and an injective $\mathcal{O}_U$-module map $\mathcal{F}^{\oplus r} \to \pi_*\mathcal{O}_V$ whose image contains $g|_V$. \end{lemma} 
\begin{lemma} \label{lemma-there-is-a-scheme-integral-over} Let $U \to X$ be a surjective \'etale morphism of schemes. Assume $X$ is quasi-compact and quasi-separated. Then there exists a surjective integral morphism $Y \to X$, such that for every $y \in Y$ there is an open neighbourhood $V \subset Y$ such that $V \to X$ factors through $U$. In fact, we may assume $Y \to X$ is finite and of finite presentation. \end{lemma} 
\begin{lemma} \label{lemma-descent-connected-fibres} Consider a diagram of morphisms of schemes $$ \xymatrix{ Z \ar[r]_{\sigma} \ar[rd] & X \ar[d] \\ & Y } $$ an a point $y \in Y$. Assume \begin{enumerate} \item $X \to Y$ is of finite presentation and flat, \item $Z \to Y$ is finite locally free, \item $Z_y \not = \emptyset$, \item all fibres of $X \to Y$ are geometrically reduced, and \item $X_y$ is geometrically connected over $\kappa(y)$. \end{enumerate} Then there exists a quasi-compact open $X^0 \subset X$ such that $X^0_y = X_y$ and such that all nonempty fibres of $X^0 \to Y$ are geometrically connected. \end{lemma} 
\begin{lemma} \label{lemma-fibre-geometrically-connected-reduced} Let $h : Y \to S$ be a morphism of schemes. Let $s \in S$ be a point. Let $T \subset Y_s$ be an open subscheme. Assume \begin{enumerate} \item $h$ is flat and of finite presentation, \item all fibres of $h$ are geometrically reduced, and \item $T$ is geometrically connected over $\kappa(s)$. \end{enumerate} Then we can find an affine elementary \'etale neighbourhood $(S', s') \to (S, s)$ and a quasi-compact open $V \subset Y_{S'}$ such that \begin{enumerate} \item[(a)] all fibres of $V \to S'$ are geometrically connected, \item[(b)] $V_{s'} = T \times_s s'$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-cover-by-geometrically-connected} Let $f : X \to S$ be a morphism of schemes which is locally of finite presentation and flat with geometrically reduced fibres. Then there exists an \'etale covering $\{X_i \to X\}_{i \in I}$ such that $X_i \to S$ factors as $X_i \to S_i \to S$ where $S_i \to S$ is \'etale and $X_i \to S_i$ is flat of finite presentation with geometrically connected and geometrically reduced fibres. \end{lemma} 
\begin{lemma} \label{lemma-normal-morphism-irreducible} Let $h : Y \to S$ be a morphism of schemes. Let $s \in S$ be a point. Let $T \subset Y_s$ be an open subscheme. Assume \begin{enumerate} \item $h$ is of finite presentation, \item $h$ is normal, and \item $T$ is geometrically irreducible over $\kappa(s)$. \end{enumerate} Then we can find an affine elementary \'etale neighbourhood $(S', s') \to (S, s)$ and a quasi-compact open $V \subset Y_{S'}$ such that \begin{enumerate} \item[(a)] all fibres of $V \to S'$ are geometrically integral, \item[(b)] $V_{s'} = T \times_s s'$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-local-structure-finite-type} Let $f : X \to S$ be a morphism. Let $x \in X$ and set $s = f(x)$. Assume that $f$ is locally of finite type and that $n = \dim_x(X_s)$. Then there exists a commutative diagram $$ \xymatrix{ X \ar[dd] & X' \ar[l]^g \ar[d]^\pi & x \ar@{|->}[dd] & x' \ar@{|->}[l]  \ar@{|->}[d] \\ & Y \ar[d]^h & & y \ar@{|->}[d] \\ S \ar@{=}[r] & S & s & s \ar@{=}[l] } $$ and a point $x' \in X'$ with $g(x') = x$ such that with $y = \pi(x')$ we have \begin{enumerate} \item $h : Y \to S$ is smooth of relative dimension $n$, \item $g : (X', x') \to (X, x)$ is an elementary \'etale neighbourhood, \item $\pi$ is finite, and $\pi^{-1}(\{y\}) = \{x'\}$, and \item $\kappa(y)$ is a purely transcendental extension of $\kappa(s)$. \end{enumerate} Moreover, if $f$ is locally of finite presentation then $\pi$ is of finite presentation. \end{lemma} 
\begin{lemma} \label{lemma-local-local-structure-finite-type} \begin{slogan} A morphism of finite type is, in \'etale neighbourhoods, finite over a smooth morphism. \end{slogan} Let $f : X \to S$ be a morphism. Let $x \in X$ and set $s = f(x)$. Assume that $f$ is locally of finite type and that $n = \dim_x(X_s)$. Then there exists a commutative diagram $$ \xymatrix{ X \ar[dd] & X' \ar[l]^g \ar[d]^\pi & x \ar@{|->}[dd] & x' \ar@{|->}[l] \ar@{|->}[d] \\ & Y' \ar[d]^h & & y' \ar@{|->}[d] \\ S & S' \ar[l]_e & s & s' \ar@{|->}[l] } $$ and a point $x' \in X'$ with $g(x') = x$ such that with $y' = \pi(x')$, $s' = h(y')$ we have \begin{enumerate} \item $h : Y' \to S'$ is smooth of relative dimension $n$, \item all fibres of $Y' \to S'$ are geometrically integral, \item $g : (X', x') \to (X, x)$ is an elementary \'etale neighbourhood, \item $\pi$ is finite, and $\pi^{-1}(\{y'\}) = \{x'\}$, \item $\kappa(y')$ is a purely transcendental extension of $\kappa(s')$, and \item $e : (S', s') \to (S, s)$ is an elementary \'etale neighbourhood. \end{enumerate} Moreover, if $f$ is locally of finite presentation, then $\pi$ is of finite presentation. \end{lemma} 
\begin{lemma} \label{lemma-local-local-structure-finite-type-affine} Assumption and notation as in Lemma \ref{lemma-local-local-structure-finite-type}. In addition to properties (1) -- (6) we may also arrange it so that \begin{enumerate} \item[(7)] $S'$, $Y'$, $X'$ are affine. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-finite-morphism-single-point-in-fibre} Let $\pi : X \to Y$ be a finite morphism. Let $x \in X$ with $y = \pi(x)$ such that $\pi^{-1}(\{y\}) = \{x\}$. Then \begin{enumerate} \item For every neighbourhood $U \subset X$ of $x$ in $X$, there exists a neighbourhood $V \subset Y$ of $y$ such that $\pi^{-1}(V) \subset U$. \item The ring map $\mathcal{O}_{Y, y} \to \mathcal{O}_{X, x}$ is finite. \item If $\pi$ is of finite presentation, then $\mathcal{O}_{Y, y} \to \mathcal{O}_{X, x}$ is of finite presentation. \item For any quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$ we have $\mathcal{F}_x = \pi_*\mathcal{F}_y$ as $\mathcal{O}_{Y, y}$-modules. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-dominate-fppf-etale-locally} Let $S$ be a scheme. Let $\{S_i \to S\}_{i \in I}$ be an fppf covering. Then there exist \begin{enumerate} \item an \'etale covering $\{S'_a \to S\}$, \item surjective finite locally free morphisms $V_a \to S'_a$, \end{enumerate} such that the fppf covering $\{V_a \to S\}$ refines the given covering $\{S_i \to S\}$. \end{lemma} 
\begin{lemma} \label{lemma-dominate-fppf} Let $S$ be a scheme. Let $\{S_i \to S\}_{i \in I}$ be an fppf covering. Then there exist \begin{enumerate} \item a Zariski open covering $S = \bigcup U_j$, \item surjective finite locally free morphisms $W_j \to U_j$, \item Zariski open coverings $W_j = \bigcup_k W_{j, k}$, \item surjective finite locally free morphisms $T_{j, k} \to W_{j, k}$ \end{enumerate} such that the fppf covering $\{T_{j, k} \to S\}$ refines the given covering $\{S_i \to S\}$. \end{lemma} 
\begin{lemma} \label{lemma-extend-integral-surjective-morphisms} Let $S$ be a scheme. If $U \subset S$ is open and $V \to U$ is a surjective integral morphism, then there exists a surjective integral morphism $\overline{V} \to S$ with $\overline{V} \times_S U$ isomorphic to $V$ as schemes over $U$. \end{lemma} 
\begin{lemma} \label{lemma-extend-finite-surjective-morphisms} Let $S$ be a quasi-compact and quasi-separated scheme. If $U \subset S$ is a quasi-compact open and $V \to U$ is a surjective finite morphism, then there exists a surjective finite morphism $\overline{V} \to S$ with $\overline{V} \times_S U$ isomorphic to $V$ as schemes over $U$. \end{lemma} 
\begin{lemma} \label{lemma-dominate-fppf-integral} Let $S$ be a scheme. Let $\{S_i \to S\}_{i \in I}$ be an fppf covering. Then there exists a surjective integral morphism $S' \to S$ and an open covering $S' = \bigcup U'_\alpha$ such that for each $\alpha$ the morphism $U'_\alpha \to S$ factors through $S_i \to S$ for some $i$. \end{lemma} 
\begin{lemma} \label{lemma-dominate-fppf-finite} Let $S$ be a quasi-compact and quasi-separated scheme. Let $\{S_i \to S\}_{i \in I}$ be an fppf covering. Then there exists a surjective finite morphism $S' \to S$ of finite presentation and an open covering $S' = \bigcup U'_\alpha$ such that for each $\alpha$ the morphism $U'_\alpha \to S$ factors through $S_i \to S$ for some $i$. \end{lemma} 
\begin{lemma} \label{lemma-fppf-ph} An fppf covering of schemes is a ph covering. \end{lemma} 
\begin{lemma} \label{lemma-quasi-projective} Let $S$ be a scheme which has an ample invertible sheaf. Let $f : X \to S$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item $X \to S$ is quasi-projective, \item $X \to S$ is H-quasi-projective, \item there exists a quasi-compact open immersion $X \to X'$ of schemes over $S$ with $X' \to S$ projective, \item $X \to S$ is of finite type and $X$ has an ample invertible sheaf, and \item $X \to S$ is of finite type and there exists an $f$-very ample invertible sheaf. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-category-quasi-projective} Let $S$ be a scheme which has an ample invertible sheaf. Let $\text{QP}_S$ be the full subcategory of the category of schemes over $S$ satisfying the equivalent conditions of Lemma \ref{lemma-quasi-projective}. \begin{enumerate} \item if $S' \to S$ is a morphism of schemes and $S'$ has an ample invertible sheaf, then base change determines a functor $\text{QP}_S \to \text{QP}_{S'}$, \item if $X \in \text{QP}_S$ and $Y \in \text{QP}_X$, then $Y \in \text{QP}_S$, \item the category $\text{QP}_S$ is closed under fibre products, \item the category $\text{QP}_S$ is closed under finite disjoint unions, \item if $X \to S$ is projective, then $X \in \text{QP}_S$, \item if $X \to S$ is quasi-affine of finite type, then $X$ is in $\text{QP}_S$, \item if $X \to S$ is quasi-finite and separated, then $X \in \text{QP}_S$, \item if $X \to S$ is a quasi-compact immersion, then $X \in \text{QP}_S$, \item add more here. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-integral-over-quasi-affine} Let $X$ be a quasi-affine scheme. Let $f : U \to X$ be an integral morphism. Then $U$ is quasi-affine and the diagram $$ \xymatrix{ U \ar[r] \ar[d] & \Spec(\Gamma(U, \mathcal{O}_U)) \ar[d] \\ X \ar[r] & \Spec(\Gamma(X, \mathcal{O}_X)) } $$ is cartesian. \end{lemma} 
\begin{lemma} \label{lemma-projective} Let $S$ be a scheme which has an ample invertible sheaf. Let $f : X \to S$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item $X \to S$ is projective, \item $X \to S$ is H-projective, \item $X \to S$ is quasi-projective and proper, \item $X \to S$ is H-quasi-projective and proper, \item $X \to S$ is proper and $X$ has an ample invertible sheaf, \item $X \to S$ is proper and there exists an $f$-ample invertible sheaf, \item $X \to S$ is proper and there exists an $f$-very ample invertible sheaf, \item there is a quasi-coherent graded $\mathcal{O}_S$-algebra $\mathcal{A}$ generated by $\mathcal{A}_1$ over $\mathcal{A}_0$ with $\mathcal{A}_1$ a finite type $\mathcal{O}_S$-module such that $X = \underline{\text{Proj}}_S(\mathcal{A})$.  \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-category-projective} Let $S$ be a scheme which has an ample invertible sheaf. Let $\text{P}_S$ be the full subcategory of the category of schemes over $S$ satisfying the equivalent conditions of Lemma \ref{lemma-projective}. \begin{enumerate} \item if $S' \to S$ is a morphism of schemes and $S'$ has an ample invertible sheaf, then base change determines a functor $\text{P}_S \to \text{P}_{S'}$, \item if $X \in \text{P}_S$ and $Y \in \text{P}_X$, then $Y \in \text{P}_S$, \item the category $\text{P}_S$ is closed under fibre products, \item the category $\text{P}_S$ is closed under finite disjoint unions, \item if $X \to S$ is finite, then $X$ is in $\text{P}_S$, \item add more here. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-ample-in-neighbourhood} \begin{reference} \cite[IV Corollary 9.6.4]{EGA} \end{reference} Let $f : X \to Y$ be a proper morphism of schemes. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Let $y \in Y$ be a point such that $\mathcal{L}_y$ is ample on $X_y$. Then there is an open neighbourhood $V \subset Y$ of $y$ such that $\mathcal{L}|_{f^{-1}(V)}$ is ample on $f^{-1}(V)/V$. \end{lemma} 
\begin{lemma} \label{lemma-apply-proj-spec} Let $R$ be a ring. Let $P$ be a proper scheme over $R$ and let $\mathcal{L}$ be an ample invertible $\mathcal{O}_P$-module. Set $A = \bigoplus_{m \geq 0} \Gamma(P, \mathcal{L}^{\otimes m})$. Then $P = \text{Proj}(A)$ and diagram (\ref{equation-proj-and-spec}) becomes the diagram $$ \xymatrix{ \underline{\Spec}_P \left( \bigoplus\nolimits_{m \in \mathbf{Z}} \mathcal{L}^{\otimes m} \right) \ar[r] \ar@{=}[d] & L = \underline{\Spec}_P \left( \bigoplus\nolimits_{m \geq 0} \mathcal{L}^{\otimes m} \right) \ar[d]^\sigma \ar[r]_-\pi & P \ar[d] \\ U \ar[r] & X \ar[r] & Z } $$ having the properties explained above. \end{lemma} 
\begin{lemma} \label{lemma-locally-principal-vertical} Let $f : X \to S$ be a morphism of schemes. Let $Z \subset X$ be a closed subscheme. Let $s \in S$. Assume \begin{enumerate} \item $S$ is irreducible with generic point $\eta$, \item $X$ is irreducible, \item $f$ is dominant, \item $f$ is locally of finite type, \item $\dim(X_s) \leq \dim(X_\eta)$, \item $Z$ is locally principal in $X$, and \item $Z_\eta = \emptyset$. \end{enumerate} Then the fibre $Z_s$ is (set theoretically) a union of irreducible components of $X_s$. \end{lemma} 
\begin{lemma} \label{lemma-horizontal} Let $A \to B$ be a local homomorphism of local rings, and $g \in \mathfrak m_B$. Assume \begin{enumerate} \item $A$ and $B$ are domains and $A \subset B$, \item $B$ is essentially of finite type over $A$, \item $g$ is not contained in any minimal prime over $\mathfrak m_AB$, and \item $\dim(B/\mathfrak m_AB) + \text{trdeg}_{\kappa(\mathfrak m_A)}(\kappa(\mathfrak m_B)) = \text{trdeg}_A(B)$. \end{enumerate} Then $A \subset B/gB$, i.e., the generic point of $\Spec(A)$ is in the image of the morphism $\Spec(B/gB) \to \Spec(A)$. \end{lemma} 
\begin{lemma} \label{lemma-equality-dimensions} Let $A \to B$ be a local homomorphism of local rings. Assume \begin{enumerate} \item $A$ and $B$ are domains and $A \subset B$, \item $B$ is essentially of finite type over $A$, and \item $B$ is flat over $A$. \end{enumerate} Then we have $$ \dim(B/\mathfrak m_AB) + \text{trdeg}_{\kappa(\mathfrak m_A)}(\kappa(\mathfrak m_B)) = \text{trdeg}_A(B). $$ \end{lemma} 
\begin{lemma} \label{lemma-closed-point-nearby-fibre} Let $f : X \to S$ be a morphism of schemes. Let $x \leadsto x'$ be a specialization of points in $X$. Set $s = f(x)$ and $s' = f(x')$. Assume \begin{enumerate} \item $x'$ is a closed point of $X_{s'}$, and \item $f$ is locally of finite type. \end{enumerate} Then the set $$ \{x_1 \in X \text{ such that } f(x_1) = s \text{ and } x_1\text{ is closed in }X_s \text{ and } x \leadsto x_1 \leadsto x' \} $$ is dense in the closure of $x$ in $X_s$. \end{lemma} 
\begin{lemma} \label{lemma-quasi-finite-quasi-section-meeting-nearby-open} Let $\varphi : A \to B$ be a local ring map of local rings. Let $V \subset \Spec(B)$ be an open subscheme which contains at least one prime not lying over $\mathfrak m_A$. Assume $A$ is Noetherian, $\varphi$ essentially of finite type, and $A/\mathfrak m_A \subset B/\mathfrak m_B$ is finite. Then there exists a $\mathfrak q \in V$, $\mathfrak m_A \not = \mathfrak q \cap A$ such that $A \to B/\mathfrak q$ is the localization of a quasi-finite ring map. \end{lemma} 
\begin{lemma} \label{lemma-quasi-finite-quasi-section-meeting-nearby-open-X} Let $f : X \to S$ be a morphism of schemes. Let $x \in X$ with image $s \in S$. Let $U \subset X$ be an open subscheme. Assume $f$ locally of finite type, $S$ locally Noetherian, $x$ a closed point of $X_s$, and assume there exists a point $x' \in U$ with $x' \leadsto x$ and $f(x') \not = s$. Then there exists a closed subscheme $Z \subset X$ such that (a) $x \in Z$, (b) $f|_Z : Z \to S$ is quasi-finite at $x$, and (c) there exists a $z \in Z$, $z \in U$, $z \leadsto x$ and $f(z) \not = s$. \end{lemma} 
\begin{lemma} \label{lemma-change-hypotheses} Suppose that $f : X \to S$ is locally of finite type, $S$ locally Noetherian, $x \in X$ a closed point of its fibre $X_s$, and $U \subset X$ an open subscheme such that $U \cap X_s = \emptyset$ and $x \in \overline{U}$, then the conclusions of Lemma \ref{lemma-quasi-finite-quasi-section-meeting-nearby-open-X} hold. \end{lemma} 
\begin{lemma} \label{lemma-stein-universally-closed} Let $S$ be a scheme. Let $f : X \to S$ be a universally closed and quasi-separated morphism. There exists a factorization $$ \xymatrix{ X \ar[rr]_{f'} \ar[rd]_f & & S' \ar[dl]^\pi \\ & S & } $$ with the following properties: \begin{enumerate} \item the morphism $f'$ is universally closed, quasi-compact, quasi-separated, and surjective, \item the morphism $\pi : S' \to S$ is integral, \item we have $f'_*\mathcal{O}_X = \mathcal{O}_{S'}$, \item we have $S' = \underline{\Spec}_S(f_*\mathcal{O}_X)$, and \item $S'$ is the normalization of $S$ in $X$, see Morphisms, Definition \ref{morphisms-definition-normalization-X-in-Y}. \end{enumerate} Formation of the factorization $f = \pi \circ f'$ commutes with flat base change. \end{lemma} 
\begin{lemma} \label{lemma-stein-universally-closed-residue-fields} In Lemma \ref{lemma-stein-universally-closed} assume in addition that $f$ is locally of finite type. Then for $s \in S$ the fibre $\pi^{-1}(\{s\}) = \{s_1, \ldots, s_n\}$ is finite and the field extensions $\kappa(s_i)/\kappa(s)$ are finite. \end{lemma} 
\begin{lemma} \label{lemma-characterize-geometrically-connected-fibres} Let $f : X \to S$ be a morphism of schemes. Let $s \in S$. Then $X_s$ is geometrically connected, if and only if for every \'etale neighbourhood $(U, u) \to (S, s)$ the base change $X_U \to U$ has connected fibre $X_u$. \end{lemma} 
\begin{theorem}[Stein factorization; Noetherian case] \label{theorem-stein-factorization-Noetherian} Let $S$ be a locally Noetherian scheme. Let $f : X \to S$ be a proper morphism. There exists a factorization $$ \xymatrix{ X \ar[rr]_{f'} \ar[rd]_f & & S' \ar[dl]^\pi \\ & S & } $$ with the following properties: \begin{enumerate} \item the morphism $f'$ is proper with geometrically connected fibres, \item the morphism $\pi : S' \to S$ is finite, \item we have $f'_*\mathcal{O}_X = \mathcal{O}_{S'}$, \item we have $S' = \underline{\Spec}_S(f_*\mathcal{O}_X)$, and \item $S'$ is the normalization of $S$ in $X$, see Morphisms, Definition \ref{morphisms-definition-normalization-X-in-Y}. \end{enumerate} \end{theorem} 
\begin{theorem}[Stein factorization; general case] \label{theorem-stein-factorization-general} Let $S$ be a scheme. Let $f : X \to S$ be a proper morphism. There exists a factorization $$ \xymatrix{ X \ar[rr]_{f'} \ar[rd]_f & & S' \ar[dl]^\pi \\ & S & } $$ with the following properties: \begin{enumerate} \item the morphism $f'$ is proper with geometrically connected fibres, \item the morphism $\pi : S' \to S$ is integral, \item we have $f'_*\mathcal{O}_X = \mathcal{O}_{S'}$, \item we have $S' = \underline{\Spec}_S(f_*\mathcal{O}_X)$, and \item $S'$ is the normalization of $S$ in $X$, see Morphisms, Definition \ref{morphisms-definition-normalization-X-in-Y}. \end{enumerate} \end{theorem} 
\begin{lemma} \label{lemma-geometrically-connected-fibres-towards-normal} Let $f : X \to S$ be a morphism of schemes. Assume \begin{enumerate} \item $f$ is proper, \item $S$ is integral with generic point $\xi$, \item $S$ is normal, \item $X$ is reduced, \item every generic point of an irreducible component of $X$ maps to $\xi$, \item we have $H^0(X_\xi, \mathcal{O}) = \kappa(\xi)$. \end{enumerate} Then $f_*\mathcal{O}_X = \mathcal{O}_S$ and $f$ has geometrically connected fibres. \end{lemma} 
\begin{lemma} \label{lemma-proper-flat-nr-geom-conn-comps-lower-semicontinuous} Let $X \to S$ be a flat proper morphism of finite presentation. Let $n_{X/S}$ be the function on $S$ counting the numbers of geometric connected components of fibres of $f$ introduced in Lemma \ref{lemma-base-change-fibres-nr-geometrically-connected-components}. Then $n_{X/S}$ is lower semi-continuous. \end{lemma} 
\begin{lemma} \label{lemma-proper-flat-geom-red} Let $f : X \to S$ be a morphism of schemes. Assume \begin{enumerate} \item $f$ is proper, flat, and of finite presentation, and \item the geometric fibres of $f$ are reduced. \end{enumerate} Then the function $n_{X/S} : S \to \mathbf{Z}$ counting the numbers of geometric connected components of fibres of $f$ is locally constant. \end{lemma} 
\begin{lemma} \label{lemma-split-off-proper-part-henselian} \begin{reference} A reference for the case of an adic Noetherian base is \cite[III, Proposition 5.5.1]{EGA} \end{reference} Let $(A, I)$ be a henselian pair. Let $X \to \Spec(A)$ be separated and of finite type. Set $X_0 = X \times_{\Spec(A)} \Spec(A/I)$. Let $Y \subset X_0$ be an open and closed subscheme such that $Y \to \Spec(A/I)$ is proper. Then there exists an open and closed subscheme $W \subset X$ which is proper over $A$ with $W \times_{\Spec(A)} \Spec(A/I) = Y$. \end{lemma} 
\begin{lemma}[Generic flatness stratification] \label{lemma-generic-flatness-stratification} Let $f : X \to S$ be a morphism of finite presentation between quasi-compact and quasi-separated schemes. Let $\mathcal{F}$ be an $\mathcal{O}_X$-module of finite presentation. Then there exists a $t \geq 0$ and closed subschemes $$ S \supset S_0 \supset S_1 \supset \ldots \supset S_t = \emptyset $$ such that $S_i \to S$ is defined by a finite type ideal sheaf, $S_0 \subset S$ is a thickening, and $\mathcal{F}$ pulled back to $X \times_S (S_i \setminus S_{i + 1})$ is flat over $S_i \setminus S_{i + 1}$. \end{lemma} 
\begin{lemma} \label{lemma-generic-flatness-stratification-scheme} Let $f : X \to S$ be a morphism of finite presentation between quasi-compact and quasi-separated schemes. Then there exists a $t \geq 0$ and closed subschemes $$ S \supset S_0 \supset S_1 \supset \ldots \supset S_t = \emptyset $$ such that $S_i \to S$ is defined by a finite type ideal sheaf, $S_0 \subset S$ is a thickening, and $X \times_S (S_i \setminus S_{i + 1})$ is flat over $S_i \setminus S_{i + 1}$. \end{lemma} 
\begin{lemma} \label{lemma-cokernel-flat} Let $R$ be a Noetherian domain. Let $R \to A \to B$ be finite type ring maps. Let $M$ be a finite $A$-module and let $N$ a finite $B$-module. Let $M \to N$ be an $A$-linear map. There exists an nonzero $f \in R$ such that the cokernel of $M_f \to N_f$ is a flat $R_f$-module. \end{lemma} 
\begin{lemma} \label{lemma-base-change-scheme-theoretic-image} Let $S$ be a quasi-compact and quasi-separated scheme. Let $f : X \to Y$ be a morphism of schemes over $S$ with both $X$ and $Y$ of finite presentation over $S$. Then there exists a $t \geq 0$ and closed subschemes $$ S \supset S_0 \supset S_1 \supset \ldots \supset S_t = \emptyset $$ with the following properties: \begin{enumerate} \item $S_i \to S$ is defined by a finite type ideal sheaf, \item $S_0 \subset S$ is a thickening, and \item with $T_i = S_i \setminus S_{i + 1}$ and $f_i$ the base change of $f$ to $T_i$ we have: formation of the scheme theoretic image of $f_i/T_i$ commutes with arbitrary base change (see discussion above the lemma). \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-smoothness-stratification-at-generic-point} Let $f : X \to S$ be a morphism of schemes of finite presentation. Let $\eta \in S$ be a generic point of an irreducible component of $S$. Assume $S$ is reduced. Then there exist \begin{enumerate} \item an open subscheme $U \subset S$ containing $\eta$, \item a surjective, universally injective, finite locally free morphism $V \to U$, \item a $t \geq 0$ and closed subschemes $$ X \times_S V \supset Z_0 \supset Z_1 \supset \ldots \supset Z_t = \emptyset $$ such that $Z_i \to X \times_S V$ is defined by a finite type ideal sheaf, $Z_0 \subset X \times_S V$ is a thickening, and such that the morphism $Z_i \setminus Z_{i + 1} \to V$ is smooth. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-smoothness-stratification} Let $f : X \to S$ be a morphism of finite presentation between quasi-compact and quasi-separated schemes. Then there exists a $t \geq 0$ and closed subschemes $$ S \supset S_0 \supset S_1 \supset \ldots \supset S_t = \emptyset $$ such that \begin{enumerate} \item $S_i \to S$ is defined by a finite type ideal sheaf, \item $S_0 \subset S$ is a thickening, \item for each $i$ there exists a surjective finite locally free morphism $T_i \to S_i \setminus S_{i + 1}$, \item for each $i$ there exists a $t_i \geq 0$ and closed subschemes $$ X_i = X \times_S T_i \supset Z_{i, 0} \supset Z_{i, 1} \supset \ldots \supset Z_{i, t_i} = \emptyset $$ such that $Z_{i, j} \to X_i$ is defined by a finite type ideal sheaf, $Z_{i, 0} \subset X_i$ is a thickening, and such that the morphism $Z_{i, j} \setminus Z_{i, j + 1} \to T_i$ is smooth. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-make-good-curves} Let $f : X \to S$ be a morphism of schemes. Let $\eta \in S$ be a generic point of an irreducible component of $S$. Assume $f$ is separated, of finite presentation, and $\dim(X_\eta) \leq 1$. Then there exists a commutative diagram $$ \xymatrix{ \overline{Y}_1 \amalg \ldots \amalg \overline{Y}_n \ar[rd] & Y_1 \amalg \ldots \amalg Y_n \ar[r]_-\nu \ar[d] \ar[l]^j & X_V \ar[r] \ar[d] & X_U \ar[r] \ar[d] & X \ar[d]^f \\ & T_1 \amalg \ldots \amalg T_n \ar[r] & V \ar[r] & U \ar[r] & S } $$ of schemes with the following properties: \begin{enumerate} \item $U \subset X$ is an open neighbourhood of $\eta$, \item $V \to U$ is a finite, surjective, universally injective morphism, \item $X_U = U \times_S X$ and $X_V = V \times_S X$ are the base changes, \item $\nu$ is finite, surjective, and there is an open $W \subset X_V$ such that \begin{enumerate} \item $W$ is dense in all fibres of $X_V \to V$, \item $\nu^{-1}(W) \cap Y_i$ is dense in all fibres of $Y_i \to T_i$, and \item $\nu^{-1}(W) \to W$ is a thickening, \end{enumerate} \item $j$ is an open immersion, \item $T_i \to V$ is finite \'etale, \item $Y_i \to T_i$ is surjective and smooth, \item $\overline{Y}_i \to T_i$ is smooth, proper, with geometrically connected fibres of dimension $\leq 1$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-separated-locally-quasi-finite-morphisms-fppf-descend} Let $S$ be a scheme. Let $\{X_i \to S\}_{i\in I}$ be an fppf covering, see Topologies, Definition \ref{topologies-definition-fppf-covering}. Let $(V_i/X_i, \varphi_{ij})$ be a descent datum relative to $\{X_i \to S\}$. If each morphism $V_i \to X_i$ is separated and locally quasi-finite, then the descent datum is effective. \end{lemma} 
\begin{definition} \label{definition-relatively-finitely-presented-sheaf} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. We say $\mathcal{F}$ is {\it finitely presented relative to $S$} or {\it of finite presentation relative to $S$} if there exists an affine open covering $S = \bigcup V_i$ and for every $i$ an affine open covering $f^{-1}(V_i) = \bigcup_j U_{ij}$ such that $\mathcal{F}(U_{ij})$ is a $\mathcal{O}_X(U_{ij})$-module of finite presentation relative to $\mathcal{O}_S(V_i)$. \end{definition} 
\begin{lemma} \label{lemma-relative-finite-presentation-characterize} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. The following are equivalent \begin{enumerate} \item $\mathcal{F}$ is of finite presentation relative to $S$, \item for every affine opens $U \subset X$, $V \subset S$ with $f(U) \subset V$ the $\mathcal{O}_X(U)$-module $\mathcal{F}(U)$ is finitely presented relative to $\mathcal{O}_S(V)$. \end{enumerate} Moreover, if this is true, then for every open subschemes $U \subset X$ and $V \subset S$ with $f(U) \subset V$ the restriction $\mathcal{F}|_U$ is of finite presentation relative to $V$. \end{lemma} 
\begin{lemma} \label{lemma-relative-finite-presentation} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. \begin{enumerate} \item If $f$ is locally of finite presentation, then $\mathcal{F}$ is of finite presentation relative to $S$ if and only if $\mathcal{F}$ is of finite presentation. \item The morphism $f$ is locally of finite presentation if and only if $\mathcal{O}_X$ is of finite presentation relative to $S$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-finite-morphism-relative-finite-presentation} Let $\pi : X \to Y$ be a finite morphism of schemes locally of finite type over a base scheme $S$. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Then $\mathcal{F}$ is of finite presentation relative to $S$ if and only if $\pi_*\mathcal{F}$ is of finite presentation relative to $S$. \end{lemma} 
\begin{lemma} \label{lemma-base-change-relative-finite-presentation} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Let $S' \to S$ be a morphism of schemes, set $X' = X \times_S S'$ and denote $\mathcal{F}'$ the pullback of $\mathcal{F}$ to $X'$. If $\mathcal{F}$ is of finite presentation relative to $S$, then $\mathcal{F}'$ is of finite presentation relative to $S'$. \end{lemma} 
\begin{lemma} \label{lemma-pull-relative-finite-presentation} Let $X \to Y \to S$ be morphisms of schemes which are locally of finite type. Let $\mathcal{G}$ be a quasi-coherent $\mathcal{O}_Y$-module. If $f : X \to Y$ is locally of finite presentation and $\mathcal{G}$ of finite presentation relative to $S$, then $f^*\mathcal{G}$ is of finite presentation relative to $S$. \end{lemma} 
\begin{lemma} \label{lemma-composition-relative-finite-presentation} Let $X \to Y \to S$ be morphisms of schemes which are locally of finite type. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. If $Y \to S$ is locally of finite presentation and $\mathcal{F}$ is of finite presentation relative to $Y$, then $\mathcal{F}$ is of finite presentation relative to $S$. \end{lemma} 
\begin{lemma} \label{lemma-ses-relatively-finite-presentation} Let $X \to S$ be a morphism of schemes which is locally of finite type. Let $0 \to \mathcal{F}' \to \mathcal{F} \to \mathcal{F}'' \to 0$ be a short exact sequence of quasi-coherent $\mathcal{O}_X$-modules. \begin{enumerate} \item If $\mathcal{F}', \mathcal{F}''$ are finitely presented relative to $S$, then so is $\mathcal{F}$. \item If $\mathcal{F}'$ is a finite type $\mathcal{O}_X$-module and $\mathcal{F}$ is finitely presented relative to $S$, then $\mathcal{F}''$ is finitely presented relative to $S$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-sum-relatively-finite-presentation} \begin{slogan} A direct summand of a module inherits the property of being finitely presented relative to a base. \end{slogan} Let $X \to S$ be a morphism of schemes which is locally of finite type. Let $\mathcal{F}, \mathcal{F}'$ be quasi-coherent $\mathcal{O}_X$-modules. If $\mathcal{F} \oplus \mathcal{F}'$ is finitely presented relative to $S$, then so are $\mathcal{F}$ and $\mathcal{F}'$. \end{lemma} 
\begin{lemma} \label{lemma-relatively-pseudo-coherent} Let $X \to S$ be a finite type morphism of affine schemes. Let $E$ be an object of $D(\mathcal{O}_X)$. Let $m \in \mathbf{Z}$. The following are equivalent \begin{enumerate} \item for some closed immersion $i : X \to \mathbf{A}^n_S$ the object $Ri_*E$ of $D(\mathcal{O}_{\mathbf{A}^n_S})$ is $m$-pseudo-coherent, and \item for all closed immersions $i : X \to \mathbf{A}^n_S$ the object $Ri_*E$ of $D(\mathcal{O}_{\mathbf{A}^n_S})$ is $m$-pseudo-coherent. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-relative-pseudo-coherence} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. Let $E$ be an object of $D(\mathcal{O}_X)$. Let $\mathcal{F}$ be an $\mathcal{O}_X$-module. Fix $m \in \mathbf{Z}$. \begin{enumerate} \item We say $E$ is {\it $m$-pseudo-coherent relative to $S$} if there exists an affine open covering $S = \bigcup V_i$ and for each $i$ an affine open covering $f^{-1}(V_i) = \bigcup U_{ij}$ such that the equivalent conditions of Lemma \ref{lemma-relatively-pseudo-coherent} are satisfied for each of the pairs $(U_{ij} \to V_i, E|_{U_{ij}})$. \item We say $E$ is {\it pseudo-coherent relative to $S$} if $E$ is $m$-pseudo-coherent relative to $S$ for all $m \in \mathbf{Z}$. \item We say $\mathcal{F}$ is {\it $m$-pseudo-coherent relative to $S$} if $\mathcal{F}$ viewed as an object of $D(\mathcal{O}_X)$ is $m$-pseudo-coherent relative to $S$. \item We say $\mathcal{F}$ is {\it pseudo-coherent relative to $S$} if $\mathcal{F}$ viewed as an object of $D(\mathcal{O}_X)$ is pseudo-coherent relative to $S$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-relative-pseudo-coherence} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. If $E$ in $D(\mathcal{O}_X)$ is $m$-pseudo-coherent relative to $S$, then $H^i(E)$ is a quasi-coherent $\mathcal{O}_X$-module for $i > m$. If $E$ is pseudo-coherent relative to $S$, then $E$ is an object of $D_\QCoh(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-localize-relative-pseudo-coherent} Let $S$ be an affine scheme. Let $V \subset S$ be a standard open. Let $X \to V$ be a finite type morphism of affine schemes. Let $U \subset X$ be an affine open. Let $E$ be an object of $D(\mathcal{O}_X)$. If the equivalent conditions of Lemma \ref{lemma-relatively-pseudo-coherent} are satisfied for the pair $(X \to V, E)$, then the equivalent conditions of Lemma \ref{lemma-relatively-pseudo-coherent} are satisfied for the pair $(U \to S, E|_U)$. \end{lemma} 
\begin{lemma} \label{lemma-glue-relative-pseudo-coherent} Let $X \to S$ be a finite type morphism of affine schemes. Let $E$ be an object of $D(\mathcal{O}_X)$. Let $m \in \mathbf{Z}$. Let $X = \bigcup U_i$ be a standard affine open covering. The following are equivalent \begin{enumerate} \item the equivalent conditions of Lemma \ref{lemma-relatively-pseudo-coherent} hold for the pairs $(U_i \to S, E|_{U_i})$, \item the equivalent conditions of Lemma \ref{lemma-relatively-pseudo-coherent} hold for the pair $(X \to S, E)$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-relative-pseudo-coherence-characterize} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. Let $E$ be an object of $D(\mathcal{O}_X)$. Fix $m \in \mathbf{Z}$. The following are equivalent \begin{enumerate} \item $E$ is $m$-pseudo-coherent relative to $S$, \item for every affine opens $U \subset X$ and $V \subset S$ with $f(U) \subset V$ the equivalent conditions of Lemma \ref{lemma-relatively-pseudo-coherent} are satisfied for the pair $(U \to V, E|_U)$. \end{enumerate} Moreover, if this is true, then for every open subschemes $U \subset X$ and $V \subset S$ with $f(U) \subset V$ the restriction $E|_U$ is $m$-pseudo-coherent relative to $V$. \end{lemma} 
\begin{lemma} \label{lemma-qcoh-relative-pseudo-coherence-characterize} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. Let $E$ be an object of $D_\QCoh(\mathcal{O}_X)$. Fix $m \in \mathbf{Z}$. The following are equivalent \begin{enumerate} \item $E$ is $m$-pseudo-coherent relative to $S$, \item there exists an affine open covering $S = \bigcup V_i$ and for each $i$ an affine open covering $f^{-1}(V_i) = \bigcup U_{ij}$ such that the complex of $\mathcal{O}_X(U_{ij})$-modules $R\Gamma(U_{ij}, E)$ is $m$-pseudo-coherent relative to $\mathcal{O}_S(V_i)$, and \item for every affine opens $U \subset X$ and $V \subset S$ with $f(U) \subset V$ the complex of $\mathcal{O}_X(U)$-modules $R\Gamma(U, E)$ is $m$-pseudo-coherent relative to $\mathcal{O}_S(V)$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-closed-morphism-relative-pseudo-coherence} Let $i : X \to Y$ morphism of schemes locally of finite type over a base scheme $S$. Assume that $i$ induces a homeomorphism of $X$ with a closed subset of $Y$. Let $E$ be an object of $D(\mathcal{O}_X)$. Then $E$ is $m$-pseudo-coherent relative to $S$ if and only if $Ri_*E$ is $m$-pseudo-coherent relative to $S$. \end{lemma} 
\begin{lemma} \label{lemma-finite-morphism-relative-pseudo-coherence} Let $\pi : X \to Y$ be a finite morphism of schemes locally of finite type over a base scheme $S$. Let $E$ be an object of $D_\QCoh(\mathcal{O}_X)$. Then $E$ is $m$-pseudo-coherent relative to $S$ if and only if $R\pi_*E$ is $m$-pseudo-coherent relative to $S$. \end{lemma} 
\begin{lemma} \label{lemma-cone-relatively-pseudo-coherent} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. Let $(E, E', E'')$ be a distinguished triangle of $D(\mathcal{O}_X)$. Let $m \in \mathbf{Z}$. \begin{enumerate} \item If $E$ is $(m + 1)$-pseudo-coherent relative to $S$ and $E'$ is $m$-pseudo-coherent relative to $S$ then $E''$ is $m$-pseudo-coherent relative to $S$. \item If $E, E''$ are $m$-pseudo-coherent relative to $S$, then $E'$ is $m$-pseudo-coherent relative to $S$. \item If $E'$ is $(m + 1)$-pseudo-coherent relative to $S$ and $E''$ is $m$-pseudo-coherent relative to $S$, then $E$ is $(m + 1)$-pseudo-coherent relative to $S$. \end{enumerate} Moreover, if two out of three of $E, E', E''$ are pseudo-coherent relative to $S$, the so is the third. \end{lemma} 
\begin{lemma} \label{lemma-rel-n-pseudo-module} Let $X \to S$ be a morphism of schemes which is locally of finite type. Let $\mathcal{F}$ be an $\mathcal{O}_X$-module. Then \begin{enumerate} \item $\mathcal{F}$ is $m$-pseudo-coherent relative to $S$ for all $m > 0$, \item $\mathcal{F}$ is $0$-pseudo-coherent relative to $S$ if and only if $\mathcal{F}$ is a finite type $\mathcal{O}_X$-module, \item $\mathcal{F}$ is $(-1)$-pseudo-coherent relative to $S$ if and only if $\mathcal{F}$ is quasi-coherent and finitely presented relative to $S$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-summands-relative-pseudo-coherent} Let $X \to S$ be a morphism of schemes which is locally of finite type. Let $m \in \mathbf{Z}$. Let $E, K$ be objects of $D(\mathcal{O}_X)$. If $E \oplus K$ is $m$-pseudo-coherent relative to $S$ so are $E$ and $K$. \end{lemma} 
\begin{lemma} \label{lemma-complex-relative-pseudo-coherent-modules} Let $X \to S$ be a morphism of schemes which is locally of finite type. Let $m \in \mathbf{Z}$. Let $\mathcal{F}^\bullet$ be a (locally) bounded above complex of $\mathcal{O}_X$-modules such that $\mathcal{F}^i$ is $(m - i)$-pseudo-coherent relative to $S$ for all $i$. Then $\mathcal{F}^\bullet$ is $m$-pseudo-coherent relative to $S$. \end{lemma} 
\begin{lemma} \label{lemma-cohomology-relative-pseudo-coherent} Let $X \to S$ be a morphism of schemes which is locally of finite type. Let $m \in \mathbf{Z}$. Let $E$ be an object of $D(\mathcal{O}_X)$. If $E$ is (locally) bounded above and $H^i(E)$ is $(m - i)$-pseudo-coherent relative to $S$ for all $i$, then $E$ is $m$-pseudo-coherent relative to $S$. \end{lemma} 
\begin{lemma} \label{lemma-base-change-relative-pseudo-coherent} Let $X \to S$ be a morphism of schemes which is locally of finite type. Let $m \in \mathbf{Z}$. Let $E$ be an object of $D(\mathcal{O}_X)$ which is $m$-pseudo-coherent relative to $S$. Let $S' \to S$ be a morphism of schemes. Set $X' = X \times_S S'$ and denote $E'$ the derived pullback of $E$ to $X'$. If $S'$ and $X$ are Tor independent over $S$, then $E'$ is $m$-pseudo-coherent relative to $S'$. \end{lemma} 
\begin{lemma} \label{lemma-pull-relative-pseudo-coherent} Let $f : X \to Y$ be a morphism of schemes locally of finite type over a base $S$. Let $m \in \mathbf{Z}$. Let $E$ be an object of $D(\mathcal{O}_Y)$. Assume \begin{enumerate} \item $\mathcal{O}_X$ is pseudo-coherent relative to $Y$\footnote{This means $f$ is pseudo-coherent, see Definition \ref{definition-pseudo-coherent}.}, and \item $E$ is $m$-pseudo-coherent relative to $S$. \end{enumerate} Then $Lf^*E$ is $m$-pseudo-coherent relative to $S$. \end{lemma} 
\begin{lemma} \label{lemma-composition-relative-pseudo-coherent} Let $f : X \to Y$ be a morphism of schemes locally of finite type over a base $S$. Let $m \in \mathbf{Z}$. Let $E$ be an object of $D(\mathcal{O}_X)$. Assume $\mathcal{O}_Y$ is pseudo-coherent relative to $S$\footnote{This means $Y \to S$ is pseudo-coherent, see Definition \ref{definition-pseudo-coherent}.}. Then the following are equivalent \begin{enumerate} \item $E$ is $m$-pseudo-coherent relative to $Y$, and \item $E$ is $m$-pseudo-coherent relative to $S$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-check-relative-pseudo-coherence-on-charts} Let $$ \xymatrix{ X \ar[rd] \ar[rr]_i & & P \ar[ld] \\ & S } $$ be a commutative diagram of schemes. Assume $i$ is a closed immersion and $P \to S$ flat and locally of finite presentation. Let $E$ be an object of $D(\mathcal{O}_X)$. Then the following are equivalent \begin{enumerate} \item $E$ is $m$-pseudo-coherent relative to $S$, \item $Ri_*E$ is $m$-pseudo-coherent relative to $S$, and \item $Ri_*E$ is $m$-pseudo-coherent on $P$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-pseudo-coherent} Let $f : X \to S$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item there exist an affine open covering $S = \bigcup V_j$ and for each $j$ an affine open covering $f^{-1}(V_j) = \bigcup U_{ji}$ such that $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_{ij})$ is a pseudo-coherent ring map, \item for every pair of affine opens $U \subset X$, $V \subset S$ such that $f(U) \subset V$ the ring map $\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is pseudo-coherent, and \item $f$ is locally of finite type and $\mathcal{O}_X$ is pseudo-coherent relative to $S$. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-pseudo-coherent} A morphism of schemes $f : X \to S$ is called {\it pseudo-coherent} if the equivalent conditions of Lemma \ref{lemma-pseudo-coherent} are satisfied. In this case we also say that $X$ is pseudo-coherent over $S$. \end{definition} 
\begin{lemma} \label{lemma-flat-base-change-pseudo-coherent} A flat base change of a pseudo-coherent morphism is pseudo-coherent. \end{lemma} 
\begin{lemma} \label{lemma-composition-pseudo-coherent} A composition of pseudo-coherent morphisms of schemes is pseudo-coherent. \end{lemma} 
\begin{lemma} \label{lemma-pseudo-coherent-finite-presentation} A pseudo-coherent morphism is locally of finite presentation. \end{lemma} 
\begin{lemma} \label{lemma-flat-finite-presentation-pseudo-coherent} A flat morphism which is locally of finite presentation is pseudo-coherent. \end{lemma} 
\begin{lemma} \label{lemma-permanence-pseudo-coherent} Let $f : X \to Y$ be a morphism of schemes pseudo-coherent over a base scheme $S$. Then $f$ is pseudo-coherent. \end{lemma} 
\begin{lemma} \label{lemma-finite-pseudo-coherent} Let $f : X \to S$ be a finite morphism of schemes. Then $f$ is pseudo-coherent if and only if $f_*\mathcal{O}_X$ is pseudo-coherent as an $\mathcal{O}_S$-module. \end{lemma} 
\begin{lemma} \label{lemma-Noetherian-pseudo-coherent} Let $f : X \to S$ be a morphism of schemes. If $S$ is locally Noetherian, then $f$ is pseudo-coherent if and only if $f$ is locally of finite type. \end{lemma} 
\begin{lemma} \label{lemma-descending-property-pseudo-coherent} The property $\mathcal{P}(f) =$``$f$ is pseudo-coherent'' is fpqc local on the base. \end{lemma} 
\begin{lemma} \label{lemma-quotient-of-flat-finitely-presented} Let $A \to B$ be a flat ring map of finite presentation. Let $I \subset B$ be an ideal. Then $A \to B/I$ is pseudo-coherent if and only if $I$ is pseudo-coherent as a $B$-module. \end{lemma} 
\begin{lemma} \label{lemma-pseudo-coherent-syntomic-local-source} The property $\mathcal{P}(f) =$``$f$ is pseudo-coherent'' is syntomic local on the source. \end{lemma} 
\begin{lemma} \label{lemma-pseudo-coherent-fppf-local-source} The property $\mathcal{P}(f) =$``$f$ is pseudo-coherent'' is fppf local on the source. \end{lemma} 
\begin{lemma} \label{lemma-perfect} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. The following are equivalent \begin{enumerate} \item there exist an affine open covering $S = \bigcup V_j$ and for each $j$ an affine open covering $f^{-1}(V_j) = \bigcup U_{ji}$ such that $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_{ij})$ is a perfect ring map, and \item for every pair of affine opens $U \subset X$, $V \subset S$ such that $f(U) \subset V$ the ring map $\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is perfect. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-perfect} A morphism of schemes $f : X \to S$ is called {\it perfect} if the equivalent conditions of Lemma \ref{lemma-perfect} are satisfied. In this case we also say that $X$ is perfect over $S$. \end{definition} 
\begin{lemma} \label{lemma-flat-base-change-perfect} A flat base change of a perfect morphism is perfect. \end{lemma} 
\begin{lemma} \label{lemma-composition-perfect} A composition of perfect morphisms of schemes is perfect. \end{lemma} 
\begin{lemma} \label{lemma-flat-finite-presentation-perfect} Let $f : X \to S$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item $f$ is flat and perfect, and \item $f$ is flat and locally of finite presentation. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-regular-target-perfect} Let $f : X \to S$ be a morphism of schemes. Assume $S$ is regular and $f$ is locally of finite type. Then $f$ is perfect. \end{lemma} 
\begin{lemma} \label{lemma-regular-immersion-perfect} A regular immersion of schemes is perfect. A Koszul-regular immersion of schemes is perfect. \end{lemma} 
\begin{lemma} \label{lemma-perfect-permanence} Let $$ \xymatrix{ X \ar[rr]_f \ar[rd] & & Y \ar[ld] \\ & S } $$ be a commutative diagram of morphisms of schemes. Assume $Y \to S$ smooth and $X \to S$ perfect. Then $f : X \to Y$ is perfect. \end{lemma} 
\begin{lemma} \label{lemma-descending-property-perfect} The property $\mathcal{P}(f) =$``$f$ is perfect'' is fpqc local on the base. \end{lemma} 
\begin{lemma} \label{lemma-check-perfect-stalks} Let $f : X \to S$ be a pseudo-coherent morphism of schemes. The following are equivalent \begin{enumerate} \item $f$ is perfect, \item $\mathcal{O}_X$ locally has finite tor dimension as a sheaf of $f^{-1}\mathcal{O}_S$-modules, and \item for all $x \in X$ the ring $\mathcal{O}_{X, x}$ has finite tor dimension as an $\mathcal{O}_{S, f(x)}$-module. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-perfect-closed-immersion-perfect-direct-image} Let $i : Z \to X$ be a perfect closed immersion of schemes. Then $i_*\mathcal{O}_Z$ is a perfect $\mathcal{O}_X$-module, i.e., it is a perfect object of $D(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-perfect-proper-perfect-direct-image} Let $S$ be a Noetherian scheme. Let $f : X \to S$ be a perfect proper morphism of schemes. Let $E \in D(\mathcal{O}_X)$ be perfect. Then $Rf_*E$ is a perfect object of $D(\mathcal{O}_S)$. \end{lemma} 
\begin{lemma} \label{lemma-perfect-fppf-local-source} The property $\mathcal{P}(f) =$``$f$ is perfect'' is fppf local on the source. \end{lemma} 
\begin{lemma} \label{lemma-factor-regular-immersion} Let $i : Z \to Y$ and $j : Y \to X$ be immersions of schemes. Assume \begin{enumerate} \item $X$ is locally Noetherian, \item $j \circ i$ is a regular immersion, and \item $i$ is perfect. \end{enumerate} Then $i$ and $j$ are regular immersions. \end{lemma} 
\begin{lemma} \label{lemma-koszul-independence-factorization} Let $S$ be a scheme. Let $U$, $P$, $P'$ be schemes over $S$. Let $u \in U$. Let $i : U \to P$, $i' : U \to P'$ be immersions over $S$. Assume $P$ and $P'$ smooth over $S$. Then the following are equivalent \begin{enumerate} \item $i$ is a Koszul-regular immersion in a neighbourhood of $u$, and \item $i'$ is a Koszul-regular immersion in a neighbourhood of $u$. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-lci} Let $f : X \to S$ be a morphism of schemes. \begin{enumerate} \item Let $x \in X$. We say that $f$ is {\it Koszul at $x$} if $f$ is of finite type at $x$ and there exists an open neighbourhood and a factorization of $f|_U$ as $\pi \circ i$ where $i : U \to P$ is a Koszul-regular immersion and $\pi : P \to S$ is smooth. \item We say $f$ is a {\it Koszul morphism}, or that $f$ is a {\it local complete intersection morphism} if $f$ is Koszul at every point. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-lci} Let $f : X \to S$ be a local complete intersection morphism. Let $P$ be a scheme smooth over $S$. Let $U \subset X$ be an open subscheme and $i : U \to P$ an immersion of schemes over $S$. Then $i$ is a Koszul-regular immersion. \end{lemma} 
\begin{lemma} \label{lemma-lci-properties} Let $f : X \to S$ be a local complete intersection morphism. Then \begin{enumerate} \item $f$ is locally of finite presentation, \item $f$ is pseudo-coherent, and \item $f$ is perfect. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-affine-lci} Let $f : X = \Spec(B) \to S = \Spec(A)$ be a morphism of affine schemes. Then $f$ is a local complete intersection morphism if and only if $A \to B$ is a local complete intersection homomorphism, see More on Algebra, Definition \ref{more-algebra-definition-local-complete-intersection}. \end{lemma} 
\begin{lemma} \label{lemma-flat-base-change-lci} A flat base change of a local complete intersection morphism is a local complete intersection morphism. \end{lemma} 
\begin{lemma} \label{lemma-composition-lci} A composition of local complete intersection morphisms is a local complete intersection morphism. \end{lemma} 
\begin{lemma} \label{lemma-flat-lci} \begin{slogan} A morphism is flat and lci if and only if it is syntomic. \end{slogan} Let $f : X \to S$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item $f$ is flat and a local complete intersection morphism, and \item $f$ is syntomic. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-regular-immersion-lci} A regular immersion of schemes is a local complete intersection morphism. A Koszul-regular immersion of schemes is a local complete intersection morphism. \end{lemma} 
\begin{lemma} \label{lemma-lci-permanence} Let $$ \xymatrix{ X \ar[rr]_f \ar[rd] & & Y \ar[ld] \\ & S } $$ be a commutative diagram of morphisms of schemes. Assume $Y \to S$ smooth and $X \to S$ is a local complete intersection morphism. Then $f : X \to Y$ is a local complete intersection morphism. \end{lemma} 
\begin{lemma} \label{lemma-morphism-regular-schemes-is-lci} Let $f : X \to Y$ be a morphism of schemes. If $f$ is locally of finite type and $X$ and $Y$ are regular, then $f$ is a local complete intersection morphism. \end{lemma} 
\begin{lemma} \label{lemma-lci-avramov} Let $$ \xymatrix{ X \ar[rr]_f \ar[rd] & & Y \ar[ld] \\ & S } $$ be a commutative diagram of morphisms of schemes. Assume \begin{enumerate} \item $S$ is locally Noetherian, \item $Y \to S$ is locally of finite type, \item $f : X \to Y$ is perfect, \item $X \to S$ is a local complete intersection morphism. \end{enumerate} Then $X \to Y$ is a local complete intersection morphism and $Y \to S$ is Koszul at $f(x)$ for all $x \in X$. \end{lemma} 
\begin{lemma} \label{lemma-lci-to-regular} Let $$ \xymatrix{ X \ar[rr]_f \ar[rd] & & Y \ar[ld] \\ & S } $$ be a commutative diagram of morphisms of schemes. Assume $S$ is locally Noetherian, $Y \to S$ is locally of finite type, $Y$ is regular, and $X \to S$ is a local complete intersection morphism. Then $f : X \to Y$ is a local complete intersection morphism and $Y \to S$ is Koszul at $f(x)$ for all $x \in X$. \end{lemma} 
\begin{lemma} \label{lemma-perfect-conormal-free-lci} Let $i : X \to Y$ be an immersion. If \begin{enumerate} \item $i$ is perfect, \item $Y$ is locally Noetherian, and \item the conormal sheaf $\mathcal{C}_{X/Y}$ is finite locally free, \end{enumerate} then $i$ is a regular immersion. \end{lemma} 
\begin{lemma} \label{lemma-lci-NL} Let $f : X \to Y$ be a local complete intersection homomorphism. Then the naive cotangent complex $\NL_{X/Y}$ is a perfect object of $D(\mathcal{O}_X)$ of tor-amplitude in $[-1, 0]$. \end{lemma} 
\begin{lemma} \label{lemma-perfect-NL-lci} Let $f : X \to Y$ be a perfect morphism of locally Noetherian schemes. The following are equivalent \begin{enumerate} \item $f$ is a local complete intersection morphism, \item $\NL_{X/Y}$ has tor-amplitude in $[-1, 0]$, and \item $\NL_{X/Y}$ is perfect with tor-amplitude in $[-1, 0]$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-flat-fp-NL-lci} Let $f : X \to Y$ be a flat morphism of finite presentation. The following are equivalent \begin{enumerate} \item $f$ is a local complete intersection morphism, \item $f$ is syntomic, \item $\NL_{X/Y}$ has tor-amplitude in $[-1, 0]$, and \item $\NL_{X/Y}$ is perfect with tor-amplitude in $[-1, 0]$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-smooth-diagonal-perfect} Let $f : X \to Y$ be a finite type morphism of locally Noetherian schemes. Denote $\Delta : X \to X \times_Y X$ the diagonal morphism. The following are equivalent \begin{enumerate} \item $f$ is smooth, \item $f$ is flat and $\Delta : X \to X \times_Y X$ is a regular immersion, \item $f$ is flat and $\Delta : X \to X \times_Y X$ is a local complete intersection morphism, \item $f$ is flat and $\Delta : X \to X \times_Y X$ is perfect. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-descending-property-lci} The property $\mathcal{P}(f) =$``$f$ is a local complete intersection morphism'' is fpqc local on the base. \end{lemma} 
\begin{lemma} \label{lemma-lci-syntomic-local-source} The property $\mathcal{P}(f) =$``$f$ is a local complete intersection morphism'' is syntomic local on the source. \end{lemma} 
\begin{lemma} \label{lemma-base-change-lci-fibres} Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of schemes over $S$. Assume both $X$ and $Y$ are flat and locally of finite presentation over $S$. Then the set $$ \{x \in X \mid f\text{ Koszul at }x\}. $$ is open in $X$ and its formation commutes with arbitrary base change $S' \to S$. \end{lemma} 
\begin{lemma} \label{lemma-unramified-lci} Let $f : X \to Y$ be a local complete intersection morphism of schemes. Then $f$ is unramified if and only if $f$ is formally unramified and in this case the conormal sheaf $\mathcal{C}_{X/Y}$ is finite locally free on $X$. \end{lemma} 
\begin{lemma} \label{lemma-transitivity-conormal-lci} Let $Z \to Y \to X$ be formally unramified morphisms of schemes. Assume that $Z \to Y$ is a local complete intersection morphism. The exact sequence $$ 0 \to i^*\mathcal{C}_{Y/X} \to \mathcal{C}_{Z/X} \to \mathcal{C}_{Z/Y} \to 0 $$ of Lemma \ref{lemma-transitivity-conormal} is short exact. \end{lemma} 
\begin{definition} \label{definition-weakly-etale} A morphism of schemes $X \to Y$ is {\it weakly \'etale} or {\it absolutely flat} if both $X \to Y$ and the diagonal morphism $X \to X \times_Y X$ are flat. \end{definition} 
\begin{lemma} \label{lemma-check-weakly-etale-stalks} Let $f : X \to Y$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item $X \to Y$ is weakly \'etale, and \item for every $x \in X$ the ring map $\mathcal{O}_{Y, f(x)} \to \mathcal{O}_{X, x}$ is weakly \'etale. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-key} Let $X \to Y$ be a morphism of schemes such that $X \to X \times_Y X$ is flat. Let $\mathcal{F}$ be an $\mathcal{O}_X$-module. If $\mathcal{F}$ is flat over $Y$, then $\mathcal{F}$ is flat over $X$. \end{lemma} 
\begin{lemma} \label{lemma-weakly-etale-characterize} Let $f : X \to S$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item The morphism $f$ is weakly \'etale. \item For every affine opens $U \subset X$, $V \subset S$ with $f(U) \subset V$ the ring map $\mathcal{O}_S(V) \to \mathcal{O}_X(U)$ is weakly \'etale. \item There exists an open covering $S = \bigcup_{j \in J} V_j$ and open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such that each of the morphisms $U_i \to V_j$, $j\in J, i\in I_j$ is weakly \'etale. \item There exists an affine open covering $S = \bigcup_{j \in J} V_j$ and affine open coverings $f^{-1}(V_j) = \bigcup_{i \in I_j} U_i$ such that the ring map $\mathcal{O}_S(V_j) \to \mathcal{O}_X(U_i)$ is of weakly \'etale, for all $j\in J, i\in I_j$. \end{enumerate} Moreover, if $f$ is weakly \'etale then for any open subschemes $U \subset X$, $V \subset S$ with $f(U) \subset V$ the restriction $f|_U : U \to V$ is weakly-\'etale. \end{lemma} 
\begin{lemma} \label{lemma-composition-weakly-etale} Let $X \to Y \to Z$ be morphisms of schemes. \begin{enumerate} \item If $X \to X \times_Y X$ and $Y \to Y \times_Z Y$ are flat, then $X \to X \times_Z X$ is flat. \item If $X \to Y$ and $Y \to Z$ are weakly \'etale, then $X \to Z$ is weakly \'etale. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-base-change-weakly-etale} Let $X \to Y$ and $Y' \to Y$ be morphisms of schemes and let $X' = Y' \times_Y X$ be the base change of $X$. \begin{enumerate} \item If $X \to X \times_Y X$ is flat, then $X' \to X' \times_{Y'} X'$ is flat. \item If $X \to Y$ is weakly \'etale, then $X' \to Y'$ is weakly \'etale. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-go-down} Let $X \to Y \to Z$ be morphisms of schemes. Assume that $X \to Y$ is flat and surjective and that $X \to X \times_Z X$ is flat. Then $Y \to Y \times_Z Y$ is flat. \end{lemma} 
\begin{lemma} \label{lemma-weakly-etale-formally-unramified} Let $f : X \to Y$ be a weakly \'etale morphism of schemes. Then $f$ is formally unramified, i.e., $\Omega_{X/Y} = 0$. \end{lemma} 
\begin{lemma} \label{lemma-when-weakly-etale} Let $f : X \to Y$ be a morphism of schemes. Then $X \to Y$ is weakly \'etale in each of the following cases \begin{enumerate} \item $X \to Y$ is a flat monomorphism, \item $X \to Y$ is an open immersion, \item $X \to Y$ is flat and unramified, \item $X \to Y$ is \'etale. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-reduced-goes-up} Let $f : X \to Y$ be a morphism of schemes. If $Y$ is reduced and $f$ weakly \'etale, then $X$ is reduced. \end{lemma} 
\begin{lemma} \label{lemma-weakly-etale-strictly-henselian-local-rings} Let $f : X \to Y$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item $f$ is weakly \'etale, and \item for $x \in X$ the local ring map $\mathcal{O}_{Y, f(x)} \to \mathcal{O}_{X, x}$ induces an isomorphism on strict henselizations. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-normal-goes-up} Let $f : X \to Y$ be a morphism of schemes. If $Y$ is a normal scheme and $f$ weakly \'etale, then $X$ is a normal scheme. \end{lemma} 
\begin{lemma} \label{lemma-weakly-etale-permanence} Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of schemes over $S$. If $X$, $Y$ are weakly \'etale over $S$, then $f$ is weakly \'etale. \end{lemma} 
\begin{lemma} \label{lemma-weakly-etale-universal-homeomorphism} Let $f : X \to Y$ be a morphism of schemes. If $f$ is weakly \'etale and a universal homeomorphism, it is an isomorphism.  \end{lemma} 
\begin{lemma} \label{lemma-relative-frobenius-weakly-etale} Let $U \to X$ be a weakly \'etale morphism of schemes where $X$ is a scheme in characteristic $p$. Then the relative Frobenius $F_{U/X} : U \to U \times_{X, F_X} X$ is an isomorphism. \end{lemma} 
\begin{theorem} \label{theorem-normalized-base-change-with-reduced-fibre} Let $A$ be a Dedekind ring with fraction field $K$. Let $X$ be a scheme flat and of finite type over $A$. Assume $A$ is a Nagata ring. There exists a finite extension $L/K$ such that the normalized base change $Y$ is smooth over $\Spec(B)$ at all generic points of all fibres. \end{theorem} 
\begin{lemma}[Variant over curves] \label{lemma-normalized-base-change-with-reduced-fibre-over-curve} Let $f : X \to S$ be a flat, finite type morphism of schemes. Assume $S$ is Nagata, integral with function field $K$, and regular of dimension $1$. Then there exists a finite extension $L/K$ such that in the diagram $$ \xymatrix{ Y \ar[rd]_g \ar[r]_-\nu & X \times_S T \ar[d] \ar[r] & X \ar[d]_f \\ & T \ar[r] & S } $$ the morphism $g$ is smooth at all generic points of fibres. Here $T$ is the normalization of $S$ in $\Spec(L)$ and $\nu : Y \to X \times_S T$ is the normalization. \end{lemma} 
\begin{lemma}[Variant with separable extension] \label{lemma-normalized-base-change-with-reduced-fibre-separable} Let $A$ be a Dedekind ring with fraction field $K$. Let $X$ be a scheme flat and of finite type over $A$. Assume $A$ is a Nagata ring and that for every generic point $\eta$ of an irreducible component of $X$ the field extension $\kappa(\eta)/K$ is separable. Then there exists a finite separable extension $L/K$ such that the normalized base change $Y$ is smooth over $\Spec(B)$ at all generic points of all fibres. \end{lemma} 
\begin{lemma}[Variant with separable extensions over curves] \label{lemma-normalized-base-change-with-reduced-fibre-over-curve-separable} Let $f : X \to S$ be a flat, finite type morphism of schemes. Assume $S$ is Nagata, integral with function field $K$, and regular of dimension $1$. Assume the field extensions $\kappa(\eta)/K$ are separable for every generic point $\eta$ of an irreducible component of $X$. Then there exists a finite separable extension $L/K$ such that in the diagram $$ \xymatrix{ Y \ar[rd]_g \ar[r]_-\nu & X \times_S T \ar[d] \ar[r] & X \ar[d]_f \\ & T \ar[r] & S } $$ the morphism $g$ is smooth at all generic points of fibres. Here $T$ is the normalization of $S$ in $\Spec(L)$ and $\nu : Y \to X \times_S T$ is the normalization. \end{lemma} 
\begin{definition} \label{definition-ind-quasi-affine} A scheme $X$ is {\it ind-quasi-affine} if every quasi-compact open of $X$ is quasi-affine. Similarly, a morphism of schemes $X \to Y$ is {\it ind-quasi-affine} if $f^{-1}(V)$ is ind-quasi-affine for each affine open $V$ in $Y$. \end{definition} 
\begin{lemma} \label{lemma-ind-quasi-affine-alternative-definition} For a morphism of schemes $f : X \to Y$, the following are equivalent: \begin{enumerate} \item $f$ is ind-quasi-affine, \item for every affine open subscheme $V \subset Y$ and every quasi-compact open subscheme $U \subset f^{-1}(V)$, the induced morphism $U \to V$ is quasi-affine.  \item for some cover $\{ V_j \}_{j \in J}$ of $Y$ by quasi-compact and quasi-separated open subschemes $V_j \subset Y$, every $j \in J$, and every quasi-compact open subscheme $U \subset f^{-1}(V_j)$, the induced morphism $U \to V_j$ is quasi-affine. \item for every quasi-compact and quasi-separated open subscheme $V \subset Y$ and every quasi-compact open subscheme $U \subset f^{-1}(V)$, the induced morphism $U \to V$ is quasi-affine. \end{enumerate} In particular, the property of being an ind-quasi-affine morphism is Zariski local on the base. \end{lemma} 
\begin{lemma} \label{lemma-ind-quasi-affine-composition} The property of being an ind-quasi-affine morphism is stable under composition. \end{lemma} 
\begin{lemma} \label{lemma-ind-quasi-affine-examples} Any quasi-affine morphism is ind-quasi-affine. Any immersion is ind-quasi-affine. \end{lemma} 
\begin{lemma} \label{lemma-ind-quasi-affine-permanence} If $f : X \to Y$ and $g : Y \to Z$ are morphisms of schemes such that $g \circ f$ is ind-quasi-affine, then $f$ is ind-quasi-affine. \end{lemma} 
\begin{lemma} \label{lemma-base-change-ind-quasi-affine} The property of being ind-quasi-affine is stable under base change. \end{lemma} 
\begin{lemma} \label{lemma-descending-property-ind-quasi-affine} The property of being ind-quasi-affine is fpqc local on the base. \end{lemma} 
\begin{lemma} \label{lemma-etale-separated-ind-quasi-affine} A separated locally quasi-finite morphism of schemes is ind-quasi-affine. \end{lemma} 
\begin{lemma} \label{lemma-prepare-pushout-along-closed-immersion-and-integral} In Situation \ref{situation-pushout-along-closed-immersion-and-integral} then for $y \in Y$ there exist affine opens $U \subset X$ and $V \subset Y$ with $i^{-1}(U) = j^{-1}(V)$ and $y \in V$. \end{lemma} 
\begin{proposition} \label{proposition-pushout-along-closed-immersion-and-integral} \begin{reference} \cite[Theorem 7.1 part iii]{Ferrand-Conducteur} \end{reference} In Situation \ref{situation-pushout-along-closed-immersion-and-integral} the pushout $Y \amalg_Z X$ exists in the category of schemes. Picture $$ \xymatrix{ Z \ar[r]_i \ar[d]_j & X \ar[d]^a \\ Y \ar[r]^-b & Y \amalg_Z X } $$ The diagram is a fibre square, the morphism $a$ is integral, the morphism $b$ is a closed immersion, and $$ \mathcal{O}_{Y \amalg_Z X} = b_*\mathcal{O}_Y \times_{c_*\mathcal{O}_Z} a_*\mathcal{O}_X $$ as sheaves of rings where $c = a \circ i = b \circ j$. \end{proposition} 
\begin{lemma} \label{lemma-pushout-separated} In Situation \ref{situation-pushout-along-closed-immersion-and-integral}. If $X$ and $Y$ are separated, then the pushout $Y \amalg_Z X$ (Proposition \ref{proposition-pushout-along-closed-immersion-and-integral}) is separated. Same with ``separated over $S$'', ``quasi-separated'', and ``quasi-separated over $S$''. \end{lemma} 
\begin{lemma} \label{lemma-pushout-finite-type} In Situation \ref{situation-pushout-along-closed-immersion-and-integral} assume $S$ is a locally Noetherian scheme and $X$, $Y$, and $Z$ are locally of finite type over $S$. Then the pushout $Y \amalg_Z X$ (Proposition \ref{proposition-pushout-along-closed-immersion-and-integral}) is locally of finite type over $S$. \end{lemma} 
\begin{lemma} \label{lemma-pushout-functor} In Situation \ref{situation-pushout-along-closed-immersion-and-integral} suppose given a commutative diagram $$ \xymatrix{ Y' \ar[d]^g & Z' \ar[l]^{j'} \ar[r]_{i'} \ar[d]^h & X' \ar[d]^f \\ Y & Z \ar[l] \ar[r] & X } $$ with cartesian squares and $f, g, h$ separated and locally quasi-finite. Then \begin{enumerate} \item the pushouts $Y \amalg_Z X$ and $Y' \amalg_{Z'} X'$ exist, \item $Y' \amalg_{Z'} X' \to Y \amalg_Z X$ is separated and locally quasi-finite, and \item the squares $$ \xymatrix{ Y' \ar[r] \ar[d] & Y' \amalg_{Z'} X' \ar[d] & X' \ar[l] \ar[d] \\ Y \ar[r] & Y \amalg_Z X & X \ar[l] } $$ are cartesian. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-pushout-functor-equivalence-flat} In Situation \ref{situation-pushout-along-closed-immersion-and-integral} the category of schemes flat, separated, and locally quasi-finite over the pushout $Y \amalg_Z X$ is equivalent to the category of $(X', Y', Z', i', j', f, g, h)$ as in Lemma \ref{lemma-pushout-functor} with $f, g, h$ flat. Similarly with ``flat'' replaced with ``\'etale''. \end{lemma} 
\begin{lemma} \label{lemma-pushout-along-closed-immersions} Let $i : Z \to X$ and $j : Z \to Y$ be closed immersions of schemes. Then the pushout $Y \amalg_Z X$ exists in the category of schemes. Picture $$ \xymatrix{ Z \ar[r]_i \ar[d]_j & X \ar[d]^a \\ Y \ar[r]^-b & Y \amalg_Z X } $$ The diagram is a fibre square, the morphisms $a$ and $b$ are closed immersions, and there is a short exact sequence $$ 0 \to \mathcal{O}_{Y \amalg_Z X} \to a_*\mathcal{O}_X \oplus b_*\mathcal{O}_Y \to c_*\mathcal{O}_Z \to 0 $$ where $c = a \circ i = b \circ j$. \end{lemma} 
\begin{lemma} \label{lemma-pushout-along-closed-immersions-properties-above} Let $i : Z \to X$ and $j : Z \to Y$ be closed immersions of schemes. Let $f : X' \to X$ and $g : Y' \to Y$ be morphisms of schemes and let $\varphi : X' \times_{X, i} Z \to Y' \times_{Y, j} Z$ be an isomorphism of schemes over $Z$. Consider the morphism $$ h : X' \amalg_{X' \times_{X, i} Z, \varphi} Y' \longrightarrow X \amalg_Z Y $$ Then we have \begin{enumerate} \item $h$ is locally of finite type if and only if $f$ and $g$ are locally of finite type, \item $h$ is flat if and only if $f$ and $g$ are flat, \item $h$ is flat and locally of finite presentation if and only if $f$ and $g$ are flat and locally of finite presentation, \item $h$ is smooth if and only if $f$ and $g$ are smooth, \item $h$ is \'etale if and only if $f$ and $g$ are \'etale, and \item add more here as needed. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-hom-from-finite-free-into-affine} Let $Z \to S$ and $X \to S$ be morphisms of affine schemes. Assume $\Gamma(Z, \mathcal{O}_Z)$ is a finite free $\Gamma(S, \mathcal{O}_S)$-module. Then $\mathit{Mor}_S(Z, X)$ is representable by an affine scheme over $S$. \end{lemma} 
\begin{lemma} \label{lemma-hom-from-finite-locally-free-into-affine} Let $Z \to S$ and $X \to S$ be morphisms of schemes. If $Z \to S$ is finite locally free and $X \to S$ is affine, then $\mathit{Mor}_S(Z, X)$ is representable by a scheme affine over $S$. \end{lemma} 
\begin{lemma} \label{lemma-hom-from-finite-locally-free-representable} Let $Z \to S$ and $X \to S$ be morphisms of schemes. Assume \begin{enumerate} \item $Z \to S$ is finite locally free, and \item for all $(s, x_1, \ldots, x_d)$ where $s \in S$ and $x_1, \ldots, x_d \in X_s$ there exists an affine open $U \subset X$ with $x_1, \ldots, x_d \in U$. \end{enumerate} Then $\mathit{Mor}_S(Z, X)$ is representable by a scheme. \end{lemma} 
\begin{lemma} \label{lemma-hom-from-finite-locally-free-separated-lqf} Let $Z \to S$ and $X \to S$ be morphisms of schemes. Assume $Z \to S$ is finite locally free and $X \to S$ is separated and locally quasi-finite. Then $\mathit{Mor}_S(Z, X)$ is representable by a scheme. \end{lemma} 
\begin{lemma} \label{lemma-case-of-tor-independence} Consider a commutative diagram of schemes $$ \xymatrix{ Z' \ar[d] \ar[r] & Y' \ar[d] \\ X' \ar[r] & S' } $$ Let $S \to S'$ be a morphism. Denote by $X$ and $Y$ the base changes of $X'$ and $Y'$ to $S$. Assume $Y' \to S'$ and $Z' \to X'$ are flat. Then $X \times_S Y$ and $Z'$ are Tor independent over $X' \times_{S'} Y'$. \end{lemma} 
\begin{lemma}[Derived Chow's lemma] \label{lemma-derived-chow} Let $A$ be a ring. Let $X$ be a separated scheme of finite presentation over $A$. Let $x \in X$. Then there exist an open neighbourhood $U \subset X$ of $x$, an $n \geq 0$, an open $V \subset \mathbf{P}^n_A$, a closed subscheme $Z \subset X \times_A \mathbf{P}^n_A$, a point $z \in Z$, and an object $E$ in $D(\mathcal{O}_{X \times_A \mathbf{P}^n_A})$ such that \begin{enumerate} \item $Z \to X \times_A \mathbf{P}^n_A$ is of finite presentation, \item $b : Z \to X$ is an isomorphism over $U$ and $b(z) = x$, \item $c : Z \to \mathbf{P}^n_A$ is a closed immersion over $V$, \item $b^{-1}(U) = c^{-1}(V)$, in particular $c(z) \in V$, \item $E|_{X \times_A V} \cong (b, c)_*\mathcal{O}_Z|_{X \times_A V}$, \item $E$ is pseudo-coherent and supported on $Z$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-compute-Fourier-Mukai-for-derived-chow} Let $A$, $x \in X$, and $U, n, V, Z, z, E$ be as in Lemma \ref{lemma-derived-chow}. For any $K \in D_\QCoh(\mathcal{O}_X)$ we have $$ Rq_*(Lp^*K \otimes^\mathbf{L} E)|_V = R(U \to V)_*K|_U $$ where $p : X \times_A \mathbf{P}^n_A \to X$ and $q : X \times_A \mathbf{P}^n_A \to \mathbf{P}^n_A$ are the projections and where the morphism $U \to V$ is the finitely presented closed immersion $c \circ (b|_U)^{-1}$. \end{lemma} 
\begin{lemma} \label{lemma-characterize-pseudo-coherent} Let $A$ be a ring. Let $X$ be a scheme separated and of finite presentation over $A$. Let $K \in D_\QCoh(\mathcal{O}_X)$. If $R\Gamma(X, E \otimes^\mathbf{L} K)$ is pseudo-coherent in $D(A)$ for every pseudo-coherent $E$ in $D(\mathcal{O}_X)$, then $K$ is pseudo-coherent relative to $A$. \end{lemma} 
\begin{lemma} \label{lemma-characterize-pseudo-coh-improved} Let $A$ be a ring. Let $X$ be a scheme separated and of finite presentation over $A$. Let  $K \in D_\QCoh(\mathcal{O}_X).$ If  $R \Gamma (X, E \otimes ^{\mathbf{L}} K)$ is pseudo-coherent in $D(A)$ for every perfect  $E \in D(\mathcal{O}_X)$, then $K$ is pseudo-coherent relative to $A$. \end{lemma} 
\begin{lemma} \label{lemma-characterize-relatively-perfect} Let $A$ be a ring. Let $X$ be a scheme separated, of finite presentation, and flat over $A$. Let  $K \in D_\QCoh(\mathcal{O}_X).$ If  $R \Gamma (X, E \otimes^\mathbf{L} K)$ is perfect in $D(A)$ for every perfect $E \in D(\mathcal{O}_X)$, then $K$ is $\Spec(A)$-perfect. \end{lemma} 
\begin{lemma} \label{lemma-relative-pseudo-coherent-descends-fppf} Let $X \to S$ be locally of finite type. Let $\{f_i : X_i \to X\}$ be an fppf covering of schemes. Let $E \in D_\QCoh(\mathcal{O}_X)$. Let $m \in \mathbf{Z}$. Then $E$ is $m$-pseudo-coherent relative to $S$ if and only if each $Lf_i^*E$ is $m$-pseudo-coherent relative to $S$. \end{lemma} 
\begin{lemma} \label{lemma-relative-pseudo-coherent-post-compose} Let $X \to T \to S$ be morphisms of schemes. Assume $T \to S$ is flat and locally of finite presentation and $X \to T$ locally of finite type. Let $E \in D(\mathcal{O}_X)$. Let $m \in \mathbf{Z}$. Then $E$ is $m$-pseudo-coherent relative to $S$ if and only if $E$ is $m$-pseudo-coherent relative to $T$. \end{lemma} 
\begin{lemma} \label{lemma-relative-pseudo-coherent-descends-fppf-base} Let $f : X \to S$ be locally of finite type. Let $\{S_i \to S\}$ be an fppf covering of schemes. Denote $f_i : X_i \to S_i$ the base change of $f$ and $g_i : X_i \to X$ the projection. Let $E \in D_\QCoh(\mathcal{O}_X)$. Let $m \in \mathbf{Z}$. Then $E$ is $m$-pseudo-coherent relative to $S$ if and only if each $Lg_i^*E$ is $m$-pseudo-coherent relative to $S_i$. \end{lemma} 
\begin{lemma} \label{lemma-thickening-pseudo-coherent} Let $i : X \to X'$ be a finite order thickening of schemes. Let $K' \in D(\mathcal{O}_{X'})$ be an object such that $K = Li^*K'$ is pseudo-coherent. Then $K'$ is pseudo-coherent. \end{lemma} 
\begin{lemma} \label{lemma-thickening-relatively-perfect} Consider a cartesian diagram $$ \xymatrix{ X \ar[r]_i \ar[d]_f & X' \ar[d]^{f'} \\ Y \ar[r]^j & Y' } $$ of schemes. Assume $X' \to Y'$ is flat and locally of finite presentation and $Y \to Y'$ is a finite order thickening. Let $E' \in D(\mathcal{O}_{X'})$. If $E = Li^*(E')$ is $Y$-perfect, then $E'$ is $Y'$-perfect. \end{lemma} 
\begin{lemma} \label{lemma-henselian-relatively-perfect} Let $(R, I)$ be a pair consisting of a ring and an ideal $I$ contained in the Jacobson radical. Set $S = \Spec(R)$ and $S_0 = \Spec(R/I)$. Let $f : X \to S$ be proper, flat, and of finite presentation. Denote $X_0 = S_0 \times_S X$. Let $E \in D(\mathcal{O}_X)$ be pseudo-coherent. If the derived restriction $E_0$ of $E$ to $X_0$ is $S_0$-perfect, then $E$ is $S$-perfect. \end{lemma} 
\begin{lemma} \label{lemma-check-h1-fibre-zero} Let $f : X \to Y$ be a proper morphism of schemes. Let $y \in Y$ be a point with $\dim(X_y) \leq 1$. If \begin{enumerate} \item $R^1f_*\mathcal{O}_X = 0$, or more generally \item there is a morphism $g : Y' \to Y$ such that $y$ is in the image of $g$ and such that $R'f'_*\mathcal{O}_{X'} = 0$ where $f' : X' \to Y'$ is the base change of $f$ by $g$. \end{enumerate} Then $H^1(X_y, \mathcal{O}_{X_y}) = 0$. \end{lemma} 
\begin{lemma} \label{lemma-h1-fibre-zero} Let $f : X \to Y$ be a proper morphism of schemes. Let $y \in Y$ be a point with $\dim(X_y) \leq 1$ and $H^1(X_y, \mathcal{O}_{X_y}) = 0$. Then there is an open neighbourhood $V \subset Y$ of $y$ such that $R^1f_*\mathcal{O}_X|_V = 0$ and the same is true after base change by any $Y' \to V$. \end{lemma} 
\begin{lemma} \label{lemma-globally-generated-vanishing} Let $f : X \to Y$ be a proper morphism of schemes such that $\dim(X_y) \leq 1$ and $H^1(X_y, \mathcal{O}_{X_y}) = 0$ for all $y \in Y$. Let $\mathcal{F}$ be quasi-coherent on $X$. Then \begin{enumerate} \item $R^pf_*\mathcal{F} = 0$ for $p > 1$, and \item $R^1f_*\mathcal{F} = 0$ if there is a surjection $f^*\mathcal{G} \to \mathcal{F}$ with $\mathcal{G}$ quasi-coherent on $Y$. \end{enumerate} If $Y$ is affine, then we also have \begin{enumerate} \item[(3)] $H^p(X, \mathcal{F}) = 0$ for $p \not \in \{0, 1\}$, and \item[(4)] $H^1(X, \mathcal{F}) = 0$ if $\mathcal{F}$ is globally generated. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-h1-fibre-zero-check-h0-kappa} Let $f : X \to Y$ be a proper morphism of schemes. Assume \begin{enumerate} \item for all $y \in Y$ we have $\dim(X_y) \leq 1$ and $H^1(X_y, \mathcal{O}_{X_y}) = 0$, and \item $\mathcal{O}_Y \to f_*\mathcal{O}_X$ is surjective. \end{enumerate} Then $\mathcal{O}_{Y'} \to f'_*\mathcal{O}_{X'}$ is surjective for any base change $f' : X' \to Y'$ of $f$. \end{lemma} 
\begin{lemma} \label{lemma-h1-fibre-zero-h0-kappa} Consider a commutative diagram $$ \xymatrix{ X \ar[rr]_f \ar[rd] & & Y \ar[ld] \\ & S } $$ of morphisms of schemes. Let $s \in S$ be a point. Assume \begin{enumerate} \item $X \to S$ is locally of finite presentation and flat at points of $X_s$, \item $f$ is proper, \item the fibres of $f_s : X_s \to Y_s$ have dimension $\leq 1$ and $R^1f_{s, *}\mathcal{O}_{X_s} = 0$, \item $\mathcal{O}_{Y_s} \to f_{s, *}\mathcal{O}_{X_s}$ is surjective. \end{enumerate} Then there is an open $Y_s \subset V \subset Y$ such that (a) $f^{-1}(V)$ is flat over $S$, (b) $\dim(X_y) \leq 1$ for $y \in V$, (c) $R^1f_*\mathcal{O}_X|_V = 0$, (d) $\mathcal{O}_V \to f_*\mathcal{O}_X|_V$ is surjective, and (b), (c), and (d) remain true after base change by any $Y' \to V$. \end{lemma} 
\begin{lemma} \label{lemma-h1-fibre-zero-h0-flat} Consider a commutative diagram $$ \xymatrix{ X \ar[rr]_f \ar[rd] & & Y \ar[ld] \\ & S } $$ of morphisms of schemes. Assume $X \to S$ is flat, $f$ is proper, $\dim(X_y) \leq 1$ for $y \in Y$, and $R^1f_*\mathcal{O}_X = 0$. Then $f_*\mathcal{O}_X$ is $S$-flat and formation of $f_*\mathcal{O}_X$ commutes with arbitrary base change $S' \to S$. \end{lemma} 
\begin{lemma} \label{lemma-h1-fibre-zero-isom} Consider a commutative diagram $$ \xymatrix{ X \ar[rr]_f \ar[rd] & & Y \ar[ld] \\ & S } $$ of morphisms of schemes. Let $s \in S$ be a point. Assume \begin{enumerate} \item $X \to S$ is locally of finite presentation and flat at points of $X_s$, \item $Y \to S$ is locally of finite presentation, \item $f$ is proper, \item the fibres of $f_s : X_s \to Y_s$ have dimension $\leq 1$ and $R^1f_{s, *}\mathcal{O}_{X_s} = 0$, \item $\mathcal{O}_{Y_s} \to f_{s, *}\mathcal{O}_{X_s}$ is an isomorphism. \end{enumerate} Then there is an open $Y_s \subset V \subset Y$ such that (a) $V$ is flat over $S$, (b) $f^{-1}(V)$ is flat over $S$, (c) $\dim(X_y) \leq 1$ for $y \in V$, (d) $R^1f_*\mathcal{O}_X|_V = 0$, (e) $\mathcal{O}_V \to f_*\mathcal{O}_X|_V$ is an isomorphism, and (a) -- (e) remain true after base change of $f^{-1}(V) \to V$ by any $S' \to S$. \end{lemma} 
\begin{lemma} \label{lemma-bijection-on-Pic} Let $f : X \to Y$ be a proper morphism of Noetherian schemes such that $f_*\mathcal{O}_X = \mathcal{O}_Y$, such that the fibres of $f$ have dimension $\leq 1$, and such that $H^1(X_y, \mathcal{O}_{X_y}) = 0$ for $y \in Y$. Then $f^* : \Pic(Y) \to \Pic(X)$ is a bijection onto the subgroup of $\mathcal{L} \in \Pic(X)$ with $\mathcal{L}|_{X_y} \cong \mathcal{O}_{X_y}$ for all $y \in Y$. \end{lemma} 
\begin{definition} \label{definition-affine-stratification} Let $X$ be a scheme. An {\it affine stratification} is a locally finite stratification $X = \coprod_{i \in I} X_i$ whose strata $X_i$ are affine and such that the inclusion morphisms $X_i \to X$ are affine. \end{definition} 
\begin{lemma} \label{lemma-improve-stratification} Let $X$ be a scheme. Let $X = \coprod_{i \in I} X_i$ be a finite affine stratification. There exists an affine stratification with index set $\{0, \ldots, n\}$ where $n$ is the length of $I$. \end{lemma} 
\begin{lemma} \label{lemma-qc-affine-stratification} Let $X$ be a scheme. The following are equivalent \begin{enumerate} \item $X$ has a finite affine stratification, and \item $X$ is quasi-compact and quasi-separated. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-affine-stratification-number} Let $X$ be a nonempty quasi-compact and quasi-separated scheme. The {\it affine stratification number} is the smallest integer $n \geq 0$ such that the following equivalent conditions are satisfied \begin{enumerate} \item there exists a finite affine stratification $X = \coprod_{i \in I} X_i$ where $I$ has length $n$, \item there exists an affine stratification $X = X_0 \amalg X_1 \amalg \ldots \amalg X_n$ with index set $\{0, \ldots, n\}$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-affine-stratification-number-bound} Let $X$ be a separated scheme which has an open covering by $n + 1$ affines. Then the affine stratification number of $X$ is at most $n$. \end{lemma} 
\begin{lemma} \label{lemma-affine-stratification-number-bound-Noetherian} Let $X$ be a Noetherian scheme of dimension $\infty > d \geq 0$. Then the affine stratification number of $X$ is at most $d$. \end{lemma} 
\begin{proposition} \label{proposition-vanishing-affine-stratification-number} Let $X$ be a nonempty quasi-compact and quasi-separated scheme with affine stratification number $n$. Then $H^p(X, \mathcal{F}) = 0$, $p > n$ for every quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$. \end{proposition} 
\begin{lemma} \label{lemma-test-universally-open} Let $f : X \to S$ be a morphism of schemes. The following are equivalent \begin{enumerate} \item $f$ is universally open, \item for every morphism $S' \to S$ which is locally of finite presentation the base change $X_{S'} \to S'$ is open, and \item for every $n$ the morphism $\mathbf{A}^n \times X \to \mathbf{A}^n \times S$ is open. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-quasi-finite-Noetherian-universally-open} Let $f : X \to Y$ be a morphism of schemes. If \begin{enumerate} \item $f$ is locally quasi-finite, \item $Y$ is geometrically unibranch and locally Noetherian, and \item every irreducible component of $X$ dominates an irreducible component of $Y$, \end{enumerate} then $f$ is universally open. \end{lemma} 
\begin{lemma} \label{lemma-characterize-universally-open-finite} Let $A \to B$ be a ring map. Say $B$ is generated as an $A$-module by $b_1, \ldots, b_d \in B$. Set $h = \sum x_ib_i \in B[x_1, \ldots, x_d]$. Then $\Spec(B) \to \Spec(A)$ is universally open if and only if the image of $D(h)$ in $\Spec(A[x_1, \ldots, x_d])$ is open. \end{lemma} 
\begin{lemma} \label{lemma-descend-quasi-finite-universally-open} Let $S = \lim S_i$ be a limit of a directed system of schemes with affine transition morphisms. Let $0 \in I$ and let $f_0 : X_0 \to Y_0$ be a morphism of schemes over $S_0$. Assume $S_0$, $X_0$, $Y_0$ are quasi-compact and quasi-separated. Let $f_i : X_i \to Y_i$ be the base change of $f_0$ to $S_i$ and let $f : X \to Y$ be the base change of $f_0$ to $S$. If \begin{enumerate} \item $f$ is locally quasi-finite and universally open, and \item $f_0$ is locally of finite presentation, \end{enumerate} then there exists an $i \geq 0$ such that $f_i$ is locally quasi-finite and universally open. \end{lemma} 
\begin{lemma} \label{lemma-count-geometric-fibres} Let $f : X \to Y$ be a locally quasi-finite morphism. Then \begin{enumerate} \item the functions $n_{X/Y}$ of Lemmas \ref{lemma-base-change-fibres-nr-geometrically-irreducible-components} and \ref{lemma-base-change-fibres-nr-geometrically-connected-components} agree, \item if $X$ is quasi-compact, then $n_{X/Y}$ attains a maximum $d < \infty$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-count-geometric-fibres-universally-open} Let $f : X \to Y$ be a separated, locally quasi-finite, and universally open morphism of schemes. Let $n_{X/Y}$ be as in Lemma \ref{lemma-count-geometric-fibres}. If $n_{X/Y}(y) \geq d$ for some $y \in Y$ and $d \geq 0$, then $n_{X/Y} \geq d$ in an open neighbourhood of $y$. \end{lemma} 
\begin{lemma} \label{lemma-large-open} Let $f : X \to Y$ be a separated, locally quasi-finite, and universally open morphism of schemes. Let $n_{X/Y}$ be as in Lemma \ref{lemma-count-geometric-fibres}. If $n_{X/Y}$ attains a maximum $d < \infty$, then the set $$ Y_d = \{y \in Y \mid n_{X/Y}(y) = d\} $$ is open in $Y$ and the morphism $f^{-1}(Y_d) \to Y_d$ is finite. \end{lemma} 
\begin{lemma} \label{lemma-weighting-check-after-etale-base-change} Given a cartesian square $$ \xymatrix{ U \ar[d]_\pi & U' \ar[l]^h \ar[d]^{\pi'} \\ V & V' \ar[l]_g } $$ with $\pi$ locally quasi-finite with finite fibres and a function $w : U \to \mathbf{Z}$ we have $(\int_\pi w) \circ g = \int_{\pi'} (w \circ h)$. \end{lemma} 
\begin{definition} \label{definition-weighting} Let $f : X \to Y$ be a locally quasi-finite morphism. A {\it weighting} or a {\it pond\'eration} of $f$ is a map $w : X \to \mathbf{Z}$ such that for any diagram $$ \xymatrix{ X \ar[d]_f & U \ar[l]^h \ar[d]^\pi \\ Y & V \ar[l]_g } $$ where $V \to Y$ is \'etale, $U \subset X_V$ is open, and $U \to V$ finite, the function $\int_\pi (w \circ h)$ is locally constant. \end{definition} 
\begin{lemma} \label{lemma-weighting-base-change} Let $f : X \to Y$ be a locally quasi-finite morphism. Let $w : X \to \mathbf{Z}$ be a weighting. Let $f' : X' \to Y'$ be the base change of $f$ by a morphism $Y' \to Y$. Then the composition $w' : X' \to \mathbf{Z}$ of $w$ and the projection $X' \to X$ is a weighting of $f'$. \end{lemma} 
\begin{lemma} \label{lemma-weighting-open} Let $f : X \to Y$ be a locally quasi-finite morphism. Let $w : X \to \mathbf{Z}$ be a weighting of $f$. If $X' \subset X$ is open, then $w|_{X'}$ is a weighting of $f|_{X'} : X' \to Y$. \end{lemma} 
\begin{lemma} \label{lemma-weighting-composition} Let $f : X \to Y$ and $g : Y \to Z$ be locally quasi-finite morphisms. Let $w_f : X \to \mathbf{Z}$ be a weighting of $f$ and let $w_g : Y \to \mathbf{Z}$ be a weighting of $g$. Then the function $$ X \longrightarrow \mathbf{Z},\quad x \longmapsto w_f(x) w_g(f(x)) $$ is a weighting of $g \circ f$. \end{lemma} 
\begin{lemma} \label{lemma-weighting-universally-open} Let $f : X \to Y$ be a locally quasi-finite morphism. Let $w : X \to \mathbf{Z}$ be a weighting. If $w(x) > 0$ for all $x \in X$, then $f$ is universally open. \end{lemma} 
\begin{lemma} \label{lemma-weighting-flat-quasi-finite} Let $f : X \to Y$ be a morphism of schemes. Assume $f$ is locally quasi-finite, locally of finite presentation, and flat. Then there is a positive weighting $w : X \to \mathbf{Z}_{> 0}$ of $f$ given by the rule that sends $x \in X$ lying over $y \in Y$ to $$ w(x) = \text{length}_{\mathcal{O}_{X, x}} (\mathcal{O}_{X, x}/\mathfrak m_y \mathcal{O}_{X, x}) [\kappa(x) : \kappa(y)]_i $$ where $[\kappa' : \kappa]_i$ is the inseparable degree (Fields, Definition \ref{fields-definition-insep-degree}). \end{lemma} 
\begin{lemma} \label{lemma-weighting-quasi-finite-Noetherian} Let $f : X \to Y$ be a morphism of schemes. Assume \begin{enumerate} \item $f$ is locally quasi-finite, and \item $Y$ is geometrically unibranch and locally Noetherian. \end{enumerate} Then there is a weighting $w : X \to \mathbf{Z}_{\geq 0}$ given by the rule that sends $x \in X$ lying over $y \in Y$ to the ``generic separable degree'' of $\mathcal{O}_{X, x}^{sh}$ over $\mathcal{O}_{Y, y}^{sh}$. \end{lemma} 
\begin{lemma} \label{lemma-jumps-w} Let $f : X \to Y$ be a locally quasi-finite morphism. Let $w : X \to \mathbf{Z}$ be a weighting of $f$. Then the level sets of the function $w$ are locally constructible in $X$. \end{lemma} 
\begin{lemma} \label{lemma-jumps-int-w} Let $f : X \to Y$ be a locally quasi-finite morphism of finite presentation. Let $w : X \to \mathbf{Z}$ be a weighting of $f$. Then the level sets of the function $\int_f w$ are locally constructible in $Y$. \end{lemma} 
\begin{lemma} \label{lemma-semicontinuous-w} Let $f : X \to Y$ be a locally quasi-finite morphism. Let $w : X \to \mathbf{Z}_{> 0}$ be a positive weighting of $f$. Then $w$ is upper semi-continuous. \end{lemma} 
\begin{lemma} \label{lemma-semicontinuous-int-w} Let $f : X \to Y$ be a separated, locally quasi-finite morphism with finite fibres. Let $w : X \to \mathbf{Z}_{> 0}$ be a positive weighting of $f$. Then $\int_f w$ is lower semi-continuous. \end{lemma} 
\begin{lemma} \label{lemma-max-int-w} Let $f : X \to Y$ be a locally quasi-finite morphism with $X$ quasi-compact. Let $w : X \to \mathbf{Z}$ be a weighting of $f$. Then $\int_f w$ attains its maximum. \end{lemma} 
\begin{lemma} \label{lemma-max-int-finite} Let $f : X \to Y$ be a separated, locally quasi-finite morphism. Let $w : X \to \mathbf{Z}_{> 0}$ be a positive weighting of $f$. Assume $\int_w f$ attains its maximum $d$ and let $Y_d \subset Y$ be the open set of points $y$ with $(\int_f w)(y) = d$. Then the morphism $f^{-1}(Y_d) \to Y_d$ is finite. \end{lemma} 
\begin{lemma} \label{lemma-open-and-closed-in-finite} Let $A \to B$ be a ring map which is finite and of finite presentation. There exists a finitely presented ring map $A \to A_{univ}$ and an idempotent $e_{univ} \in B \otimes_A A_{univ}$ such that for any ring map $A \to A'$ and idempotent $e \in B \otimes_A A'$ there is a ring map $A_{univ} \to A'$ mapping $e_{univ}$ to $e$. \end{lemma} 
\begin{lemma} \label{lemma-open-and-closed-in-quasi-finite} Let $X \to Y$ be a morphism of affine schemes which is quasi-finite and of finite presentation. There exists a morphism $Y_{univ} \to Y$ of finite presentation and an open subscheme $U_{univ} \subset Y_{univ} \times_Y X$ such that $U_{univ} \to Y_{univ}$ is finite with the following property: given any morphism $Y' \to Y$ of affine schemes and an open subscheme $U' \subset Y' \times_Y X$ such that $U' \to Y'$ is finite, there exists a morphism $Y' \to Y_{univ}$ such that the inverse image of $U_{univ}$ is $U'$. \end{lemma} 
\begin{lemma} \label{lemma-descend-weighting} Let $Y = \lim Y_i$ be a directed limit of affine schemes. Let $0 \in I$ and let $f_0 : X_0 \to Y_0$ be a morphism of affine schemes which is quasi-finite and of finite presentation. Let $f : X  \to Y$ and $f_i : X_i \to Y_i$ for $i \geq 0$ be the base changes of $f_0$. If $w : X \to \mathbf{Z}$ is a weighting of $f$, then for sufficiently large $i$ there exists a weighting $w_i : X_i \to \mathbf{Z}$ of $f_i$ whose pullback to $X$ is $w$. \end{lemma} 
\begin{lemma} \label{lemma-affineness-of-large-open} Let $f : X \to Y$ be a morphism of affine schemes which is quasi-finite and of finite presentation. Let $w : X \to \mathbf{Z}_{> 0}$ be a positive weighting of $f$. Let $d < \infty$ be the maximum value of $\int_f w$. The open $$ Y_d = \{y \in Y \mid (\textstyle{\int}_f w)(y) = d \} $$ of $Y$ is affine. \end{lemma} 
\begin{proposition} \label{proposition-asn-weighting} Let $f : X \to Y$ be a surjective quasi-finite morphism of schemes. Let $w : X \to \mathbf{Z}_{> 0}$ be a positive weighting of $f$. Assume $X$ affine and $Y$ separated\footnote{It suffices if the diagonal of $Y$ is affine.}. Then the affine stratification number of $Y$ is at most the number of distinct values of $\int_f w$. \end{proposition} 
\begin{definition} \label{definition-cd-morphism} A morphism $f : X \to Y$ of schemes is said to be {\it completely decomposed}\footnote{This may be nonstandard terminology.} if for all points $y \in Y$ there is a point $x \in X$ with $f(x) = y$ such that the field extension $\kappa(x)/\kappa(y)$ is trivial. A family of morphisms $\{f_i : X_i \to Y\}_{i \in I}$ of schemes with fixed target is said to be {\it completely decomposed} if $\coprod f_i : \coprod Y_i \to X$ is completely decomposed. \end{definition} 
\begin{lemma} \label{lemma-composition-cd} The composition of two completely decomposed morphisms of schemes is completely decomposed. If $\{f_i : X_i \to Y\}_{i \in I}$ is completely decomposed and for each $i$ we have a family $\{X_{ij} \to X_i\}_{j \in J_i}$ which is completely decomposed, then the family $\{X_{ij} \to Y\}_{i \in I, j \in J_i}$ is completely decomposed. \end{lemma} 
\begin{lemma} \label{lemma-base-change-cd} The base change of a completely decomposed morphism of schemes is completely decomposed. If $\{f_i : X_i \to Y\}_{i \in I}$ is completely decomposed and $Y' \to Y$ is a morphism of schemes, then $\{X_i \times_Y Y' \to Y'\}_{i \in I}$ is completely decomposed. \end{lemma} 
\begin{lemma} \label{lemma-decompose} \begin{reference} \cite[Lemma 2.1.2]{EHIK} \end{reference} Let $f : X \to Y$ be a morphism of schemes. Assume $f$ is completely decomposed, $f$ is locally of finite presentation, and $Y$ is quasi-compact and quasi-separated. Then there exist $n \geq 0$ and morphisms $Z_i \to Y$, $i = 1, \ldots, n$ with the following properties \begin{enumerate} \item $\coprod Z_i \to Y$ is surjective, \item $Z_i \to Y$ is an immersion for all $i$, \item $Z_i \to Y$ is of finite presentation for all $i$, and \item the base change $X \times_Y Z_i \to Z_i$ has a section for all $i$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-descend-cd} Let $S = \lim_{\lambda \in \Lambda} S_\lambda$ be a limit of a directed system of schemes with affine transition morphisms. Let $0 \in \Lambda$ and let $f_0 : X_0 \to Y_0$ be a morphism of schemes over $S_0$. For $\lambda \geq 0$ let $f_\lambda : X_\lambda \to Y_\lambda$ be the base change of $f_0$ to $S_\lambda$ and let $f : X \to Y$ be the base change of $f_0$ to $S$. If \begin{enumerate} \item $f$ is completely decomposed, \item $Y_0$ is quasi-compact and quasi-separated, and \item $f_0$ is locally of finite presentation, \end{enumerate} then there exists an $\lambda \geq 0$ such that $f_\lambda$ is completely decomposed. \end{lemma} 
\begin{lemma} \label{lemma-ample-family-ample-relative} Let $f : X \to Y$ be a morphism of schemes. Assume \begin{enumerate} \item $Y$ has an ample family of invertible modules, \item there exists an $f$-ample invertible module on $X$. \end{enumerate} Then $X$ has an ample family of invertible modules. \end{lemma} 
\begin{lemma} \label{lemma-resolution-property-goes-up-affine} Let $f : X \to Y$ be an affine or quasi-affine morphism of schemes. If $Y$ has an ample family of invertible modules, so does $X$. \end{lemma} 
\begin{lemma} \label{lemma-get-ample-family} Let $X$ be a scheme. Suppose given effective Cartier divisors $D_1, \ldots, D_m$ on $X$ and invertible modules $\mathcal{L}_1, \ldots, \mathcal{L}_m$ such that $\bigcap D_i = \emptyset$ and $\mathcal{L}_i|_{X \setminus D_i}$ is ample. Then $X$ has an ample family of invertible modules. \end{lemma} 
\begin{lemma} \label{lemma-blow-up-ample-family} \begin{reference} \cite[Proposition 1.3.1]{Gross-thesis} \end{reference} Let $X$ be a quasi-compact and quasi-separated scheme with finitely many irreducible components. There exists a quasi-compact dense open $U \subset X$ and a $U$-admissible blowing up $X' \to X$ such that the scheme $X'$ has an ample family of invertible modules. \end{lemma} 
\begin{proposition} \label{proposition-envelope-with-resolution-property} Let $X$ be a quasi-compact and quasi-separated scheme. There exists a morphism $f : Y \to X$ which is of finite presentation, proper, and completely decomposed (Definition \ref{definition-cd-morphism}) such that the scheme $Y$ has an ample family of invertible modules. \end{proposition} 
\begin{lemma} \label{lemma-affine-extensive-criterion} A morphism $f : X \to Y$ of affine schemes is a closed immersion  if and only if for every injective ring map $A \to B$ and commutative  square $$ \xymatrix{ \Spec(B) \ar[d] \ar[r] & X \ar[d]^f \\ \Spec(A) \ar[r] \ar@{..>}[ur] & Y } $$ there exists a lift $\Spec(A) \to X$ making the two triangles commute. \end{lemma} 
\begin{lemma} \label{lemma-scheme-affine-if-aff-is-split-mono} Let $X$ be a scheme. If the canonical morphism $X \to \Spec(\Gamma(X, \mathcal{O}_X))$ of Schemes, Lemma \ref{schemes-lemma-morphism-into-affine} has a retraction, then $X$ is an affine scheme. \end{lemma} 
\begin{lemma} \label{lemma-aff-is-injective-on-sheaves} Let $X$ be a scheme. Let $f : X \to S = \Spec(\Gamma(X, \mathcal{O}_X))$ be the canonical morphism of Schemes, Lemma \ref{schemes-lemma-morphism-into-affine}. The largest quasi-coherent $\mathcal{O}_S$-module contained in the kernel of $f^\sharp : \mathcal{O}_S \to f_*\mathcal{O}_X$ is zero. If $X$ is quasi-compact, then $f^\sharp$ is injective. In particular, if $X$ is quasi-compact, then $f$ is a  dominant morphism. \end{lemma} 
\begin{lemma} \label{lemma-extensive-criterion} Let $f: X \to Y$ be a quasi-compact morphism of schemes. Then $f$ is a closed immersion if and only if for every injective  ring map $A \to B$ and commutative square $$ \xymatrix{ \Spec(B) \ar[d] \ar[r] & X \ar[d]^f \\ \Spec(A) \ar[r] \ar@{..>}[ur] & Y } $$ there exists a lift $\Spec A \to X$ making the diagram commute. \end{lemma} 
