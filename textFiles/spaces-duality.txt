\begin{lemma} \label{lemma-equivalent-definitions} Let $S$ be a scheme. Let $X$ be a locally Noetherian algebraic space over $S$. Let $K$ be an object of $D_\QCoh(\mathcal{O}_X)$. The following are equivalent \begin{enumerate} \item For every \'etale morphism $U \to X$ where $U$ is a scheme the restriction $K|_U$ is a dualizing complex for $U$ (as discussed above). \item There exists a surjective \'etale morphism $U \to X$ where $U$ is a scheme such that $K|_U$ is a dualizing complex for $U$. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-dualizing-scheme} Let $S$ be a scheme. Let $X$ be a locally Noetherian algebraic space over $S$. An object $K$ of $D_\QCoh(\mathcal{O}_X)$ is called a {\it dualizing complex} if $K$ satisfies the equivalent conditions of Lemma \ref{lemma-equivalent-definitions}. \end{definition} 
\begin{lemma} \label{lemma-affine-duality} Let $A$ be a Noetherian ring and let $X = \Spec(A)$. Let $\mathcal{O}_\etale$ be the structure sheaf of $X$ on the small \'etale site of $X$. Let $K, L$ be objects of $D(A)$. If $K \in D_{\textit{Coh}}(A)$ and $L$ has finite injective dimension, then $$ \epsilon^*\widetilde{R\Hom_A(K, L)} = R\SheafHom_{\mathcal{O}_\etale}(\epsilon^*\widetilde{K}, \epsilon^*\widetilde{L}) $$ in $D(\mathcal{O}_\etale)$ where $\epsilon : (X_\etale, \mathcal{O}_\etale) \to (X, \mathcal{O}_X)$ is as in Derived Categories of Spaces, Section \ref{spaces-perfect-section-derived-quasi-coherent-etale}. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-spaces} Let $S$ be a scheme. Let $X$ be a locally Noetherian algebraic space over $S$. Let $K$ be a dualizing complex on $X$. Then $K$ is an object of $D_{\textit{Coh}}(\mathcal{O}_X)$ and $D = R\SheafHom_{\mathcal{O}_X}(-, K)$ induces an anti-equivalence $$ D : D_{\textit{Coh}}(\mathcal{O}_X) \longrightarrow D_{\textit{Coh}}(\mathcal{O}_X) $$ which comes equipped with a canonical isomorphism $\text{id} \to D \circ D$. If $X$ is quasi-compact, then $D$ exchanges $D^+_{\textit{Coh}}(\mathcal{O}_X)$ and $D^-_{\textit{Coh}}(\mathcal{O}_X)$ and induces an equivalence $D^b_{\textit{Coh}}(\mathcal{O}_X) \to D^b_{\textit{Coh}}(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-unique-spaces} Let $S$ be a scheme. Let $X$ be a locally Noetherian algebraic space over $S$. If $K$ and $K'$ are dualizing complexes on $X$, then $K'$ is isomorphic to $K \otimes_{\mathcal{O}_X}^\mathbf{L} L$ for some invertible object $L$ of $D(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-dimension-function-scheme} Let $S$ be a scheme. Let $X$ be a locally Noetherian quasi-separated algebraic space over $S$. Let $\omega_X^\bullet$ be a dualizing complex on $X$. Then $X$ the function $|X| \to \mathbf{Z}$ defined by $$ x \longmapsto \delta(x)\text{ such that } \omega_{X, \overline{x}}^\bullet[-\delta(x)] \text{ is a normalized dualizing complex over } \mathcal{O}_{X, \overline{x}} $$ is a dimension function on $|X|$. \end{lemma} 
\begin{lemma} \label{lemma-twisted-inverse-image} \begin{reference} This is almost the same as \cite[Example 4.2]{Neeman-Grothendieck}. \end{reference} Let $S$ be a scheme. Let $f : X \to Y$ be a morphism between quasi-separated and quasi-compact algebraic spaces over $S$. The functor $Rf_* : D_\QCoh(X) \to D_\QCoh(Y)$ has a right adjoint. \end{lemma} 
\begin{lemma} \label{lemma-twisted-inverse-image-bounded-below} Notation and assumptions as in Lemma \ref{lemma-twisted-inverse-image}. Let $a : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_X)$ be the right adjoint to $Rf_*$. Then $a$ maps $D^+_\QCoh(\mathcal{O}_Y)$ into $D^+_\QCoh(\mathcal{O}_X)$. In fact, there exists an integer $N$ such that $H^i(K) = 0$ for $i \leq c$ implies $H^i(a(K)) = 0$ for $i \leq c - N$. \end{lemma} 
\begin{lemma} \label{lemma-iso-on-RSheafHom} Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated algebraic spaces over $S$. Let $a$ be the right adjoint to $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$. Let $L \in D_\QCoh(\mathcal{O}_X)$ and $K \in D_\QCoh(\mathcal{O}_Y)$. Then the map (\ref{equation-sheafy-trace}) $$ Rf_*R\SheafHom_{\mathcal{O}_X}(L, a(K)) \longrightarrow R\SheafHom_{\mathcal{O}_Y}(Rf_*L, K) $$ becomes an isomorphism after applying the functor $DQ_Y : D(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_Y)$ discussed in Derived Categories of Spaces, Section \ref{spaces-perfect-section-better-coherator}. \end{lemma} 
\begin{lemma} \label{lemma-iso-global-hom} Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of quasi-separated and quasi-compact algebraic spaces over $S$. For all $L \in D_\QCoh(\mathcal{O}_X)$ and $K \in D_\QCoh(\mathcal{O}_Y)$ (\ref{equation-sheafy-trace}) induces an isomorphism $R\Hom_X(L, a(K)) \to R\Hom_Y(Rf_*L, K)$ of global derived homs. \end{lemma} 
\begin{lemma} \label{lemma-flat-precompose-pus} In diagram (\ref{equation-base-change}) the map $a \circ Rg_* \leftarrow Rg'_* \circ a'$ is an isomorphism. \end{lemma} 
\begin{lemma} \label{lemma-compose-base-change-maps} Let $S$ be a scheme. Consider a commutative diagram $$ \xymatrix{ X' \ar[r]_k \ar[d]_{f'} & X \ar[d]^f \\ Y' \ar[r]^l \ar[d]_{g'} & Y \ar[d]^g \\ Z' \ar[r]^m & Z } $$ of quasi-compact and quasi-separated algebraic spaces over $S$ where both diagrams are cartesian and where $f$ and $l$ as well as $g$ and $m$ are Tor independent. Then the maps (\ref{equation-base-change-map}) for the two squares compose to give the base change map for the outer rectangle (see proof for a precise statement). \end{lemma} 
\begin{lemma} \label{lemma-compose-base-change-maps-horizontal} Let $S$ be a scheme. Consider a commutative diagram $$ \xymatrix{ X'' \ar[r]_{g'} \ar[d]_{f''} & X' \ar[r]_g \ar[d]_{f'} & X \ar[d]^f \\ Y'' \ar[r]^{h'} & Y' \ar[r]^h & Y } $$ of quasi-compact and quasi-separated algebraic spaces over $S$ where both diagrams are cartesian and where $f$ and $h$ as well as $f'$ and $h'$ are Tor independent. Then the maps (\ref{equation-base-change-map}) for the two squares compose to give the base change map for the outer rectangle (see proof for a precise statement). \end{lemma} 
\begin{lemma} \label{lemma-more-base-change} In diagram (\ref{equation-base-change}) assume in addition $g : Y' \to Y$ is a morphism of affine schemes and $f : X \to Y$ is proper. Then the base change map (\ref{equation-base-change-map}) induces an isomorphism $$ L(g')^*a(K) \longrightarrow a'(Lg^*K) $$ in the following cases \begin{enumerate} \item for all $K \in D_\QCoh(\mathcal{O}_X)$ if $f$ is flat of finite presentation, \item for all $K \in D_\QCoh(\mathcal{O}_X)$ if $f$ is perfect and $Y$ Noetherian, \item for $K \in D_\QCoh^+(\mathcal{O}_X)$ if $g$ has finite Tor dimension and $Y$ Noetherian. \end{enumerate} \end{lemma} 
\begin{lemma}[Trace map and base change] \label{lemma-trace-map-and-base-change} Suppose we have a diagram (\ref{equation-base-change}). Then the maps $1 \star \text{Tr}_f : Lg^* \circ Rf_* \circ a \to Lg^*$ and $\text{Tr}_{f'} \star 1 : Rf'_* \circ a' \circ Lg^* \to Lg^*$ agree via the base change maps $\beta : Lg^* \circ Rf_* \to Rf'_* \circ L(g')^*$ (Cohomology on Sites, Remark \ref{sites-cohomology-remark-base-change}) and $\alpha : L(g')^* \circ a \to a' \circ Lg^*$ (\ref{equation-base-change-map}). More precisely, the diagram $$ \xymatrix{ Lg^* \circ Rf_* \circ a \ar[d]_{\beta \star 1} \ar[r]_-{1 \star \text{Tr}_f} & Lg^* \\ Rf'_* \circ L(g')^* \circ a \ar[r]^{1 \star \alpha} & Rf'_* \circ a' \circ Lg^* \ar[u]_{\text{Tr}_{f'} \star 1} } $$ of transformations of functors commutes. \end{lemma} 
\begin{lemma} \label{lemma-unit-and-base-change} Suppose we have a diagram (\ref{equation-base-change}). Then the maps $1 \star \eta_f : L(g')^* \to L(g')^* \circ a \circ Rf_*$ and $\eta_{f'} \star 1 : L(g')^* \to a' \circ Rf'_* \circ L(g')^*$ agree via the base change maps $\beta : Lg^* \circ Rf_* \to Rf'_* \circ L(g')^*$ (Cohomology on Sites, Remark \ref{sites-cohomology-remark-base-change}) and $\alpha : L(g')^* \circ a \to a' \circ Lg^*$ (\ref{equation-base-change-map}). More precisely, the diagram $$ \xymatrix{ L(g')^* \ar[r]_-{1 \star \eta_f} \ar[d]_{\eta_{f'} \star 1} & L(g')^* \circ a \circ Rf_* \ar[d]^\alpha \\ a' \circ Rf'_* \circ L(g')^* & a' \circ Lg^* \circ Rf_* \ar[l]_-\beta } $$ of transformations of functors commutes. \end{lemma} 
\begin{lemma} \label{lemma-compare-with-pullback-perfect} Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated algebraic spaces over $S$. The map $Lf^*K \otimes^\mathbf{L}_{\mathcal{O}_X} a(L) \to a(K \otimes_{\mathcal{O}_Y}^\mathbf{L} L)$ defined above for $K, L \in D_\QCoh(\mathcal{O}_Y)$ is an isomorphism if $K$ is perfect. In particular, (\ref{equation-compare-with-pullback}) is an isomorphism if $K$ is perfect. \end{lemma} 
\begin{lemma} \label{lemma-restriction-compare-with-pullback} Suppose we have a diagram (\ref{equation-base-change}). Let $K \in D_\QCoh(\mathcal{O}_Y)$. The diagram $$ \xymatrix{ L(g')^*(Lf^*K \otimes^\mathbf{L}_{\mathcal{O}_X} a(\mathcal{O}_Y)) \ar[r] \ar[d] & L(g')^*a(K) \ar[d] \\ L(f')^*Lg^*K \otimes_{\mathcal{O}_{X'}}^\mathbf{L} a'(\mathcal{O}_{Y'}) \ar[r] & a'(Lg^*K) } $$ commutes where the horizontal arrows are the maps (\ref{equation-compare-with-pullback}) for $K$ and $Lg^*K$ and the vertical maps are constructed using Cohomology on Sites, Remark \ref{sites-cohomology-remark-base-change} and (\ref{equation-base-change-map}). \end{lemma} 
\begin{lemma} \label{lemma-proper-flat} Let $S$ be a scheme. Let $Y$ be a quasi-compact and quasi-separated algebraic space over $S$. Let $f : X \to Y$ be a morphism of algebraic spaces which is proper, flat, and of finite presentation. Let $a$ be the right adjoint for $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ of Lemma \ref{lemma-twisted-inverse-image}. Then $a$ commutes with direct sums. \end{lemma} 
\begin{lemma} \label{lemma-compare-with-pullback-flat-proper} Let $S$ be a scheme. Let $Y$ be a quasi-compact and quasi-separated algebraic space over $S$. Let $f : X \to Y$ be a morphism of algebraic spaces which is proper, flat, and of finite presentation. The map (\ref{equation-compare-with-pullback}) is an isomorphism for every object $K$ of $D_\QCoh(\mathcal{O}_Y)$. \end{lemma} 
\begin{lemma} \label{lemma-properties-relative-dualizing} Let $Y$ be an affine scheme. Let $f : X \to Y$ be a morphism of algebraic spaces which is proper, flat, and of finite presentation. Let $a$ be the right adjoint for $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ of Lemma \ref{lemma-twisted-inverse-image}. Then \begin{enumerate} \item $a(\mathcal{O}_Y)$ is a $Y$-perfect object of $D(\mathcal{O}_X)$, \item $Rf_*a(\mathcal{O}_Y)$ has vanishing cohomology sheaves in positive degrees, \item $\mathcal{O}_X \to R\SheafHom_{\mathcal{O}_X}(a(\mathcal{O}_Y), a(\mathcal{O}_Y))$ is an isomorphism. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-relative-dualizing-proper-flat} Let $S$ be a scheme. Let $f : X \to Y$ be a proper, flat morphism of algebraic spaces over $S$ which is of finite presentation. A {\it relative dualizing complex} for $X/Y$ is a pair $(\omega_{X/Y}^\bullet, \tau)$ consisting of a $Y$-perfect object $\omega_{X/Y}^\bullet$ of $D(\mathcal{O}_X)$ and a map $$ \tau : Rf_*\omega_{X/Y}^\bullet \longrightarrow \mathcal{O}_Y $$ such that for any cartesian square $$ \xymatrix{ X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\ Y' \ar[r]^g & Y } $$ where $Y'$ is an affine scheme the pair $(L(g')^*\omega_{X/Y}^\bullet, Lg^*\tau)$ is isomorphic to the pair $(a'(\mathcal{O}_{Y'}), \text{Tr}_{f', \mathcal{O}_{Y'}})$ studied in Sections \ref{section-twisted-inverse-image}, \ref{section-base-change-map}, \ref{section-base-change-II}, \ref{section-trace}, \ref{section-compare-with-pullback}, and \ref{section-proper-flat}. \end{definition} 
\begin{lemma} \label{lemma-relative-dualizing-RHom} Let $S$ be a scheme. Let $X \to Y$ be a proper, flat morphism of algebraic spaces which is of finite presentation. If $(\omega_{X/Y}^\bullet, \tau)$ is a relative dualizing complex, then  $\mathcal{O}_X \to R\SheafHom_{\mathcal{O}_X}(\omega_{X/Y}^\bullet, \omega_{X/Y}^\bullet)$ is an isomorphism and $Rf_*\omega_{X/Y}^\bullet$ has vanishing cohomology sheaves in positive degrees. \end{lemma} 
\begin{lemma} \label{lemma-uniqueness-relative-dualizing} Let $S$ be a scheme. Let $X \to Y$ be a proper, flat morphism of algebraic spaces which is of finite presentation. If $(\omega_j^\bullet, \tau_j)$, $j = 1, 2$ are two relative dualizing complexes on $X/Y$, then there is a unique isomorphism $(\omega_1^\bullet, \tau_1) \to (\omega_2^\bullet, \tau_2)$. \end{lemma} 
\begin{lemma} \label{lemma-covering-enough} Let $S$ be a scheme. Let $X \to Y$ be a proper, flat morphism of algebraic spaces which is of finite presentation. Let $(\omega^\bullet, \tau)$ be a pair consisting of a $Y$-perfect object of $D(\mathcal{O}_X)$ and a map $\tau : Rf_*\omega^\bullet \to \mathcal{O}_Y$. Assume we have cartesian diagrams $$ \xymatrix{ X_i \ar[r]_{g_i'} \ar[d]_{f_i} & X \ar[d]^f \\ Y_i \ar[r]^{g_i} & Y } $$ with $Y_i$ affine such that $\{g_i : Y_i \to Y\}$ is an \'etale covering and isomorphisms of pairs $(\omega^\bullet|_{X_i}, \tau|_{Y_i}) \to (a_i(\mathcal{O}_{Y_i}), \text{Tr}_{f_i, \mathcal{O}_{Y_i}})$ as in Definition \ref{definition-relative-dualizing-proper-flat}. Then $(\omega^\bullet, \tau)$ is a relative dualizing complex for $X$ over $Y$. \end{lemma} 
\begin{lemma} \label{lemma-existence-relative-dualizing} Let $S$ be a scheme. Let $X \to Y$ be a proper, flat morphism of algebraic spaces which is of finite presentation. There exists a relative dualizing complex $(\omega_{X/Y}^\bullet, \tau)$. \end{lemma} 
\begin{lemma} \label{lemma-base-change-relative-dualizing} Let $S$ be a scheme. Consider a cartesian square $$ \xymatrix{ X' \ar[d]_{f'} \ar[r]_{g'} & X \ar[d]^f \\ Y' \ar[r]^g & Y } $$ of algebraic spaces over $S$. Assume $X \to Y$ is proper, flat, and of finite presentation. Let $(\omega_{X/Y}^\bullet, \tau)$ be a relative dualizing complex for $f$. Then $(L(g')^*\omega_{X/Y}^\bullet, Lg^*\tau)$ is a relative dualizing complex for $f'$. \end{lemma} 
\begin{lemma} \label{lemma-compare} Let $S$ be a scheme. Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated algebraic spaces over $S$. Assume $X$ and $Y$ are representable and let $f_0 : X_0 \to Y_0$ be a morphism of schemes representing $f$ (awkward but temporary notation). Let $a : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_X)$ be the right adjoint of $Rf_*$ from Lemma \ref{lemma-twisted-inverse-image}. Let $a_0 : D_\QCoh(\mathcal{O}_{Y_0}) \to D_\QCoh(\mathcal{O}_{X_0})$ be the right adjoint of $Rf_*$ from Duality for Schemes, Lemma \ref{duality-lemma-twisted-inverse-image}. Then  $$ \xymatrix{ D_\QCoh(\mathcal{O}_{X_0}) \ar@{=}[rrrrrr]_{\text{Derived Categories of Spaces, Lemma \ref{spaces-perfect-lemma-derived-quasi-coherent-small-etale-site}}} & & & & & & D_\QCoh(\mathcal{O}_X) \\ D_\QCoh(\mathcal{O}_{Y_0}) \ar[u]^{a_0} \ar@{=}[rrrrrr]^{\text{Derived Categories of Spaces, Lemma \ref{spaces-perfect-lemma-derived-quasi-coherent-small-etale-site}}} & & & & & & D_\QCoh(\mathcal{O}_Y) \ar[u]_a } $$ is commutative. \end{lemma} 
