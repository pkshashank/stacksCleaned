\begin{lemma} \label{lemma-equivalent-definitions} Let $X$ be a locally Noetherian scheme. Let $K$ be an object of $D(\mathcal{O}_X)$. The following are equivalent \begin{enumerate} \item For every affine open $U = \Spec(A) \subset X$ there exists a dualizing complex $\omega_A^\bullet$ for $A$ such that $K|_U$ is isomorphic to the image of $\omega_A^\bullet$ by the functor $\widetilde{} : D(A) \to D(\mathcal{O}_U)$. \item There is an affine open covering $X = \bigcup U_i$, $U_i = \Spec(A_i)$ such that for each $i$ there exists a dualizing complex $\omega_i^\bullet$ for $A_i$ such that $K|_{U_i}$ is isomorphic to the image of $\omega_i^\bullet$ by the functor $\widetilde{} : D(A_i) \to D(\mathcal{O}_{U_i})$. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-dualizing-scheme} Let $X$ be a locally Noetherian scheme. An object $K$ of $D(\mathcal{O}_X)$ is called a {\it dualizing complex} if $K$ satisfies the equivalent conditions of Lemma \ref{lemma-equivalent-definitions}. \end{definition} 
\begin{lemma} \label{lemma-affine-duality} Let $A$ be a Noetherian ring and let $X = \Spec(A)$. Let $K, L$ be objects of $D(A)$. If $K \in D_{\textit{Coh}}(A)$ and $L$ has finite injective dimension, then $$ R\SheafHom_{\mathcal{O}_X}(\widetilde{K}, \widetilde{L}) = \widetilde{R\Hom_A(K, L)} $$ in $D(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-internal-hom-evaluate-isom} Let $X$ be a Noetherian scheme. Let $K, L, M \in D_\QCoh(\mathcal{O}_X)$.  Then the map $$ R\SheafHom(L, M) \otimes_{\mathcal{O}_X}^\mathbf{L} K \longrightarrow R\SheafHom(R\SheafHom(K, L), M) $$ of Cohomology, Lemma \ref{cohomology-lemma-internal-hom-evaluate} is an isomorphism in the following two cases \begin{enumerate} \item $K \in D^-_{\textit{Coh}}(\mathcal{O}_X)$, $L \in D^+_{\textit{Coh}}(\mathcal{O}_X)$, and $M$ affine locally has finite injective dimension (see proof), or \item $K$ and $L$ are in $D_{\textit{Coh}}(\mathcal{O}_X)$, the object $R\SheafHom(L, M)$ has finite tor dimension, and $L$ and $M$ affine locally have finite injective dimension (in particular $L$ and $M$ are bounded). \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-dualizing-schemes} Let $K$ be a dualizing complex on a locally Noetherian scheme $X$. Then $K$ is an object of $D_{\textit{Coh}}(\mathcal{O}_X)$ and $D = R\SheafHom_{\mathcal{O}_X}(-, K)$ induces an anti-equivalence $$ D : D_{\textit{Coh}}(\mathcal{O}_X) \longrightarrow D_{\textit{Coh}}(\mathcal{O}_X) $$ which comes equipped with a canonical isomorphism $\text{id} \to D \circ D$. If $X$ is quasi-compact, then $D$ exchanges $D^+_{\textit{Coh}}(\mathcal{O}_X)$ and $D^-_{\textit{Coh}}(\mathcal{O}_X)$ and induces an anti-equivalence $D^b_{\textit{Coh}}(\mathcal{O}_X) \to D^b_{\textit{Coh}}(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-unique-schemes} Let $X$ be a locally Noetherian scheme. If $K$ and $K'$ are dualizing complexes on $X$, then $K'$ is isomorphic to $K \otimes_{\mathcal{O}_X}^\mathbf{L} L$ for some invertible object $L$ of $D(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-dimension-function-scheme} Let $X$ be a locally Noetherian scheme. Let $\omega_X^\bullet$ be a dualizing complex on $X$. Then $X$ is universally catenary and the function $X \to \mathbf{Z}$ defined by $$ x \longmapsto \delta(x)\text{ such that } \omega_{X, x}^\bullet[-\delta(x)] \text{ is a normalized dualizing complex over } \mathcal{O}_{X, x} $$ is a dimension function. \end{lemma} 
\begin{lemma} \label{lemma-sitting-in-degrees} Let $X$ be a locally Noetherian scheme. Let $\omega_X^\bullet$ be a dualizing complex on $X$ with associated dimension function $\delta$. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. Set $\mathcal{E}^i = \SheafExt^{-i}_{\mathcal{O}_X}(\mathcal{F}, \omega_X^\bullet)$. Then $\mathcal{E}^i$ is a coherent $\mathcal{O}_X$-module and for $x \in X$ we have \begin{enumerate} \item $\mathcal{E}^i_x$ is nonzero only for $\delta(x) \leq i \leq \delta(x) + \dim(\text{Supp}(\mathcal{F}_x))$, \item $\dim(\text{Supp}(\mathcal{E}^{i + \delta(x)}_x)) \leq i$, \item $\text{depth}(\mathcal{F}_x)$ is the smallest integer $i \geq 0$ such that $\mathcal{E}_x^{i + \delta(x)} \not = 0$, and \item we have $x \in \text{Supp}(\bigoplus_{j \leq i} \mathcal{E}^j) \Leftrightarrow \text{depth}_{\mathcal{O}_{X, x}}(\mathcal{F}_x) + \delta(x) \leq i$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-twisted-inverse-image} \begin{reference} This is almost the same as \cite[Example 4.2]{Neeman-Grothendieck}. \end{reference} Let $f : X \to Y$ be a morphism between quasi-separated and quasi-compact schemes. The functor $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ has a right adjoint. \end{lemma} 
\begin{lemma} \label{lemma-twisted-inverse-image-bounded-below} Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated schemes. Let $a : D_\QCoh(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_X)$ be the right adjoint to $Rf_*$ of Lemma \ref{lemma-twisted-inverse-image}. Then $a$ maps $D^+_\QCoh(\mathcal{O}_Y)$ into $D^+_\QCoh(\mathcal{O}_X)$. In fact, there exists an integer $N$ such that $H^i(K) = 0$ for $i \leq c$ implies $H^i(a(K)) = 0$ for $i \leq c - N$. \end{lemma} 
\begin{lemma} \label{lemma-iso-on-RSheafHom} Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated schemes. Let $a$ be the right adjoint to $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$. Let $L \in D_\QCoh(\mathcal{O}_X)$ and $K \in D_\QCoh(\mathcal{O}_Y)$. Then the map (\ref{equation-sheafy-trace}) $$ Rf_*R\SheafHom_{\mathcal{O}_X}(L, a(K)) \longrightarrow R\SheafHom_{\mathcal{O}_Y}(Rf_*L, K) $$ becomes an isomorphism after applying the functor $DQ_Y : D(\mathcal{O}_Y) \to D_\QCoh(\mathcal{O}_Y)$ discussed in Derived Categories of Schemes, Section \ref{perfect-section-better-coherator}. \end{lemma} 
\begin{lemma} \label{lemma-iso-global-hom} Let $f : X \to Y$ be a morphism of quasi-separated and quasi-compact schemes. For all $L \in D_\QCoh(\mathcal{O}_X)$ and $K \in D_\QCoh(\mathcal{O}_Y)$ (\ref{equation-sheafy-trace}) induces an isomorphism $R\Hom_X(L, a(K)) \to R\Hom_Y(Rf_*L, K)$ of global derived homs. \end{lemma} 
\begin{lemma} \label{lemma-flat-precompose-pus} In diagram (\ref{equation-base-change}) assume that $g$ is flat or more generally that $f$ and $g$ are Tor independent. Then $a \circ Rg_* \leftarrow Rg'_* \circ a'$ is an isomorphism. \end{lemma} 
\begin{lemma} \label{lemma-when-sheafy} Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated schemes. Let $a$ be the right adjoint to $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$. Let $V \subset Y$ be quasi-compact open with inverse image $U \subset X$. \begin{enumerate} \item For every $Q \in D_\QCoh^+(\mathcal{O}_Y)$ supported on $Y \setminus V$ the image $a(Q)$ is supported on $X \setminus U$ if and only if (\ref{equation-sheafy}) is an isomorphism on all $K$ in $D_\QCoh^+(\mathcal{O}_Y)$. \item For every $Q \in D_\QCoh(\mathcal{O}_Y)$ supported on $Y \setminus V$ the image $a(Q)$ is supported on $X \setminus U$ if and only if (\ref{equation-sheafy}) is an isomorphism on all $K$ in $D_\QCoh(\mathcal{O}_Y)$. \item If $a$ commutes with direct sums, then the equivalent conditions of (1) imply the equivalent conditions of (2). \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-proper-noetherian} Let $Y$ be a quasi-compact and quasi-separated scheme. Let $f : X \to Y$ be a proper morphism. If\footnote{This proof works for those morphisms of quasi-compact and quasi-separated schemes such that $Rf_*P$ is pseudo-coherent for all $P$ perfect on $X$. It follows easily from a theorem of Kiehl \cite{Kiehl} that this holds if $f$ is proper and pseudo-coherent. This is the correct generality for this lemma and some of the other results in this chapter.} \begin{enumerate} \item $f$ is flat and of finite presentation, or \item $Y$ is Noetherian \end{enumerate} then the equivalent conditions of Lemma \ref{lemma-when-sheafy} part (1) hold for all quasi-compact opens $V$ of $Y$. \end{lemma} 
\begin{lemma} \label{lemma-compose-base-change-maps} Consider a commutative diagram $$ \xymatrix{ X' \ar[r]_k \ar[d]_{f'} & X \ar[d]^f \\ Y' \ar[r]^l \ar[d]_{g'} & Y \ar[d]^g \\ Z' \ar[r]^m & Z } $$ of quasi-compact and quasi-separated schemes where both diagrams are cartesian and where $f$ and $l$ as well as $g$ and $m$ are Tor independent. Then the maps (\ref{equation-base-change-map}) for the two squares compose to give the base change map for the outer rectangle (see proof for a precise statement). \end{lemma} 
\begin{lemma} \label{lemma-compose-base-change-maps-horizontal} Consider a commutative diagram $$ \xymatrix{ X'' \ar[r]_{g'} \ar[d]_{f''} & X' \ar[r]_g \ar[d]_{f'} & X \ar[d]^f \\ Y'' \ar[r]^{h'} & Y' \ar[r]^h & Y } $$ of quasi-compact and quasi-separated schemes where both diagrams are cartesian and where $f$ and $h$ as well as $f'$ and $h'$ are Tor independent. Then the maps (\ref{equation-base-change-map}) for the two squares compose to give the base change map for the outer rectangle (see proof for a precise statement). \end{lemma} 
\begin{lemma} \label{lemma-more-base-change} In diagram (\ref{equation-base-change}) assume \begin{enumerate} \item $g : Y' \to Y$ is a morphism of affine schemes, \item $f : X \to Y$ is proper, and \item $f$ and $g$ are Tor independent. \end{enumerate} Then the base change map (\ref{equation-base-change-map}) induces an isomorphism $$ L(g')^*a(K) \longrightarrow a'(Lg^*K) $$ in the following cases \begin{enumerate} \item for all $K \in D_\QCoh(\mathcal{O}_Y)$ if $f$ is flat of finite presentation, \item for all $K \in D_\QCoh(\mathcal{O}_Y)$ if $f$ is perfect and $Y$ Noetherian, \item for $K \in D_\QCoh^+(\mathcal{O}_Y)$ if $g$ has finite Tor dimension and $Y$ Noetherian. \end{enumerate} \end{lemma} 
\begin{lemma}[Trace map and base change] \label{lemma-trace-map-and-base-change} Suppose we have a diagram (\ref{equation-base-change}) where $f$ and $g$ are tor independent. Then the maps $1 \star \text{Tr}_f : Lg^* \circ Rf_* \circ a \to Lg^*$ and $\text{Tr}_{f'} \star 1 : Rf'_* \circ a' \circ Lg^* \to Lg^*$ agree via the base change maps $\beta : Lg^* \circ Rf_* \to Rf'_* \circ L(g')^*$ (Cohomology, Remark \ref{cohomology-remark-base-change}) and $\alpha : L(g')^* \circ a \to a' \circ Lg^*$ (\ref{equation-base-change-map}). More precisely, the diagram $$ \xymatrix{ Lg^* \circ Rf_* \circ a \ar[d]_{\beta \star 1} \ar[r]_-{1 \star \text{Tr}_f} & Lg^* \\ Rf'_* \circ L(g')^* \circ a \ar[r]^{1 \star \alpha} & Rf'_* \circ a' \circ Lg^* \ar[u]_{\text{Tr}_{f'} \star 1} } $$ of transformations of functors commutes. \end{lemma} 
\begin{lemma} \label{lemma-unit-and-base-change} Suppose we have a diagram (\ref{equation-base-change}) where $f$ and $g$ are tor independent. Then the maps $1 \star \eta_f : L(g')^* \to L(g')^* \circ a \circ Rf_*$ and $\eta_{f'} \star 1 : L(g')^* \to a' \circ Rf'_* \circ L(g')^*$ agree via the base change maps $\beta : Lg^* \circ Rf_* \to Rf'_* \circ L(g')^*$ (Cohomology, Remark \ref{cohomology-remark-base-change}) and $\alpha : L(g')^* \circ a \to a' \circ Lg^*$ (\ref{equation-base-change-map}). More precisely, the diagram $$ \xymatrix{ L(g')^* \ar[r]_-{1 \star \eta_f} \ar[d]_{\eta_{f'} \star 1} & L(g')^* \circ a \circ Rf_* \ar[d]^\alpha \\ a' \circ Rf'_* \circ L(g')^* & a' \circ Lg^* \circ Rf_* \ar[l]_-\beta } $$ of transformations of functors commutes. \end{lemma} 
\begin{lemma} \label{lemma-compare-with-pullback-perfect} Let $f : X \to Y$ be a morphism of quasi-compact and quasi-separated schemes. The map $Lf^*K \otimes^\mathbf{L}_{\mathcal{O}_X} a(L) \to a(K \otimes_{\mathcal{O}_Y}^\mathbf{L} L)$ defined above for $K, L \in D_\QCoh(\mathcal{O}_Y)$ is an isomorphism if $K$ is perfect. In particular, (\ref{equation-compare-with-pullback}) is an isomorphism if $K$ is perfect. \end{lemma} 
\begin{lemma} \label{lemma-restriction-compare-with-pullback} Suppose we have a diagram (\ref{equation-base-change}) where $f$ and $g$ are tor independent. Let $K \in D_\QCoh(\mathcal{O}_Y)$. The diagram $$ \xymatrix{ L(g')^*(Lf^*K \otimes^\mathbf{L}_{\mathcal{O}_X} a(\mathcal{O}_Y)) \ar[r] \ar[d] & L(g')^*a(K) \ar[d] \\ L(f')^*Lg^*K \otimes_{\mathcal{O}_{X'}}^\mathbf{L} a'(\mathcal{O}_{Y'}) \ar[r] & a'(Lg^*K) } $$ commutes where the horizontal arrows are the maps (\ref{equation-compare-with-pullback}) for $K$ and $Lg^*K$ and the vertical maps are constructed using Cohomology, Remark \ref{cohomology-remark-base-change} and (\ref{equation-base-change-map}). \end{lemma} 
\begin{lemma} \label{lemma-compare-on-open} Let $f : X \to Y$ be a proper morphism of Noetherian schemes. Let $V \subset Y$ be an open such that $f^{-1}(V) \to V$ is an isomorphism. Then for $K \in D_\QCoh^+(\mathcal{O}_Y)$ the map (\ref{equation-compare-with-pullback}) restricts to an isomorphism over $f^{-1}(V)$. \end{lemma} 
\begin{lemma} \label{lemma-transitivity-compare-with-pullback} Let $f : X \to Y$ and $g : Y \to Z$ be composable morphisms of quasi-compact and quasi-separated schemes and set $h = g \circ f$. Let $a, b, c$ be the adjoints of Lemma \ref{lemma-twisted-inverse-image} for $f, g, h$. For any $K \in D_\QCoh(\mathcal{O}_Z)$ the diagram $$ \xymatrix{ Lf^*(Lg^*K \otimes_{\mathcal{O}_Y}^\mathbf{L} b(\mathcal{O}_Z)) \otimes_{\mathcal{O}_X}^\mathbf{L} a(\mathcal{O}_Y) \ar@{=}[d] \ar[r] & a(Lg^*K \otimes_{\mathcal{O}_Y}^\mathbf{L} b(\mathcal{O}_Z)) \ar[r] & a(b(K)) \ar@{=}[d] \\ Lh^*K \otimes_{\mathcal{O}_X}^\mathbf{L} Lf^*b(\mathcal{O}_Z) \otimes_{\mathcal{O}_X}^\mathbf{L} a(\mathcal{O}_Y) \ar[r] & Lh^*K \otimes_{\mathcal{O}_X}^\mathbf{L} c(\mathcal{O}_Z) \ar[r] & c(K) } $$ is commutative where the arrows are (\ref{equation-compare-with-pullback}) and we have used $Lh^* = Lf^* \circ Lg^*$ and $c = a \circ b$. \end{lemma} 
\begin{lemma} \label{lemma-compute-sheaf-with-exact-support} With notation as above. The functor $\SheafHom(\mathcal{O}_Z, -)$ is a right adjoint to the functor $i_* : \textit{Mod}(\mathcal{O}_Z) \to \textit{Mod}(\mathcal{O}_X)$. For $V \subset Z$ open we have $$ \Gamma(V, \SheafHom(\mathcal{O}_Z, \mathcal{F})) = \{s \in \Gamma(U, \mathcal{F}) \mid \mathcal{I}s = 0\} $$ where $U \subset X$ is an open whose intersection with $Z$ is $V$. \end{lemma} 
\begin{lemma} \label{lemma-sheaf-with-exact-support-adjoint} With notation as above. The functor $R\SheafHom(\mathcal{O}_Z, -)$ is the right adjoint of the functor $Ri_* : D(\mathcal{O}_Z) \to D(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-sheaf-with-exact-support-ext} With notation as above. We have $$ Ri_*R\SheafHom(\mathcal{O}_Z, K) = R\SheafHom_{\mathcal{O}_X}(i_*\mathcal{O}_Z, K) $$ in $D(\mathcal{O}_X)$ for all $K$ in $D(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-sheaf-with-exact-support-internal-home} With notation as above. For $M \in D(\mathcal{O}_Z)$ we have $$ R\SheafHom_{\mathcal{O}_X}(Ri_*M, K) = Ri_*R\SheafHom_{\mathcal{O}_Z}(M, R\SheafHom(\mathcal{O}_Z, K)) $$ in $D(\mathcal{O}_Z)$ for all $K$ in $D(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-sheaf-with-exact-support-quasi-coherent} Let $i : Z \to X$ be a pseudo-coherent closed immersion of schemes (any closed immersion if $X$ is locally Noetherian). Then \begin{enumerate} \item $R\SheafHom(\mathcal{O}_Z, -)$ maps $D^+_\QCoh(\mathcal{O}_X)$ into $D^+_\QCoh(\mathcal{O}_Z)$, and \item if $X = \Spec(A)$ and $Z = \Spec(B)$, then the diagram $$ \xymatrix{ D^+(B) \ar[r] & D_\QCoh^+(\mathcal{O}_Z) \\ D^+(A) \ar[r] \ar[u]^{R\Hom(B, -)} & D_\QCoh^+(\mathcal{O}_X) \ar[u]_{R\SheafHom(\mathcal{O}_Z, -)} } $$ is commutative. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-sheaf-with-exact-support-coherent} Let $i : Z \to X$ be a closed immersion of schemes. Assume $X$ is a locally Noetherian. Then $R\SheafHom(\mathcal{O}_Z, -)$ maps $D^+_{\textit{Coh}}(\mathcal{O}_X)$ into $D^+_{\textit{Coh}}(\mathcal{O}_Z)$. \end{lemma} 
\begin{lemma} \label{lemma-twisted-inverse-image-closed} Let $X$ be a quasi-compact and quasi-separated scheme. Let $i : Z \to X$ be a pseudo-coherent closed immersion (if $X$ is Noetherian, then any closed immersion is pseudo-coherent). Let $a : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Z)$ be the right adjoint to $Ri_*$. Then there is a functorial isomorphism $$ a(K) = R\SheafHom(\mathcal{O}_Z, K) $$ for $K \in D_\QCoh^+(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-check-base-change-is-iso} In the situation above, the map (\ref{equation-base-change-exact-support}) is an isomorphism if and only if the base change map $$ Lf^*R\SheafHom_{\mathcal{O}_X}(\mathcal{O}_Z, K) \longrightarrow R\SheafHom_{\mathcal{O}_{X'}}(\mathcal{O}_{Z'}, Lf^*K) $$ of Cohomology, Remark \ref{cohomology-remark-prepare-fancy-base-change} is an isomorphism. \end{lemma} 
\begin{lemma} \label{lemma-flat-bc-sheaf-with-exact-support} In the situation above, assume $f$ is flat and $i$ pseudo-coherent. Then (\ref{equation-base-change-exact-support}) is an isomorphism for $K$ in $D^+_\QCoh(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-sheaf-with-exact-support-tensor} Let $i : Z \to X$ be a pseudo-coherent closed immersion of schemes. Let $M \in D_\QCoh(\mathcal{O}_X)$ locally have tor-amplitude in $[a, \infty)$. Let $K \in D_\QCoh^+(\mathcal{O}_X)$. Then there is a canonical isomorphism $$ R\SheafHom(\mathcal{O}_Z, K) \otimes_{\mathcal{O}_Z}^\mathbf{L} Li^*M = R\SheafHom(\mathcal{O}_Z, K \otimes_{\mathcal{O}_X}^\mathbf{L} M) $$ in $D(\mathcal{O}_Z)$. \end{lemma} 
\begin{lemma} \label{lemma-compute-sheafhom-affine} With notation as above. The functor $\SheafHom(f_*\mathcal{O}_Y, -)$ is a right adjoint to the restriction functor $\textit{Mod}(f_*\mathcal{O}_Y) \to \textit{Mod}(\mathcal{O}_X)$. For an affine open $U \subset X$ we have $$ \Gamma(U, \SheafHom(f_*\mathcal{O}_Y, \mathcal{F})) = \Hom_A(B, \mathcal{F}(U)) $$ where $A = \mathcal{O}_X(U)$ and $B = \mathcal{O}_Y(f^{-1}(U))$. \end{lemma} 
\begin{lemma} \label{lemma-sheafhom-affine-adjoint} With notation as above. The functor $R\SheafHom(f_*\mathcal{O}_Y, -)$ is the right adjoint of the functor $D(f_*\mathcal{O}_Y) \to D(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-sheafhom-affine-ext} With notation as above. The composition $$ D(\mathcal{O}_X) \xrightarrow{R\SheafHom(f_*\mathcal{O}_Y, -)} D(f_*\mathcal{O}_Y) \to D(\mathcal{O}_X) $$ is the functor $K \mapsto R\SheafHom_{\mathcal{O}_X}(f_*\mathcal{O}_Y, K)$. \end{lemma} 
\begin{lemma} \label{lemma-finite-twisted} Let $f : Y \to X$ be a finite pseudo-coherent morphism of schemes (a finite morphism of Noetherian schemes is pseudo-coherent). The functor $R\SheafHom(f_*\mathcal{O}_Y, -)$ maps $D_\QCoh^+(\mathcal{O}_X)$ into $D_\QCoh^+(f_*\mathcal{O}_Y)$. If $X$ is quasi-compact and quasi-separated, then the diagram $$ \xymatrix{ D_\QCoh^+(\mathcal{O}_X) \ar[rr]_a \ar[rd]_{R\SheafHom(f_*\mathcal{O}_Y, -)} & & D_\QCoh^+(\mathcal{O}_Y) \ar[ld]^\Phi \\ & D_\QCoh^+(f_*\mathcal{O}_Y) } $$ is commutative, where $a$ is the right adjoint of Lemma \ref{lemma-twisted-inverse-image} for $f$ and $\Phi$ is the equivalence of Derived Categories of Schemes, Lemma \ref{perfect-lemma-affine-morphism-equivalence}. \end{lemma} 
\begin{lemma} \label{lemma-proper-flat} Let $Y$ be a quasi-compact and quasi-separated scheme. Let $f : X \to Y$ be a morphism of schemes which is proper, flat, and of finite presentation. Let $a$ be the right adjoint for $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ of Lemma \ref{lemma-twisted-inverse-image}. Then $a$ commutes with direct sums. \end{lemma} 
\begin{lemma} \label{lemma-proper-flat-relative} Let $Y$ be a quasi-compact and quasi-separated scheme. Let $f : X \to Y$ be a morphism of schemes which is proper, flat, and of finite presentation. Let $a$ be the right adjoint for $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ of Lemma \ref{lemma-twisted-inverse-image}. Then \begin{enumerate} \item for every closed $T \subset Y$ if $Q \in D_\QCoh(Y)$ is supported on $T$, then $a(Q)$ is supported on $f^{-1}(T)$, \item for every open $V \subset Y$ and any $K \in D_\QCoh(\mathcal{O}_Y)$ the map (\ref{equation-sheafy}) is an isomorphism, and \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-compare-with-pullback-flat-proper} Let $Y$ be a quasi-compact and quasi-separated scheme. Let $f : X \to Y$ be a morphism of schemes which is proper, flat, and of finite presentation. The map (\ref{equation-compare-with-pullback}) is an isomorphism for every object $K$ of $D_\QCoh(\mathcal{O}_Y)$. \end{lemma} 
\begin{lemma} \label{lemma-proper-flat-base-change} Let $g : Y' \to Y$ be a morphism of quasi-compact and quasi-separated schemes. Let $f : X \to Y$ be a proper, flat morphism of finite presentation. Then the base change map (\ref{equation-base-change-map}) is an isomorphism for all $K \in D_\QCoh(\mathcal{O}_Y)$. \end{lemma} 
\begin{lemma} \label{lemma-properties-relative-dualizing} Let $Y$ be a quasi-compact and quasi-separated scheme. Let $f : X \to Y$ be a morphism of schemes which is proper, flat, and of finite presentation with relative dualizing complex $\omega_{X/Y}^\bullet$ (Remark \ref{remark-relative-dualizing-complex}). Then \begin{enumerate} \item $\omega_{X/Y}^\bullet$ is a $Y$-perfect object of $D(\mathcal{O}_X)$, \item $Rf_*\omega_{X/Y}^\bullet$ has vanishing cohomology sheaves in positive degrees, \item $\mathcal{O}_X \to R\SheafHom_{\mathcal{O}_X}(\omega_{X/Y}^\bullet, \omega_{X/Y}^\bullet)$ is an isomorphism. \end{enumerate} \end{lemma} 
\begin{lemma}[Rigidity] \label{lemma-van-den-bergh} Let $Y$ be a quasi-compact and quasi-separated scheme. Let $f : X \to Y$ be a proper, flat morphism of finite presentation with relative dualizing complex $\omega_{X/Y}^\bullet$ (Remark \ref{remark-relative-dualizing-complex}). There is a canonical isomorphism \begin{equation} \label{equation-pre-rigid} \mathcal{O}_X = c(L\text{pr}_1^*\omega_{X/Y}^\bullet) = c(L\text{pr}_2^*\omega_{X/Y}^\bullet) \end{equation} and a canonical isomorphism \begin{equation} \label{equation-rigid} \omega_{X/Y}^\bullet = c\left(L\text{pr}_1^*\omega_{X/Y}^\bullet \otimes_{\mathcal{O}_{X \times_Y X}}^\mathbf{L} L\text{pr}_2^*\omega_{X/Y}^\bullet\right) \end{equation} where $c$ is the right adjoint of Lemma \ref{lemma-twisted-inverse-image} for the diagonal $\Delta : X \to X \times_Y X$. \end{lemma} 
\begin{lemma} \label{lemma-proper-flat-noetherian} Let $f : X \to Y$ be a perfect proper morphism of Noetherian schemes. Let $a$ be the right adjoint for $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ of Lemma \ref{lemma-twisted-inverse-image}. Then $a$ commutes with direct sums. \end{lemma} 
\begin{lemma} \label{lemma-proper-flat-noetherian-relative} Let $f : X \to Y$ be a perfect proper morphism of Noetherian schemes. Let $a$ be the right adjoint for $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ of Lemma \ref{lemma-twisted-inverse-image}. Then \begin{enumerate} \item for every closed $T \subset Y$ if $Q \in D_\QCoh(Y)$ is supported on $T$, then $a(Q)$ is supported on $f^{-1}(T)$, \item for every open $V \subset Y$ and any $K \in D_\QCoh(\mathcal{O}_Y)$ the map (\ref{equation-sheafy}) is an isomorphism, and \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-compare-with-pullback-flat-proper-noetherian} Let $f : X \to Y$ be a perfect proper morphism of Noetherian schemes. The map (\ref{equation-compare-with-pullback}) is an isomorphism for every object $K$ of $D_\QCoh(\mathcal{O}_Y)$. \end{lemma} 
\begin{lemma} \label{lemma-proper-perfect-base-change} Let $f : X \to Y$ be a perfect proper morphism of Noetherian schemes. Let $g : Y' \to Y$ be a morphism with $Y'$ Noetherian. If $X$ and $Y'$ are tor independent over $Y$, then the base change map (\ref{equation-base-change-map}) is an isomorphism for all $K \in D_\QCoh(\mathcal{O}_Y)$. \end{lemma} 
\begin{lemma} \label{lemma-compute-for-effective-Cartier} As above, let $X$ be a scheme and let $D \subset X$ be an effective Cartier divisor. There is a canonical isomorphism $R\SheafHom(\mathcal{O}_D, \mathcal{O}_X) = \mathcal{N}[-1]$ in $D(\mathcal{O}_D)$. \end{lemma} 
\begin{lemma} \label{lemma-sheaf-with-exact-support-effective-Cartier} As above, let $X$ be a scheme and let $D \subset X$ be an effective Cartier divisor. Then (\ref{equation-map-effective-Cartier}) combined with Lemma \ref{lemma-compute-for-effective-Cartier} defines an isomorphism $$ Li^*K \otimes_{\mathcal{O}_D}^\mathbf{L} \mathcal{N}[-1] \longrightarrow R\SheafHom(\mathcal{O}_D, K) $$ functorial in $K$ in $D(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-upper-shriek-P1} Let $Y$ be a quasi-compact and quasi-separated scheme. Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_Y$-module of rank $n + 1$ with determinant $\mathcal{L} = \wedge^{n + 1}(\mathcal{E})$. Let $f : X = \mathbf{P}(\mathcal{E}) \to Y$ be the projection. Let $a$ be the right adjoint for $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ of Lemma \ref{lemma-twisted-inverse-image}. Then there is an isomorphism $$ c : f^*\mathcal{L}(-n - 1)[n] \longrightarrow a(\mathcal{O}_Y) $$ In particular, if $\mathcal{E} = \mathcal{O}_Y^{\oplus n + 1}$, then $X = \mathbf{P}^n_Y$ and we obtain $a(\mathcal{O}_Y) = \mathcal{O}_X(-n - 1)[n]$. \end{lemma} 
\begin{lemma} \label{lemma-ext} Let $Y$ be a ringed space. Let $\mathcal{I} \subset \mathcal{O}_Y$ be a sheaf of ideals. Set $\mathcal{O}_X = \mathcal{O}_Y/\mathcal{I}$ and $\mathcal{N} = \SheafHom_{\mathcal{O}_Y}(\mathcal{I}/\mathcal{I}^2, \mathcal{O}_X)$. There is a canonical isomorphism $c : \mathcal{N} \to \SheafExt^1_{\mathcal{O}_Y}(\mathcal{O}_X, \mathcal{O}_X) $. \end{lemma} 
\begin{lemma} \label{lemma-regular-ideal-ext} Let $Y$ be a ringed space. Let $\mathcal{I} \subset \mathcal{O}_Y$ be a sheaf of ideals. Set $\mathcal{O}_X = \mathcal{O}_Y/\mathcal{I}$. If $\mathcal{I}$ is Koszul-regular (Divisors, Definition \ref{divisors-definition-regular-ideal-sheaf}) then composition on $R\SheafHom_{\mathcal{O}_Y}(\mathcal{O}_X, \mathcal{O}_X)$ defines isomorphisms $$ \wedge^i(\SheafExt^1_{\mathcal{O}_Y}(\mathcal{O}_X, \mathcal{O}_X)) \longrightarrow \SheafExt^i_{\mathcal{O}_Y}(\mathcal{O}_X, \mathcal{O}_X) $$ for all $i$. \end{lemma} 
\begin{lemma} \label{lemma-regular-immersion-ext} Let $Y$ be a ringed space. Let $\mathcal{I} \subset \mathcal{O}_Y$ be a sheaf of ideals. Set $\mathcal{O}_X = \mathcal{O}_Y/\mathcal{I}$ and $\mathcal{N} = \SheafHom_{\mathcal{O}_Y}(\mathcal{I}/\mathcal{I}^2, \mathcal{O}_X)$. If $\mathcal{I}$ is Koszul-regular (Divisors, Definition \ref{divisors-definition-regular-ideal-sheaf}) then $$ R\SheafHom_{\mathcal{O}_Y}(\mathcal{O}_X, \mathcal{O}_Y) = \wedge^r \mathcal{N}[-r] $$ where $r : Y \to \{1, 2, 3, \ldots \}$ sends $y$ to the minimal number of generators of $\mathcal{I}$ needed in a neighbourhood of $y$. \end{lemma} 
\begin{lemma} \label{lemma-regular-immersion} Let $Y$ be a quasi-compact and quasi-separated scheme. Let $i : X \to Y$ be a Koszul-regular closed immersion. Let $a$ be the right adjoint of $Ri_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ of Lemma \ref{lemma-twisted-inverse-image}. Then there is an isomorphism $$ \wedge^r\mathcal{N}[-r] \longrightarrow a(\mathcal{O}_Y) $$ where $\mathcal{N} = \SheafHom_{\mathcal{O}_X}(\mathcal{C}_{X/Y}, \mathcal{O}_X)$ is the normal sheaf of $i$ (Morphisms, Section \ref{morphisms-section-conormal-sheaf}) and $r$ is its rank viewed as a locally constant function on $X$. \end{lemma} 
\begin{lemma} \label{lemma-smooth-proper} Let $S$ be a Noetherian scheme. Let $f : X \to S$ be a smooth proper morphism of relative dimension $d$. Let $a$ be the right adjoint of $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_S)$ as in Lemma \ref{lemma-twisted-inverse-image}. Then there is an isomorphism $$ \wedge^d \Omega_{X/S}[d] \longrightarrow a(\mathcal{O}_S) $$ in $D(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-shriek-well-defined} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. The functor $f^!$ is, up to canonical isomorphism, independent of the choice of the compactification. \end{lemma} 
\begin{lemma} \label{lemma-upper-shriek-composition} In Situation \ref{situation-shriek} let $f : X \to Y$ and $g : Y \to Z$ be composable morphisms of $\textit{FTS}_S$. Then there is a canonical isomorphism $(g \circ f)^! \to f^! \circ g^!$. \end{lemma} 
\begin{lemma} \label{lemma-pseudo-functor} In Situation \ref{situation-shriek} the constructions of Lemmas \ref{lemma-shriek-well-defined} and \ref{lemma-upper-shriek-composition} define a pseudo functor from the category $\textit{FTS}_S$ into the $2$-category of categories (see Categories, Definition \ref{categories-definition-functor-into-2-category}). \end{lemma} 
\begin{lemma} \label{lemma-map-pullback-to-shriek-well-defined} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. There are canonical maps $$ \mu_{f, K} : Lf^*K \otimes_{\mathcal{O}_X}^\mathbf{L} f^!\mathcal{O}_Y \longrightarrow f^!K $$ functorial in $K$ in $D^+_\QCoh(\mathcal{O}_Y)$. If $g : Y \to Z$ is another morphism of $\textit{FTS}_S$, then the diagram $$ \xymatrix{ Lf^*(Lg^*K \otimes_{\mathcal{O}_Y}^\mathbf{L} g^!\mathcal{O}_Z) \otimes_{\mathcal{O}_X}^\mathbf{L} f^!\mathcal{O}_Y \ar@{=}[d] \ar[r]_-{\mu_f} & f^!(Lg^*K \otimes_{\mathcal{O}_Y}^\mathbf{L} g^!\mathcal{O}_Z) \ar[r]_-{f^!\mu_g} & f^!g^!K \ar@{=}[d] \\ Lf^*Lg^*K \otimes_{\mathcal{O}_X}^\mathbf{L} Lf^* g^!\mathcal{O}_Z \otimes_{\mathcal{O}_X}^\mathbf{L} f^!\mathcal{O}_Y \ar[r]^-{\mu_f} & Lf^*Lg^*K \otimes_{\mathcal{O}_X}^\mathbf{L} f^!g^!\mathcal{O}_Z \ar[r]^-{\mu_{g \circ f}} & f^!g^!K } $$ commutes for all $K \in D^+_\QCoh(\mathcal{O}_Z)$. \end{lemma} 
\begin{lemma} \label{lemma-shriek-open-immersion} In Situation \ref{situation-shriek} let $Y$ be an object of $\textit{FTS}_S$ and let $j : X \to Y$ be an open immersion. Then there is a canonical isomorphism $j^! = j^*$ of functors. \end{lemma} 
\begin{lemma} \label{lemma-restrict-before-or-after} In Situation \ref{situation-shriek} let $$ \xymatrix{ U \ar[r]_j \ar[d]_g & X \ar[d]^f \\ V \ar[r]^{j'} & Y } $$ be a commutative diagram of $\textit{FTS}_S$ where $j$ and $j'$ are open immersions. Then $j^* \circ f^! = g^! \circ (j')^*$ as functors $D^+_\QCoh(\mathcal{O}_Y) \to D^+(\mathcal{O}_U)$. \end{lemma} 
\begin{lemma} \label{lemma-shriek-affine-line} In Situation \ref{situation-shriek} let $Y$ be an object of $\textit{FTS}_S$ and let $f : X = \mathbf{A}^1_Y \to Y$ be the projection. Then there is a (noncanonical) isomorphism $f^!(-) \cong Lf^*(-) [1]$ of functors. \end{lemma} 
\begin{lemma} \label{lemma-shriek-closed-immersion} In Situation \ref{situation-shriek} let $Y$ be an object of $\textit{FTS}_S$ and let $i : X \to Y$ be a closed immersion. Then there is a canonical isomorphism $i^!(-) = R\SheafHom(\mathcal{O}_X, -)$ of functors. \end{lemma} 
\begin{lemma} \label{lemma-shriek-coherent} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. Then $f^!$ maps $D_{\textit{Coh}}^+(\mathcal{O}_Y)$ into $D_{\textit{Coh}}^+(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-shriek-dualizing} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. If $K$ is a dualizing complex for $Y$, then $f^!K$ is a dualizing complex for $X$. \end{lemma} 
\begin{lemma} \label{lemma-shriek-via-duality} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. Let $K$ be a dualizing complex on $Y$. Set $D_Y(M) = R\SheafHom_{\mathcal{O}_Y}(M, K)$ for $M \in D_{\textit{Coh}}(\mathcal{O}_Y)$ and $D_X(E) = R\SheafHom_{\mathcal{O}_X}(E, f^!K)$ for $E \in D_{\textit{Coh}}(\mathcal{O}_X)$. Then there is a canonical isomorphism $$ f^!M \longrightarrow D_X(Lf^*D_Y(M)) $$ for $M \in D_{\textit{Coh}}^+(\mathcal{O}_Y)$. \end{lemma} 
\begin{lemma} \label{lemma-perfect-comparison-shriek} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. Assume $f$ is perfect (e.g., flat). Then \begin{enumerate} \item[(a)] $f^!\mathcal{O}_Y$ is in $D_{\textit{Coh}}^b(\mathcal{O}_X)$, \item[(b)] $f^!\mathcal{O}_Y$ has finite tor dimension in $D(f^{-1}\mathcal{O}_Y)$, \item[(c)] $\mathcal{O}_X \to R\SheafHom_{\mathcal{O}_X}(f^!\mathcal{O}_Y, f^!\mathcal{O}_Y)$ is an isomorphism, \item[(d)] $f^!$ maps $D_{\textit{Coh}}^b(\mathcal{O}_Y)$ into $D_{\textit{Coh}}^b(\mathcal{O}_X)$, \item[(e)] the map $\mu_{f,  K} : Lf^*K \otimes_{\mathcal{O}_X}^\mathbf{L} f^!\mathcal{O}_Y \to f^!K$ of Lemma \ref{lemma-map-pullback-to-shriek-well-defined} is an isomorphism for all $K \in D_\QCoh^+(\mathcal{O}_Y)$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-flat-shriek-relatively-perfect} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. If $f$ is flat, then $f^!\mathcal{O}_Y$ is a $Y$-perfect object of $D(\mathcal{O}_X)$ and $\mathcal{O}_X \to R\SheafHom_{\mathcal{O}_X}(f^!\mathcal{O}_Y, f^!\mathcal{O}_Y)$ is an isomorphism. \end{lemma} 
\begin{lemma} \label{lemma-lci-shriek} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. Assume $f : X \to Y$ is a local complete intersection morphism. Then \begin{enumerate} \item $f^!\mathcal{O}_Y$ is an invertible object of $D(\mathcal{O}_X)$, and \item $f^!$ maps perfect complexes to perfect complexes. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-base-change-shriek-flat} In Situation \ref{situation-shriek} let $$ \xymatrix{ X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\ Y' \ar[r]^g & Y } $$ be a cartesian diagram of $\textit{FTS}_S$ with $g$ flat. Then there is an isomorphism $L(g')^* \circ f^! \to (f')^! \circ Lg^*$ on $D_\QCoh^+(\mathcal{O}_Y)$. \end{lemma} 
\begin{lemma} \label{lemma-shriek-etale} In Situation \ref{situation-shriek} let $f : X \to Y$ be an \'etale morphism of $\textit{FTS}_S$. Then $f^! \cong f^*$ as functors on $D^+_\QCoh(\mathcal{O}_Y)$. \end{lemma} 
\begin{lemma}[Makeshift base change] \label{lemma-base-change-locally} In Situation \ref{situation-shriek} let $$ \xymatrix{ X' \ar[r]_{g'} \ar[d]_{f'} & X \ar[d]^f \\ Y' \ar[r]^g & Y } $$ be a cartesian diagram of $\textit{FTS}_S$. Let $E \in D^+_\QCoh(\mathcal{O}_Y)$ be an object such that $Lg^*E$ is in $D^+(\mathcal{O}_Y)$. If $f$ is flat, then $L(g')^*f^!E$ and $(f')^!Lg^*E$ restrict to isomorphic objects of $D(\mathcal{O}_{U'})$ for $U' \subset X'$ affine open mapping into affine opens of $Y$, $Y'$, and $X$. \end{lemma} 
\begin{lemma} \label{lemma-relative-dualizing-fibres} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. Assume $f$ is flat. Set $\omega_{X/Y}^\bullet = f^!\mathcal{O}_Y$ in $D^b_{\textit{Coh}}(X)$. Let $y \in Y$ and $h : X_y \to X$ the projection. Then $Lh^*\omega_{X/Y}^\bullet$ is a dualizing complex on $X_y$. \end{lemma} 
\begin{lemma} \label{lemma-good-dualizing-unique} In Situation \ref{situation-dualizing} let $X$ be a scheme of finite type over $S$ and let $\mathcal{U}$ be a finite open covering of $X$ by schemes separated over $S$. If there exists a dualizing complex normalized relative to $\omega_S^\bullet$ and $\mathcal{U}$, then it is unique up to unique isomorphism. \end{lemma} 
\begin{lemma} \label{lemma-good-dualizing-independence-covering} In Situation \ref{situation-dualizing} let $X$ be a scheme of finite type over $S$ and let $\mathcal{U}$, $\mathcal{V}$ be two finite open coverings of $X$ by schemes separated over $S$. If there exists a dualizing complex normalized relative to $\omega_S^\bullet$ and $\mathcal{U}$, then there exists a dualizing complex normalized relative to $\omega_S^\bullet$ and $\mathcal{V}$ and these complexes are canonically isomorphic. \end{lemma} 
\begin{lemma} \label{lemma-existence-good-dualizing} In Situation \ref{situation-dualizing} let $X$ be a scheme of finite type over $S$ and let $\mathcal{U}$ be a finite open covering of $X$ by schemes separated over $S$. Then there exists a dualizing complex normalized relative to $\omega_S^\bullet$ and $\mathcal{U}$. \end{lemma} 
\begin{definition} \label{definition-good-dualizing} Let $S$ be a Noetherian scheme and let $\omega_S^\bullet$ be a dualizing complex on $S$. Let $X$ be a scheme of finite type over $S$. The complex $K$ constructed above is called the {\it dualizing complex normalized relative to $\omega_S^\bullet$} and is denoted $\omega_X^\bullet$. \end{definition} 
\begin{lemma} \label{lemma-good-over-both} Let $(S, \omega_S^\bullet)$ be as in Situation \ref{situation-dualizing}. Let $f : X \to Y$ be a morphism of finite type schemes over $S$. Let $\omega_X^\bullet$ and $\omega_Y^\bullet$ be dualizing complexes normalized relative to $\omega_S^\bullet$. Then $\omega_X^\bullet$ is a dualizing complex normalized relative to $\omega_Y^\bullet$. \end{lemma} 
\begin{lemma} \label{lemma-open-immersion-good-dualizing-complex} Let $(S, \omega_S^\bullet)$ be as in Situation \ref{situation-dualizing}. Let $j : X \to Y$ be an open immersion of schemes of finite type over $S$. Let $\omega_X^\bullet$ and $\omega_Y^\bullet$ be dualizing complexes normalized relative to $\omega_S^\bullet$. Then there is a canonical isomorphism $\omega_X^\bullet = \omega_Y^\bullet|_X$. \end{lemma} 
\begin{lemma} \label{lemma-proper-map-good-dualizing-complex} Let $(S, \omega_S^\bullet)$ be as in Situation \ref{situation-dualizing}. Let $f : X \to Y$ be a proper morphism of schemes of finite type over $S$. Let $\omega_X^\bullet$ and $\omega_Y^\bullet$ be dualizing complexes normalized relative to $\omega_S^\bullet$. Let $a$ be the right adjoint of Lemma \ref{lemma-twisted-inverse-image} for $f$. Then there is a canonical isomorphism $a(\omega_Y^\bullet) = \omega_X^\bullet$. \end{lemma} 
\begin{lemma} \label{lemma-duality-bootstrap} Let $(S, \omega_S^\bullet)$ be as in Situation \ref{situation-dualizing}. With $f^!_{new}$ and $\omega_X^\bullet$ defined for all (morphisms of) schemes of finite type over $S$ as above: \begin{enumerate} \item the functors $f^!_{new}$ and the arrows $(g \circ f)^!_{new} \to f^!_{new} \circ g^!_{new}$ turn $D_{\textit{Coh}}^+$ into a pseudo functor from the category of schemes of finite type over $S$ into the $2$-category of categories, \item $\omega_X^\bullet = (X \to S)^!_{new} \omega_S^\bullet$, \item the functor $D_X$ defines an involution of $D_{\textit{Coh}}(\mathcal{O}_X)$ switching $D_{\textit{Coh}}^+(\mathcal{O}_X)$ and $D_{\textit{Coh}}^-(\mathcal{O}_X)$ and fixing $D_{\textit{Coh}}^b(\mathcal{O}_X)$, \item $\omega_X^\bullet = f^!_{new}\omega_Y^\bullet$ for $f : X \to Y$ a morphism of finite type schemes over $S$, \item $f^!_{new}M = D_X(Lf^*D_Y(M))$ for $M \in D_{\textit{Coh}}^+(\mathcal{O}_Y)$, and \item if in addition $f$ is proper, then $f^!_{new}$ is isomorphic to the restriction of the right adjoint of $Rf_* : D_\QCoh(\mathcal{O}_X) \to D_\QCoh(\mathcal{O}_Y)$ to $D_{\textit{Coh}}^+(\mathcal{O}_Y)$ and there is a canonical isomorphism $$ Rf_*R\SheafHom_{\mathcal{O}_X}(K, f^!_{new}M) \to R\SheafHom_{\mathcal{O}_Y}(Rf_*K, M) $$ for $K \in D^-_{\textit{Coh}}(\mathcal{O}_X)$ and $M \in D_{\textit{Coh}}^+(\mathcal{O}_Y)$, and $$ Rf_*R\SheafHom_{\mathcal{O}_X}(K, \omega_X^\bullet) = R\SheafHom_{\mathcal{O}_Y}(Rf_*K, \omega_Y^\bullet) $$ for $K \in D^-_{\textit{Coh}}(\mathcal{O}_X)$ and \end{enumerate} If $X$ is separated over $S$, then $\omega_X^\bullet$ is canonically isomorphic to $(X \to S)^!\omega_S^\bullet$ and if $f$ is a morphism between schemes separated over $S$, then there is a canonical isomorphism\footnote{We haven't checked that these are compatible with the isomorphisms $(g \circ f)^! \to f^! \circ g^!$ and $(g \circ f)^!_{new} \to f^!_{new} \circ g^!_{new}$. We will do this here if we need this later.} $f_{new}^!K = f^!K$ for $K$ in $D_{\textit{Coh}}^+$. \end{lemma} 
\begin{lemma} \label{lemma-good-dualizing-normalized} Let $S$ be a Noetherian scheme and let $\omega_S^\bullet$ be a dualizing complex. Let $X$ be a scheme of finite type over $S$ and let $\omega_X^\bullet$ be the dualizing complex normalized relative to $\omega_S^\bullet$. If $x \in X$ is a closed point lying over a closed point $s$ of $S$, then $\omega_{X, x}^\bullet$ is a normalized dualizing complex over $\mathcal{O}_{X, x}$ provided that $\omega_{S, s}^\bullet$ is a normalized dualizing complex over $\mathcal{O}_{S, s}$. \end{lemma} 
\begin{lemma} \label{lemma-good-dualizing-dimension-function} Let $S$ be a Noetherian scheme and let $\omega_S^\bullet$ be a dualizing complex. Let $f : X \to S$ be of finite type and let $\omega_X^\bullet$ be the dualizing complex normalized relative to $\omega_S^\bullet$. For all $x \in X$ we have $$ \delta_X(x) - \delta_S(f(x)) = \text{trdeg}_{\kappa(f(x))}(\kappa(x)) $$ where $\delta_S$, resp.\ $\delta_X$ is the dimension function of $\omega_S^\bullet$, resp.\ $\omega_X^\bullet$, see Lemma \ref{lemma-dimension-function-scheme}. \end{lemma} 
\begin{lemma} \label{lemma-shriek} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. Let $x \in X$ with image $y \in Y$. Then $$ H^i(f^!\mathcal{O}_Y)_x \not = 0 \Rightarrow - \dim_x(X_y) \leq i. $$ \end{lemma} 
\begin{lemma} \label{lemma-flat-shriek} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. Let $x \in X$ with image $y \in Y$. If $f$ is flat, then $$ H^i(f^!\mathcal{O}_Y)_x \not = 0 \Rightarrow - \dim_x(X_y) \leq i \leq 0. $$ In fact, if all fibres of $f$ have dimension $\leq d$, then $f^!\mathcal{O}_Y$ has tor-amplitude in $[-d, 0]$ as an object of $D(X, f^{-1}\mathcal{O}_Y)$. \end{lemma} 
\begin{lemma} \label{lemma-shriek-over-CM} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. Let $x \in X$ with image $y \in Y$. Assume \begin{enumerate} \item $\mathcal{O}_{Y, y}$ is Cohen-Macaulay, and \item $\text{trdeg}_{\kappa(f(\xi))}(\kappa(\xi)) \leq r$ for any generic point $\xi$ of an irreducible component of $X$ containing $x$. \end{enumerate} Then $$ H^i(f^!\mathcal{O}_Y)_x \not = 0 \Rightarrow - r \leq i $$ and the stalk $H^{-r}(f^!\mathcal{O}_Y)_x$ is $(S_2)$ as an $\mathcal{O}_{X, x}$-module. \end{lemma} 
\begin{lemma} \label{lemma-flat-quasi-finite-shriek} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. If $f$ is flat and quasi-finite, then $$ f^!\mathcal{O}_Y = \omega_{X/Y}[0] $$ for some coherent $\mathcal{O}_X$-module $\omega_{X/Y}$ flat over $Y$. \end{lemma} 
\begin{lemma} \label{lemma-CM-shriek} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. If $f$ is Cohen-Macaulay (More on Morphisms, Definition \ref{more-morphisms-definition-CM}), then $$ f^!\mathcal{O}_Y = \omega_{X/Y}[d] $$ for some coherent $\mathcal{O}_X$-module $\omega_{X/Y}$ flat over $Y$ where $d$ is the locally constant function on $X$ which gives the relative dimension of $X$ over $Y$. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-module} Let $X$ be a connected Noetherian scheme and let $\omega_X$ be a dualizing module on $X$. The support of $\omega_X$ is the union of the irreducible components of maximal dimension with respect to any dimension function and $\omega_X$ is a coherent $\mathcal{O}_X$-module having property $(S_2)$. \end{lemma} 
\begin{lemma} \label{lemma-vanishing-good-dualizing} Let $X/A$ with $\omega_X^\bullet$ and $\omega_X$ be as in Example \ref{example-proper-over-local}. Then \begin{enumerate} \item $H^i(\omega_X^\bullet) \not = 0 \Rightarrow i \in \{-\dim(X), \ldots, 0\}$, \item the dimension of the support of $H^i(\omega_X^\bullet)$ is at most $-i$, \item $\text{Supp}(\omega_X)$ is the union of the components of dimension $\dim(X)$, and \item $\omega_X$ has property $(S_2)$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-dualizing-module-proper-over-A} Let $X/A$ with dualizing module $\omega_X$ be as in Example \ref{example-proper-over-local}. Let $d = \dim(X_s)$ be the dimension of the closed fibre. If $\dim(X) = d + \dim(A)$, then the dualizing module $\omega_X$ represents the functor $$ \mathcal{F} \longmapsto \Hom_A(H^d(X, \mathcal{F}), \omega_A) $$ on the category of coherent $\mathcal{O}_X$-modules. \end{lemma} 
\begin{lemma} \label{lemma-dualizing-module-CM-scheme} Let $X$ be a locally Noetherian scheme with dualizing complex $\omega_X^\bullet$. \begin{enumerate} \item $X$ is Cohen-Macaulay $\Leftrightarrow$ $\omega_X^\bullet$ locally has a unique nonzero cohomology sheaf, \item $\mathcal{O}_{X, x}$ is Cohen-Macaulay $\Leftrightarrow$ $\omega_{X, x}^\bullet$ has a unique nonzero cohomology, \item $U = \{x \in X \mid \mathcal{O}_{X, x}\text{ is Cohen-Macaulay}\}$ is open and Cohen-Macaulay. \end{enumerate} If $X$ is connected and Cohen-Macaulay, then there is an integer $n$ and a coherent Cohen-Macaulay $\mathcal{O}_X$-module $\omega_X$ such that $\omega_X^\bullet = \omega_X[-n]$. \end{lemma} 
\begin{lemma} \label{lemma-has-dualizing-module-CM-scheme} Let $X$ be a locally Noetherian scheme. If there exists a coherent sheaf $\omega_X$ such that $\omega_X[0]$ is a dualizing complex on $X$, then $X$ is a Cohen-Macaulay scheme. \end{lemma} 
\begin{lemma} \label{lemma-affine-flat-Noetherian-CM} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. Let $x \in X$. If $f$ is flat, then the following are equivalent \begin{enumerate} \item $f$ is Cohen-Macaulay at $x$, \item $f^!\mathcal{O}_Y$ has a unique nonzero cohomology sheaf in a neighbourhood of $x$. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-gorenstein} Let $X$ be a scheme. We say $X$ is {\it Gorenstein} if $X$ is locally Noetherian and $\mathcal{O}_{X, x}$ is Gorenstein for all $x \in X$. \end{definition} 
\begin{lemma} \label{lemma-gorenstein-CM} A Gorenstein scheme is Cohen-Macaulay. \end{lemma} 
\begin{lemma} \label{lemma-regular-gorenstein} A regular scheme is Gorenstein. \end{lemma} 
\begin{lemma} \label{lemma-gorenstein} Let $X$ be a locally Noetherian scheme. \begin{enumerate} \item If $X$ has a dualizing complex $\omega_X^\bullet$, then \begin{enumerate} \item $X$ is Gorenstein $\Leftrightarrow$ $\omega_X^\bullet$ is an invertible object of $D(\mathcal{O}_X)$, \item $\mathcal{O}_{X, x}$ is Gorenstein $\Leftrightarrow$ $\omega_{X, x}^\bullet$ is an invertible object of $D(\mathcal{O}_{X, x})$, \item $U = \{x \in X \mid \mathcal{O}_{X, x}\text{ is Gorenstein}\}$ is an open Gorenstein subscheme. \end{enumerate} \item If $X$ is Gorenstein, then $X$ has a dualizing complex if and only if $\mathcal{O}_X[0]$ is a dualizing complex. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-gorenstein-lci} If $f : Y \to X$ is a local complete intersection morphism with $X$ a Gorenstein scheme, then $Y$ is Gorenstein. \end{lemma} 
\begin{lemma} \label{lemma-gorenstein-local-syntomic} The property $\mathcal{P}(S) =$``$S$ is Gorenstein'' is local in the syntomic topology. \end{lemma} 
\begin{lemma} \label{lemma-gorenstein-base-change} Let $X$ be a locally Noetherian scheme over the field $k$. Let $k'/k$ be a finitely generated field extension. Let $x \in X$ be a point, and let $x' \in X_{k'}$ be a point lying over $x$. Then we have $$ \mathcal{O}_{X, x}\text{ is Gorenstein} \Leftrightarrow \mathcal{O}_{X_{k'}, x'}\text{ is Gorenstein} $$ If $X$ is locally of finite type over $k$, the same holds for any field extension $k'/k$. \end{lemma} 
\begin{definition} \label{definition-gorenstein-morphism} Let $f : X \to Y$ be a morphism of schemes. Assume that all the fibres $X_y$ are locally Noetherian schemes. \begin{enumerate} \item Let $x \in X$, and $y = f(x)$. We say that $f$ is {\it Gorenstein at $x$} if $f$ is flat at $x$, and the local ring of the scheme $X_y$ at $x$ is Gorenstein. \item We say $f$ is a {\it Gorenstein morphism} if $f$ is Gorenstein at every point of $X$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-gorenstein-morphism} Let $f : X \to Y$ be a morphism of schemes. Assume all fibres of $f$ are locally Noetherian. The following are equivalent \begin{enumerate} \item $f$ is Gorenstein, and \item $f$ is flat and its fibres are Gorenstein schemes. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-gorenstein-CM-morphism} A Gorenstein morphism is Cohen-Macaulay. \end{lemma} 
\begin{lemma} \label{lemma-lci-gorenstein} A syntomic morphism is Gorenstein. Equivalently a flat local complete intersection morphism is Gorenstein. \end{lemma} 
\begin{lemma} \label{lemma-composition-gorenstein} Let $f : X \to Y$ and $g : Y \to Z$ be morphisms. Assume that the fibres $X_y$, $Y_z$ and $X_z$ of $f$, $g$, and $g \circ f$ are locally Noetherian. \begin{enumerate} \item If $f$ is Gorenstein at $x$ and $g$ is Gorenstein at $f(x)$, then $g \circ f$ is Gorenstein at $x$. \item If $f$ and $g$ are Gorenstein, then $g \circ f$ is Gorenstein. \item If $g \circ f$ is Gorenstein at $x$ and $f$ is flat at $x$, then $f$ is Gorenstein at $x$ and $g$ is Gorenstein at $f(x)$. \item If $g \circ f$ is Gorenstein and $f$ is flat, then $f$ is Gorenstein and $g$ is Gorenstein at every point in the image of $f$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-flat-morphism-from-gorenstein-scheme} \begin{slogan} Gorensteinnes of the total space of a flat fibration implies same for base and fibres \end{slogan} Let $f : X \to Y$ be a flat morphism of locally Noetherian schemes. If $X$ is Gorenstein, then $f$ is Gorenstein and $\mathcal{O}_{Y, f(x)}$ is Gorenstein for all $x \in X$. \end{lemma} 
\begin{lemma} \label{lemma-base-change-gorenstein} Let $f : X \to Y$ be a morphism of schemes. Assume that all the fibres $X_y$ are locally Noetherian schemes. Let $Y' \to Y$ be locally of finite type. Let $f' : X' \to Y'$ be the base change of $f$. Let $x' \in X'$ be a point with image $x \in X$. \begin{enumerate} \item If $f$ is Gorenstein at $x$, then $f' : X' \to Y'$ is Gorenstein at $x'$. \item If $f$ is flat at $x$ and $f'$ is Gorenstein at $x'$, then $f$ is Gorenstein at $x$. \item If $Y' \to Y$ is flat at $f'(x')$ and $f'$ is Gorenstein at $x'$, then $f$ is Gorenstein at $x$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-flat-lft-base-change-gorenstein} Let $f : X \to Y$ be a morphism of schemes which is flat and locally of finite type. Then formation of the set $\{x \in X \mid f\text{ is Gorenstein at }x\}$ commutes with arbitrary base change. \end{lemma} 
\begin{lemma} \label{lemma-affine-flat-Noetherian-gorenstein} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. Let $x \in X$. If $f$ is flat, then the following are equivalent \begin{enumerate} \item $f$ is Gorenstein at $x$, \item $f^!\mathcal{O}_Y$ is isomorphic to an invertible object in a neighbourhood of $x$. \end{enumerate} In particular, the set of points where $f$ is Gorenstein is open in $X$. \end{lemma} 
\begin{lemma} \label{lemma-flat-finite-presentation-characterize-gorenstein} Let $f : X \to S$ be a morphism of schemes which is flat and locally of finite presentation. Let $x \in X$ with image $s \in S$. Set $d = \dim_x(X_s)$. The following are equivalent \begin{enumerate} \item $f$ is Gorenstein at $x$, \item there exists an open neighbourhood $U \subset X$ of $x$ and a locally quasi-finite morphism $U \to \mathbf{A}^d_S$ over $S$ which is Gorenstein at $x$, \item there exists an open neighbourhood $U \subset X$ of $x$ and a locally quasi-finite Gorenstein morphism $U \to \mathbf{A}^d_S$ over $S$, \item for any $S$-morphism $g : U \to \mathbf{A}^d_S$ of an open neighbourhood $U \subset X$ of $x$ we have: $g$ is quasi-finite at $x$ $\Rightarrow$ $g$ is Gorenstein at $x$. \end{enumerate} In particular, the set of points where $f$ is Gorenstein is open in $X$. \end{lemma} 
\begin{lemma} \label{lemma-gorenstein-local-source-and-target} The property $\mathcal{P}(f)=$``the fibres of $f$ are locally Noetherian and $f$ is Gorenstein'' is local in the fppf topology on the target and local in the syntomic topology on the source. \end{lemma} 
\begin{lemma} \label{lemma-descent-ascent} Let $f : X \to Y$ be a morphism of locally Noetherian schemes. Assume \begin{enumerate} \item $f$ is syntomic and surjective, or \item $f$ is a surjective flat local complete intersection morphism, or \item $f$ is a surjective Gorenstein morphism of finite type. \end{enumerate} Then $K \in D_\QCoh(\mathcal{O}_Y)$ is a dualizing complex on $Y$ if and only if $Lf^*K$ is a dualizing complex on $X$. \end{lemma} 
\begin{lemma} \label{lemma-duality-proper-over-field} Let $X$ be a proper scheme over a field $k$. There exists a dualizing complex $\omega_X^\bullet$ with the following properties \begin{enumerate} \item $H^i(\omega_X^\bullet)$ is nonzero only for $i \in [-\dim(X), 0]$, \item $\omega_X = H^{-\dim(X)}(\omega_X^\bullet)$ is a coherent $(S_2)$-module whose support is the irreducible components of dimension $\dim(X)$, \item the dimension of the support of $H^i(\omega_X^\bullet)$ is at most $-i$, \item for $x \in X$ closed the module $H^i(\omega_{X, x}^\bullet) \oplus \ldots \oplus H^0(\omega_{X, x}^\bullet)$ is nonzero if and only if $\text{depth}(\mathcal{O}_{X, x}) \leq -i$, \item for $K \in D_\QCoh(\mathcal{O}_X)$ there are functorial isomorphisms\footnote{This property characterizes $\omega_X^\bullet$ in $D_\QCoh(\mathcal{O}_X)$ up to unique isomorphism by the Yoneda lemma. Since $\omega_X^\bullet$ is in $D^b_{\textit{Coh}}(\mathcal{O}_X)$ in fact it suffices to consider $K \in D^b_{\textit{Coh}}(\mathcal{O}_X)$.} $$ \Ext^i_X(K, \omega_X^\bullet) = \Hom_k(H^{-i}(X, K), k) $$ compatible with shifts and distinguished triangles, \item there are functorial isomorphisms $\Hom(\mathcal{F}, \omega_X) = \Hom_k(H^{\dim(X)}(X, \mathcal{F}), k)$ for $\mathcal{F}$ quasi-coherent on $X$, and \item if $X \to \Spec(k)$ is smooth of relative dimension $d$, then $\omega_X^\bullet \cong \wedge^d\Omega_{X/k}[d]$ and $\omega_X \cong \wedge^d\Omega_{X/k}$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-duality-proper-over-field-perfect} Let $k$, $X$, and $\omega_X^\bullet$ be as in Lemma \ref{lemma-duality-proper-over-field}. Let $t : H^0(X, \omega_X^\bullet) \to k$ be as in Remark \ref{remark-duality-proper-over-field}. Let $E \in D(\mathcal{O}_X)$ be perfect. Then the pairings $$ H^i(X, \omega_X^\bullet \otimes_{\mathcal{O}_X}^\mathbf{L} E^\vee) \times H^{-i}(X, E) \longrightarrow k, \quad (\xi, \eta) \longmapsto t((1_{\omega_X^\bullet} \otimes \epsilon)(\xi \cup \eta)) $$ are perfect for all $i$. Here $\cup$ denotes the cupproduct of Cohomology, Section \ref{cohomology-section-cup-product} and $\epsilon : E^\vee \otimes_{\mathcal{O}_X}^\mathbf{L} E \to \mathcal{O}_X$ is as in Cohomology, Example \ref{cohomology-example-dual-derived}. \end{lemma} 
\begin{lemma} \label{lemma-duality-proper-over-field-CM} Let $X$ be a proper scheme over a field $k$ which is Cohen-Macaulay and equidimensional of dimension $d$. The module $\omega_X$ of Lemma \ref{lemma-duality-proper-over-field} has the following properties \begin{enumerate} \item $\omega_X$ is a dualizing module on $X$ (Section \ref{section-dualizing-module}), \item $\omega_X$ is a coherent Cohen-Macaulay module whose support is $X$, \item there are functorial isomorphisms $\Ext^i_X(K, \omega_X[d]) = \Hom_k(H^{-i}(X, K), k)$ compatible with shifts and distinguished triangles for $K \in D_\QCoh(X)$, \item there are functorial isomorphisms $\Ext^{d - i}(\mathcal{F}, \omega_X) = \Hom_k(H^i(X, \mathcal{F}), k)$ for $\mathcal{F}$ quasi-coherent on $X$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-sanity-check-duality} Let $X$ be a proper scheme over a field $k$. Let $\omega_X^\bullet$ and $\omega_X$ be as in Lemma \ref{lemma-duality-proper-over-field}. \begin{enumerate} \item If $X \to \Spec(k)$ factors as $X \to \Spec(k') \to \Spec(k)$ for some field $k'$, then $\omega_X^\bullet$ and $\omega_X$ are as in Lemma \ref{lemma-duality-proper-over-field} for the morphism $X \to \Spec(k')$. \item If $K/k$ is a field extension, then the pullback of $\omega_X^\bullet$ and $\omega_X$ to the base change $X_K$ are as in  Lemma \ref{lemma-duality-proper-over-field} for the morphism $X_K \to \Spec(K)$. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-relative-dualizing-complex} Let $X \to S$ be a morphism of schemes which is flat and locally of finite presentation. Let $W \subset X \times_S X$ be any open such that the diagonal $\Delta_{X/S} : X \to X \times_S X$ factors through a closed immersion $\Delta : X \to W$. A {\it relative dualizing complex} is a pair $(K, \xi)$ consisting of an object $K \in D(\mathcal{O}_X)$ and a map $$ \xi : \Delta_*\mathcal{O}_X \longrightarrow L\text{pr}_1^*K|_W $$ in $D(\mathcal{O}_W)$ such that \begin{enumerate} \item $K$ is $S$-perfect (Derived Categories of Schemes, Definition \ref{perfect-definition-relatively-perfect}), and \item $\xi$ defines an isomorphism of $\Delta_*\mathcal{O}_X$ with $R\SheafHom_{\mathcal{O}_W}( \Delta_*\mathcal{O}_X, L\text{pr}_1^*K|_W)$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-relative-dualizing-complex-algebra} Let $X \to S$ be a morphism of schemes which is flat and locally of finite presentation. Let $(K, \xi)$ be a relative dualizing complex. Then for any commutative diagram $$ \xymatrix{ \Spec(A) \ar[d] \ar[r] & X \ar[d] \\ \Spec(R) \ar[r] & S } $$ whose horizontal arrows are open immersions, the restriction of $K$ to $\Spec(A)$ corresponds via Derived Categories of Schemes, Lemma \ref{perfect-lemma-affine-compare-bounded} to a relative dualizing complex for $R \to A$ in the sense of Dualizing Complexes, Definition \ref{dualizing-definition-relative-dualizing-complex}. \end{lemma} 
\begin{lemma} \label{lemma-relative-dualizing-RHom} Let $X \to S$ be a morphism of schemes which is flat and locally of finite presentation. Let $(K, \xi)$ be a relative dualizing complex. Then $\mathcal{O}_X \to R\SheafHom_{\mathcal{O}_X}(K, K)$ is an isomorphism. \end{lemma} 
\begin{lemma} \label{lemma-uniqueness-relative-dualizing} Let $X \to S$ be a morphism of schemes which is flat and locally of finite presentation. If $(K, \xi)$ and $(L, \eta)$ are two relative dualizing complexes on $X/S$, then there is a unique isomorphism $K \to L$ sending $\xi$ to $\eta$. \end{lemma} 
\begin{lemma} \label{lemma-existence-relative-dualizing} Let $X \to S$ be a morphism of schemes which is flat and locally of finite presentation. There exists a relative dualizing complex $(K, \xi)$. \end{lemma} 
\begin{lemma} \label{lemma-base-change-relative-dualizing} Consider a cartesian square $$ \xymatrix{ X' \ar[d]_{f'} \ar[r]_{g'} & X \ar[d]^f \\ S' \ar[r]^g & S } $$ of schemes. Assume $X \to S$ is flat and locally of finite presentation. Let $(K, \xi)$ be a relative dualizing complex for $f$. Set $K' = L(g')^*K$. Let $\xi'$ be the derived base change of $\xi$ (see proof). Then $(K', \xi')$ is a relative dualizing complex for $f'$. \end{lemma} 
\begin{lemma} \label{lemma-flat-proper-relative-dualizing} Let $S$ be a quasi-compact and quasi-separated scheme. Let $f : X \to S$ be a proper, flat morphism of finite presentation. The relative dualizing complex $\omega_{X/S}^\bullet$ of Remark \ref{remark-relative-dualizing-complex} together with (\ref{equation-pre-rigid}) is a relative dualizing complex in the sense of Definition \ref{definition-relative-dualizing-complex}. \end{lemma} 
\begin{lemma} \label{lemma-compactifyable-relative-dualizing} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. If $f$ is flat, then $f^!\mathcal{O}_Y$ is (the first component of) a relative dualizing complex for $X$ over $Y$ in the sense of Definition \ref{definition-relative-dualizing-complex}. \end{lemma} 
\begin{lemma} \label{lemma-relative-dualizing-composition} Let $f : Y \to X$ and $X \to S$ be morphisms of schemes which are flat and of finite presentation. Let $(K, \xi)$ and $(M, \eta)$ be a relative dualizing complex for $X \to S$ and $Y \to X$. Set $E = M \otimes_{\mathcal{O}_Y}^\mathbf{L} Lf^*K$. Then $(E, \zeta)$ is a relative dualizing complex for $Y \to S$ for a suitable $\zeta$. \end{lemma} 
\begin{lemma} \label{lemma-determinant} Let $X$ be a locally ringed space. Let $$ \mathcal{E}_1 \xrightarrow{\alpha} \mathcal{E}_0 \to \mathcal{F} \to 0 $$ be a short exact sequence of $\mathcal{O}_X$-modules. Assume $\mathcal{E}_1$ and $\mathcal{E}_0$ are locally free of ranks $r_1, r_0$. Then there is a canonical map $$ \wedge^{r_0 - r_1}\mathcal{F} \longrightarrow \wedge^{r_1}(\mathcal{E}_1^\vee) \otimes \wedge^{r_0}\mathcal{E}_0 $$ which is an isomorphism on the stalk at $x \in X$ if and only if $\mathcal{F}$ is locally free of rank $r_0 - r_1$ in an open neighbourhood of $x$. \end{lemma} 
\begin{lemma} \label{lemma-fundamental-class-lci} Let $Y$ be a Noetherian scheme. Let $f : X \to Y$ be a local complete intersection morphism which factors as an immersion $X \to P$ followed by a proper smooth morphism $P \to Y$. Let $r$ be the locally constant function on $X$ such that $\omega_{X/Y} = H^{-r}(f^!\mathcal{O}_Y)$ is the unique nonzero cohomology sheaf of $f^!\mathcal{O}_Y$, see Lemma \ref{lemma-lci-shriek}. Then there is a map $$ \wedge^r\Omega_{X/Y} \longrightarrow \omega_{X/Y} $$ which is an isomorphism on the stalk at a point $x$ if and only if $f$ is smooth at $x$. \end{lemma} 
\begin{lemma} \label{lemma-fundamental-class-almost-lci} Let $f : X \to Y$ be a morphism of schemes. Let $r \geq 0$. Assume \begin{enumerate} \item $Y$ is Cohen-Macaulay (Properties, Definition \ref{properties-definition-Cohen-Macaulay}), \item $f$ factors as $X \to P \to Y$ where the first morphism is an immersion and the second is smooth and proper, \item if $x \in X$ and $\dim(\mathcal{O}_{X, x}) \leq 1$, then $f$ is Koszul at $x$ (More on Morphisms, Definition \ref{more-morphisms-definition-lci}), and \item if $\xi$ is a generic point of an irreducible component of $X$, then we have $\text{trdeg}_{\kappa(f(\xi))} \kappa(\xi) = r$. \end{enumerate} Then with $\omega_{X/Y} = H^{-r}(f^!\mathcal{O}_Y)$ there is a map $$ \wedge^r\Omega_{X/Y} \longrightarrow \omega_{X/Y} $$ which is an isomorphism on the locus where $f$ is smooth. \end{lemma} 
\begin{lemma} \label{lemma-lift-map} Let $j : U \to X$ be an open immersion of Noetherian schemes. Let $(K_n)$ be a Deligne system and denote $K \in D^b_{\textit{Coh}}(\mathcal{O}_U)$ the value of the constant system $(K_n|_U)$. Let $L$ be an object of $D^b_{\textit{Coh}}(\mathcal{O}_X)$. Then $\colim \Hom_X(K_n, L) = \Hom_U(K, L|_U)$. \end{lemma} 
\begin{lemma} \label{lemma-lift-map-plus} The result of Lemma \ref{lemma-lift-map} holds even for $L \in D^+_{\textit{Coh}}(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-extension-by-zero} Let $j : U \to X$ be an open immersion of Noetherian schemes. \begin{enumerate} \item Let $(K_n)$ and $(L_n)$ be Deligne systems. Let $K$ and $L$ be the values of the constant systems $(K_n|_U)$ and $(L_n|_U)$. Given a morphism $\alpha : K \to L$ of $D(\mathcal{O}_U)$ there is a unique morphism of pro-systems $(K_n) \to (L_n)$ of $D^b_{\textit{Coh}}(\mathcal{O}_X)$ whose restriction to $U$ is $\alpha$. \item Given $K \in D^b_{\textit{Coh}}(\mathcal{O}_U)$ there exists a Deligne system $(K_n)$ such that $(K_n|_U)$ is constant with value $K$. \item The pro-object $(K_n)$ of $D^b_{\textit{Coh}}(\mathcal{O}_X)$ of (2) is unique up to unique isomorphism (as a pro-object). \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-extension-by-zero-triangle} Let $j : U \to X$ be an open immersion of Noetherian schemes. Let $$ K \to L \to M \to K[1] $$ be a distinguished triangle of $D^b_{\textit{Coh}}(\mathcal{O}_U)$. Then there exists an inverse system of distinguished triangles $$ K_n \to L_n \to M_n \to K_n[1] $$ in $D^b_{\textit{Coh}}(\mathcal{O}_X)$ such that $(K_n)$, $(L_n)$, $(M_n)$ are Deligne systems and such that the restriction of these distinguished triangles to $U$ is isomorphic to the distinguished triangle we started out with. \end{lemma} 
\begin{lemma} \label{lemma-deligne-system-2-out-of-3} Let $j : U \to X$ be an open immersion of Noetherian schemes. Let $$ K_n \to L_n \to M_n \to K_n[1] $$ be an inverse system of distinguished triangles in $D^b_{\textit{Coh}}(\mathcal{O}_X)$. If $(K_n)$ and $(M_n)$ are pro-isomorphic to Deligne systems, then so is $(L_n)$. \end{lemma} 
\begin{lemma} \label{lemma-consequence-Artin-Rees-bis} Let $X$ be a Noetherian scheme. Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of ideals. Let $\mathcal{F}^\bullet$ be a complex of coherent $\mathcal{O}_X$-modules. Let $p \in \mathbf{Z}$. Set $\mathcal{H} = H^p(\mathcal{F}^\bullet)$ and $\mathcal{H}_n = H^p(\mathcal{I}^n\mathcal{F}^\bullet)$. Then there are canonical $\mathcal{O}_X$-module maps $$ \ldots \to \mathcal{H}_3 \to \mathcal{H}_2 \to \mathcal{H}_1 \to \mathcal{H} $$ There exists a $c > 0$ such that for $n \geq c$ the image of $\mathcal{H}_n \to \mathcal{H}$ is contained in $\mathcal{I}^{n - c}\mathcal{H}$ and there is a canonical $\mathcal{O}_X$-module map $\mathcal{I}^n\mathcal{H} \to \mathcal{H}_{n - c}$ such that the compositions $$ \mathcal{I}^n \mathcal{H} \to \mathcal{H}_{n - c} \to \mathcal{I}^{n - 2c}\mathcal{H} \quad\text{and}\quad \mathcal{H}_n \to \mathcal{I}^{n - c}\mathcal{H} \to \mathcal{H}_{n - 2c} $$ are the canonical ones. In particular, the inverse systems $(\mathcal{H}_n)$ and $(\mathcal{I}^n\mathcal{H})$ are isomorphic as pro-objects of $\textit{Mod}(\mathcal{O}_X)$. \end{lemma} 
\begin{lemma} \label{lemma-characterize-extension-by-zero-algebra} Let $j : U \to X$ be an open immersion of Noetherian schemes. Let $a \leq b$ be integers. Let $(K_n)$ be an inverse system of $D^b_{\textit{Coh}}(\mathcal{O}_X)$ such that $H^i(K_n) = 0$ for $i \not \in [a, b]$. The following are equivalent \begin{enumerate} \item $(K_n)$ is pro-isomorphic to a Deligne system, \item for every $p \in \mathbf{Z}$ there exists a coherent $\mathcal{O}_X$-module $\mathcal{F}$ such that the pro-systems $(H^p(K_n))$ and $(\mathcal{I}^n\mathcal{F})$ are pro-isomorphic. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-characterize-extension-by-zero} Let $j : U \to X$ be an open immersion of Noetherian schemes. Let $(K_n)$ be an inverse system in $D^b_{\textit{Coh}}(\mathcal{O}_X)$. Let $X = W_1 \cup \ldots \cup W_r$ be an open covering. The following are equivalent \begin{enumerate} \item $(K_n)$ is pro-isomorphic to a Deligne system, \item for each $i$ the restriction $(K_n|_{W_i})$ is pro-isomorphic to a Deligne system with respect to the open immersion $U \cap W_i \to W_i$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-tensoring-Deligne-system} Let $j : U \to X$ be an open immersion of Noetherian schemes. Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of ideals with $V(\mathcal{I}) = X \setminus U$. Let $K$ be in $D^b_{\textit{Coh}}(\mathcal{O}_X)$. Then $$ K \otimes_{\mathcal{O}_X}^\mathbf{L} \mathcal{I}^n $$ is pro-isomorphic to a Deligne system with constant value $K|_U$ over $U$. \end{lemma} 
\begin{lemma} \label{lemma-well-defined-pre} Let $f : X \to Y$ be a proper morphism of Noetherian schemes. Let $V \subset Y$ be an open subscheme and set $U = f^{-1}(V)$. Picture $$ \xymatrix{ U \ar[r]_j \ar[d]_g & X \ar[d]^f \\ V \ar[r]^{j'} & Y } $$ Then we have a canonical isomorphism $Rj'_! \circ Rg_* \to Rf_* \circ Rj_!$ of functors $D^b_{\textit{Coh}}(\mathcal{O}_U) \to \text{Pro-}D^b_{\textit{Coh}}(\mathcal{O}_Y)$ where $Rj_!$ and $Rj'_!$ are as in Remark \ref{remark-extension-by-zero}. \end{lemma} 
\begin{lemma} \label{lemma-well-defined} Let $j : U \to X$ be an open immersion of Noetherian schemes. Let $j' : U \to X'$ be a compactification of $U$ over $X$ (see proof) and denote $f : X' \to X$ the structure morphism. Then we have a canonical isomorphism $Rj_! \to Rf_* \circ R(j')_!$ of functors $D^b_{\textit{Coh}}(\mathcal{O}_U) \to \text{Pro-}D^b_{\textit{Coh}}(\mathcal{O}_X)$ where $Rj_!$ and $Rj'_!$ are as in Remark \ref{remark-extension-by-zero}. \end{lemma} 
\begin{lemma} \label{lemma-lower-shriek-well-defined} The functor $Rf_!$ is, up to isomorphism, independent of the choice of the compactification. \end{lemma} 
\begin{proposition} \label{proposition-duality-compactly-supported} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. Then the functors $Rf_!$ and $f^!$ are adjoint in the following sense: for all $K \in D^b_{\textit{Coh}}(\mathcal{O}_X)$ and $L \in D^+_{\textit{Coh}}(\mathcal{O}_Y)$ we have $$ \Hom_X(K, f^!L) = \Hom_{\text{Pro-}D^+_{\textit{Coh}}(\mathcal{O}_Y)}(Rf_!K, L) $$ bifunctorially in $K$ and $L$. \end{proposition} 
\begin{lemma} \label{lemma-compactly-supported-triangle} In Situation \ref{situation-shriek} let $f : X \to Y$ be a morphism of $\textit{FTS}_S$. Let $$ K \to L \to M \to K[1] $$ be a distinguished triangle of $D^b_{\textit{Coh}}(\mathcal{O}_X)$. Then there exists an inverse system of distinguished triangles $$ K_n \to L_n \to M_n \to K_n[1] $$ in $D^b_{\textit{Coh}}(\mathcal{O}_Y)$ such that the pro-systems $(K_n)$, $(L_n)$, and $(M_n)$ give $Rf_!K$, $Rf_!L$, and $Rf_!M$. \end{lemma} 
\begin{lemma} \label{lemma-composition-lower-shriek} In Situation \ref{situation-shriek} let $f : X \to Y$ and $g : Y \to Z$ be composable morphisms of $\textit{FTS}_S$. With notation as in Remark \ref{remark-composition-lower-shriek} we have $Rg_! \circ Rf_! = R(g \circ f)_!$. \end{lemma} 
\begin{lemma} \label{lemma-duality-compact-support} Let $p : U \to \Spec(k)$ be separated of finite type where $k$ is a field. Let $\omega_{U/k}^\bullet = p^!\mathcal{O}_{\Spec(k)}$. There are canonical isomorphisms $$ \Hom_k(H^i(U, K), k) = H^{-i}_c(U, R\SheafHom_{\mathcal{O}_U}(K, \omega_{U/k}^\bullet)) $$ of topological $k$-vector spaces functorial for $K$ in $D^b_{\textit{Coh}}(\mathcal{O}_U)$. \end{lemma} 
\begin{lemma} \label{lemma-duality-compact-support-restrict-open} With notation as in Lemma \ref{lemma-duality-compact-support} suppose $U' \subset U$ is an open subscheme. Then the diagram $$ \xymatrix{ \Hom_k(H^i(U, K), k) \ar[rr] & & H^{-i}_c(U, R\SheafHom_{\mathcal{O}_U}(K, \omega_{U/k}^\bullet)) \\ \Hom_k(H^i(U', K|_{U'}), k) \ar[rr] \ar[u] & & H^{-i}_c(U', R\SheafHom_{\mathcal{O}_{U'}}(K, \omega_{U'/k}^\bullet)) \ar[u] } $$ is commutative. Here the horizontal arrows are the isomorphisms of Lemma \ref{lemma-duality-compact-support}, the vertical arrow on the left is the contragredient to the restriction map $H^i(U, K) \to H^i(U', K|_{U'})$, and the right vertical arrow is Remark \ref{remark-covariance-open-lower-shriek} (see discussion before the lemma). \end{lemma} 
\begin{lemma} \label{lemma-h0-compactly-supported} Let $X$ be a proper scheme over a field $k$. Let $K \in D^b_{\textit{Coh}}(\mathcal{O}_X)$ with $H^i(K) = 0$ for $i < 0$. Set $\mathcal{F} = H^0(K)$. Let $Z \subset X$ be closed with complement $U = X \setminus U$. Then $$ H^0_c(U, K|_U) \subset H^0(X, \mathcal{F}) $$ is given by those global sections of $\mathcal{F}$ which vanish in an open neighbourhood of $Z$. \end{lemma} 
\begin{lemma} \label{lemma-lichtenbaum} Let $U$ be a variety. Let $\mathcal{F}$ be a coherent $\mathcal{O}_U$-module. If $H^d(U, \mathcal{F})$ is nonzero, then $\dim(U) \geq d$ and if equality holds, then $U$ is proper. \end{lemma} 
\begin{theorem} \label{theorem-lichtenbaum} Let $X$ be a nonempty separated scheme of finite type over a field $k$. Let $d = \dim(X)$. The following are equivalent \begin{enumerate} \item $H^d(X, \mathcal{F}) = 0$ for all coherent $\mathcal{O}_X$-modules $\mathcal{F}$ on $X$, \item $H^d(X, \mathcal{F}) = 0$ for all quasi-coherent $\mathcal{O}_X$-modules $\mathcal{F}$ on $X$, and \item no irreducible component $X' \subset X$ of dimension $d$ is proper over $k$. \end{enumerate} \end{theorem} 
