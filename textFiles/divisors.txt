\begin{definition} \label{definition-associated} Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$. \begin{enumerate} \item We say $x \in X$ is {\it associated} to $\mathcal{F}$ if the maximal ideal $\mathfrak m_x$ is associated to the $\mathcal{O}_{X, x}$-module $\mathcal{F}_x$. \item We denote $\text{Ass}(\mathcal{F})$ or $\text{Ass}_X(\mathcal{F})$ the set of associated points of $\mathcal{F}$. \item The {\it associated points of $X$} are the associated points of $\mathcal{O}_X$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-associated-affine-open} Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$. Let $\Spec(A) = U \subset X$ be an affine open, and set $M = \Gamma(U, \mathcal{F})$. Let $x \in U$, and let $\mathfrak p \subset A$ be the corresponding prime. \begin{enumerate} \item If $\mathfrak p$ is associated to $M$, then $x$ is associated to $\mathcal{F}$. \item If $\mathfrak p$ is finitely generated, then the converse holds as well. \end{enumerate} In particular, if $X$ is locally Noetherian, then the equivalence $$ \mathfrak p \in \text{Ass}(M) \Leftrightarrow x \in \text{Ass}(\mathcal{F}) $$ holds for all pairs $(\mathfrak p, x)$ as above. \end{lemma} 
\begin{lemma} \label{lemma-ass-support} Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Then $\text{Ass}(\mathcal{F}) \subset \text{Supp}(\mathcal{F})$. \end{lemma} 
\begin{lemma} \label{lemma-ses-ass} Let $X$ be a scheme. Let $0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0$ be a short exact sequence of quasi-coherent sheaves on $X$. Then $\text{Ass}(\mathcal{F}_2) \subset \text{Ass}(\mathcal{F}_1) \cup \text{Ass}(\mathcal{F}_3)$ and $\text{Ass}(\mathcal{F}_1) \subset \text{Ass}(\mathcal{F}_2)$. \end{lemma} 
\begin{lemma} \label{lemma-finite-ass} Let $X$ be a locally Noetherian scheme. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. Then $\text{Ass}(\mathcal{F}) \cap U$ is finite for every quasi-compact open $U \subset X$. \end{lemma} 
\begin{lemma} \label{lemma-ass-zero} Let $X$ be a locally Noetherian scheme. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Then $$ \mathcal{F} = 0 \Leftrightarrow \text{Ass}(\mathcal{F}) = \emptyset. $$ \end{lemma} 
\begin{lemma} \label{lemma-restriction-injective-open-contains-ass} Let $X$ be a locally Noetherian scheme. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. If $U \subset X$ is open and $\text{Ass}(\mathcal{F}) \subset U$, then $\Gamma(X, \mathcal{F}) \to \Gamma(U, \mathcal{F})$ is injective. \end{lemma} 
\begin{lemma} \label{lemma-minimal-support-in-ass} Let $X$ be a locally Noetherian scheme. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Let $x \in \text{Supp}(\mathcal{F})$ be a point in the support of $\mathcal{F}$ which is not a specialization of another point of $\text{Supp}(\mathcal{F})$. Then $x \in \text{Ass}(\mathcal{F})$. In particular, any generic point of an irreducible component of $X$ is an associated point of $X$. \end{lemma} 
\begin{lemma} \label{lemma-check-injective-on-ass} Let $X$ be a locally Noetherian scheme. Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a map of quasi-coherent $\mathcal{O}_X$-modules. Assume that for every $x \in X$ at least one of the following happens \begin{enumerate} \item $\mathcal{F}_x \to \mathcal{G}_x$ is injective, or \item $x \not \in \text{Ass}(\mathcal{F})$. \end{enumerate} Then $\varphi$ is injective. \end{lemma} 
\begin{lemma} \label{lemma-check-isomorphism-via-depth-and-ass} Let $X$ be a locally Noetherian scheme. Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a map of quasi-coherent $\mathcal{O}_X$-modules. Assume $\mathcal{F}$ is coherent and that for every $x \in X$ one of the following happens \begin{enumerate} \item $\mathcal{F}_x \to \mathcal{G}_x$ is an isomorphism, or \item $\text{depth}(\mathcal{F}_x) \geq 2$ and $x \not \in \text{Ass}(\mathcal{G})$. \end{enumerate} Then $\varphi$ is an isomorphism. \end{lemma} 
\begin{lemma} \label{lemma-bourbaki} Let $f : X \to S$ be a morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$ which is flat over $S$. Let $\mathcal{G}$ be a quasi-coherent sheaf on $S$. Then we have $$ \text{Ass}_X(\mathcal{F} \otimes_{\mathcal{O}_X} f^*\mathcal{G}) \supset \bigcup\nolimits_{s \in \text{Ass}_S(\mathcal{G})} \text{Ass}_{X_s}(\mathcal{F}_s) $$ and equality holds if $S$ is locally Noetherian (for the notation $\mathcal{F}_s$ see above). \end{lemma} 
\begin{definition} \label{definition-embedded} Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$. \begin{enumerate} \item An {\it embedded associated point} of $\mathcal{F}$ is an associated point which is not maximal among the associated points of $\mathcal{F}$, i.e., it is the specialization of another associated point of $\mathcal{F}$. \item A point $x$ of $X$ is called an {\it embedded point} if $x$ is an embedded associated point of $\mathcal{O}_X$. \item An {\it embedded component} of $X$ is an irreducible closed subset $Z = \overline{\{x\}}$ where $x$ is an embedded point of $X$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-embedded} Let $X$ be a locally Noetherian scheme. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. Then \begin{enumerate} \item the generic points of irreducible components of $\text{Supp}(\mathcal{F})$ are associated points of $\mathcal{F}$, and \item an associated point of $\mathcal{F}$ is embedded if and only if it is not a generic point of an irreducible component of $\text{Supp}(\mathcal{F})$. \end{enumerate} In particular an embedded point of $X$ is an associated point of $X$ which is not a generic point of an irreducible component of $X$. \end{lemma} 
\begin{lemma} \label{lemma-S1-no-embedded} Let $X$ be a locally Noetherian scheme. Let $\mathcal{F}$ be a coherent sheaf on $X$. Then the following are equivalent: \begin{enumerate} \item $\mathcal{F}$ has no embedded associated points, and \item $\mathcal{F}$ has property $(S_1)$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-noetherian-dim-1-CM-no-embedded-points} Let $X$ be a locally Noetherian scheme of dimension $\leq 1$. The following are equivalent \begin{enumerate} \item $X$ is Cohen-Macaulay, and \item $X$ has no embedded points. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-scheme-theoretically-dense-contain-embedded-points} Let $X$ be a locally Noetherian scheme. Let $U \subset X$ be an open subscheme. The following are equivalent \begin{enumerate} \item $U$ is scheme theoretically dense in $X$ (Morphisms, Definition \ref{morphisms-definition-scheme-theoretically-dense}), \item $U$ is dense in $X$ and $U$ contains all embedded points of $X$, and \item $U$ contains all associated points of $X$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-remove-embedded-points} Let $X$ be a locally Noetherian scheme. Let $\mathcal{F}$ be a coherent sheaf on $X$. The set of coherent subsheaves $$ \{ \mathcal{K} \subset \mathcal{F} \mid \text{Supp}(\mathcal{K})\text{ is nowhere dense in }\text{Supp}(\mathcal{F}) \} $$ has a maximal element $\mathcal{K}$. Setting $\mathcal{F}' = \mathcal{F}/\mathcal{K}$ we have the following \begin{enumerate} \item $\text{Supp}(\mathcal{F}') = \text{Supp}(\mathcal{F})$, \item $\mathcal{F}'$ has no embedded associated points, and \item there exists a dense open $U \subset X$ such that $U \cap \text{Supp}(\mathcal{F})$ is dense in $\text{Supp}(\mathcal{F})$ and $\mathcal{F}'|_U \cong \mathcal{F}|_U$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-no-embedded-points-endos} Let $X$ be a locally Noetherian scheme. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module without embedded associated points. Set $$ \mathcal{I} = \Ker(\mathcal{O}_X \longrightarrow \SheafHom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{F})). $$ This is a coherent sheaf of ideals which defines a closed subscheme $Z \subset X$ without embedded points. Moreover there exists a coherent sheaf $\mathcal{G}$ on $Z$ such that (a) $\mathcal{F} = (Z \to X)_*\mathcal{G}$, (b) $\mathcal{G}$ has no associated embedded points, and (c) $\text{Supp}(\mathcal{G}) = Z$ (as sets). \end{lemma} 
\begin{definition} \label{definition-weakly-associated} Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$. \begin{enumerate} \item We say $x \in X$ is {\it weakly associated} to $\mathcal{F}$ if the maximal ideal $\mathfrak m_x$ is weakly associated to the $\mathcal{O}_{X, x}$-module $\mathcal{F}_x$. \item We denote $\text{WeakAss}(\mathcal{F})$ the set of weakly associated points of $\mathcal{F}$. \item The {\it weakly associated points of $X$} are the weakly associated points of $\mathcal{O}_X$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-weakly-associated-affine-open} Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$. Let $\Spec(A) = U \subset X$ be an affine open, and set $M = \Gamma(U, \mathcal{F})$. Let $x \in U$, and let $\mathfrak p \subset A$ be the corresponding prime. The following are equivalent \begin{enumerate} \item $\mathfrak p$ is weakly associated to $M$, and \item $x$ is weakly associated to $\mathcal{F}$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-weakly-ass-support} Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Then $$ \text{Ass}(\mathcal{F}) \subset \text{WeakAss}(\mathcal{F}) \subset \text{Supp}(\mathcal{F}). $$ \end{lemma} 
\begin{lemma} \label{lemma-ses-weakly-ass} Let $X$ be a scheme. Let $0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0$ be a short exact sequence of quasi-coherent sheaves on $X$. Then $\text{WeakAss}(\mathcal{F}_2) \subset \text{WeakAss}(\mathcal{F}_1) \cup \text{WeakAss}(\mathcal{F}_3)$ and $\text{WeakAss}(\mathcal{F}_1) \subset \text{WeakAss}(\mathcal{F}_2)$. \end{lemma} 
\begin{lemma} \label{lemma-weakly-ass-zero} Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Then $$ \mathcal{F} = (0) \Leftrightarrow \text{WeakAss}(\mathcal{F}) = \emptyset $$ \end{lemma} 
\begin{lemma} \label{lemma-restriction-injective-open-contains-weakly-ass} Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. If $U \subset X$ is open and $\text{WeakAss}(\mathcal{F}) \subset U$, then $\Gamma(X, \mathcal{F}) \to \Gamma(U, \mathcal{F})$ is injective. \end{lemma} 
\begin{lemma} \label{lemma-minimal-support-in-weakly-ass} Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Let $x \in \text{Supp}(\mathcal{F})$ be a point in the support of $\mathcal{F}$ which is not a specialization of another point of $\text{Supp}(\mathcal{F})$. Then $x \in \text{WeakAss}(\mathcal{F})$. In particular, any generic point of an irreducible component of $X$ is weakly associated to $\mathcal{O}_X$. \end{lemma} 
\begin{lemma} \label{lemma-ass-weakly-ass} Let $X$ be a scheme. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. If $\mathfrak m_x$ is a finitely generated ideal of $\mathcal{O}_{X, x}$, then $$ x \in \text{Ass}(\mathcal{F}) \Leftrightarrow x \in \text{WeakAss}(\mathcal{F}). $$ In particular, if $X$ is locally Noetherian, then $\text{Ass}(\mathcal{F}) = \text{WeakAss}(\mathcal{F})$. \end{lemma} 
\begin{lemma} \label{lemma-weakass-pushforward} Let $f : X \to S$ be a quasi-compact and quasi-separated morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Let $s \in S$ be a point which is not in the image of $f$. Then $s$ is not weakly associated to $f_*\mathcal{F}$. \end{lemma} 
\begin{lemma} \label{lemma-check-injective-on-weakass} Let $X$ be a scheme. Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a map of quasi-coherent $\mathcal{O}_X$-modules. Assume that for every $x \in X$ at least one of the following happens \begin{enumerate} \item $\mathcal{F}_x \to \mathcal{G}_x$ is injective, or \item $x \not \in \text{WeakAss}(\mathcal{F})$. \end{enumerate} Then $\varphi$ is injective. \end{lemma} 
\begin{lemma} \label{lemma-depth-2-hartog} Let $X$ be a locally Noetherian scheme. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. Let $j : U \to X$ be an open subscheme such that for $x \in X \setminus U$ we have $\text{depth}(\mathcal{F}_x) \geq 2$. Then $$ \mathcal{F} \longrightarrow j_*(\mathcal{F}|_U) $$ is an isomorphism and consequently $\Gamma(X, \mathcal{F}) \to \Gamma(U, \mathcal{F})$ is an isomorphism too. \end{lemma} 
\begin{lemma} \label{lemma-weakass-reduced} Let $X$ be a reduced scheme. Then the weakly associated points of $X$ are exactly the generic points of the irreducible components of $X$. \end{lemma} 
\begin{lemma} \label{lemma-weakly-ass-reverse-functorial} Let $f : X \to S$ be an affine morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Then we have $$ \text{WeakAss}_S(f_*\mathcal{F}) \subset f(\text{WeakAss}_X(\mathcal{F})) $$ \end{lemma} 
\begin{lemma} \label{lemma-ass-functorial-equal} Let $f : X \to S$ be an affine morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. If $X$ is locally Noetherian, then we have $$ f(\text{Ass}_X(\mathcal{F})) = \text{Ass}_S(f_*\mathcal{F}) = \text{WeakAss}_S(f_*\mathcal{F}) = f(\text{WeakAss}_X(\mathcal{F})) $$ \end{lemma} 
\begin{lemma} \label{lemma-weakly-associated-finite} Let $f : X \to S$ be a finite morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Then $\text{WeakAss}(f_*\mathcal{F}) = f(\text{WeakAss}(\mathcal{F}))$. \end{lemma} 
\begin{lemma} \label{lemma-weakly-ass-pullback} Let $f : X \to S$ be a morphism of schemes. Let $\mathcal{G}$ be a quasi-coherent $\mathcal{O}_S$-module. Let $x \in X$ with $s = f(x)$. If $f$ is flat at $x$, the point $x$ is a generic point of the fibre $X_s$, and $s \in \text{WeakAss}_S(\mathcal{G})$, then $x \in \text{WeakAss}(f^*\mathcal{G})$. \end{lemma} 
\begin{lemma} \label{lemma-weakly-ass-change-fields} Let $K/k$ be a field extension. Let $X$ be a scheme over $k$. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Let $y \in X_K$ with image $x \in X$. If $y$ is a weakly associated point of the pullback $\mathcal{F}_K$, then $x$ is a weakly associated point of $\mathcal{F}$. \end{lemma} 
\begin{lemma} \label{lemma-depth-pushforward} Let $f : X \to S$ be a quasi-compact and quasi-separated morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Let $s \in S$. \begin{enumerate} \item If $s \not \in f(X)$, then $s$ is not weakly associated to $f_*\mathcal{F}$. \item If $s \not \in f(X)$ and $\mathcal{O}_{S, s}$ is Noetherian, then $s$ is not associated to $f_*\mathcal{F}$. \item If $s \not \in f(X)$, $(f_*\mathcal{F})_s$ is a finite $\mathcal{O}_{S, s}$-module, and $\mathcal{O}_{S, s}$ is Noetherian, then $\text{depth}((f_*\mathcal{F})_s) \geq 2$. \item If $\mathcal{F}$ is flat over $S$ and $a \in \mathfrak m_s$ is a nonzerodivisor, then $a$ is a nonzerodivisor on $(f_*\mathcal{F})_s$. \item If $\mathcal{F}$ is flat over $S$ and $a, b \in \mathfrak m_s$ is a regular sequence, then $a$ is a nonzerodivisor on $(f_*\mathcal{F})_s$ and $b$ is a nonzerodivisor on $(f_*\mathcal{F})_s/a(f_*\mathcal{F})_s$. \item If $\mathcal{F}$ is flat over $S$ and $(f_*\mathcal{F})_s$ is a finite $\mathcal{O}_{S, s}$-module, then $\text{depth}((f_*\mathcal{F})_s) \geq \min(2, \text{depth}(\mathcal{O}_{S, s}))$. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-relative-assassin} Let $f : X \to S$ be a morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. The {\it relative assassin of $\mathcal{F}$ in $X$ over $S$} is the set $$ \text{Ass}_{X/S}(\mathcal{F}) = \bigcup\nolimits_{s \in S} \text{Ass}_{X_s}(\mathcal{F}_s) $$ where $\mathcal{F}_s = (X_s \to X)^*\mathcal{F}$ is the restriction of $\mathcal{F}$ to the fibre of $f$ at $s$. \end{definition} 
\begin{lemma} \label{lemma-relative-assassin-affine-open} Let $f : X \to S$ be a morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$. Let $U \subset X$ and $V \subset S$ be affine opens with $f(U) \subset V$. Write $U = \Spec(A)$, $V = \Spec(R)$, and set $M = \Gamma(U, \mathcal{F})$. Let $x \in U$, and let $\mathfrak p \subset A$ be the corresponding prime. Then $$ \mathfrak p \in \text{Ass}_{A/R}(M) \Rightarrow x \in \text{Ass}_{X/S}(\mathcal{F}) $$ If all fibres $X_s$ of $f$ are locally Noetherian, then $\mathfrak p \in \text{Ass}_{A/R}(M) \Leftrightarrow x \in \text{Ass}_{X/S}(\mathcal{F})$ for all pairs $(\mathfrak p, x)$ as above. \end{lemma} 
\begin{lemma} \label{lemma-base-change-relative-assassin} Let $f : X \to S$ be a morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Let $g : S' \to S$ be a morphism of schemes. Consider the base change diagram $$ \xymatrix{ X' \ar[d] \ar[r]_{g'} & X \ar[d] \\ S' \ar[r]^g & S } $$ and set $\mathcal{F}' = (g')^*\mathcal{F}$. Let $x' \in X'$ be a point with images $x \in X$, $s' \in S'$ and $s \in S$. Assume $f$ locally of finite type. Then $x' \in \text{Ass}_{X'/S'}(\mathcal{F}')$ if and only if $x \in \text{Ass}_{X/S}(\mathcal{F})$ and $x'$ corresponds to a generic point of an irreducible component of $\Spec(\kappa(s') \otimes_{\kappa(s)} \kappa(x))$. \end{lemma} 
\begin{definition} \label{definition-relative-weak-assassin} Let $f : X \to S$ be a morphism of schemes. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. The {\it relative weak assassin of $\mathcal{F}$ in $X$ over $S$} is the set $$ \text{WeakAss}_{X/S}(\mathcal{F}) = \bigcup\nolimits_{s \in S} \text{WeakAss}(\mathcal{F}_s) $$ where $\mathcal{F}_s = (X_s \to X)^*\mathcal{F}$ is the restriction of $\mathcal{F}$ to the fibre of $f$ at $s$. \end{definition} 
\begin{lemma} \label{lemma-relative-weak-assassin-assassin-finite-type} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Then $\text{WeakAss}_{X/S}(\mathcal{F}) = \text{Ass}_{X/S}(\mathcal{F})$. \end{lemma} 
\begin{lemma} \label{lemma-relative-weak-assassin-finite} Let $f : X \to S$ be a morphism of schemes. Let $i : Z \to X$ be a finite morphism. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_Z$-module. Then $\text{WeakAss}_{X/S}(i_*\mathcal{F}) = i(\text{WeakAss}_{Z/S}(\mathcal{F}))$. \end{lemma} 
\begin{lemma} \label{lemma-base-change-fitting-ideal} Let $f : T \to S$ be a morphism of schemes. Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_S$-module. Then $f^{-1}\text{Fit}_i(\mathcal{F}) \cdot \mathcal{O}_T = \text{Fit}_i(f^*\mathcal{F})$. \end{lemma} 
\begin{lemma} \label{lemma-fitting-ideal-of-finitely-presented} Let $S$ be a scheme. Let $\mathcal{F}$ be a finitely presented $\mathcal{O}_S$-module. Then $\text{Fit}_r(\mathcal{F})$ is a quasi-coherent ideal of finite type. \end{lemma} 
\begin{lemma} \label{lemma-on-subscheme-cut-out-by-Fit-0} Let $S$ be a scheme. Let $\mathcal{F}$ be a finite type, quasi-coherent $\mathcal{O}_S$-module. Let $Z_0 \subset S$ be the closed subscheme cut out by $\text{Fit}_0(\mathcal{F})$. Let $Z \subset S$ be the scheme theoretic support of $\mathcal{F}$. Then \begin{enumerate} \item $Z \subset Z_0 \subset S$ as closed subschemes, \item $Z = Z_0 = \text{Supp}(\mathcal{F})$ as closed subsets, \item there exists a finite type, quasi-coherent $\mathcal{O}_{Z_0}$-module $\mathcal{G}_0$ with $$ (Z_0 \to X)_*\mathcal{G}_0 = \mathcal{F}. $$ \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-fitting-ideal-generate-locally} Let $S$ be a scheme. Let $\mathcal{F}$ be a finite type, quasi-coherent $\mathcal{O}_S$-module. Let $s \in S$. Then $\mathcal{F}$ can be generated by $r$ elements in a neighbourhood of $s$ if and only if $\text{Fit}_r(\mathcal{F})_s = \mathcal{O}_{S, s}$. \end{lemma} 
\begin{lemma} \label{lemma-fitting-ideal-finite-locally-free} Let $S$ be a scheme. Let $\mathcal{F}$ be a finite type, quasi-coherent $\mathcal{O}_S$-module. Let $r \geq 0$. The following are equivalent \begin{enumerate} \item $\mathcal{F}$ is finite locally free of rank $r$ \item $\text{Fit}_{r - 1}(\mathcal{F}) = 0$ and $\text{Fit}_r(\mathcal{F}) = \mathcal{O}_S$, and \item $\text{Fit}_k(\mathcal{F}) = 0$ for $k < r$ and $\text{Fit}_k(\mathcal{F}) = \mathcal{O}_S$ for $k \geq r$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-locally-free-rank-r-pullback} Let $S$ be a scheme. Let $\mathcal{F}$ be a finite type, quasi-coherent $\mathcal{O}_S$-module. The closed subschemes $$ S = Z_{-1} \supset Z_0 \supset Z_1 \supset Z_2 \ldots $$ defined by the Fitting ideals of $\mathcal{F}$ have the following properties \begin{enumerate} \item The intersection $\bigcap Z_r$ is empty. \item The functor $(\Sch/S)^{opp} \to \textit{Sets}$ defined by the rule $$ T \longmapsto \left\{ \begin{matrix} \{*\} & \text{if }\mathcal{F}_T\text{ is locally generated by } \leq r\text{ sections} \\ \emptyset & \text{otherwise} \end{matrix} \right. $$ is representable by the open subscheme $S \setminus Z_r$. \item The functor $F_r : (\Sch/S)^{opp} \to \textit{Sets}$ defined by the rule $$ T \longmapsto \left\{ \begin{matrix} \{*\} & \text{if }\mathcal{F}_T\text{ locally free rank }r\\ \emptyset & \text{otherwise} \end{matrix} \right. $$ is representable by the locally closed subscheme $Z_{r - 1} \setminus Z_r$ of $S$. \end{enumerate} If $\mathcal{F}$ is of finite presentation, then $Z_r \to S$, $S \setminus Z_r \to S$, and $Z_{r - 1} \setminus Z_r \to S$ are of finite presentation. \end{lemma} 
\begin{lemma} \label{lemma-finite-presentation-module} Let $S$ be a scheme. Let $\mathcal{F}$ be an $\mathcal{O}_S$-module of finite presentation. Let $S = Z_{-1} \supset Z_0 \supset Z_1 \supset \ldots$ be as in Lemma \ref{lemma-locally-free-rank-r-pullback}. Set $S_r = Z_{r - 1} \setminus Z_r$. Then $S' = \coprod_{r \geq 0} S_r$ represents the functor $$ F_{flat} : \Sch/S \longrightarrow \textit{Sets},\quad\quad T \longmapsto \left\{ \begin{matrix} \{*\} & \text{if }\mathcal{F}_T\text{ flat over }T\\ \emptyset & \text{otherwise} \end{matrix} \right. $$ Moreover, $\mathcal{F}|_{S_r}$ is locally free of rank $r$ and the morphisms $S_r \to S$ and $S' \to S$ are of finite presentation. \end{lemma} 
\begin{lemma} \label{lemma-base-change-and-fitting-ideal-omega} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. Let $X = Z_{-1} \supset Z_0 \supset Z_1 \supset \ldots$ be the closed subschemes defined by the fitting ideals of $\Omega_{X/S}$. Then the formation of $Z_i$ commutes with arbitrary base change. \end{lemma} 
\begin{lemma} \label{lemma-zero-fitting-ideal-omega-unramified} Let $f : X \to S$ be a morphism of schemes which is locally of finite type. The closed subscheme $Z \subset X$ cut out by the $0$th fitting ideal of $\Omega_{X/S}$ is exactly the set of points where $f$ is not unramified. \end{lemma} 
\begin{lemma} \label{lemma-d-fitting-ideal-omega-smooth} Let $f : X \to S$ be a morphism of schemes. Let $d \geq 0$ be an integer. Assume \begin{enumerate} \item $f$ is flat, \item $f$ is locally of finite presentation, and \item every nonempty fibre of $f$ is equidimensional of dimension $d$. \end{enumerate} Let $Z \subset X$ be the closed subscheme cut out by the $d$th fitting ideal of $\Omega_{X/S}$. Then $Z$ is exactly the set of points where $f$ is not smooth. \end{lemma} 
\begin{lemma} \label{lemma-torsion-sections} Let $X$ be an integral scheme with generic point $\eta$. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Let $U \subset X$ be nonempty open and $s \in \mathcal{F}(U)$. The following are equivalent \begin{enumerate} \item for some $x \in U$ the image of $s$ in $\mathcal{F}_x$ is torsion, \item for all $x \in U$ the image of $s$ in $\mathcal{F}_x$ is torsion, \item the image of $s$ in $\mathcal{F}_\eta$ is zero, \item the image of $s$ in $j_*\mathcal{F}_\eta$ is zero, where $j : \eta \to X$ is the inclusion morphism. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-torsion} Let $X$ be an integral scheme. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. \begin{enumerate} \item We say a local section of $\mathcal{F}$ is {\it torsion} if it satisfies the equivalent conditions of Lemma \ref{lemma-torsion-sections}. \item We say $\mathcal{F}$ is {\it torsion free} if every torsion section of $\mathcal{F}$ is $0$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-check-torsion-on-affines} Let $X$ be an integral scheme. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. The following are equivalent \begin{enumerate} \item $\mathcal{F}$ is torsion free, \item for $U \subset X$ affine open $\mathcal{F}(U)$ is a torsion free $\mathcal{O}(U)$-module. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-torsion} Let $X$ be an integral scheme. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. The torsion sections of $\mathcal{F}$ form a quasi-coherent $\mathcal{O}_X$-submodule $\mathcal{F}_{tors} \subset \mathcal{F}$. The quotient module $\mathcal{F}/\mathcal{F}_{tors}$ is torsion free. \end{lemma} 
\begin{lemma} \label{lemma-flat-torsion-free} Let $X$ be an integral scheme. Any flat quasi-coherent $\mathcal{O}_X$-module is torsion free. \end{lemma} 
\begin{lemma} \label{lemma-flat-pullback-torsion} Let $f : X \to Y$ be a flat morphism of integral schemes. Let $\mathcal{G}$ be a torsion free quasi-coherent $\mathcal{O}_Y$-module. Then $f^*\mathcal{G}$ is a torsion free $\mathcal{O}_X$-module. \end{lemma} 
\begin{lemma} \label{lemma-flat-over-integral-integral-fibre} Let $f : X \to Y$ be a flat morphism of schemes. If $Y$ is integral and the generic fibre of $f$ is integral, then $X$ is integral. \end{lemma} 
\begin{lemma} \label{lemma-check-torsion} Let $X$ be an integral scheme. Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. Then $\mathcal{F}$ is torsion free if and only if $\mathcal{F}_x$ is a torsion free $\mathcal{O}_{X, x}$-module for all $x \in X$. \end{lemma} 
\begin{lemma} \label{lemma-extension-torsion-free} Let $X$ be an integral scheme. Let $0 \to \mathcal{F} \to \mathcal{F}' \to \mathcal{F}'' \to 0$ be a short exact sequence of quasi-coherent $\mathcal{O}_X$-modules. If $\mathcal{F}$ and $\mathcal{F}''$ are torsion free, then $\mathcal{F}'$ is torsion free. \end{lemma} 
\begin{lemma} \label{lemma-torsion-free-finite-noetherian-domain} Let $X$ be a locally Noetherian integral scheme with generic point $\eta$. Let $\mathcal{F}$ be a nonzero coherent $\mathcal{O}_X$-module. The following are equivalent \begin{enumerate} \item $\mathcal{F}$ is torsion free, \item $\eta$ is the only associated prime of $\mathcal{F}$, \item $\eta$ is in the support of $\mathcal{F}$ and $\mathcal{F}$ has property $(S_1)$, and \item $\eta$ is in the support of $\mathcal{F}$ and $\mathcal{F}$ has no embedded associated prime. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-torsion-free-over-regular-dim-1} Let $X$ be an integral regular scheme of dimension $\leq 1$. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. The following are equivalent \begin{enumerate} \item $\mathcal{F}$ is torsion free, \item $\mathcal{F}$ is finite locally free. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-hom-into-torsion-free} Let $X$ be an integral scheme. Let $\mathcal{F}$, $\mathcal{G}$ be quasi-coherent $\mathcal{O}_X$-modules. If $\mathcal{G}$ is torsion free and $\mathcal{F}$ is of finite presentation, then $\SheafHom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{G})$ is torsion free. \end{lemma} 
\begin{lemma} \label{lemma-isom-depth-2-torsion-free} Let $X$ be an integral locally Noetherian scheme. Let $\varphi : \mathcal{F} \to \mathcal{G}$ be a map of quasi-coherent $\mathcal{O}_X$-modules. Assume $\mathcal{F}$ is coherent, $\mathcal{G}$ is torsion free, and that for every $x \in X$ one of the following happens \begin{enumerate} \item $\mathcal{F}_x \to \mathcal{G}_x$ is an isomorphism, or \item $\text{depth}(\mathcal{F}_x) \geq 2$. \end{enumerate} Then $\varphi$ is an isomorphism. \end{lemma} 
\begin{definition} \label{definition-reflexive} Let $X$ be an integral locally Noetherian scheme. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. The {\it reflexive hull} of $\mathcal{F}$ is the $\mathcal{O}_X$-module $$ \mathcal{F}^{**} = \SheafHom_{\mathcal{O}_X}( \SheafHom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{O}_X), \mathcal{O}_X) $$ We say $\mathcal{F}$ is {\it reflexive} if the natural map $j : \mathcal{F} \longrightarrow \mathcal{F}^{**}$ is an isomorphism. \end{definition} 
\begin{lemma} \label{lemma-check-reflexive-on-affines} Let $X$ be an integral locally Noetherian scheme. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. The following are equivalent \begin{enumerate} \item $\mathcal{F}$ is reflexive, \item for $U \subset X$ affine open $\mathcal{F}(U)$ is a reflexive $\mathcal{O}(U)$-module. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-reflexive-torsion-free} Let $X$ be an integral locally Noetherian scheme. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. \begin{enumerate} \item If $\mathcal{F}$ is reflexive, then $\mathcal{F}$ is torsion free. \item The map $j : \mathcal{F} \longrightarrow \mathcal{F}^{**}$ is injective if and only if $\mathcal{F}$ is torsion free. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-check-reflexive} Let $X$ be an integral locally Noetherian scheme. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. The following are equivalent \begin{enumerate} \item $\mathcal{F}$ is reflexive, \item $\mathcal{F}_x$ is a reflexive $\mathcal{O}_{X, x}$-module for all $x \in X$, \item $\mathcal{F}_x$ is a reflexive $\mathcal{O}_{X, x}$-module for all closed points $x \in X$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-flat-pullback-reflexive} Let $f : X \to Y$ be a flat morphism of integral locally Noetherian schemes. Let $\mathcal{G}$ be a coherent reflexive $\mathcal{O}_Y$-module. Then $f^*\mathcal{G}$ is a coherent reflexive $\mathcal{O}_X$-module. \end{lemma} 
\begin{lemma} \label{lemma-sequence-reflexive} Let $X$ be an integral locally Noetherian scheme. Let $0 \to \mathcal{F} \to \mathcal{F}' \to \mathcal{F}''$ be an exact sequence of coherent $\mathcal{O}_X$-modules. If $\mathcal{F}'$ is reflexive and $\mathcal{F}''$ is torsion free, then $\mathcal{F}$ is reflexive. \end{lemma} 
\begin{lemma} \label{lemma-dual-reflexive} Let $X$ be an integral locally Noetherian scheme. Let $\mathcal{F}$, $\mathcal{G}$ be coherent $\mathcal{O}_X$-modules. If $\mathcal{G}$ is reflexive, then $\SheafHom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{G})$ is reflexive. \end{lemma} 
\begin{lemma} \label{lemma-reflexive-depth-2} Let $X$ be an integral locally Noetherian scheme. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. The following are equivalent \begin{enumerate} \item $\mathcal{F}$ is reflexive, \item for each $x \in X$ one of the following happens \begin{enumerate} \item $\mathcal{F}_x$ is a reflexive $\mathcal{O}_{X, x}$-module, or \item $\text{depth}(\mathcal{F}_x) \geq 2$. \end{enumerate} \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-reflexive-S2} Let $X$ be an integral locally Noetherian scheme. Let $\mathcal{F}$ be a coherent reflexive $\mathcal{O}_X$-module. Let $x \in X$. \begin{enumerate} \item If $\text{depth}(\mathcal{O}_{X, x}) \geq 2$, then $\text{depth}(\mathcal{F}_x) \geq 2$. \item If $X$ is $(S_2)$, then $\mathcal{F}$ is $(S_2)$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-reflexive-S2-extend} Let $X$ be an integral locally Noetherian scheme. Let $j : U \to X$ be an open subscheme with complement $Z$. Assume $\mathcal{O}_{X, z}$ has depth $\geq 2$ for all $z \in Z$. Then $j^*$ and $j_*$ define an equivalence of categories between the category of coherent reflexive $\mathcal{O}_X$-modules and the category of coherent reflexive $\mathcal{O}_U$-modules. \end{lemma} 
\begin{lemma} \label{lemma-reflexive-over-normal} Let $X$ be an integral locally Noetherian normal scheme. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. The following are equivalent \begin{enumerate} \item $\mathcal{F}$ is reflexive, \item $\mathcal{F}$ is torsion free and has property $(S_2)$, and \item there exists an open subscheme $j : U \to X$ such that \begin{enumerate} \item every irreducible component of $X \setminus U$ has codimension $\geq 2$ in $X$, \item $j^*\mathcal{F}$ is finite locally free, and \item $\mathcal{F} = j_*j^*\mathcal{F}$. \end{enumerate} \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-describe-reflexive-hull} Let $X$ be an integral locally Noetherian normal scheme with generic point $\eta$. Let $\mathcal{F}$, $\mathcal{G}$ be coherent $\mathcal{O}_X$-modules. Let $T : \mathcal{G}_\eta \to \mathcal{F}_\eta$ be a linear map. Then $T$ extends to a map $\mathcal{G} \to \mathcal{F}^{**}$ of $\mathcal{O}_X$-modules if and only if \begin{itemize} \item[(*)] for every $x \in X$ with $\dim(\mathcal{O}_{X, x}) = 1$ we have $$ T\left(\Im(\mathcal{G}_x \to \mathcal{G}_\eta)\right) \subset \Im(\mathcal{F}_x \to \mathcal{F}_\eta). $$ \end{itemize} \end{lemma} 
\begin{lemma} \label{lemma-reflexive-over-regular-dim-2} Let $X$ be a regular scheme of dimension $\leq 2$. Let $\mathcal{F}$ be a coherent $\mathcal{O}_X$-module. The following are equivalent \begin{enumerate} \item $\mathcal{F}$ is reflexive, \item $\mathcal{F}$ is finite locally free. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-effective-Cartier-divisor} Let $S$ be a scheme. \begin{enumerate} \item A {\it locally principal closed subscheme} of $S$ is a closed subscheme whose sheaf of ideals is locally generated by a single element. \item An {\it effective Cartier divisor} on $S$ is a closed subscheme $D \subset S$ whose ideal sheaf $\mathcal{I}_D \subset \mathcal{O}_S$ is an invertible $\mathcal{O}_S$-module. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-characterize-effective-Cartier-divisor} Let $S$ be a scheme. Let $D \subset S$ be a closed subscheme. The following are equivalent: \begin{enumerate} \item The subscheme $D$ is an effective Cartier divisor on $S$. \item For every $x \in D$ there exists an affine open neighbourhood $\Spec(A) = U \subset S$ of $x$ such that $U \cap D = \Spec(A/(f))$ with $f \in A$ a nonzerodivisor. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-complement-locally-principal-closed-subscheme} Let $S$ be a scheme. Let $Z \subset S$ be a locally principal closed subscheme. Let $U = S \setminus Z$. Then $U \to S$ is an affine morphism. \end{lemma} 
\begin{lemma} \label{lemma-complement-effective-Cartier-divisor} Let $S$ be a scheme. Let $D \subset S$ be an effective Cartier divisor. Let $U = S \setminus D$. Then $U \to S$ is an affine morphism and $U$ is scheme theoretically dense in $S$. \end{lemma} 
\begin{lemma} \label{lemma-effective-Cartier-makes-dimension-drop} Let $S$ be a scheme. Let $D \subset S$ be an effective Cartier divisor. Let $s \in D$. If $\dim_s(S) < \infty$, then $\dim_s(D) < \dim_s(S)$. \end{lemma} 
\begin{definition} \label{definition-sum-effective-Cartier-divisors} Let $S$ be a scheme. Given effective Cartier divisors $D_1$, $D_2$ on $S$ we set $D = D_1 + D_2$ equal to the closed subscheme of $S$ corresponding to the quasi-coherent sheaf of ideals $\mathcal{I}_{D_1}\mathcal{I}_{D_2} \subset \mathcal{O}_S$. We call this the {\it sum of the effective Cartier divisors $D_1$ and $D_2$}. \end{definition} 
\begin{lemma} \label{lemma-sum-effective-Cartier-divisors} The sum of two effective Cartier divisors is an effective Cartier divisor. \end{lemma} 
\begin{lemma} \label{lemma-difference-effective-Cartier-divisors} Let $X$ be a scheme. Let $D, D'$ be two effective Cartier divisors on $X$. If $D \subset D'$ (as closed subschemes of $X$), then there exists an effective Cartier divisor $D''$ such that $D' = D + D''$. \end{lemma} 
\begin{lemma} \label{lemma-sum-closed-subschemes-effective-Cartier} Let $X$ be a scheme. Let $Z, Y$ be two closed subschemes of $X$ with ideal sheaves $\mathcal{I}$ and $\mathcal{J}$. If $\mathcal{I}\mathcal{J}$ defines an effective Cartier divisor $D \subset X$, then $Z$ and $Y$ are effective Cartier divisors and $D = Z + Y$. \end{lemma} 
\begin{lemma} \label{lemma-sum-effective-Cartier-divisors-union} Let $X$ be a scheme. Let $D, D' \subset X$ be effective Cartier divisors such that the scheme theoretic intersection $D \cap D'$ is an effective Cartier divisor on $D'$. Then $D + D'$ is the scheme theoretic union of $D$ and $D'$. \end{lemma} 
\begin{lemma} \label{lemma-pullback-locally-principal} Let $f : S' \to S$ be a morphism of schemes. Let $Z \subset S$ be a locally principal closed subscheme. Then the inverse image $f^{-1}(Z)$ is a locally principal closed subscheme of $S'$. \end{lemma} 
\begin{definition} \label{definition-pullback-effective-Cartier-divisor} Let $f : S' \to S$ be a morphism of schemes. Let $D \subset S$ be an effective Cartier divisor. We say the {\it pullback of $D$ by $f$ is defined} if the closed subscheme $f^{-1}(D) \subset S'$ is an effective Cartier divisor. In this case we denote it either $f^*D$ or $f^{-1}(D)$ and we call it the {\it pullback of the effective Cartier divisor}. \end{definition} 
\begin{lemma} \label{lemma-pullback-effective-Cartier-defined} Let $f : X \to Y$ be a morphism of schemes. Let $D \subset Y$ be an effective Cartier divisor. The pullback of $D$ by $f$ is defined in each of the following cases: \begin{enumerate} \item $f(x) \not \in D$ for any weakly associated point $x$ of $X$, \item $X$, $Y$ integral and $f$ dominant, \item $X$ reduced and $f(\xi) \not \in D$ for any generic point $\xi$ of any irreducible component of $X$, \item $X$ is locally Noetherian and $f(x) \not \in D$ for any associated point $x$ of $X$, \item $X$ is locally Noetherian, has no embedded points, and $f(\xi) \not \in D$ for any generic point $\xi$ of an irreducible component of $X$, \item $f$ is flat, and \item add more here as needed. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-pullback-effective-Cartier-divisors-additive} Let $f : S' \to S$ be a morphism of schemes. Let $D_1$, $D_2$ be effective Cartier divisors on $S$. If the pullbacks of $D_1$ and $D_2$ are defined then the pullback of $D = D_1 + D_2$ is defined and $f^*D = f^*D_1 + f^*D_2$. \end{lemma} 
\begin{definition} \label{definition-invertible-sheaf-effective-Cartier-divisor} Let $S$ be a scheme. Let $D \subset S$ be an effective Cartier divisor with ideal sheaf $\mathcal{I}_D$. \begin{enumerate} \item The {\it invertible sheaf $\mathcal{O}_S(D)$ associated to $D$} is defined by $$ \mathcal{O}_S(D) = \SheafHom_{\mathcal{O}_S}(\mathcal{I}_D, \mathcal{O}_S) = \mathcal{I}_D^{\otimes -1}. $$ \item The {\it canonical section}, usually denoted $1$ or $1_D$, is the global section of $\mathcal{O}_S(D)$ corresponding to the inclusion mapping $\mathcal{I}_D \to \mathcal{O}_S$. \item We write $\mathcal{O}_S(-D) = \mathcal{O}_S(D)^{\otimes -1} = \mathcal{I}_D$. \item Given a second effective Cartier divisor $D' \subset S$ we define $\mathcal{O}_S(D - D') = \mathcal{O}_S(D) \otimes_{\mathcal{O}_S} \mathcal{O}_S(-D')$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-conormal-effective-Cartier-divisor} Let $S$ be a scheme and let $D \subset S$ be an effective Cartier divisor. Then the conormal sheaf is $\mathcal{C}_{D/S} = \mathcal{I}_D|_D = \mathcal{O}_S(-D)|_D$ and the normal sheaf is $\mathcal{N}_{D/S} = \mathcal{O}_S(D)|_D$. \end{lemma} 
\begin{lemma} \label{lemma-ses-add-divisor} Let $X$ be a scheme. Let $D, C \subset X$ be effective Cartier divisors with $C \subset D$ and let $D' = D + C$. Then there is a short exact sequence $$ 0 \to \mathcal{O}_X(-D)|_C \to \mathcal{O}_{D'} \to \mathcal{O}_D \to 0 $$ of $\mathcal{O}_X$-modules. \end{lemma} 
\begin{lemma} \label{lemma-invertible-sheaf-sum-effective-Cartier-divisors} Let $S$ be a scheme. Let $D_1$, $D_2$ be effective Cartier divisors on $S$. Let $D = D_1 + D_2$. Then there is a unique isomorphism $$ \mathcal{O}_S(D_1) \otimes_{\mathcal{O}_S} \mathcal{O}_S(D_2) \longrightarrow \mathcal{O}_S(D) $$ which maps $1_{D_1} \otimes 1_{D_2}$ to $1_D$. \end{lemma} 
\begin{lemma} \label{lemma-pullback-effective-Cartier-divisors} Let $f : S' \to S$ be a morphism of schemes. Let $D$ be a effective Cartier divisors on $S$. If the pullback of $D$ is defined then $f^*\mathcal{O}_S(D) = \mathcal{O}_{S'}(f^*D)$ and the canonical section $1_D$ pulls back to the canonical section $1_{f^*D}$. \end{lemma} 
\begin{definition} \label{definition-regular-section} Let $(X, \mathcal{O}_X)$ be a locally ringed space. Let $\mathcal{L}$ be an invertible sheaf on $X$. A global section $s \in \Gamma(X, \mathcal{L})$ is called a {\it regular section} if the map $\mathcal{O}_X \to \mathcal{L}$, $f \mapsto fs$ is injective. \end{definition} 
\begin{lemma} \label{lemma-regular-section-structure-sheaf} Let $X$ be a locally ringed space. Let $f \in \Gamma(X, \mathcal{O}_X)$. The following are equivalent: \begin{enumerate} \item $f$ is a regular section, and \item for any $x \in X$ the image $f \in \mathcal{O}_{X, x}$ is a nonzerodivisor. \end{enumerate} If $X$ is a scheme these are also equivalent to \begin{enumerate} \item[(3)] for any affine open $\Spec(A) = U \subset X$ the image $f \in A$ is a nonzerodivisor, \item[(4)] there exists an affine open covering $X = \bigcup \Spec(A_i)$ such that the image of $f$ in $A_i$ is a nonzerodivisor for all $i$. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-zero-scheme-s} Let $X$ be a scheme. Let $\mathcal{L}$ be an invertible sheaf. Let $s \in \Gamma(X, \mathcal{L})$ be a global section. The {\it zero scheme} of $s$ is the closed subscheme $Z(s) \subset X$ defined by the quasi-coherent sheaf of ideals $\mathcal{I} \subset \mathcal{O}_X$ which is the image of the map $s : \mathcal{L}^{\otimes -1} \to \mathcal{O}_X$. \end{definition} 
\begin{lemma} \label{lemma-zero-scheme} Let $X$ be a scheme. Let $\mathcal{L}$ be an invertible sheaf. Let $s \in \Gamma(X, \mathcal{L})$. \begin{enumerate} \item Consider closed immersions $i : Z \to X$ such that $i^*s \in \Gamma(Z, i^*\mathcal{L})$ is zero ordered by inclusion. The zero scheme $Z(s)$ is the maximal element of this ordered set. \item For any morphism of schemes $f : Y \to X$ we have $f^*s = 0$ in $\Gamma(Y, f^*\mathcal{L})$ if and only if $f$ factors through $Z(s)$. \item The zero scheme $Z(s)$ is a locally principal closed subscheme. \item The zero scheme $Z(s)$ is an effective Cartier divisor if and only if $s$ is a regular section of $\mathcal{L}$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-characterize-OD} \begin{slogan} Effective Cartier divisors on a scheme are the same as invertible sheaves with fixed regular global section. \end{slogan} Let $X$ be a scheme. \begin{enumerate} \item If $D \subset X$ is an effective Cartier divisor, then the canonical section $1_D$ of $\mathcal{O}_X(D)$ is regular. \item Conversely, if $s$ is a regular section of the invertible sheaf $\mathcal{L}$, then there exists a unique effective Cartier divisor $D = Z(s) \subset X$ and a unique isomorphism $\mathcal{O}_X(D) \to \mathcal{L}$ which maps $1_D$ to $s$. \end{enumerate} The constructions $D \mapsto (\mathcal{O}_X(D), 1_D)$ and $(\mathcal{L}, s) \mapsto Z(s)$ give mutually inverse maps $$ \left\{ \begin{matrix} \text{effective Cartier divisors on }X \end{matrix} \right\} \leftrightarrow \left\{ \begin{matrix} \text{isomorphism classes of pairs }(\mathcal{L}, s)\\ \text{consisting of an invertible } \mathcal{O}_X\text{-module}\\ \mathcal{L}\text{ and a regular global section }s \end{matrix} \right\} $$ \end{lemma} 
\begin{lemma} \label{lemma-regular-section-associated-points} Let $X$ be a locally Noetherian scheme. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Let $s \in \Gamma(X, \mathcal{L})$. Then $s$ is a regular section if and only if $s$ does not vanish in the associated points of $X$. \end{lemma} 
\begin{lemma} \label{lemma-effective-Cartier-in-points} Let $X$ be a locally Noetherian scheme. Let $D \subset X$ be a closed subscheme corresponding to the quasi-coherent ideal sheaf $\mathcal{I} \subset \mathcal{O}_X$. \begin{enumerate} \item If for every $x \in D$ the ideal $\mathcal{I}_x \subset \mathcal{O}_{X, x}$ can be generated by one element, then $D$ is locally principal. \item If for every $x \in D$ the ideal $\mathcal{I}_x \subset \mathcal{O}_{X, x}$ can be generated by a single nonzerodivisor, then $D$ is an effective Cartier divisor. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-effective-Cartier-codimension-1} Let $X$ be a locally Noetherian scheme. \begin{enumerate} \item Let $D \subset X$ be a locally principal closed subscheme. Let $\xi \in D$ be a generic point of an irreducible component of $D$. Then $\dim(\mathcal{O}_{X, \xi}) \leq 1$. \item Let $D \subset X$ be an effective Cartier divisor. Let $\xi \in D$ be a generic point of an irreducible component of $D$. Then $\dim(\mathcal{O}_{X, \xi}) = 1$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-integral-effective-Cartier-divisor-dvr} Let $X$ be a Noetherian scheme. Let $D \subset X$ be an integral closed subscheme which is also an effective Cartier divisor. Then the local ring of $X$ at the generic point of $D$ is a discrete valuation ring. \end{lemma} 
\begin{lemma} \label{lemma-effective-Cartier-divisor-Sk} Let $X$ be a locally Noetherian scheme. Let $D \subset X$ be an effective Cartier divisor. If $X$ is $(S_k)$, then $D$ is $(S_{k - 1})$. \end{lemma} 
\begin{lemma} \label{lemma-normal-effective-Cartier-divisor-S1} Let $X$ be a locally Noetherian normal scheme. Let $D \subset X$ be an effective Cartier divisor. Then $D$ is $(S_1)$. \end{lemma} 
\begin{lemma} \label{lemma-weil-divisor-is-cartier-UFD} Let $X$ be a locally Noetherian scheme. Let $D \subset X$ be an integral closed subscheme. Assume that \begin{enumerate} \item $D$ has codimension $1$ in $X$, and \item $\mathcal{O}_{X, x}$ is a UFD for all $x \in D$. \end{enumerate} Then $D$ is an effective Cartier divisor. \end{lemma} 
\begin{lemma} \label{lemma-codim-1-part} Let $X$ be a Noetherian scheme. Let $Z \subset X$ be a closed subscheme. Assume there exist integral effective Cartier divisors $D_i \subset X$ and a closed subset $Z' \subset X$ of codimension $\geq 2$ such that $Z \subset Z' \cup \bigcup D_i$ set-theoretically. Then there exists an effective Cartier divisor of the form $$ D = \sum a_i D_i \subset Z $$ such that $D \to Z$ is an isomorphism away from codimension $2$ in $X$. The existence of the $D_i$ is guaranteed if $\mathcal{O}_{X, x}$ is a UFD for all $x \in Z$ or if $X$ is regular. \end{lemma} 
\begin{lemma} \label{lemma-codimension-1-is-effective-Cartier} Let $Z \subset X$ be a closed subscheme of a Noetherian scheme. Assume \begin{enumerate} \item $Z$ has no embedded points, \item every irreducible component of $Z$ has codimension $1$ in $X$, \item every local ring $\mathcal{O}_{X, x}$, $x \in Z$ is a UFD or $X$ is regular. \end{enumerate} Then $Z$ is an effective Cartier divisor. \end{lemma} 
\begin{lemma} \label{lemma-UFD-one-equation-CM} Let $R$ be a Noetherian UFD. Let $I \subset R$ be an ideal such that $R/I$ has no embedded primes and such that every minimal prime over $I$ has height $1$. Then $I = (f)$ for some $f \in R$. \end{lemma} 
\begin{lemma} \label{lemma-effective-Cartier-divisor-is-a-sum} Let $X$ be a Noetherian scheme. Let $D \subset X$ be an effective Cartier divisor. Assume that there exist integral effective Cartier divisors $D_i \subset X$ such that $D \subset \bigcup D_i$ set theoretically. Then $D = \sum a_i D_i$ for some $a_i \geq 0$. The existence of the $D_i$ is guaranteed if $\mathcal{O}_{X, x}$ is a UFD for all $x \in D$ or if $X$ is regular. \end{lemma} 
\begin{lemma} \label{lemma-quasi-projective-Noetherian-pic-effective-Cartier} \begin{slogan} On a projective scheme, every line bundle has a regular meromorphic section. \end{slogan} Let $X$ be a Noetherian scheme which has an ample invertible sheaf. Then every invertible $\mathcal{O}_X$-module is isomorphic to $$ \mathcal{O}_X(D - D') = \mathcal{O}_X(D) \otimes_{\mathcal{O}_X} \mathcal{O}_X(D')^{\otimes -1} $$ for some effective Cartier divisors $D, D'$ in $X$. Moreover, given a finite subset $E \subset X$ we may choose $D, D'$ such that $E \cap D = \emptyset$ and $E \cap D' = \emptyset$. If $X$ is quasi-affine, then we may choose $D' = \emptyset$. \end{lemma} 
\begin{lemma} \label{lemma-wedge-product-ses} Let $X$ be an integral regular scheme of dimension $2$. Let $i : D \to X$ be the immersion of an effective Cartier divisor. Let $\mathcal{F} \to \mathcal{F}' \to i_*\mathcal{G} \to 0$ be an exact sequence of coherent $\mathcal{O}_X$-modules. Assume \begin{enumerate} \item $\mathcal{F}, \mathcal{F}'$ are locally free of rank $r$ on a nonempty open of $X$, \item $D$ is an integral scheme, \item $\mathcal{G}$ is a finite locally free $\mathcal{O}_D$-module of rank $s$. \end{enumerate} Then $\mathcal{L} = (\wedge^r\mathcal{F})^{**}$ and $\mathcal{L}' = (\wedge^r \mathcal{F}')^{**}$ are invertible $\mathcal{O}_X$-modules and $\mathcal{L}' \cong \mathcal{L}(k D)$ for some $k \in \{0, \ldots, \min(s, r)\}$. \end{lemma} 
\begin{lemma} \label{lemma-affine-punctured-spec} Let $(A, \mathfrak m)$ be a Noetherian local ring. The punctured spectrum $U = \Spec(A) \setminus \{\mathfrak m\}$ of $A$ is affine if and only if $\dim(A) \leq 1$. \end{lemma} 
\begin{lemma} \label{lemma-complement-affine-open-immersion} \begin{reference} \cite[EGA IV, Corollaire 21.12.7]{EGA4} \end{reference} Let $X$ be a locally Noetherian scheme. Let $U \subset X$ be an open subscheme such that the inclusion morphism $U \to X$ is affine. For every generic point $\xi$ of an irreducible component of $X \setminus U$ the local ring $\mathcal{O}_{X, \xi}$ has dimension $\leq 1$. If $U$ is dense or if $\xi$ is in the closure of $U$, then $\dim(\mathcal{O}_{X, \xi}) = 1$. \end{lemma} 
\begin{lemma} \label{lemma-complement-affine-open} Let $X$ be a separated locally Noetherian scheme. Let $U \subset X$ be an affine open. For every generic point $\xi$ of an irreducible component of $X \setminus U$ the local ring $\mathcal{O}_{X, \xi}$ has dimension $\leq 1$. If $U$ is dense or if $\xi$ is in the closure of $U$, then $\dim(\mathcal{O}_{X, \xi}) = 1$. \end{lemma} 
\begin{lemma} \label{lemma-complement-open-affine-effective-cartier-divisor} Let $X$ be a Noetherian separated scheme. Let $U \subset X$ be a dense affine open. If $\mathcal{O}_{X, x}$ is a UFD for all $x \in X \setminus U$, then there exists an effective Cartier divisor $D \subset X$ with $U = X \setminus D$. \end{lemma} 
\begin{lemma} \label{lemma-complement-open-affine-effective-cartier-divisor-bis} Let $X$ be a Noetherian scheme with affine diagonal. Let $U \subset X$ be a dense affine open. If $\mathcal{O}_{X, x}$ is a UFD for all $x \in X \setminus U$, then there exists an effective Cartier divisor $D \subset X$ with $U = X \setminus D$. \end{lemma} 
\begin{lemma} \label{lemma-regular-ample-family} Let $X$ be a quasi-compact, regular scheme with affine diagonal. Then $X$ has an ample family of invertible modules (Morphisms, Definition \ref{morphisms-definition-family-ample-invertible-modules}). \end{lemma} 
\begin{lemma} \label{lemma-finite-trivialize-invertible-upstairs} Let $\pi : X \to Y$ be a finite morphism of schemes. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Let $y \in Y$. There exists an open neighbourhood $V \subset Y$ of $y$ such that $\mathcal{L}|_{\pi^{-1}(V)}$ is trivial. \end{lemma} 
\begin{lemma} \label{lemma-norm-invertible} Let $\pi : X \to Y$ be a finite morphism of schemes. If there exists a norm of degree $d$ for $\pi$, then there exists a homomorphism of abelian groups $$ \text{Norm}_\pi : \Pic(X) \to \Pic(Y) $$ such that $\text{Norm}_\pi(\pi^*\mathcal{N}) \cong \mathcal{N}^{\otimes d}$ for all invertible $\mathcal{O}_Y$-modules $\mathcal{N}$. \end{lemma} 
\begin{lemma} \label{lemma-norm-map-invertible} Let $\pi : X \to Y$ be a finite morphism of schemes. Assume there exists a norm of degree $d$ for $\pi$. For any $\mathcal{O}_X$-linear map $\varphi : \mathcal{L} \to \mathcal{L}'$ of invertible $\mathcal{O}_X$-modules there is an $\mathcal{O}_Y$-linear map $$ \text{Norm}_\pi(\varphi) : \text{Norm}_\pi(\mathcal{L}) \longrightarrow \text{Norm}_\pi(\mathcal{L}') $$ with $\text{Norm}_\pi(\mathcal{L})$, $\text{Norm}_\pi(\mathcal{L}')$ as in Lemma \ref{lemma-norm-invertible}. Moreover, for $y \in Y$ the following are equivalent \begin{enumerate} \item $\varphi$ is zero at a point of $x \in X$ with $\pi(x) = y$, and \item $\text{Norm}_\pi(\varphi)$ is zero at $y$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-norm-ample} Let $\pi : X \to Y$ be a finite morphism of schemes. Assume $X$ has an ample invertible sheaf and there exists a norm of degree $d$ for $\pi$. Then $Y$ has an ample invertible sheaf. \end{lemma} 
\begin{lemma} \label{lemma-norm-quasi-affine} Let $\pi : X \to Y$ be a finite morphism of schemes. Assume $X$ is quasi-affine and there exists a norm of degree $d$ for $\pi$. Then $Y$ is quasi-affine. \end{lemma} 
\begin{lemma} \label{lemma-finite-locally-free-has-norm} Let $\pi : X \to Y$ be a finite locally free morphism of degree $d \geq 1$. Then there exists a canonical norm of degree $d$ whose formation commutes with arbitrary base change. \end{lemma} 
\begin{lemma} \label{lemma-norm-in-normal-case} Let $\pi : X \to Y$ be a finite surjective morphism with $X$ and $Y$ integral and $Y$ normal. Then there exists a norm of degree $[R(X) : R(Y)]$ for $\pi$. \end{lemma} 
\begin{lemma} \label{lemma-Frobenius-gives-norm-for-reduction} Let $X$ be a Noetherian scheme. Let $p$ be a prime number such that $p\mathcal{O}_X = 0$. Then for some $e > 0$ there exists a norm of degree $p^e$ for $X_{red} \to X$ where $X_{red}$ is the reduction of $X$. \end{lemma} 
\begin{proposition} \label{proposition-push-down-ample} Let $\pi : X \to Y$ be a finite surjective morphism of schemes. Assume that $X$ has an ample invertible $\mathcal{O}_X$-module. If \begin{enumerate} \item $\pi$ is finite locally free, or \item $Y$ is an integral normal scheme, or \item $Y$ is Noetherian, $p\mathcal{O}_Y = 0$, and $X = Y_{red}$, \end{enumerate} then $Y$ has an ample invertible $\mathcal{O}_Y$-module. \end{proposition} 
\begin{lemma} \label{lemma-push-down-quasi-affine} Let $\pi : X \to Y$ be a finite surjective morphism of schemes. Assume that $X$ is quasi-affine. If either \begin{enumerate} \item $\pi$ is finite locally free, or \item $Y$ is an integral normal scheme \end{enumerate} then $Y$ is quasi-affine. \end{lemma} 
\begin{lemma} \label{lemma-relative-Cartier} Let $f : X \to S$ be a morphism of schemes. Let $D \subset X$ be a closed subscheme. Assume \begin{enumerate} \item $D$ is an effective Cartier divisor, and \item $D \to S$ is a flat morphism. \end{enumerate} Then for every morphism of schemes $g : S' \to S$ the pullback $(g')^{-1}D$ is an effective Cartier divisor on $X' = S' \times_S X$ where $g' : X' \to X$ is the projection. \end{lemma} 
\begin{definition} \label{definition-relative-effective-Cartier-divisor} Let $f : X \to S$ be a morphism of schemes. A {\it relative effective Cartier divisor} on $X/S$ is an effective Cartier divisor $D \subset X$ such that $D \to S$ is a flat morphism of schemes. \end{definition} 
\begin{lemma} \label{lemma-sum-relative-effective-Cartier-divisor} Let $f : X \to S$ be a morphism of schemes. If $D_1, D_2 \subset X$ are relative effective Cartier divisor on $X/S$ then so is $D_1 + D_2$ (Definition \ref{definition-sum-effective-Cartier-divisors}). \end{lemma} 
\begin{lemma} \label{lemma-difference-relative-effective-Cartier-divisor} Let $f : X \to S$ be a morphism of schemes. If $D_1, D_2 \subset X$ are relative effective Cartier divisor on $X/S$ and $D_1 \subset D_2$ as closed subschemes, then the effective Cartier divisor $D$ such that $D_2 = D_1 + D$ (Lemma \ref{lemma-difference-effective-Cartier-divisors}) is a relative effective Cartier divisor on $X/S$. \end{lemma} 
\begin{lemma} \label{lemma-flat-at-x} Let $f : X \to S$ be a morphism of schemes. Let $D \subset X$ be a relative effective Cartier divisor on $X/S$. If $x \in D$ and $\mathcal{O}_{X, x}$ is Noetherian, then $f$ is flat at $x$. \end{lemma} 
\begin{lemma} \label{lemma-flat-relative-Cartier-divisor} Let $f : X \to S$ be a morphism of schemes. Let $D \subset X$ be a relative effective Cartier divisor. If $f$ is locally of finite presentation, then there exists an open subscheme $U \subset X$ such that $D \subset U$ and such that $f|_U : U \to S$ is flat. \end{lemma} 
\begin{lemma} \label{lemma-michael-artin} Let $f : X \to S$ be a morphism of schemes. Let $D \subset X$ be a relative effective Cartier divisor on $X/S$. If $f$ is flat at all points of $X \setminus D$, then $f$ is flat. \end{lemma} 
\begin{lemma} \label{lemma-fibre-Cartier} Let $\varphi : X \to S$ be a flat morphism which is locally of finite presentation. Let $Z \subset X$ be a closed subscheme. Let $x \in Z$ with image $s \in S$. \begin{enumerate} \item If $Z_s \subset X_s$ is a Cartier divisor in a neighbourhood of $x$, then there exists an open $U \subset X$ and a relative effective Cartier divisor $D \subset U$ such that $Z \cap U \subset D$ and $Z_s \cap U = D_s$. \item If $Z_s \subset X_s$ is a Cartier divisor in a neighbourhood of $x$, the morphism $Z \to X$ is of finite presentation, and $Z \to S$ is flat at $x$, then we can choose $U$ and $D$ such that $Z \cap U = D$. \item If $Z_s \subset X_s$ is a Cartier divisor in a neighbourhood of $x$ and $Z$ is a locally principal closed subscheme of $X$ in a neighbourhood of $x$, then we can choose $U$ and $D$ such that $Z \cap U = D$. \end{enumerate} In particular, if $Z \to S$ is locally of finite presentation and flat and all fibres $Z_s \subset X_s$ are effective Cartier divisors, then $Z$ is a relative effective Cartier divisor. Similarly, if $Z$ is a locally principal closed subscheme of $X$ such that all fibres $Z_s \subset X_s$ are effective Cartier divisors, then $Z$ is a relative effective Cartier divisor. \end{lemma} 
\begin{definition} \label{definition-conormal-sheaf} Let $f : Z \to X$ be an immersion. The {\it conormal algebra $\mathcal{C}_{Z/X, *}$ of $Z$ in $X$} or the {\it conormal algebra of $f$} is the quasi-coherent sheaf of graded $\mathcal{O}_Z$-algebras $\bigoplus_{n \geq 0} \mathcal{I}^n/\mathcal{I}^{n + 1}$ described above. \end{definition} 
\begin{lemma} \label{lemma-affine-conormal-sheaf} Let $i : Z \to X$ be an immersion. The conormal algebra of $i$ has the following properties: \begin{enumerate} \item Let $U \subset X$ be any open such that $i(Z)$ is a closed subset of $U$. Let $\mathcal{I} \subset \mathcal{O}_U$ be the sheaf of ideals corresponding to the closed subscheme $i(Z) \subset U$. Then $$ \mathcal{C}_{Z/X, *} = i^*\left(\bigoplus\nolimits_{n \geq 0} \mathcal{I}^n\right) = i^{-1}\left( \bigoplus\nolimits_{n \geq 0} \mathcal{I}^n/\mathcal{I}^{n + 1} \right) $$ \item For any affine open $\Spec(R) = U \subset X$ such that $Z \cap U = \Spec(R/I)$ there is a canonical isomorphism $\Gamma(Z \cap U, \mathcal{C}_{Z/X, *}) = \bigoplus_{n \geq 0} I^n/I^{n + 1}$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-conormal-algebra-functorial} Let $$ \xymatrix{ Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\ Z' \ar[r]^{i'} & X' } $$ be a commutative diagram in the category of schemes. Assume $i$, $i'$ immersions. There is a canonical map of graded $\mathcal{O}_Z$-algebras $$ f^*\mathcal{C}_{Z'/X', *} \longrightarrow \mathcal{C}_{Z/X, *} $$ characterized by the following property: For every pair of affine opens $(\Spec(R) = U \subset X, \Spec(R') = U' \subset X')$ with $f(U) \subset U'$ such that $Z \cap U = \Spec(R/I)$ and $Z' \cap U' = \Spec(R'/I')$ the induced map $$ \Gamma(Z' \cap U', \mathcal{C}_{Z'/X', *}) = \bigoplus\nolimits (I')^n/(I')^{n + 1} \longrightarrow \bigoplus\nolimits_{n \geq 0} I^n/I^{n + 1} = \Gamma(Z \cap U, \mathcal{C}_{Z/X, *}) $$ is the one induced by the ring map $f^\sharp : R' \to R$ which has the property $f^\sharp(I') \subset I$. \end{lemma} 
\begin{lemma} \label{lemma-conormal-algebra-functorial-flat} Let $$ \xymatrix{ Z \ar[r]_i \ar[d]_f & X \ar[d]^g \\ Z' \ar[r]^{i'} & X' } $$ be a fibre product diagram in the category of schemes with $i$, $i'$ immersions. Then the canonical map $f^*\mathcal{C}_{Z'/X', *} \to \mathcal{C}_{Z/X, *}$ of Lemma \ref{lemma-conormal-algebra-functorial} is surjective. If $g$ is flat, then it is an isomorphism. \end{lemma} 
\begin{definition} \label{definition-normal-cone} Let $i : Z \to X$ be an immersion of schemes. The {\it normal cone $C_ZX$} of $Z$ in $X$ is $$ C_ZX = \underline{\Spec}_Z(\mathcal{C}_{Z/X, *}) $$ see Constructions, Definitions \ref{constructions-definition-cone} and \ref{constructions-definition-abstract-cone}. The {\it normal bundle} of $Z$ in $X$ is the vector bundle $$ N_ZX = \underline{\Spec}_Z(\text{Sym}(\mathcal{C}_{Z/X})) $$ see Constructions, Definitions \ref{constructions-definition-vector-bundle} and \ref{constructions-definition-abstract-vector-bundle}. \end{definition} 
\begin{lemma} \label{lemma-types-regular-sequences-implications} Let $X$ be a ringed space. Let $f_1, \ldots, f_r \in \Gamma(X, \mathcal{O}_X)$. We have the following implications $f_1, \ldots, f_r$ is a regular sequence $\Rightarrow$ $f_1, \ldots, f_r$ is a Koszul-regular sequence $\Rightarrow$ $f_1, \ldots, f_r$ is an $H_1$-regular sequence $\Rightarrow$ $f_1, \ldots, f_r$ is a quasi-regular sequence. \end{lemma} 
\begin{definition} \label{definition-regular-ideal-sheaf} \begin{reference} The concept of a Koszul-regular ideal sheaf was introduced in \cite[Expose VII, Definition 1.4]{SGA6} where it was called a regular ideal sheaf. \end{reference} Let $X$ be a ringed space. Let $\mathcal{J} \subset \mathcal{O}_X$ be a sheaf of ideals. \begin{enumerate} \item We say $\mathcal{J}$ is {\it regular} if for every $x \in \text{Supp}(\mathcal{O}_X/\mathcal{J})$ there exists an open neighbourhood $x \in U \subset X$ and a regular sequence $f_1, \ldots, f_r \in \mathcal{O}_X(U)$ such that $\mathcal{J}|_U$ is generated by $f_1, \ldots, f_r$. \item We say $\mathcal{J}$ is {\it Koszul-regular} if for every $x \in \text{Supp}(\mathcal{O}_X/\mathcal{J})$ there exists an open neighbourhood $x \in U \subset X$ and a Koszul-regular sequence $f_1, \ldots, f_r \in \mathcal{O}_X(U)$ such that $\mathcal{J}|_U$ is generated by $f_1, \ldots, f_r$. \item We say $\mathcal{J}$ is {\it $H_1$-regular} if for every $x \in \text{Supp}(\mathcal{O}_X/\mathcal{J})$ there exists an open neighbourhood $x \in U \subset X$ and a $H_1$-regular sequence $f_1, \ldots, f_r \in \mathcal{O}_X(U)$ such that $\mathcal{J}|_U$ is generated by $f_1, \ldots, f_r$. \item We say $\mathcal{J}$ is {\it quasi-regular} if for every $x \in \text{Supp}(\mathcal{O}_X/\mathcal{J})$ there exists an open neighbourhood $x \in U \subset X$ and a quasi-regular sequence $f_1, \ldots, f_r \in \mathcal{O}_X(U)$ such that $\mathcal{J}|_U$ is generated by $f_1, \ldots, f_r$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-regular-quasi-regular-scheme} Let $X$ be a ringed space. Let $\mathcal{J}$ be a sheaf of ideals. We have the following implications: $\mathcal{J}$ is regular $\Rightarrow$ $\mathcal{J}$ is Koszul-regular $\Rightarrow$ $\mathcal{J}$ is $H_1$-regular $\Rightarrow$ $\mathcal{J}$ is quasi-regular. \end{lemma} 
\begin{lemma} \label{lemma-quasi-regular-ideal} Let $X$ be a locally ringed space. Let $\mathcal{J} \subset \mathcal{O}_X$ be a sheaf of ideals. Then $\mathcal{J}$ is quasi-regular if and only if the following conditions are satisfied: \begin{enumerate} \item $\mathcal{J}$ is an $\mathcal{O}_X$-module of finite type, \item $\mathcal{J}/\mathcal{J}^2$ is a finite locally free $\mathcal{O}_X/\mathcal{J}$-module, and \item the canonical maps $$ \text{Sym}^n_{\mathcal{O}_X/\mathcal{J}}(\mathcal{J}/\mathcal{J}^2) \longrightarrow \mathcal{J}^n/\mathcal{J}^{n + 1} $$ are isomorphisms for all $n \geq 0$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-generate-regular-ideal} Let $(X, \mathcal{O}_X)$ be a locally ringed space. Let $\mathcal{J} \subset \mathcal{O}_X$ be a sheaf of ideals. Let $x \in X$ and $f_1, \ldots, f_r \in \mathcal{J}_x$ whose images give a basis for the $\kappa(x)$-vector space $\mathcal{J}_x/\mathfrak m_x\mathcal{J}_x$. \begin{enumerate} \item If $\mathcal{J}$ is quasi-regular, then there exists an open neighbourhood such that $f_1, \ldots, f_r \in \mathcal{O}_X(U)$ form a quasi-regular sequence generating $\mathcal{J}|_U$. \item If $\mathcal{J}$ is $H_1$-regular, then there exists an open neighbourhood such that $f_1, \ldots, f_r \in \mathcal{O}_X(U)$ form an $H_1$-regular sequence generating $\mathcal{J}|_U$. \item If $\mathcal{J}$ is Koszul-regular, then there exists an open neighbourhood such that $f_1, \ldots, f_r \in \mathcal{O}_X(U)$ form an Koszul-regular sequence generating $\mathcal{J}|_U$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-regular-ideal-sheaf-quasi-coherent} Any regular, Koszul-regular, $H_1$-regular, or quasi-regular sheaf of ideals on a scheme is a finite type quasi-coherent sheaf of ideals. \end{lemma} 
\begin{lemma} \label{lemma-regular-ideal-sheaf-scheme} Let $X$ be a scheme. Let $\mathcal{J}$ be a sheaf of ideals. Then $\mathcal{J}$ is regular (resp.\ Koszul-regular, $H_1$-regular, quasi-regular) if and only if for every $x \in \text{Supp}(\mathcal{O}_X/\mathcal{J})$ there exists an affine open neighbourhood $x \in U \subset X$, $U = \Spec(A)$ such that $\mathcal{J}|_U = \widetilde{I}$ and such that $I$ is generated by a regular (resp.\ Koszul-regular, $H_1$-regular, quasi-regular) sequence $f_1, \ldots, f_r \in A$. \end{lemma} 
\begin{lemma} \label{lemma-Noetherian-scheme-regular-ideal} Let $X$ be a locally Noetherian scheme. Let $\mathcal{J} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of ideals. Let $x$ be a point of the support of $\mathcal{O}_X/\mathcal{J}$. The following are equivalent \begin{enumerate} \item $\mathcal{J}_x$ is generated by a regular sequence in $\mathcal{O}_{X, x}$, \item $\mathcal{J}_x$ is generated by a Koszul-regular sequence in $\mathcal{O}_{X, x}$, \item $\mathcal{J}_x$ is generated by an $H_1$-regular sequence in $\mathcal{O}_{X, x}$, \item $\mathcal{J}_x$ is generated by a quasi-regular sequence in $\mathcal{O}_{X, x}$, \item there exists an affine neighbourhood $U = \Spec(A)$ of $x$ such that $\mathcal{J}|_U = \widetilde{I}$ and $I$ is generated by a regular sequence in $A$, and \item there exists an affine neighbourhood $U = \Spec(A)$ of $x$ such that $\mathcal{J}|_U = \widetilde{I}$ and $I$ is generated by a Koszul-regular sequence in $A$, and \item there exists an affine neighbourhood $U = \Spec(A)$ of $x$ such that $\mathcal{J}|_U = \widetilde{I}$ and $I$ is generated by an $H_1$-regular sequence in $A$, and \item there exists an affine neighbourhood $U = \Spec(A)$ of $x$ such that $\mathcal{J}|_U = \widetilde{I}$ and $I$ is generated by a quasi-regular sequence in $A$, \item there exists a neighbourhood $U$ of $x$ such that $\mathcal{J}|_U$ is regular, and \item there exists a neighbourhood $U$ of $x$ such that $\mathcal{J}|_U$ is Koszul-regular, and \item there exists a neighbourhood $U$ of $x$ such that $\mathcal{J}|_U$ is $H_1$-regular, and \item there exists a neighbourhood $U$ of $x$ such that $\mathcal{J}|_U$ is quasi-regular. \end{enumerate} In particular, on a locally Noetherian scheme the notions of regular, Koszul-regular, $H_1$-regular, or quasi-regular ideal sheaf all agree. \end{lemma} 
\begin{definition} \label{definition-regular-immersion} \begin{reference} The concept of a Koszul-regular immersion was introduced in \cite[Expose VII, Definition 1.4]{SGA6} where it was called a regular immersion. \end{reference} Let $i : Z \to X$ be an immersion of schemes. Choose an open subscheme $U \subset X$ such that $i$ identifies $Z$ with a closed subscheme of $U$ and denote $\mathcal{I} \subset \mathcal{O}_U$ the corresponding quasi-coherent sheaf of ideals. \begin{enumerate} \item We say $i$ is a {\it regular immersion} if $\mathcal{I}$ is regular. \item We say $i$ is a {\it Koszul-regular immersion} if $\mathcal{I}$ is Koszul-regular. \item We say $i$ is a {\it $H_1$-regular immersion} if $\mathcal{I}$ is $H_1$-regular. \item We say $i$ is a {\it quasi-regular immersion} if $\mathcal{I}$ is quasi-regular. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-regular-quasi-regular-immersion} Let $i : Z \to X$ be an immersion of schemes. We have the following implications: $i$ is regular $\Rightarrow$ $i$ is Koszul-regular $\Rightarrow$ $i$ is $H_1$-regular $\Rightarrow$ $i$ is quasi-regular. \end{lemma} 
\begin{lemma} \label{lemma-regular-immersion-noetherian} Let $i : Z \to X$ be an immersion of schemes. Assume $X$ is locally Noetherian. Then $i$ is regular $\Leftrightarrow$ $i$ is Koszul-regular $\Leftrightarrow$ $i$ is $H_1$-regular $\Leftrightarrow$ $i$ is quasi-regular. \end{lemma} 
\begin{lemma} \label{lemma-flat-base-change-regular-immersion} Let $i : Z \to X$ be a regular (resp.\ Koszul-regular, $H_1$-regular, quasi-regular) immersion. Let $X' \to X$ be a flat morphism. Then the base change $i' : Z \times_X X' \to X'$ is a regular (resp.\ Koszul-regular, $H_1$-regular, quasi-regular) immersion. \end{lemma} 
\begin{lemma} \label{lemma-quasi-regular-immersion} Let $i : Z \to X$ be an immersion of schemes. Then $i$ is a quasi-regular immersion if and only if the following conditions are satisfied \begin{enumerate} \item $i$ is locally of finite presentation, \item the conormal sheaf $\mathcal{C}_{Z/X}$ is finite locally free, and \item the map (\ref{equation-conormal-algebra-quotient}) is an isomorphism. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-transitivity-conormal-quasi-regular} Let $Z \to Y \to X$ be immersions of schemes. Assume that $Z \to Y$ is $H_1$-regular. Then the canonical sequence of Morphisms, Lemma \ref{morphisms-lemma-transitivity-conormal} $$ 0 \to i^*\mathcal{C}_{Y/X} \to \mathcal{C}_{Z/X} \to \mathcal{C}_{Z/Y} \to 0 $$ is exact and locally split. \end{lemma} 
\begin{lemma} \label{lemma-composition-regular-immersion} Let $i : Z \to Y$ and $j : Y \to X$ be immersions of schemes. \begin{enumerate} \item If $i$ and $j$ are regular immersions, so is $j \circ i$. \item If $i$ and $j$ are Koszul-regular immersions, so is $j \circ i$. \item If $i$ and $j$ are $H_1$-regular immersions, so is $j \circ i$. \item If $i$ is an $H_1$-regular immersion and $j$ is a quasi-regular immersion, then $j \circ i$ is a quasi-regular immersion. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-permanence-regular-immersion} Let $i : Z \to Y$ and $j : Y \to X$ be immersions of schemes. Assume that the sequence $$ 0 \to i^*\mathcal{C}_{Y/X} \to \mathcal{C}_{Z/X} \to \mathcal{C}_{Z/Y} \to 0 $$ of Morphisms, Lemma \ref{morphisms-lemma-transitivity-conormal} is exact and locally split. \begin{enumerate} \item If $j \circ i$ is a quasi-regular immersion, so is $i$. \item If $j \circ i$ is a $H_1$-regular immersion, so is $i$. \item If both $j$ and $j \circ i$ are Koszul-regular immersions, so is $i$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-extra-permanence-regular-immersion-noetherian} Let $i : Z \to Y$ and $j : Y \to X$ be immersions of schemes. Pick $z \in Z$ and denote $y \in Y$, $x \in X$ the corresponding points. Assume $X$ is locally Noetherian. The following are equivalent \begin{enumerate} \item $i$ is a regular immersion in a neighbourhood of $z$ and $j$ is a regular immersion in a neighbourhood of $y$, \item $i$ and $j \circ i$ are regular immersions in a neighbourhood of $z$, \item $j \circ i$ is a regular immersion in a neighbourhood of $z$ and the conormal sequence $$ 0 \to i^*\mathcal{C}_{Y/X} \to \mathcal{C}_{Z/X} \to \mathcal{C}_{Z/Y} \to 0 $$ is split exact in a neighbourhood of $z$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-koszul-regular-smooth-locally-regular} Let $i : Z \to X$ be a Koszul regular closed immersion. Then there exists a surjective smooth morphism $X' \to X$ such that the base change $i' : Z \times_X X' \to X'$ of $i$ is a regular immersion. \end{lemma} 
\begin{lemma} \label{lemma-immersion-regular-regular-immersion} Let $i : Z \to X$ be an immersion. If $Z$ and $X$ are regular schemes, then $i$ is a regular immersion. \end{lemma} 
\begin{lemma} \label{lemma-relative-regular-immersion} Let $f : X \to S$ be a morphism of schemes. Let $i : Z \subset X$ be an immersion. Assume \begin{enumerate} \item $i$ is an $H_1$-regular (resp.\ quasi-regular) immersion, and \item $Z \to S$ is a flat morphism. \end{enumerate} Then for every morphism of schemes $g : S' \to S$ the base change $Z' = S' \times_S Z \to X' = S' \times_S X$ is an $H_1$-regular (resp.\ quasi-regular) immersion. \end{lemma} 
\begin{definition} \label{definition-relative-H1-regular-immersion} Let $f : X \to S$ be a morphism of schemes. Let $i : Z \to X$ be an immersion. \begin{enumerate} \item We say $i$ is a {\it relative quasi-regular immersion} if $Z \to S$ is flat and $i$ is a quasi-regular immersion. \item We say $i$ is a {\it relative $H_1$-regular immersion} if $Z \to S$ is flat and $i$ is an $H_1$-regular immersion. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-quasi-regular-immersion-flat-at-x} Let $f : X \to S$ be a morphism of schemes. Let $Z \to X$ be a relative quasi-regular immersion. If $x \in Z$ and $\mathcal{O}_{X, x}$ is Noetherian, then $f$ is flat at $x$. \end{lemma} 
\begin{lemma} \label{lemma-relative-regular-immersion-flat-in-neighbourhood} Let $X \to S$ be a morphism of schemes. Let $Z \to X$ be an immersion. Assume \begin{enumerate} \item $X \to S$ is flat and locally of finite presentation, \item $Z \to X$ is a relative quasi-regular immersion. \end{enumerate} Then $Z \to X$ is a regular immersion and the same remains true after any base change. \end{lemma} 
\begin{lemma} \label{lemma-flat-relative-H1-regular} Let $X \to S$ be a morphism of schemes. Let $Z \to X$ be a relative $H_1$-regular immersion. Assume $X \to S$ is locally of finite presentation. Then \begin{enumerate} \item there exists an open subscheme $U \subset X$ such that $Z \subset U$ and such that $U \to S$ is flat, and \item $Z \to X$ is a regular immersion and the same remains true after any base change. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-fibre-quasi-regular} Let $\varphi : X \to S$ be a flat morphism which is locally of finite presentation. Let $T \subset X$ be a closed subscheme. Let $x \in T$ with image $s \in S$. \begin{enumerate} \item If $T_s \subset X_s$ is a quasi-regular immersion in a neighbourhood of $x$, then there exists an open $U \subset X$ and a relative quasi-regular immersion $Z \subset U$ such that $Z_s = T_s \cap U_s$ and $T \cap U \subset Z$. \item If $T_s \subset X_s$ is a quasi-regular immersion in a neighbourhood of $x$, the morphism $T \to X$ is of finite presentation, and $T \to S$ is flat at $x$, then we can choose $U$ and $Z$ as in (1) such that $T \cap U = Z$. \item If $T_s \subset X_s$ is a quasi-regular immersion in a neighbourhood of $x$, and $T$ is cut out by $c$ equations in a neighbourhood of $x$, where $c = \dim_x(X_s) - \dim_x(T_s)$, then we can choose $U$ and $Z$ as in (1) such that $T \cap U = Z$. \end{enumerate} In each case $Z \to U$ is a regular immersion by Lemma \ref{lemma-relative-regular-immersion-flat-in-neighbourhood}. In particular, if $T \to S$ is locally of finite presentation and flat and all fibres $T_s \subset X_s$ are quasi-regular immersions, then $T \to X$ is a relative quasi-regular immersion. \end{lemma} 
\begin{lemma} \label{lemma-section-smooth-regular-immersion} Let $f : X \to S$ be a smooth morphism of schemes. Let $\sigma : S \to X$ be a section of $f$. Then $\sigma$ is a regular immersion. \end{lemma} 
\begin{lemma} \label{lemma-lift-regular-immersion-to-smooth} Let $$ \xymatrix{ Y \ar[rd]_j \ar[rr]_i & & X \ar[ld] \\ & S } $$ be a commutative diagram of morphisms of schemes. Assume $X \to S$ smooth, and $i$, $j$ immersions. If $j$ is a regular (resp.\ Koszul-regular, $H_1$-regular, quasi-regular) immersion, then so is $i$. \end{lemma} 
\begin{lemma} \label{lemma-immersion-lci-into-smooth-regular-immersion} Let $$ \xymatrix{ Y \ar[rd] \ar[rr]_i & & X \ar[ld] \\ & S } $$ be a commutative diagram of morphisms of schemes. Assume that $Y \to S$ is syntomic, $X \to S$ smooth, and $i$ an immersion. Then $i$ is a regular immersion. \end{lemma} 
\begin{lemma} \label{lemma-immersion-smooth-into-smooth-regular-immersion} Let $$ \xymatrix{ Y \ar[rd] \ar[rr]_i & & X \ar[ld] \\ & S } $$ be a commutative diagram of morphisms of schemes. Assume that $Y \to S$ is smooth, $X \to S$ smooth, and $i$ an immersion. Then $i$ is a regular immersion. \end{lemma} 
\begin{lemma} \label{lemma-push-regular-immersion-thru-smooth} Let $$ \xymatrix{ Y \ar[rd]_j \ar[rr]_i & & X \ar[ld] \\ & S } $$ be a commutative diagram of morphisms of schemes. Assume $X \to S$ smooth and $i$ and $j$ immersions. If $i$ is a Koszul-regular (resp.\ $H_1$-regular, quasi-regular) immersion, then so is $j$. \end{lemma} 
\begin{definition} \label{definition-sheaf-meromorphic-functions} Let $(X, \mathcal{O}_X)$ be a locally ringed space. The {\it sheaf of meromorphic functions on $X$} is the sheaf {\it $\mathcal{K}_X$} associated to the presheaf displayed above. A {\it meromorphic function} on $X$ is a global section of $\mathcal{K}_X$. \end{definition} 
\begin{definition} \label{definition-meromorphic-section} Let $X$ be a locally ringed space. Let $\mathcal{F}$ be a sheaf of $\mathcal{O}_X$-modules. \begin{enumerate} \item We denote $\mathcal{K}_X(\mathcal{F})$ the sheaf of $\mathcal{K}_X$-modules which is the sheafification of the presheaf $U \mapsto \mathcal{S}(U)^{-1}\mathcal{F}(U)$. Equivalently $\mathcal{K}_X(\mathcal{F}) = \mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{K}_X$ (see above). \item A {\it meromorphic section of $\mathcal{F}$} is a global section of $\mathcal{K}_X(\mathcal{F})$. \end{enumerate} \end{definition} 
\begin{definition} \label{definition-pullback-meromorphic-sections} Let $f : (X, \mathcal{O}_X) \to (Y, \mathcal{O}_Y)$ be a morphism of locally ringed spaces. We say that {\it pullbacks of meromorphic functions are defined for $f$} if for every pair of open $U \subset X$, $V \subset Y$ such that $f(U) \subset V$, and any section $s \in \Gamma(V, \mathcal{S}_Y)$ the pullback $f^\sharp(s) \in \Gamma(U, \mathcal{O}_X)$ is an element of $\Gamma(U, \mathcal{S}_X)$. \end{definition} 
\begin{lemma} \label{lemma-pullback-meromorphic-sections-defined} Let $f : X \to Y$ be a morphism of schemes. In each of the following cases pullbacks of meromorphic functions are defined. \begin{enumerate} \item every weakly associated point of $X$ maps to a generic point of an irreducible component of $Y$, \item $X$, $Y$ are integral and $f$ is dominant, \item $X$ is integral and the generic point of $X$ maps to a generic point of an irreducible component of $Y$, \item $X$ is reduced and every generic point of every irreducible component of $X$ maps to the generic point of an irreducible component of $Y$, \item $X$ is locally Noetherian, and any associated point of $X$ maps to a generic point of an irreducible component of $Y$, \item $X$ is locally Noetherian, has no embedded points and any generic point of an irreducible component of $X$ maps to the generic point of an irreducible component of $Y$, and \item $f$ is flat. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-meromorphic-weakass-finite} Let $X$ be a scheme such that \begin{enumerate} \item[(a)] every weakly associated point of $X$ is a generic point of an irreducible component of $X$, and \item[(b)] any quasi-compact open has a finite number of irreducible components. \end{enumerate} Let $X^0$ be the set of generic points of irreducible components of $X$. Then we have $$ \mathcal{K}_X = \bigoplus\nolimits_{\eta \in X^0} j_{\eta, *}\mathcal{O}_{X, \eta} = \prod\nolimits_{\eta \in X^0} j_{\eta, *}\mathcal{O}_{X, \eta} $$ where $j_\eta : \Spec(\mathcal{O}_{X, \eta}) \to X$ is the canonical map of Schemes, Section \ref{schemes-section-points}. Moreover \begin{enumerate} \item $\mathcal{K}_X$ is a quasi-coherent sheaf of $\mathcal{O}_X$-algebras, \item for every quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$ the sheaf $$ \mathcal{K}_X(\mathcal{F}) = \bigoplus\nolimits_{\eta \in X^0} j_{\eta, *}\mathcal{F}_\eta = \prod\nolimits_{\eta \in X^0} j_{\eta, *}\mathcal{F}_\eta $$ of meromorphic sections of $\mathcal{F}$ is quasi-coherent, \item $\mathcal{S}_x \subset \mathcal{O}_{X, x}$ is the set of nonzerodivisors for any $x \in X$, \item $\mathcal{K}_{X, x}$ is the total quotient ring of $\mathcal{O}_{X, x}$ for any $x \in X$, \item $\mathcal{K}_X(U)$ equals the total quotient ring of $\mathcal{O}_X(U)$ for any affine open $U \subset X$, \item the ring of rational functions of $X$ (Morphisms, Definition \ref{morphisms-definition-rational-function}) is the ring of meromorphic functions on $X$, in a formula: $R(X) = \Gamma(X, \mathcal{K}_X)$. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-regular-meromorphic-section} Let $X$ be a locally ringed space. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. A meromorphic section $s$ of $\mathcal{L}$ is said to be {\it regular} if the induced map $\mathcal{K}_X \to \mathcal{K}_X(\mathcal{L})$ is injective. In other words, $s$ is a regular section of the invertible $\mathcal{K}_X$-module $\mathcal{K}_X(\mathcal{L})$, see Definition \ref{definition-regular-section}. \end{definition} 
\begin{lemma} \label{lemma-meromorphic-sections-pullback} Let $f : X \to Y$ be a morphism of locally ringed spaces. Assume that pullbacks of meromorphic functions are defined for $f$ (see Definition \ref{definition-pullback-meromorphic-sections}). \begin{enumerate} \item Let $\mathcal{F}$ be a sheaf of $\mathcal{O}_Y$-modules. There is a canonical pullback map $f^* : \Gamma(Y, \mathcal{K}_Y(\mathcal{F})) \to \Gamma(X, \mathcal{K}_X(f^*\mathcal{F}))$ for meromorphic sections of $\mathcal{F}$. \item Let $\mathcal{L}$ be an invertible $\mathcal{O}_Y$-module. A regular meromorphic section $s$ of $\mathcal{L}$ pulls back to a regular meromorphic section $f^*s$ of $f^*\mathcal{L}$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-regular-meromorphic-ideal-denominators} Let $X$ be a scheme. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Let $s$ be a regular meromorphic section of $\mathcal{L}$. Let us denote $\mathcal{I} \subset \mathcal{O}_X$ the sheaf of ideals defined by the rule $$ \mathcal{I}(V) = \{f \in \mathcal{O}_X(V) \mid fs \in \mathcal{L}(V)\}. $$ The formula makes sense since $\mathcal{L}(V) \subset \mathcal{K}_X(\mathcal{L})(V)$. Then $\mathcal{I}$ is a quasi-coherent sheaf of ideals and we have injective maps $$ 1 : \mathcal{I} \longrightarrow \mathcal{O}_X, \quad s : \mathcal{I} \longrightarrow \mathcal{L} $$ whose cokernels are supported on closed nowhere dense subsets of $X$. \end{lemma} 
\begin{definition} \label{definition-regular-meromorphic-ideal-denominators} Let $X$ be a scheme. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Let $s$ be a regular meromorphic section of $\mathcal{L}$. The sheaf of ideals $\mathcal{I}$ constructed in Lemma \ref{lemma-regular-meromorphic-ideal-denominators} is called the {\it ideal sheaf of denominators of $s$}. \end{definition} 
\begin{lemma} \label{lemma-meromorphic-section-restricts-to-zero} Let $X$ be a quasi-compact scheme. Let $h \in \Gamma(X, \mathcal{O}_X)$ and $f \in \Gamma(X, \mathcal{K}_X)$ such that $f$ restricts to zero on $X_h$. Then $h^n f = 0$ for some $n \gg 0$. \end{lemma} 
\begin{lemma} \label{lemma-locally-Noetherian-K} Let $X$ be a locally Noetherian scheme. \begin{enumerate} \item For any $x \in X$ we have $\mathcal{S}_x \subset \mathcal{O}_{X, x}$ is the set of nonzerodivisors, and hence $\mathcal{K}_{X, x}$ is the total quotient ring of $\mathcal{O}_{X, x}$. \item For any affine open $U \subset X$ the ring $\mathcal{K}_X(U)$ equals the total quotient ring of $\mathcal{O}_X(U)$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-quasi-coherent-K} Let $X$ be a locally Noetherian scheme having no embedded points. Let $X^0$ be the set of generic points of irreducible components of $X$. Then we have $$ \mathcal{K}_X = \bigoplus\nolimits_{\eta \in X^0} j_{\eta, *}\mathcal{O}_{X, \eta} = \prod\nolimits_{\eta \in X^0} j_{\eta, *}\mathcal{O}_{X, \eta} $$ where $j_\eta : \Spec(\mathcal{O}_{X, \eta}) \to X$ is the canonical map of Schemes, Section \ref{schemes-section-points}. Moreover \begin{enumerate} \item $\mathcal{K}_X$ is a quasi-coherent sheaf of $\mathcal{O}_X$-algebras, \item for every quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$ the sheaf $$ \mathcal{K}_X(\mathcal{F}) = \bigoplus\nolimits_{\eta \in X^0} j_{\eta, *}\mathcal{F}_\eta = \prod\nolimits_{\eta \in X^0} j_{\eta, *}\mathcal{F}_\eta $$ of meromorphic sections of $\mathcal{F}$ is quasi-coherent, and \item the ring of rational functions of $X$ is the ring of meromorphic functions on $X$, in a formula: $R(X) = \Gamma(X, \mathcal{K}_X)$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-regular-meromorphic-section-exists-noetherian} Let $X$ be a locally Noetherian scheme having no embedded points. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Then $\mathcal{L}$ has a regular meromorphic section. \end{lemma} 
\begin{lemma} \label{lemma-make-maps-regular-section} Suppose given \begin{enumerate} \item $X$ a locally Noetherian scheme, \item $\mathcal{L}$ an invertible $\mathcal{O}_X$-module, \item $s$ a regular meromorphic section of $\mathcal{L}$, and \item $\mathcal{F}$ coherent on $X$ without embedded associated points and $\text{Supp}(\mathcal{F}) = X$. \end{enumerate} Let $\mathcal{I} \subset \mathcal{O}_X$ be the ideal of denominators of $s$. Let $T \subset X$ be the union of the supports of $\mathcal{O}_X/\mathcal{I}$ and $\mathcal{L}/s(\mathcal{I})$ which is a nowhere dense closed subset $T \subset X$ according to Lemma \ref{lemma-regular-meromorphic-ideal-denominators}. Then there are canonical injective maps $$ 1 : \mathcal{I}\mathcal{F} \to \mathcal{F}, \quad s : \mathcal{I}\mathcal{F} \to \mathcal{F} \otimes_{\mathcal{O}_X}\mathcal{L} $$ whose cokernels are supported on $T$. \end{lemma} 
\begin{lemma} \label{lemma-reduced-finite-irreducible} Let $X$ be a reduced scheme such that any quasi-compact open has a finite number of irreducible components. Let $X^0$ be the set of generic points of irreducible components of $X$. Then we have $$ \mathcal{K}_X = \bigoplus\nolimits_{\eta \in X^0} j_{\eta, *}\kappa(\eta) = \prod\nolimits_{\eta \in X^0} j_{\eta, *}\kappa(\eta) $$ where $j_\eta : \Spec(\kappa(\eta)) \to X$ is the canonical map of Schemes, Section \ref{schemes-section-points}. Moreover \begin{enumerate} \item $\mathcal{K}_X$ is a quasi-coherent sheaf of $\mathcal{O}_X$-algebras, \item for every quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$ the sheaf $$ \mathcal{K}_X(\mathcal{F}) = \bigoplus\nolimits_{\eta \in X^0} j_{\eta, *}\mathcal{F}_\eta = \prod\nolimits_{\eta \in X^0} j_{\eta, *}\mathcal{F}_\eta $$ of meromorphic sections of $\mathcal{F}$ is quasi-coherent, \item $\mathcal{S}_x \subset \mathcal{O}_{X, x}$ is the set of nonzerodivisors for any $x \in X$, \item $\mathcal{K}_{X, x}$ is the total quotient ring of $\mathcal{O}_{X, x}$ for any $x \in X$, \item $\mathcal{K}_X(U)$ equals the total quotient ring of $\mathcal{O}_X(U)$ for any affine open $U \subset X$, \item the ring of rational functions of $X$ is the ring of meromorphic functions on $X$, in a formula: $R(X) = \Gamma(X, \mathcal{K}_X)$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-reduced-normalization} Let $X$ be a scheme. Assume $X$ is reduced and any quasi-compact open $U \subset X$ has a finite number of irreducible components. Then the normalization morphism $\nu : X^\nu \to X$ is the morphism $$ \underline{\Spec}_X(\mathcal{O}') \longrightarrow X $$ where $\mathcal{O}' \subset \mathcal{K}_X$ is the integral closure of $\mathcal{O}_X$ in the sheaf of meromorphic functions. \end{lemma} 
\begin{lemma} \label{lemma-meromorphic-functions-integral-scheme} Let $X$ be an integral scheme with generic point $\eta$. We have \begin{enumerate} \item the sheaf of meromorphic functions is isomorphic to the constant sheaf with value the function field (see Morphisms, Definition \ref{morphisms-definition-function-field}) of $X$. \item for any quasi-coherent sheaf $\mathcal{F}$ on $X$ the sheaf $\mathcal{K}_X(\mathcal{F})$ is isomorphic to the constant sheaf with value $\mathcal{F}_\eta$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-regular-meromorphic-section-exists} Let $X$ be a scheme. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. In each of the following cases $\mathcal{L}$ has a regular meromorphic section: \begin{enumerate} \item $X$ is integral, \item $X$ is reduced and any quasi-compact open has a finite number of irreducible components, \item $X$ is locally Noetherian and has no embedded points. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-components-locally-finite} Let $X$ be a locally Noetherian scheme. Let $Z \subset X$ be a closed subscheme. The collection of irreducible components of $Z$ is locally finite in $X$. \end{lemma} 
\begin{definition} \label{definition-Weil-divisor} Let $X$ be a locally Noetherian integral scheme. \begin{enumerate} \item A {\it prime divisor} is an integral closed subscheme $Z \subset X$ of codimension $1$. \item A {\it Weil divisor} is a formal sum $D = \sum n_Z Z$ where the sum is over prime divisors of $X$ and the collection $\{Z \mid n_Z \not = 0\}$ is locally finite (Topology, Definition \ref{topology-definition-locally-finite}). \end{enumerate} The group of all Weil divisors on $X$ is denoted $\text{Div}(X)$. \end{definition} 
\begin{definition} \label{definition-order-vanishing} Let $X$ be a locally Noetherian integral scheme. Let $f \in R(X)^*$. For every prime divisor $Z \subset X$ we define the {\it order of vanishing of $f$ along $Z$} as the integer $$ \text{ord}_Z(f) = \text{ord}_{\mathcal{O}_{X, \xi}}(f) $$ where the right hand side is the notion of Algebra, Definition \ref{algebra-definition-ord} and $\xi$ is the generic point of $Z$. \end{definition} 
\begin{lemma} \label{lemma-divisor-locally-finite} Let $X$ be a locally Noetherian integral scheme. Let $f \in R(X)^*$. Then the collections $$ \{Z \subset X \mid Z\text{ a prime divisor with generic point }\xi \text{ and }f\text{ not in }\mathcal{O}_{X, \xi}\} $$ and $$ \{Z \subset X \mid Z \text{ a prime divisor and }\text{ord}_Z(f) \not = 0\} $$ are locally finite in $X$. \end{lemma} 
\begin{definition} \label{definition-principal-divisor} Let $X$ be a locally Noetherian integral scheme. Let $f \in R(X)^*$. The {\it principal Weil divisor associated to $f$} is the Weil divisor $$ \text{div}(f) = \text{div}_X(f) = \sum \text{ord}_Z(f) [Z] $$ where the sum is over prime divisors and $\text{ord}_Z(f)$ is as in Definition \ref{definition-order-vanishing}. This makes sense by Lemma \ref{lemma-divisor-locally-finite}. \end{definition} 
\begin{lemma} \label{lemma-div-additive} Let $X$ be a locally Noetherian integral scheme. Let $f, g \in R(X)^*$. Then $$ \text{div}_X(fg) = \text{div}_X(f) + \text{div}_X(g) $$ as Weil divisors on $X$. \end{lemma} 
\begin{definition} \label{definition-class-group} Let $X$ be a locally Noetherian integral scheme. The {\it Weil divisor class group} of $X$ is the quotient of the group of Weil divisors by the subgroup of principal Weil divisors. Notation: $\text{Cl}(X)$. \end{definition} 
\begin{definition} \label{definition-order-vanishing-meromorphic} Let $X$ be a locally Noetherian integral scheme. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Let $s \in \Gamma(X, \mathcal{K}_X(\mathcal{L}))$ be a regular meromorphic section of $\mathcal{L}$. For every prime divisor $Z \subset X$ we define the {\it order of vanishing of $s$ along $Z$} as the integer $$ \text{ord}_{Z, \mathcal{L}}(s) = \text{ord}_{\mathcal{O}_{X, \xi}}(s/s_\xi) $$ where the right hand side is the notion of Algebra, Definition \ref{algebra-definition-ord}, $\xi \in Z$ is the generic point, and $s_\xi \in \mathcal{L}_\xi$ is a generator. \end{definition} 
\begin{lemma} \label{lemma-divisor-meromorphic-locally-finite} Let $X$ be a locally Noetherian integral scheme. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Let $s \in \mathcal{K}_X(\mathcal{L})$ be a regular (i.e., nonzero) meromorphic section of $\mathcal{L}$. Then the sets $$ \{Z \subset X \mid Z \text{ a prime divisor with generic point }\xi \text{ and }s\text{ not in }\mathcal{L}_\xi\} $$ and $$ \{Z \subset X \mid Z \text{ is a prime divisor and } \text{ord}_{Z, \mathcal{L}}(s) \not = 0\} $$ are locally finite in $X$. \end{lemma} 
\begin{lemma} \label{lemma-divisor-meromorphic-well-defined} Let $X$ be a locally Noetherian integral scheme. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Let $s, s' \in \mathcal{K}_X(\mathcal{L})$ be nonzero meromorphic sections of $\mathcal{L}$. Then $f = s/s'$ is an element of $R(X)^*$ and we have $$ \sum \text{ord}_{Z, \mathcal{L}}(s)[Z] = \sum \text{ord}_{Z, \mathcal{L}}(s')[Z] + \text{div}(f) $$ as Weil divisors. \end{lemma} 
\begin{definition} \label{definition-divisor-invertible-sheaf} Let $X$ be a locally Noetherian integral scheme. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. \begin{enumerate} \item For any nonzero meromorphic section $s$ of $\mathcal{L}$ we define the {\it Weil divisor associated to $s$} as $$ \text{div}_\mathcal{L}(s) = \sum \text{ord}_{Z, \mathcal{L}}(s) [Z] \in \text{Div}(X) $$ where the sum is over prime divisors. \item We define {\it Weil divisor class associated to $\mathcal{L}$} as the image of $\text{div}_\mathcal{L}(s)$ in $\text{Cl}(X)$ where $s$ is any nonzero meromorphic section of $\mathcal{L}$ over $X$. This is well defined by Lemma \ref{lemma-divisor-meromorphic-well-defined}. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-c1-additive} Let $X$ be a locally Noetherian integral scheme. Let $\mathcal{L}$, $\mathcal{N}$ be invertible $\mathcal{O}_X$-modules. Let $s$, resp.\ $t$ be a nonzero meromorphic section of $\mathcal{L}$, resp.\ $\mathcal{N}$. Then $st$ is a nonzero meromorphic section of $\mathcal{L} \otimes \mathcal{N}$, and $$ \text{div}_{\mathcal{L} \otimes \mathcal{N}}(st) = \text{div}_\mathcal{L}(s) + \text{div}_\mathcal{N}(t) $$ in $\text{Div}(X)$. In particular, the Weil divisor class of $\mathcal{L} \otimes_{\mathcal{O}_X} \mathcal{N}$ is the sum of the Weil divisor classes of $\mathcal{L}$ and $\mathcal{N}$. \end{lemma} 
\begin{lemma} \label{lemma-normal-c1-injective} Let $X$ be a locally Noetherian integral scheme. If $X$ is normal, then the map (\ref{equation-c1}) $\Pic(X) \to \text{Cl}(X)$ is injective. \end{lemma} 
\begin{lemma} \label{lemma-local-rings-UFD-c1-bijective} Let $X$ be a locally Noetherian integral scheme. Consider the map (\ref{equation-c1}) $\Pic(X) \to \text{Cl}(X)$. The following are equivalent \begin{enumerate} \item the local rings of $X$ are UFDs, and \item $X$ is normal and $\Pic(X) \to \text{Cl}(X)$ is surjective. \end{enumerate} In this case $\Pic(X) \to \text{Cl}(X)$ is an isomorphism. \end{lemma} 
\begin{lemma} \label{lemma-in-image-pullback} Let $\varphi : X \to Y$ be a morphism of schemes. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Assume that \begin{enumerate} \item $X$ is locally Noetherian, \item $Y$ is locally Noetherian, integral, and normal, \item $\varphi$ is flat with integral (hence nonempty) fibres, \item $\varphi$ is either quasi-compact or locally of finite type, \item $\mathcal{L}$ is trivial when restricted to the generic fibre of $\varphi$. \end{enumerate} Then $\mathcal{L} \cong \varphi^*\mathcal{N}$ for some invertible $\mathcal{O}_Y$-module $\mathcal{N}$. \end{lemma} 
\begin{lemma} \label{lemma-closure-effective-cartier-divisor} Let $X$ be a locally Noetherian scheme. Let $U \subset X$ be an open and let $D \subset U$ be an effective Cartier divisor. If $\mathcal{O}_{X, x}$ is a UFD for all $x \in X \setminus U$, then there exists an effective Cartier divisor $D' \subset X$ with $D = U \cap D'$. \end{lemma} 
\begin{lemma} \label{lemma-extend-invertible-module} Let $X$ be a locally Noetherian scheme. Let $U \subset X$ be an open and let $\mathcal{L}$ be an invertible $\mathcal{O}_U$-module. If $\mathcal{O}_{X, x}$ is a UFD for all $x \in X \setminus U$, then there exists an invertible $\mathcal{O}_X$-module $\mathcal{L}'$ with $\mathcal{L} \cong \mathcal{L}'|_U$. \end{lemma} 
\begin{lemma} \label{lemma-open-subscheme-UFD} Let $R$ be a UFD. The Picard groups of the following are trivial. \begin{enumerate} \item $\Spec(R)$ and any open subscheme of it. \item $\mathbf{A}^n_R = \Spec(R[x_1, \ldots, x_n])$ and any open subscheme of it. \end{enumerate} In particular, the Picard group of any open subscheme of affine $n$-space $\mathbf{A}^n_k$ over a field $k$ is trivial. \end{lemma} 
\begin{lemma} \label{lemma-Pic-projective-space-UFD} Let $R$ be a UFD. The Picard group of $\mathbf{P}^n_R$ is $\mathbf{Z}$. More precisely, there is an isomorphism $$ \mathbf{Z} \longrightarrow \Pic(\mathbf{P}^n_R),\quad m \longmapsto \mathcal{O}_{\mathbf{P}^n_R}(m) $$ In particular, the Picard group of $\mathbf{P}^n_k$ of projective space over a field $k$ is $\mathbf{Z}$. \end{lemma} 
\begin{lemma} \label{lemma-reflexive-normal} Let $X$ be an integral locally Noetherian normal scheme. For $\mathcal{F}$ and $\mathcal{G}$ coherent reflexive $\mathcal{O}_X$-modules the map $$ (\SheafHom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{O}_X) \otimes_{\mathcal{O}_X} \mathcal{G})^{**} \to \SheafHom_{\mathcal{O}_X}(\mathcal{F}, \mathcal{G}) $$ is an isomorphism. The rule $\mathcal{F}, \mathcal{G} \mapsto (\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{G})^{**}$ defines an abelian group law on the set of isomorphism classes of rank $1$ coherent reflexive $\mathcal{O}_X$-modules. \end{lemma} 
\begin{lemma} \label{lemma-normal-class-group} Let $X$ be an integral locally Noetherian normal scheme. The group of rank $1$ coherent reflexive $\mathcal{O}_X$-modules is isomorphic to the Weil divisor class group $\text{Cl}(X)$ of $X$. \end{lemma} 
\begin{lemma} \label{lemma-structure-sheaf-Xs} Let $X$ be an integral locally Noetherian normal scheme. Let $\mathcal{F}$ be a rank 1 coherent reflexive $\mathcal{O}_X$-module. Let $s \in \Gamma(X, \mathcal{F})$. Let $$ U = \{x \in X \mid s : \mathcal{O}_{X, x} \to \mathcal{F}_x \text{ is an isomorphism}\} $$ Then $j : U \to X$ is an open subscheme of $X$ and $$ j_*\mathcal{O}_U = \colim (\mathcal{O}_X \xrightarrow{s} \mathcal{F} \xrightarrow{s} \mathcal{F}^{[2]} \xrightarrow{s} \mathcal{F}^{[3]} \xrightarrow{s} \ldots) $$ where $\mathcal{F}^{[1]} = \mathcal{F}$ and inductively $\mathcal{F}^{[n + 1]} = (\mathcal{F} \otimes_{\mathcal{O}_X} \mathcal{F}^{[n]})^{**}$. \end{lemma} 
\begin{lemma} \label{lemma-Xs-codim-complement} Assumptions and notation as in Lemma \ref{lemma-structure-sheaf-Xs}. If $s$ is nonzero, then every irreducible component of $X \setminus U$ has codimension $1$ in $X$. \end{lemma} 
\begin{lemma} \label{lemma-affine-Xs} Assumptions and notation as in Lemma \ref{lemma-structure-sheaf-Xs}. The following are equivalent \begin{enumerate} \item the inclusion morphism $j : U \to X$ is affine, and \item for every $x \in X \setminus U$ there is an $n > 0$ such that $s^n \in \mathfrak m_x \mathcal{F}^{[n]}_x$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-relative-proj-quasi-compact} Let $S$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent graded $\mathcal{O}_S$-algebra. Let $p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative Proj of $\mathcal{A}$. If one of the following holds \begin{enumerate} \item $\mathcal{A}$ is of finite type as a sheaf of $\mathcal{A}_0$-algebras, \item $\mathcal{A}$ is generated by $\mathcal{A}_1$ as an $\mathcal{A}_0$-algebra and $\mathcal{A}_1$ is a finite type $\mathcal{A}_0$-module, \item there exists a finite type quasi-coherent $\mathcal{A}_0$-submodule $\mathcal{F} \subset \mathcal{A}_{+}$ such that $\mathcal{A}_{+}/\mathcal{F}\mathcal{A}$ is a locally nilpotent sheaf of ideals of $\mathcal{A}/\mathcal{F}\mathcal{A}$, \end{enumerate} then $p$ is quasi-compact. \end{lemma} 
\begin{lemma} \label{lemma-relative-proj-finite-type} Let $S$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent graded $\mathcal{O}_S$-algebra. Let $p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative Proj of $\mathcal{A}$. If $\mathcal{A}$ is of finite type as a sheaf of $\mathcal{O}_S$-algebras, then $p$ is of finite type and $\mathcal{O}_X(d)$ is a finite type $\mathcal{O}_X$-module. \end{lemma} 
\begin{lemma} \label{lemma-relative-proj-universally-closed} Let $S$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent graded $\mathcal{O}_S$-algebra. Let $p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative Proj of $\mathcal{A}$. If $\mathcal{O}_S \to \mathcal{A}_0$ is an integral algebra map\footnote{In other words, the integral closure of $\mathcal{O}_S$ in $\mathcal{A}_0$, see Morphisms, Definition \ref{morphisms-definition-integral-closure}, equals $\mathcal{A}_0$.} and $\mathcal{A}$ is of finite type as an $\mathcal{A}_0$-algebra, then $p$ is universally closed. \end{lemma} 
\begin{lemma} \label{lemma-relative-proj-proper} Let $S$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent graded $\mathcal{O}_S$-algebra. Let $p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative Proj of $\mathcal{A}$. The following conditions are equivalent \begin{enumerate} \item $\mathcal{A}_0$ is a finite type $\mathcal{O}_S$-module and $\mathcal{A}$ is of finite type as an $\mathcal{A}_0$-algebra, \item $\mathcal{A}_0$ is a finite type $\mathcal{O}_S$-module and $\mathcal{A}$ is of finite type as an $\mathcal{O}_S$-algebra \end{enumerate} If these conditions hold, then $p$ is locally projective and in particular proper. \end{lemma} 
\begin{lemma} \label{lemma-relative-proj-projective} Let $S$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent graded $\mathcal{O}_S$-algebra. Let $p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative Proj of $\mathcal{A}$. If $\mathcal{A}$ is generated by $\mathcal{A}_1$ over $\mathcal{A}_0$ and $\mathcal{A}_1$ is a finite type $\mathcal{O}_S$-module, then $p$ is projective. \end{lemma} 
\begin{lemma} \label{lemma-relative-proj-flat} Let $S$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent graded $\mathcal{O}_S$-algebra. Let $p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative Proj of $\mathcal{A}$. If $\mathcal{A}_d$ is a flat $\mathcal{O}_S$-module for $d \gg 0$, then $p$ is flat and $\mathcal{O}_X(d)$ is flat over $S$. \end{lemma} 
\begin{lemma} \label{lemma-relative-proj-finite-presentation} Let $S$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent graded $\mathcal{O}_S$-algebra. Let $p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative Proj of $\mathcal{A}$. If $\mathcal{A}$ is a finitely presented $\mathcal{O}_S$-algebra, then $p$ is of finite presentation and $\mathcal{O}_X(d)$ is an $\mathcal{O}_X$-module of finite presentation. \end{lemma} 
\begin{lemma} \label{lemma-closed-subscheme-proj} Let $S$ be a scheme. Let $\mathcal{A}$ be a quasi-coherent graded $\mathcal{O}_S$-algebra. Let $p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative Proj of $\mathcal{A}$. Let $i : Z \to X$ be a closed subscheme. Denote $\mathcal{I} \subset \mathcal{A}$ the kernel of the canonical map $$ \mathcal{A} \longrightarrow \bigoplus\nolimits_{d \geq 0} p_*\left((i_*\mathcal{O}_Z)(d)\right). $$ If $p$ is quasi-compact, then there is an isomorphism $Z = \underline{\text{Proj}}_S(\mathcal{A}/\mathcal{I})$. \end{lemma} 
\begin{lemma} \label{lemma-equation-codim-1-in-projective-space} Let $R$ be a Noetherian UFD. Let $Z \subset \mathbf{P}^n_R$ be a closed subscheme which has no embedded points such that every irreducible component of $Z$ has codimension $1$ in $\mathbf{P}^n_R$. Then the ideal $I(Z) \subset R[T_0, \ldots, T_n]$ corresponding to $Z$ is principal. \end{lemma} 
\begin{lemma} \label{lemma-closed-subscheme-proj-finite} Let $S$ be a quasi-compact and quasi-separated scheme. Let $\mathcal{A}$ be a quasi-coherent graded $\mathcal{O}_S$-algebra. Let $p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative Proj of $\mathcal{A}$. Let $i : Z \to X$ be a closed subscheme. If $p$ is quasi-compact and $i$ of finite presentation, then there exists a $d > 0$ and a quasi-coherent finite type $\mathcal{O}_S$-submodule $\mathcal{F} \subset \mathcal{A}_d$ such that $Z = \underline{\text{Proj}}_S(\mathcal{A}/\mathcal{F}\mathcal{A})$. \end{lemma} 
\begin{lemma} \label{lemma-closed-subscheme-proj-finite-type} Let $S$ be a quasi-compact and quasi-separated scheme. Let $\mathcal{A}$ be a quasi-coherent graded $\mathcal{O}_S$-algebra. Let $p : X = \underline{\text{Proj}}_S(\mathcal{A}) \to S$ be the relative Proj of $\mathcal{A}$. Let $i : Z \to X$ be a closed subscheme. Let $U \subset S$ be an open. Assume that \begin{enumerate} \item $p$ is quasi-compact, \item $i$ of finite presentation, \item $U \cap p(i(Z)) = \emptyset$, \item $U$ is quasi-compact, \item $\mathcal{A}_n$ is a finite type $\mathcal{O}_S$-module for all $n$. \end{enumerate} Then there exists a $d > 0$ and a quasi-coherent finite type $\mathcal{O}_S$-submodule $\mathcal{F} \subset \mathcal{A}_d$ with (a) $Z = \underline{\text{Proj}}_S(\mathcal{A}/\mathcal{F}\mathcal{A})$ and (b) the support of $\mathcal{A}_d/\mathcal{F}$ is disjoint from $U$. \end{lemma} 
\begin{lemma} \label{lemma-conormal-sheaf-section-projective-bundle} Let $X$ be a scheme. Let $\mathcal{E}$ be a quasi-coherent $\mathcal{O}_X$-module. There is a bijection $$ \left\{ \begin{matrix} \text{sections }\sigma\text{ of the } \\ \text{morphism } \mathbf{P}(\mathcal{E}) \to X \end{matrix} \right\} \leftrightarrow \left\{ \begin{matrix} \text{surjections }\mathcal{E} \to \mathcal{L}\text{ where} \\ \mathcal{L}\text{ is an invertible }\mathcal{O}_X\text{-module} \end{matrix} \right\} $$ In this case $\sigma$ is a closed immersion and there is a canonical isomorphism $$ \Ker(\mathcal{E} \to \mathcal{L}) \otimes_{\mathcal{O}_X} \mathcal{L}^{\otimes -1} \longrightarrow \mathcal{C}_{\sigma(X)/\mathbf{P}(\mathcal{E})} $$ Both the bijection and isomorphism are compatible with base change. \end{lemma} 
\begin{definition} \label{definition-blow-up} Let $X$ be a scheme. Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of ideals, and let $Z \subset X$ be the closed subscheme corresponding to $\mathcal{I}$, see Schemes, Definition \ref{schemes-definition-immersion}. The {\it blowing up of $X$ along $Z$}, or the {\it blowing up of $X$ in the ideal sheaf $\mathcal{I}$} is the morphism $$ b : \underline{\text{Proj}}_X \left(\bigoplus\nolimits_{n \geq 0} \mathcal{I}^n\right) \longrightarrow X $$ The {\it exceptional divisor} of the blowup is the inverse image $b^{-1}(Z)$. Sometimes $Z$ is called the {\it center} of the blowup. \end{definition} 
\begin{lemma} \label{lemma-blowing-up-affine} Let $X$ be a scheme. Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of ideals. Let $U = \Spec(A)$ be an affine open subscheme of $X$ and let $I \subset A$ be the ideal corresponding to $\mathcal{I}|_U$. If $b : X' \to X$ is the blowup of $X$ in $\mathcal{I}$, then there is a canonical isomorphism $$ b^{-1}(U) = \text{Proj}(\bigoplus\nolimits_{d \geq 0} I^d) $$ of $b^{-1}(U)$ with the homogeneous spectrum of the Rees algebra of $I$ in $A$. Moreover, $b^{-1}(U)$ has an affine open covering by spectra of the affine blowup algebras $A[\frac{I}{a}]$. \end{lemma} 
\begin{lemma} \label{lemma-flat-base-change-blowing-up} \begin{slogan} Blowing up commutes with flat base change. \end{slogan} Let $X_1 \to X_2$ be a flat morphism of schemes. Let $Z_2 \subset X_2$ be a closed subscheme. Let $Z_1$ be the inverse image of $Z_2$ in $X_1$. Let $X'_i$ be the blowup of $Z_i$ in $X_i$. Then there exists a cartesian diagram $$ \xymatrix{ X_1' \ar[r] \ar[d] & X_2' \ar[d] \\ X_1 \ar[r] & X_2 } $$ of schemes. \end{lemma} 
\begin{lemma} \label{lemma-blowing-up-gives-effective-Cartier-divisor} Let $X$ be a scheme. Let $Z \subset X$ be a closed subscheme. The blowing up $b : X' \to X$ of $Z$ in $X$ has the following properties: \begin{enumerate} \item $b|_{b^{-1}(X \setminus Z)} : b^{-1}(X \setminus Z) \to X \setminus Z$ is an isomorphism, \item the exceptional divisor $E = b^{-1}(Z)$ is an effective Cartier divisor on $X'$, \item there is a canonical isomorphism $\mathcal{O}_{X'}(-1) = \mathcal{O}_{X'}(E)$ \end{enumerate} \end{lemma} 
\begin{lemma}[Universal property blowing up] \label{lemma-universal-property-blowing-up} Let $X$ be a scheme. Let $Z \subset X$ be a closed subscheme. Let $\mathcal{C}$ be the full subcategory of $(\Sch/X)$ consisting of $Y \to X$ such that the inverse image of $Z$ is an effective Cartier divisor on $Y$. Then the blowing up $b : X' \to X$ of $Z$ in $X$ is a final object of $\mathcal{C}$. \end{lemma} 
\begin{lemma} \label{lemma-characterize-affine-blowup} Let $b : X' \to X$ be the blowing up of the scheme $X$ along a closed subscheme $Z$. Let $U = \Spec(A)$ be an affine open of $X$ and let $I \subset A$ be the ideal corresponding to $Z \cap U$. Let $a \in I$ and let $x' \in X'$ be a point mapping to a point of $U$. Then $x'$ is a point of the affine open $U' = \Spec(A[\frac{I}{a}])$ if and only if the image of $a$ in $\mathcal{O}_{X', x'}$ cuts out the exceptional divisor. \end{lemma} 
\begin{lemma} \label{lemma-blow-up-effective-Cartier-divisor} Let $X$ be a scheme. Let $Z \subset X$ be an effective Cartier divisor. The blowup of $X$ in $Z$ is the identity morphism of $X$. \end{lemma} 
\begin{lemma} \label{lemma-blow-up-reduced-scheme} Let $X$ be a scheme. Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of ideals. If $X$ is reduced, then the blowup $X'$ of $X$ in $\mathcal{I}$ is reduced. \end{lemma} 
\begin{lemma} \label{lemma-blow-up-integral-scheme} Let $X$ be a scheme. Let $\mathcal{I} \subset \mathcal{O}_X$ be a nonzero quasi-coherent sheaf of ideals. If $X$ is integral, then the blowup $X'$ of $X$ in $\mathcal{I}$ is integral. \end{lemma} 
\begin{lemma} \label{lemma-blow-up-and-irreducible-components} Let $X$ be a scheme. Let $Z \subset X$ be a closed subscheme. Let $b : X' \to X$ be the blowing up of $X$ along $Z$. Then $b$ induces an bijective map from the set of generic points of irreducible components of $X'$ to the set of generic points of irreducible components of $X$ which are not in $Z$. \end{lemma} 
\begin{lemma} \label{lemma-blow-up-pullback-effective-Cartier} Let $X$ be a scheme. Let $b : X' \to X$ be a blowup of $X$ in a closed subscheme. The pullback $b^{-1}D$ is defined for all effective Cartier divisors $D \subset X$ and pullbacks of meromorphic functions are defined for $b$ (Definitions \ref{definition-pullback-effective-Cartier-divisor} and \ref{definition-pullback-meromorphic-sections}). \end{lemma} 
\begin{lemma} \label{lemma-blowing-up-two-ideals} Let $X$ be a scheme. Let $\mathcal{I}, \mathcal{J} \subset \mathcal{O}_X$ be quasi-coherent sheaves of ideals. Let $b : X' \to X$ be the blowing up of $X$ in $\mathcal{I}$. Let $b' : X'' \to X'$ be the blowing up of $X'$ in $b^{-1}\mathcal{J} \mathcal{O}_{X'}$. Then $X'' \to X$ is canonically isomorphic to the blowing up of $X$ in $\mathcal{I}\mathcal{J}$. \end{lemma} 
\begin{lemma} \label{lemma-blowing-up-projective} Let $X$ be a scheme. Let $\mathcal{I} \subset \mathcal{O}_X$ be a quasi-coherent sheaf of ideals. Let $b : X' \to X$ be the blowing up of $X$ in the ideal sheaf $\mathcal{I}$. If $\mathcal{I}$ is of finite type, then \begin{enumerate} \item $b : X' \to X$ is a projective morphism, and \item $\mathcal{O}_{X'}(1)$ is a $b$-relatively ample invertible sheaf. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-composition-finite-type-blowups} \begin{slogan} Composition of blowing ups is a blowing up \end{slogan} Let $X$ be a quasi-compact and quasi-separated scheme. Let $Z \subset X$ be a closed subscheme of finite presentation. Let $b : X' \to X$ be the blowing up with center $Z$. Let $Z' \subset X'$ be a closed subscheme of finite presentation. Let $X'' \to X'$ be the blowing up with center $Z'$. There exists a closed subscheme $Y \subset X$ of finite presentation, such that \begin{enumerate} \item $Y = Z \cup b(Z')$ set theoretically, and \item the composition $X'' \to X$ is isomorphic to the blowing up of $X$ in $Y$. \end{enumerate} \end{lemma} 
\begin{definition} \label{definition-strict-transform} With $Z \subset S$ and $f : X \to S$ as above. \begin{enumerate} \item Given a quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$ the {\it strict transform} of $\mathcal{F}$ with respect to the blowup of $S$ in $Z$ is the quotient $\mathcal{F}'$ of $\text{pr}_X^*\mathcal{F}$ by the submodule of sections supported on $\text{pr}_{S'}^{-1}E$. \item The {\it strict transform} of $X$ is the closed subscheme $X' \subset X \times_S S'$ cut out by the quasi-coherent ideal of sections of $\mathcal{O}_{X \times_S S'}$ supported on $\text{pr}_{S'}^{-1}E$. \end{enumerate} \end{definition} 
\begin{lemma} \label{lemma-strict-transform} In the situation of Definition \ref{definition-strict-transform}. \begin{enumerate} \item The strict transform $X'$ of $X$ is the blowup of $X$ in the closed subscheme $f^{-1}Z$ of $X$. \item For a quasi-coherent $\mathcal{O}_X$-module $\mathcal{F}$ the strict transform $\mathcal{F}'$ is canonically isomorphic to the pushforward along $X' \to X \times_S S'$ of the strict transform of $\mathcal{F}$ relative to the blowing up $X' \to X$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-strict-transform-flat} In the situation of Definition \ref{definition-strict-transform}. \begin{enumerate} \item If $X$ is flat over $S$ at all points lying over $Z$, then the strict transform of $X$ is equal to the base change $X \times_S S'$. \item Let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. If $\mathcal{F}$ is flat over $S$ at all points lying over $Z$, then the strict transform $\mathcal{F}'$ of $\mathcal{F}$ is equal to the pullback $\text{pr}_X^*\mathcal{F}$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-strict-transform-affine} Let $S$ be a scheme. Let $Z \subset S$ be a closed subscheme. Let $b : S' \to S$ be the blowing up of $Z$ in $S$. Let $g : X \to Y$ be an affine morphism of schemes over $S$. Let $\mathcal{F}$ be a quasi-coherent sheaf on $X$. Let $g' : X \times_S S' \to Y \times_S S'$ be the base change of $g$. Let $\mathcal{F}'$ be the strict transform of $\mathcal{F}$ relative to $b$. Then $g'_*\mathcal{F}'$ is the strict transform of $g_*\mathcal{F}$. \end{lemma} 
\begin{lemma} \label{lemma-strict-transform-different-centers} Let $S$ be a scheme. Let $Z \subset S$ be a closed subscheme. Let $D \subset S$ be an effective Cartier divisor. Let $Z' \subset S$ be the closed subscheme cut out by the product of the ideal sheaves of $Z$ and $D$. Let $S' \to S$ be the blowup of $S$ in $Z$. \begin{enumerate} \item The blowup of $S$ in $Z'$ is isomorphic to $S' \to S$. \item Let $f : X \to S$ be a morphism of schemes and let $\mathcal{F}$ be a quasi-coherent $\mathcal{O}_X$-module. If $\mathcal{F}$ has no nonzero local sections supported in $f^{-1}D$, then the strict transform of $\mathcal{F}$ relative to the blowing up in $Z$ agrees with the strict transform of $\mathcal{F}$ relative to the blowing up of $S$ in $Z'$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-strict-transform-composition-blowups} Let $S$ be a scheme. Let $Z \subset S$ be a closed subscheme. Let $b : S' \to S$ be the blowing up with center $Z$. Let $Z' \subset S'$ be a closed subscheme. Let $S'' \to S'$ be the blowing up with center $Z'$. Let $Y \subset S$ be a closed subscheme such that $Y = Z \cup b(Z')$ set theoretically and the composition $S'' \to S$ is isomorphic to the blowing up of $S$ in $Y$. In this situation, given any scheme $X$ over $S$ and $\mathcal{F} \in \QCoh(\mathcal{O}_X)$ we have \begin{enumerate} \item the strict transform of $\mathcal{F}$ with respect to the blowing up of $S$ in $Y$ is equal to the strict transform with respect to the blowup $S'' \to S'$ in $Z'$ of the strict transform of $\mathcal{F}$ with respect to the blowup $S' \to S$ of $S$ in $Z$, and \item the strict transform of $X$ with respect to the blowing up of $S$ in $Y$ is equal to the strict transform with respect to the blowup $S'' \to S'$ in $Z'$ of the strict transform of $X$ with respect to the blowup $S' \to S$ of $S$ in $Z$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-strict-transform-universally-injective} In the situation of Definition \ref{definition-strict-transform}. Suppose that $$ 0 \to \mathcal{F}_1 \to \mathcal{F}_2 \to \mathcal{F}_3 \to 0 $$ is an exact sequence of quasi-coherent sheaves on $X$ which remains exact after any base change $T \to S$. Then the strict transforms of $\mathcal{F}_i'$ relative to any blowup $S' \to S$ form a short exact sequence $0 \to \mathcal{F}'_1 \to \mathcal{F}'_2 \to \mathcal{F}'_3 \to 0$ too. \end{lemma} 
\begin{definition} \label{definition-admissible-blowup} Let $X$ be a scheme. Let $U \subset X$ be an open subscheme. A morphism $X' \to X$ is called a {\it $U$-admissible blowup} if there exists a closed immersion $Z \to X$ of finite presentation with $Z$ disjoint from $U$ such that $X'$ is isomorphic to the blowup of $X$ in $Z$. \end{definition} 
\begin{lemma} \label{lemma-composition-admissible-blowups} \begin{slogan} Admissible blowups are stable under composition. \end{slogan} Let $X$ be a quasi-compact and quasi-separated scheme. Let $U \subset X$ be a quasi-compact open subscheme. Let $b : X' \to X$ be a $U$-admissible blowup. Let $X'' \to X'$ be a $U$-admissible blowup. Then the composition $X'' \to X$ is a $U$-admissible blowup. \end{lemma} 
\begin{lemma} \label{lemma-extend-admissible-blowups} Let $X$ be a quasi-compact and quasi-separated scheme. Let $U, V \subset X$ be quasi-compact open subschemes. Let $b : V' \to V$ be a $U \cap V$-admissible blowup. Then there exists a $U$-admissible blowup $X' \to X$ whose restriction to $V$ is $V'$. \end{lemma} 
\begin{lemma} \label{lemma-dominate-admissible-blowups} Let $X$ be a quasi-compact and quasi-separated scheme. Let $U \subset X$ be a quasi-compact open subscheme. Let $b_i : X_i \to X$, $i = 1, \ldots, n$ be $U$-admissible blowups. There exists a $U$-admissible blowup $b : X' \to X$ such that (a) $b$ factors as $X' \to X_i \to X$ for $i = 1, \ldots, n$ and (b) each of the morphisms $X' \to X_i$ is a $U$-admissible blowup. \end{lemma} 
\begin{lemma} \label{lemma-separate-disjoint-opens-by-blowing-up} \begin{slogan} Separate irreducible components by blowing up. \end{slogan} Let $X$ be a quasi-compact and quasi-separated scheme. Let $U, V$ be quasi-compact disjoint open subschemes of $X$. Then there exist a $U \cup V$-admissible blowup $b : X' \to X$ such that $X'$ is a disjoint union of open subschemes $X' = X'_1 \amalg X'_2$ with $b^{-1}(U) \subset X'_1$ and $b^{-1}(V) \subset X'_2$. \end{lemma} 
\begin{lemma} \label{lemma-blowing-up-denominators} Let $X$ be a locally Noetherian scheme. Let $\mathcal{L}$ be an invertible $\mathcal{O}_X$-module. Let $s$ be a regular meromorphic section of $\mathcal{L}$. Let $U \subset X$ be the maximal open subscheme such that $s$ corresponds to a section of $\mathcal{L}$ over $U$. The blowup $b : X' \to X$ in the ideal of denominators of $s$ is $U$-admissible. There exists an effective Cartier divisor $D \subset X'$ and an isomorphism $$ b^*\mathcal{L} = \mathcal{O}_{X'}(D - E), $$ where $E \subset X'$ is the exceptional divisor such that the meromorphic section $b^*s$ corresponds, via the isomorphism, to the meromorphic section $1_D \otimes (1_E)^{-1}$. \end{lemma} 
\begin{lemma} \label{lemma-strict-transform-blowup-fitting-ideal} Let $S$ be a scheme. Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_S$-module. Let $Z_k \subset S$ be the closed subscheme cut out by $\text{Fit}_k(\mathcal{F})$, see Section \ref{section-fitting-ideals}. Let $S' \to S$ be the blowup of $S$ in $Z_k$ and let $\mathcal{F}'$ be the strict transform of $\mathcal{F}$. Then $\mathcal{F}'$ can locally be generated by $\leq k$ sections. \end{lemma} 
\begin{lemma} \label{lemma-strict-transform-blowup-fitting-ideal-locally-free} Let $S$ be a scheme. Let $\mathcal{F}$ be a finite type quasi-coherent $\mathcal{O}_S$-module. Let $Z_k \subset S$ be the closed subscheme cut out by $\text{Fit}_k(\mathcal{F})$, see Section \ref{section-fitting-ideals}. Assume that $\mathcal{F}$ is locally free of rank $k$ on $S \setminus Z_k$. Let $S' \to S$ be the blowup of $S$ in $Z_k$ and let $\mathcal{F}'$ be the strict transform of $\mathcal{F}$. Then $\mathcal{F}'$ is locally free of rank $k$. \end{lemma} 
\begin{lemma} \label{lemma-blowup-fitting-ideal} Let $X$ be a scheme. Let $\mathcal{F}$ be a finitely presented $\mathcal{O}_X$-module. Let $U \subset X$ be a scheme theoretically dense open such that $\mathcal{F}|_U$ is finite locally free of constant rank $r$. Then \begin{enumerate} \item the blowup $b : X' \to X$ of $X$ in the $r$th Fitting ideal of $\mathcal{F}$ is $U$-admissible, \item the strict transform $\mathcal{F}'$ of $\mathcal{F}$ with respect to $b$ is locally free of rank $r$, \item the kernel $\mathcal{K}$ of the surjection $b^*\mathcal{F} \to \mathcal{F}'$ is finitely presented and $\mathcal{K}|_U = 0$, \item $b^*\mathcal{F}$ and $\mathcal{K}$ are perfect $\mathcal{O}_{X'}$-modules of tor dimension $\leq 1$. \end{enumerate} \end{lemma} 
\begin{lemma} \label{lemma-filter-after-modification} Let $X$ be an integral scheme. Let $\mathcal{E}$ be a finite locally free $\mathcal{O}_X$-module. There exists a modification $f : X' \to X$ such that $f^*\mathcal{E}$ has a filtration whose successive quotients are invertible $\mathcal{O}_{X'}$-modules. \end{lemma} 
\begin{lemma} \label{lemma-extend-rational-map-after-modification} Let $S$ be a scheme. Let $X$, $Y$ be schemes over $S$. Assume $X$ is Noetherian and $Y$ is proper over $S$. Given an $S$-rational map $f : U \to Y$ from $X$ to $Y$ there exists a morphism $p : X' \to X$ and an $S$-morphism $f' : X' \to Y$ such that \begin{enumerate} \item $p$ is proper and $p^{-1}(U) \to U$ is an isomorphism, \item $f'|_{p^{-1}(U)}$ is equal to $f \circ p|_{p^{-1}(U)}$. \end{enumerate} \end{lemma} 
